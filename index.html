<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hifz Tracker">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Hifz Tracker</title>

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
    
    <!-- Firebase SDK v12 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, deleteDoc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuA7Nr0A2eyxDJ3-TY5ODXCMy1uYk9UPM",
            authDomain: "hifz-record-dee0e.firebaseapp.com",
            projectId: "hifz-record-dee0e",
            storageBucket: "hifz-record-dee0e.firebasestorage.app",
            messagingSenderId: "619664875996",
            appId: "1:619664875996:web:43ad2a1e69d4a02837ef19"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = { auth, db };
        window.firebaseModules = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            getDocs,
            collection,
            onSnapshot,
            deleteDoc,
            updateDoc,
            query,
            where
        };
    </script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- CSV Parsing Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #F2F2F7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            color: #1C1C1E;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F2F2F7;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1024px;
                padding: 0 20px;
            }
        }

        .header {
            background: #F2F2F7;
            padding: 20px;
            text-align: center;
            border-radius: 0;
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px 40px;
            }
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1C1C1E;
        }

        @media (min-width: 768px) {
            .app-title {
                font-size: 36px;
            }
        }

        .current-date {
            font-size: 16px;
            font-weight: 500;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .current-date {
                font-size: 18px;
            }
        }

        .cloud-status {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            color: #1C1C1E;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .cloud-status.connected {
            background: rgba(16, 163, 127, 0.2);
            color: #0D7A5F;
        }

        .cloud-status.connecting {
            background: rgba(255, 149, 0, 0.2);
            color: #E65100;
        }

        .cloud-status.disconnected {
            background: rgba(255, 59, 48, 0.2);
            color: #C62828;
        }

        .user-info {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(16, 163, 127, 0.1);
            border-radius: 12px;
            color: #1C1C1E;
            font-size: 14px;
            font-weight: 600;
        }

        /* Profile Selection */
        .profile-selection { 
            margin: 20px; 
            display: block; 
        }

        @media (min-width: 768px) {
            .profile-selection {
                margin: 40px auto;
                max-width: 600px;
            }
        }

        .profile-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .profile-card {
                padding: 40px;
            }
        }

        .profile-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .profile-title {
                font-size: 28px;
                margin-bottom: 30px;
            }
        }

        .profile-option {
            background: #F8F9FA;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .profile-option {
                padding: 20px;
                gap: 16px;
            }
        }

        .profile-option:hover {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.05);
        }

        .profile-option.selected {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.1);
        }

        .profile-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .profile-icon {
                font-size: 32px;
                width: 50px;
            }
        }

        .profile-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        @media (min-width: 768px) {
            .profile-info h3 {
                font-size: 18px;
            }
        }

        .profile-info p {
            font-size: 12px;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .profile-info p {
                font-size: 14px;
            }
        }

        .continue-button {
            width: 100%;
            padding: 14px;
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        @media (min-width: 768px) {
            .continue-button {
                padding: 18px;
                font-size: 18px;
            }
        }

        .continue-button:hover {
            background: #0D7A5F;
        }

        .continue-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        /* Login styles */
        .login-section { 
            margin: 20px; 
            display: none; 
        }

        @media (min-width: 768px) {
            .login-section {
                margin: 40px auto;
                max-width: 500px;
            }
        }
        
        .login-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .login-card {
                padding: 40px;
            }
        }
        
        .login-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .login-title {
                font-size: 28px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #8E8E93;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 10px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }
        
        .login-button { 
            width: 100%; 
            padding: 14px; 
            background: #10A37F; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .login-button {
                padding: 18px;
                font-size: 18px;
            }
        }
        
        .login-button:hover { 
            background: #0D7A5F; 
        }

        .back-button {
            background: #8E8E93;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .error-message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
            display: none;
            background: #FF3B30;
            color: white;
        }

        /* Permission Notice */
        .permission-notice {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid #10A37F;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 15px 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #0D7A5F;
            display: none;
        }

        @media (min-width: 768px) {
            .permission-notice {
                margin: 20px 40px;
                font-size: 16px;
            }
        }

        .permission-notice.read-only {
            background: rgba(255, 149, 0, 0.1);
            border-color: #FF9500;
            color: #E65100;
        }

        /* Hide student selector for parent users */
        .parent-mode .student-selector {
            display: none;
        }

        /* Main app styles */
        .main-content { 
            display: none; 
            padding: 10px 20px 20px 20px; 
        }

        @media (min-width: 768px) {
            .main-content {
                padding: 15px 40px 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 40px;
                align-items: start;
            }

            .main-left {
                order: 1;
            }

            .main-right {
                order: 2;
            }
        }
        
        .student-selector { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .student-selector {
                margin-bottom: 30px;
            }
        }
        
        .student-tabs { 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 4px; 
        }

        @media (min-width: 768px) {
            .student-tabs {
                gap: 12px;
                flex-wrap: wrap;
                overflow-x: visible;
            }
        }
        
        .student-tab { 
            min-width: 100px; 
            max-width: 140px;
            padding: 12px 16px; 
            background: white; 
            border: 1px solid #E5E5EA; 
            border-radius: 20px; 
            color: #8E8E93; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .student-tab {
                min-width: 120px;
                max-width: 160px;
                padding: 14px 20px;
                font-size: 14px;
            }
        }
        
        .student-tab.active { 
            background: #10A37F; 
            border-color: #10A37F; 
            color: white; 
        }

        .stats-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 16px; 
            margin-bottom: 24px; 
        }

        @media (min-width: 768px) {
            .stats-container {
                gap: 20px;
                margin-bottom: 32px;
            }
        }
        
        .stat-card { 
            background: white; 
            padding: 24px; 
            border-radius: 24px; 
            border: 1px solid #E5E5EA; 
            text-align: center; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); 
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10A37F, #0D7A5F);
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 32px 24px;
            }
        }
        
        .stat-number { 
            font-size: 36px; 
            font-weight: 800; 
            margin-bottom: 8px; 
            background: linear-gradient(135deg, #10A37F, #0D7A5F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (min-width: 768px) {
            .stat-number {
                font-size: 42px;
                margin-bottom: 12px;
            }
        }
        
        .stat-label { 
            font-size: 14px; 
            color: #6B7280; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 16px;
            }
        }
        
        .stat-card.sabak .stat-number { 
            background: linear-gradient(135deg, #10A37F, #0D7A5F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.sabak::before {
            background: linear-gradient(90deg, #10A37F, #0D7A5F);
        }
        
        .stat-card.para .stat-number { 
            background: linear-gradient(135deg, #8E44AD, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.para::before {
            background: linear-gradient(90deg, #8E44AD, #7C3AED);
        }
        
        .stat-card.dhor .stat-number { 
            background: linear-gradient(135deg, #FF9500, #F59E0B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.dhor::before {
            background: linear-gradient(90deg, #FF9500, #F59E0B);
        }

        .section { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .section {
                margin-bottom: 30px;
            }
        }
        
        .section-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 12px; 
            padding-left: 4px; 
        }

        @media (min-width: 768px) {
            .section-title {
                font-size: 22px;
                margin-bottom: 16px;
            }
        }

        .today-progress { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }
        
        .progress-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 18px; 
            border-bottom: 1px solid #F2F2F7; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .progress-row {
                padding: 20px 24px;
            }
        }

        .progress-row.read-only {
            cursor: default;
        }
        
        .progress-row:last-child { 
            border-bottom: none; 
        }
        
        .progress-row:hover:not(.read-only) { 
            background: #F8F9FA; 
        }
        
        .progress-info { 
            display: flex; 
            align-items: center; 
        }
        
        .progress-icon { 
            width: 40px; 
            height: 40px; 
            background: #F2F2F7; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 12px; 
            font-size: 18px; 
        }

        @media (min-width: 768px) {
            .progress-icon {
                width: 50px;
                height: 50px;
                margin-right: 16px;
                font-size: 22px;
            }
        }
        
        .progress-icon.sabak { 
            background: rgba(16, 163, 127, 0.1); 
            color: #10A37F; 
        }
        
        .progress-icon.para { 
            background: rgba(142, 68, 173, 0.1); 
            color: #8E44AD; 
        }
        
        .progress-icon.dhor { 
            background: rgba(255, 149, 0, 0.1); 
            color: #FF9500; 
        }
        
        .progress-details h4 { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 2px; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .progress-details h4 {
                font-size: 18px;
            }
        }
        
        .progress-details p { 
            font-size: 13px; 
            color: #8E8E93; 
        }

        @media (min-width: 768px) {
            .progress-details p {
                font-size: 14px;
            }
        }
        
        .progress-status { 
            display: flex; 
            align-items: center; 
            gap: 6px;
            white-space: nowrap;
        }
        
        .amount-badge { 
            background: #F2F2F7; 
            color: #8E8E93; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
        }

        @media (min-width: 768px) {
            .amount-badge {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
        
        .grade-badge { 
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .grade-badge {
                width: 16px;
                height: 16px;
            }
        }
        
        .grade-badge.excellent { 
            background: #34C759; 
        }
        
        .grade-badge.good { 
            background: #8E44AD; 
        }
        
        .grade-badge.okay { 
            background: #FF9500; 
        }
        
        .grade-badge.poor { 
            background: #FF3B30; 
        }

        .parent-check-button { 
            background: #34C759; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .parent-check-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .parent-check-button.checked { 
            background: #8E8E93; 
        }

        .conversion-badge {
            background: rgba(16, 163, 127, 0.1);
            color: #10A37F;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        @media (min-width: 768px) {
            .conversion-badge {
                font-size: 11px;
                padding: 3px 8px;
            }
        }

        .parent-check-indicator {
            color: #007AFF;
            font-size: 14px;
            font-weight: 600;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-check-indicator {
                font-size: 16px;
            }
        }

        .parent-pending-indicator {
            color: #FF3B30;
            font-size: 12px;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-pending-indicator {
                font-size: 14px;
            }
        }

        .did-not-give-button {
            background: #FF9500;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .did-not-give-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        .did-not-give-button.active {
            background: #8E8E93;
        }

        .did-not-give-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        .today-progress.did-not-give {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Orange indicator for calendar */
        .day-indicators .indicator.did-not-give {
            background: #FF9500;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 2px;
        }

        .absent-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .absent-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .absent-button.active { 
            background: #8E8E93; 
        }

        .absent-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        .today-progress.absent { 
            opacity: 0.5; 
            pointer-events: none; 
        }

        /* Homework Button */
        .homework-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .homework-button:hover {
            background: #2563EB;
        }

        @media (min-width: 768px) {
            .homework-button {
                font-size: 16px;
                padding: 16px 24px;
            }
        }

        /* Message Styles */
        .message-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
            margin-bottom: 12px;
        }

        .message-type-badge.info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .message-type-badge.reminder {
            background: #FED7AA;
            color: #C2410C;
        }

        .message-type-badge.urgent {
            background: #FEE2E2;
            color: #991B1B;
        }

        .message-item {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .message-item.unread {
            border-left: 4px solid #3B82F6;
            background: #F8FAFC;
        }

        .message-item.read {
            opacity: 0.8;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .message-date {
            font-size: 12px;
            color: #8E8E93;
            font-weight: 600;
        }

        .message-content {
            color: #1C1C1E;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .message-review-btn {
            background: #10A37F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-review-btn:hover {
            background: #0D7A5F;
        }

        .message-notification {
            background: #E8F4FD;
            border: 2px solid #3B82F6;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            animation: messageGlow 2s ease-in-out infinite;
        }

        @keyframes messageGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); 
            }
            50% { 
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5); 
            }
        }

        .message-notification-title {
            font-size: 18px;
            font-weight: 600;
            color: #1E40AF;
            margin-bottom: 8px;
        }

        .message-notification-desc {
            font-size: 14px;
            color: #3730A3;
            margin-bottom: 16px;
        }

        /* Message Type Button States */
        .grade-button[data-type] {
            background: #F2F2F7;
            color: #8E8E93;
            transition: all 0.3s ease;
        }

        .grade-button[data-type].selected.info {
            background: #3B82F6;
            color: white;
        }

        .grade-button[data-type].selected.reminder {
            background: #FF9500;
            color: white;
        }

        .grade-button[data-type].selected.urgent {
            background: #FF3B30;
            color: white;
        }

        /* Message Management Styles - Match Homework Theme */
        .message-management-item {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-management-item.hidden {
            display: none;
        }

        .message-info {
            flex: 1;
        }

        .message-student-name {
            font-size: 20px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }

        .message-details {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-type-tag {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .message-type-tag.info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .message-type-tag.reminder {
            background: #FED7AA;
            color: #C2410C;
        }

        .message-type-tag.urgent {
            background: #FEE2E2;
            color: #991B1B;
        }

        .message-due-date {
            font-size: 14px;
            color: #8E8E93;
            font-weight: 500;
        }

        .message-preview {
            font-size: 14px;
            color: #8E8E93;
            margin-top: 4px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .message-status-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .message-status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .message-status-badge.read {
            background: #D1FAE5;
            color: #047857;
        }

        .message-status-badge.unread {
            background: #FEF3C7;
            color: #92400E;
        }

        .message-delete-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-delete-btn:hover {
            background: #D70015;
        }

        .no-messages {
            text-align: center;
            padding: 50px 30px;
            color: #8E8E93;
        }

        .no-messages h3 {
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #1C1C1E;
        }

        .no-messages p {
            color: #8E8E93;
            font-size: 16px;
        }

        /* Calendar styles */
        .calendar-container { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .calendar-container {
                padding: 30px;
            }
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            margin-top: 12px; 
        }

        @media (min-width: 768px) {
            .calendar-grid {
                gap: 8px;
                margin-top: 16px;
            }
        }
        
        .day-header { 
            font-weight: 600; 
            text-align: center; 
            padding: 10px; 
            color: #8E8E93; 
            font-size: 12px; 
        }

        @media (min-width: 768px) {
            .day-header {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #F2F2F7; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            border: 1px solid #E5E5EA; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            position: relative; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .calendar-day {
                border-radius: 12px;
                font-size: 14px;
            }
        }
        
        .calendar-day:hover { 
            background: #E5E5EA; 
        }
        
        .calendar-day.today { 
            border: 2px solid #10A37F; 
            background: #F2F2F7;
            font-weight: 700;
        }
        
        .calendar-day.has-data { 
            background: white; 
            border-color: #10A37F; 
        }

        .calendar-day.holiday {
            background: #FFF3CD !important;
            border-color: #FF9500 !important;
            color: #856404 !important;
        }

        .calendar-day.weekend {
            color: #B8B8B8;
        }
        
        .day-indicators { 
            display: flex; 
            gap: 1px; 
            margin-top: 2px; 
            align-items: center;
        }
        
        .indicator { 
            width: 4px; 
            height: 4px; 
            border-radius: 50%; 
        }

        @media (min-width: 768px) {
            .indicator {
                width: 6px;
                height: 6px;
            }
        }
        
        .indicator.sabak { 
            background: #10A37F; 
        }
        
        .indicator.para { 
            background: #8E44AD; 
        }
        
        .indicator.dhor { 
            background: #FF9500; 
        }

        .indicator.homework {
            background: #3B82F6;
        }

        .parent-check-tick {
            color: #007AFF;
            font-size: 8px;
            font-weight: bold;
            margin-left: 1px;
        }

        @media (min-width: 768px) {
            .parent-check-tick {
                font-size: 10px;
                margin-left: 2px;
            }
        }
        
        .nav-arrow { 
            background: white; 
            border: 1px solid #E5E5EA; 
            color: #10A37F; 
            padding: 10px 14px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .nav-arrow {
                padding: 12px 18px;
                font-size: 18px;
            }
        }
        
        .month-navigation { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 16px; 
            padding: 0 4px; 
        }

        @media (min-width: 768px) {
            .month-navigation {
                margin-bottom: 20px;
            }
        }
        
        .month-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            text-align: center; 
            flex: 1; 
            margin: 0 12px; 
        }

        @media (min-width: 768px) {
            .month-title {
                font-size: 22px;
            }
        }

        /* Modal styles - UPDATED WITH FIXED CLOSE BUTTON */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(5px); 
        }
        
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 0; /* Remove default padding */
            border-radius: 20px; 
            width: 95%; 
            max-width: 600px; 
            position: relative; 
            max-height: 85vh; 
            overflow: hidden; /* Changed from auto to prevent double scroll */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 800px;
                margin: 3% auto;
                width: 90%;
            }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px 25px 20px 25px; 
            border-bottom: 1px solid #F2F2F7; 
            background: white;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 1001;
            border-radius: 20px 20px 0 0;
        }

        @media (min-width: 768px) {
            .modal-header {
                padding: 35px 35px 25px 35px;
            }
        }

        .modal-body {
            padding: 35px 25px 25px 25px;
            max-height: calc(85vh - 100px); /* Adjust based on header height */
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-body {
                padding: 45px 35px 35px 35px;
                max-height: calc(85vh - 120px);
            }
        }
        
        .modal-title { 
            font-size: 24px; 
            font-weight: 700; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .modal-title {
                font-size: 28px;
            }
        }
        
        .close { 
            color: #8E8E93; 
            font-size: 32px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: color 0.3s ease; 
            padding: 8px; 
            line-height: 1; 
            position: relative;
            z-index: 1002;
        }

        @media (min-width: 768px) {
            .close {
                font-size: 36px;
            }
        }

        .close:hover {
            color: #1C1C1E;
        }
        
        .entry-form { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }

        @media (min-width: 768px) {
            .entry-form {
                gap: 30px;
            }
        }
        
        .grade-buttons { 
            display: flex; 
            gap: 12px; 
        }

        @media (min-width: 768px) {
            .grade-buttons {
                gap: 16px;
            }
        }
        
        .grade-button { 
            flex: 1; 
            padding: 12px; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            background: #F2F2F7; 
            color: #8E8E93; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-align: center; 
        }

        @media (min-width: 768px) {
            .grade-button {
                padding: 16px;
                font-size: 16px;
            }
        }
        
        .grade-button.selected { 
            background: #10A37F; 
            /*border-color: #10A37F;*/
            color: white; 
        }
        
        .save-button { 
            background: #10A37F; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease;
            width: 100%;
        }

        @media (min-width: 768px) {
            .save-button {
                padding: 16px;
                font-size: 16px;
            }
        }

        .save-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        .save-button.permanent-delete {
            background: #FF3B30;
            border: 2px solid #DC2626;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
            animation: dangerPulse 2s ease-in-out infinite;
        }

        .save-button.permanent-delete:hover {
            background: #DC2626;
            box-shadow: 0 6px 16px rgba(255, 59, 48, 0.4);
        }

        @keyframes dangerPulse {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3); 
            }
            50% { 
                box-shadow: 0 4px 12px rgba(255, 59, 48, 0.5); 
            }
        }

        @media (min-width: 768px) {
            .save-button {
                padding: 16px;
                font-size: 16px;
            }
        }
        
        .clear-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 15px; 
        }

        @media (min-width: 768px) {
            .clear-button {
                padding: 16px;
                font-size: 16px;
                margin-top: 20px;
            }
        }

        .form-select { 
            width: 100%; 
            padding: 16px 20px; 
            border: 1px solid #E5E5EA; 
            border-radius: 12px; 
            background: #F2F2F7; 
            color: #1C1C1E; 
            font-size: 18px; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .form-select {
                padding: 20px 24px;
                font-size: 20px;
            }
        }
        
        .form-select:focus { 
            outline: none; 
            border-color: #10A37F; 
            background: white; 
        }

        /* Manage Students Modal Styles */
        .manage-tab-button {
            background: #F2F2F7;
            border: 1px solid #E5E5EA;
            color: #8E8E93;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .manage-tab-button.active {
            background: #10A37F;
            border-color: #10A37F;
            color: white;
        }

        .manage-tab-button:hover:not(.active) {
            background: #E5E5EA;
        }

        .manage-section {
            min-height: 300px;
        }

        .access-code-item {
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .access-code-item .access-code-info {
            background: transparent;
            border: none;
        }

        .access-code-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 16px;
        }

        .access-code-info p {
            font-size: 12px;
            color: #8E8E93;
        }

        .access-code-display {
            background: #F2F2F7;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #10A37F;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-button {
            background: #10A37F;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-button:hover {
            background: #0D7A5F;
        }

        .copy-button.copied {
            background: #34C759;
        }

        .no-students-message {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
        }

        /* Recovery Center Styles */
        .recovery-item {
            border: 1px solid #E5E5EA;
            border-left: 4px solid #FF9500;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.3s ease;
            background: #FFFBF0;
        }

        .recovery-item:hover {
            box-shadow: 0 2px 8px rgba(255, 149, 0, 0.15);
        }

        .recovery-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 140px;
        }

        .recovery-restore-btn {
            background: #10A37F;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recovery-restore-btn:hover {
            background: #0D7A5F;
        }

        .recovery-delete-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recovery-delete-btn:hover {
            background: #DC2626;
        }

        .manage-tab-button {
            background: #F2F2F7;
            border: 1px solid #E5E5EA;
            color: #8E8E93;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .manage-tab-button {
                font-size: 11px;
                padding: 8px 10px;
            }
        }

        @media (max-width: 640px) {
            .manage-tab-button {
                font-size: 10px;
                padding: 6px 8px;
            }
        }

        /* UPDATED - Homework Modal Styles to Match App Theme */
        .homework-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .homework-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* UPDATED - Homework checkbox styles to match app theme */
        .homework-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .homework-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #F8F9FA;
        }

        .homework-checkbox:hover {
            background: #F2F2F7;
            border-color: #10A37F;
        }

        .homework-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: #10A37F;
        }

        .homework-checkbox-content {
            flex: 1;
        }

        .homework-checkbox-title {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        .homework-checkbox-desc {
            font-size: 14px;
            color: #8E8E93;
        }

        .homework-description {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 16px;
            resize: vertical;
            margin-top: 12px;
            font-family: inherit;
        }

        .homework-description:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }

        /* UPDATED - Orange homework notification styling */
        .homework-notification {
            background: #FFF4E6; /* Light orange background */
            border: none; /* Dark orange border */
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(234, 88, 12, 0.15); /* Orange shadow */
        }

        .homework-notification-title {
            font-size: 18px;
            font-weight: 600;
            color: #C2410C; /* Dark orange text */
            margin-bottom: 8px;
        }

        .homework-notification-desc {
            font-size: 14px;
            color: #9A3412; /* Medium orange text */
            margin-bottom: 12px;
        }

        .homework-due-date {
            font-size: 12px;
            color: #EA580C; /* Dark orange for due date */
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* UPDATED - Homework management styles with app theme */
        .homework-item {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .homework-item.completed {
            background: #F0FDF4;
            /*border-color: #34C759;*/
        }

        .homework-item.overdue {
            background: #FFF8F0;
            /*border-color: #FFB84D;*/
        }

        .homework-item.did-not-give {
            background: #FEF2F2;
            /*border-color: #FF3B30;*/
        }

        .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .homework-student-name {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 6px;
        }

        .homework-type-badge {
            background: #3B82F6;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .homework-type-badge.sabak {
            background: #10A37F;
        }

        .homework-type-badge.para {
            background: #8E44AD;
        }

        .homework-type-badge.dhor {
            background: #FF9500;
        }

        .homework-details {
            color: #8E8E93;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .homework-description-display {
            background: #F8F9FA;
            padding: 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #1C1C1E;
            margin-bottom: 16px;
            border-left: 4px solid #3B82F6;
        }

        .homework-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* UPDATED - Smaller homework action buttons */
        .homework-toggle {
            background: #34C759;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .homework-toggle.incomplete {
            background: #FF3B30;
        }

        .homework-toggle.did-not-give {
            background: #FF3B30;
        }

        .homework-toggle:hover {
            opacity: 0.8;
        }

        /* UPDATED - Homework status badges to match app theme */
        .homework-status {
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
        }

        .homework-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .homework-status.pending {
            background: #FED7AA;
            color: #C2410C;
        }

        .homework-status.overdue {
            background: #FFE4CC;
            color: #EA580C;
        }

        .homework-status.did-not-give {
            background: #FEE2E2;
            color: #991B1B;
        }

        .homework-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-button {
            background: #F2F2F7;
            border: 1px solid #E5E5EA;
            color: #8E8E93;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-button.active {
            background: #10A37F;
            border-color: #10A37F;
            color: white;
        }

        .no-homework {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
        }

        /* UPDATED - Homework summary to match app theme */
        .homework-summary-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .homework-summary-title {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 16px;
            text-align: center;
        }

        .homework-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .homework-summary-stat {
            text-align: center;
            padding: 16px;
            background: #F8F9FA;
            border-radius: 12px;
            border: 1px solid #E5E5EA;
        }

        .homework-summary-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .homework-summary-label {
            font-size: 12px;
            color: #8E8E93;
            font-weight: 600;
        }

        /* UPDATED - Overall Progress Modal to match app theme */
        .hifz-duration-card {
            background: linear-gradient(135deg, #10A37F, #0D7A5F);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(16, 163, 127, 0.3);
        }

        .hifz-duration-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .hifz-duration-time {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .hifz-duration-date {
            font-size: 12px;
            opacity: 0.8;
        }

        .progress-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .progress-item {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .progress-item.completed {
            border-left: 4px solid #34C759;
        }

        .progress-item.current {
            border-left: 4px solid #3B82F6;
        }

        .progress-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-item-juz {
            font-size: 18px;
            font-weight: 700;
            color: #1C1C1E;
        }

        .progress-item-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .progress-item-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .progress-item-status.current {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .progress-item-details {
            color: #6B7280;
            font-size: 14px;
            line-height: 1.5;
        }

        .progress-item-duration {
            font-weight: 600;
            color: #10A37F;
            margin-top: 8px;
        }

        /* Controls */
        .app-controls { 
            margin: 10px 20px 20px 20px; 
            display: none;
        }

        @media (min-width: 768px) {
            .app-controls {
                margin: 15px 40px 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .app-controls {
                margin: 0;
            }
        }
        
        .controls-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .controls-card {
                padding: 30px;
            }
        }
        
        .controls-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 16px; 
        }

        @media (min-width: 768px) {
            .controls-title {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }
        
        .control-button { 
            width: 100%; 
            padding: 12px; 
            background: #F2F2F7; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            color: #1C1C1E; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 8px; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }

        @media (min-width: 768px) {
            .control-button {
                padding: 16px;
                font-size: 16px;
                margin-bottom: 12px;
            }
        }
        
        .control-button.danger { 
            background: #FF3B30; 
            border-color: #FF3B30; 
            color: white; 
        }
        
        .pdf-export-button { 
            background: linear-gradient(135deg, #10A37F, #0D7A5F) !important; 
            color: white !important; 
            border: none !important; 
        }
        
        .loading-spinner { 
            display: none; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #ffffff; 
            border-top: 2px solid transparent; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 20px; 
            color: #8E8E93; 
            font-size: 12px;
            background: #F2F2F7;
        }

        @media (min-width: 768px) {
            .footer {
                font-size: 14px;
                padding: 30px;
                background: #F2F2F7;
            }
        }
        
        .logout-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 16px auto; 
            display: block; 
        }

        @media (min-width: 768px) {
            .logout-button {
                padding: 16px 32px;
                font-size: 16px;
            }
        }

        .access-code-info {
            background: #E8F4FD;
            border: none;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #1E40AF;
        }

        .access-code-info strong {
            color: #1E40AF;
        }

        @media (min-width: 768px) {
            .access-code-info {
                font-size: 16px;
                padding: 16px;
            }
        }

        /* Holiday list styles */
        .holiday-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .holiday-item {
            background: #F8F9FA;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .holiday-remove-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        /* NEW STYLES FOR JUZ OVERVIEW AND PROGRESS */
        .juz-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .juz-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
        }

        .juz-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .juz-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .juz-card.completed {
            border-color: #34C759;
            background: #F0FDF4;
        }

        .juz-card.current {
            border-color: #3B82F6;
            background: #EFF6FF;
        }

        .juz-number {
            font-size: 24px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 12px;
            text-align: center;
        }

        .juz-status {
            font-size: 12px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 12px;
        }

        .juz-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .juz-status.current {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .juz-status.not-started {
            background: #F3F4F6;
            color: #6B7280;
        }

        .juz-dates {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.4;
        }

        .juz-duration {
            font-size: 16px;
            font-weight: 600;
            color: #10A37F;
            text-align: center;
            margin-top: 8px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .date-input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .date-input-row label {
            min-width: 100px;
            font-size: 14px;
            font-weight: 600;
            color: #6B7280;
        }

        .date-input-row input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            background: #F9FAFB;
            color: #1C1C1E;
            font-size: 14px;
        }

        .date-input-row input:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }

        /* Update modal styles for larger content */
        .large-modal .modal-content {
            max-width: 1000px;
            max-height: 90vh;
        }

        .large-modal .modal-body {
            max-height: calc(90vh - 120px);
        }

        /* Target Status Styles */
        .target-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }
        
        .target-status-badge.above {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .target-status-badge.on {
            background: #DBEAFE;
            color: #1E40AF;
        }
        
        .target-status-badge.below {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        .monthly-target-item {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .monthly-target-header {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .target-textarea {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 12px;
        }
        
        .target-textarea:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }
        
        .target-status-buttons {
            display: flex;
            gap: 8px;
        }
        
        .target-status-button {
            flex: 1;
            padding: 10px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            background: #F2F2F7;
            color: #8E8E93;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .target-status-button.selected {
            border-color: transparent;
        }
        
        .target-status-button.selected.above {
            background: #34C759;
            color: white;
        }
        
        .target-status-button.selected.on {
            background: #007AFF;
            color: white;
        }
        
        .target-status-button.selected.below {
            background: #FF3B30;
            color: white;
        }
        
        .target-view-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .target-view-title {
            font-size: 18px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .target-view-item {
            padding: 16px;
            background: #F8F9FA;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        /* 🔥 ADD THESE NEW COLORED BACKGROUND STYLES 🔥 */
        .target-view-item.above-target {
            background: #F0FDF4;  /* Light green background like completed homework */
            border-left: 4px solid #34C759;
        }

        .target-view-item.on-target {
            background: #EFF6FF;  /* Light blue background */
            border-left: 4px solid #007AFF;
        }

        .target-view-item.below-target {
            background: #FEF2F2;  /* Light red background like did-not-give homework */
            border-left: 4px solid #FF3B30;
        }
        
        .target-view-month {
            font-size: 14px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 8px;
        }
        
        .target-view-text {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.5;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">📖 Hifz Tracker</h1>
            <div class="current-date" id="currentDate">Loading...</div>
            <div class="cloud-status connecting" id="cloudStatus">🔄 Connecting to Cloud...</div>
            <div class="user-info" id="userInfo" style="display: none;"></div>
        </div>

        <!-- Profile Selection -->
        <div class="profile-selection" id="profileSelection">
            <div class="profile-card">
                <h2 class="profile-title">Select Your Profile</h2>
                
                <div class="profile-option" onclick="selectProfile('teacher')" data-profile="teacher">
                    <div class="profile-icon">📖</div>
                    <div class="profile-info">
                        <h3>Ustaadh</h3>
                        <p>Manage students, generate reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('office')" data-profile="office">
                    <div class="profile-icon">🕌</div>
                    <div class="profile-info">
                        <h3>Office</h3>
                        <p>View all students, generate reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('parent')" data-profile="parent">
                    <div class="profile-icon">👨‍👩‍👧‍👦</div>
                    <div class="profile-info">
                        <h3>Parent</h3>
                        <p>View your child's progress</p>
                    </div>
                </div>

                <button class="continue-button" onclick="continueToLogin()" id="continueButton" disabled>
                    Continue
                </button>
            </div>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="login-card">
                <button class="back-button" onclick="goBackToProfiles()">← Back to Profiles</button>
                <h2 class="login-title" id="loginTitle">Login</h2>
                <div class="error-message" id="errorMessage"></div>
                
                <div class="form-group">
                    <label class="form-label" id="accessCodeLabel">Access Code</label>
                    <input type="password" class="form-input" id="accessCode" placeholder="Enter access code">
                </div>

                <button class="login-button" onclick="login()">Login</button>
                
                <!-- Access Code Info -->
                <div class="access-code-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">📝 Need Your Access Code?</div>
                    <div>If you need your access code please contact Ustaadh:</div>
                    <div style="margin-top: 8px;"><strong>sam.dev247@gmail.com</strong></div>
                </div>
            </div>
        </div>

        <!-- Permission Notice -->
        <div class="permission-notice" id="permissionNotice"></div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="main-left">
                <!-- Student Selector -->
                <div class="student-selector">
                    <div class="student-tabs" id="studentTabs"></div>
                </div>

                <!-- Student Name Display -->
                <div class="section" id="studentNameDisplay" style="display: none;">
                    <h2 class="section-title" style="text-align: center; font-size: 20px; color: #10A37F; margin-bottom: 8px;" id="selectedStudentName"></h2>
                </div>

                <!-- Statistics -->
                <div class="section">
                    <h2 class="section-title" id="monthlyProgressTitle">Monthly Progress</h2>
                    <div class="stats-container">
                        <div class="stat-card sabak">
                            <div class="stat-number" id="sabakCount">0</div>
                            <div class="stat-label">Sabak</div>
                        </div>
                        <div class="stat-card para">
                            <div class="stat-number" id="paraCount">0</div>
                            <div class="stat-label">Sabak Para</div>
                        </div>
                        <div class="stat-card dhor">
                            <div class="stat-number" id="dhorCount">0</div>
                            <div class="stat-label">Dhor</div>
                        </div>
                    </div>
                </div>

                <!-- Homework Section (for Parents) -->
                <div class="section" id="homeworkSection" style="display: none;">
                    <div id="homeworkNotification" class="homework-notification">
                        <div class="homework-notification-title">📚 New Homework Assigned</div>
                        <div class="homework-notification-desc" id="homeworkNotificationDesc">You have new homework from your Ustaadh</div>
                        <div class="homework-due-date" id="homeworkDueDate">Due: Tomorrow</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="homework-button" onclick="showViewHomeworkModal()" style="flex: 1; margin-top: 0;">
                                View Homework
                            </button>
                            <button class="homework-button" onclick="showHomeworkSummaryModal()" style="flex: 1; margin-top: 0; background: #8E44AD;">
                                Homework Summary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Today's Progress -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="progressSectionTitle">Today's Progress</h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="absent-button" onclick="toggleAbsent()" id="absentButton" style="display: none;">
                                🔴 Absent
                            </button>
                            <button class="did-not-give-button" onclick="toggleDidNotGive()" id="didNotGiveButton" style="display: none;">
                                🟠 Did Not Give
                            </button>
                        </div>
                    </div>
                    
                    <div class="today-progress" id="todayProgressContainer">
                        <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                            <div class="progress-info">
                                <div class="progress-icon sabak">📖</div>
                                <div class="progress-details">
                                    <h4>Sabak</h4>
                                    <p>New Lesson</p>
                                </div>
                            </div>
                            <div class="progress-status" id="sabakStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                            <div class="progress-info">
                                <div class="progress-icon para">🔄</div>
                                <div class="progress-details">
                                    <h4>Sabak Para</h4>
                                    <p>Previous Lessons</p>
                                </div>
                            </div>
                            <div class="progress-status" id="paraStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                            <div class="progress-info">
                                <div class="progress-icon dhor">💭</div>
                                <div class="progress-details">
                                    <h4>Dhor</h4>
                                    <p>Revision</p>
                                </div>
                            </div>
                            <div class="progress-status" id="dhorStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parent Check Section -->
                <div class="section" id="parentCheckSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="parentCheckTitle">Checked by Parent</h2>
                        <button class="parent-check-button" onclick="toggleParentCheck()" id="parentCheckButton">
                            ✓ Mark as Checked
                        </button>
                    </div>
                    <div style="background: white; border-radius: 16px; padding: 16px; border: 1px solid #E5E5EA; font-size: 14px; color: #8E8E93;" id="parentCheckDescription">
                        Mark when you have reviewed your child's progress for today
                        <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                            <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                            <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-right">
                <!-- Monthly Calendar -->
                <div class="section">
                    <div class="month-navigation">
                        <button class="nav-arrow" onclick="changeMonth(-1)">‹</button>
                        <h3 class="month-title" id="monthTitle">Loading...</h3>
                        <button class="nav-arrow" onclick="changeMonth(1)">›</button>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <!-- App Controls -->
                <div class="app-controls" id="appControls">
                    <div class="controls-card">
                        <h3 class="controls-title" id="controlsTitle">Controls</h3>
                        
                        <!-- Ustaadh Controls -->
                        <div id="teacherControls" style="display: none;">
                            <button class="control-button" onclick="showManageStudentsModal()">🧑‍🧑‍🧒‍🧒 Manage Students</button>
                            <button class="control-button" onclick="showImportDataModal()">📥 Import Student Data</button>
                            <button class="control-button" onclick="showUpdateStudentOverviewModal()">📊 Update Student Overview</button>
                            <button class="control-button" onclick="showStudentTargetsModal()">🎯 Student Targets</button>
                            <button class="control-button" onclick="showAssignHomeworkModal()">📚 Assign Homework</button>
                            <button class="control-button" onclick="showViewAllHomeworkModal()">📋 View All Homework</button>
                            <button class="control-button" onclick="showSendMessageModal()">💬 Send Message to Parent</button>
                            <button class="control-button" onclick="showManageMessagesModal()">📬 Manage Messages</button>
                            <button class="control-button" onclick="showHolidayModal()">🗓️ Manage Holidays</button>
                            <button class="control-button" onclick="showAcademicYearModal()">📅 Set Academic Year</button>
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="pdfSpinner"></div>
                                <span id="pdfBtnText">📄 Export Student PDF</span>
                            </button>
                            <button class="control-button danger" onclick="showResetModal()">🗑️ Reset All Data</button>
                        </div>

                        <!-- Office Controls -->
                        <div id="officeControls" style="display: none;">
                            <button class="control-button" onclick="showOverallProgressModal()">📈 Overall Progress</button>
                            <button class="control-button" onclick="showOfficeTargetsModal()">🎯 Student Targets</button>
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="officePdfSpinner"></div>
                                <span id="officePdfBtnText">📄 Export Student PDF</span>
                            </button>
                        </div>

                        <!-- Parent Controls -->
                        <div id="parentControls" style="display: none;">
                            <button class="control-button" onclick="showHomeworkSummaryModal()">📊 Homework Summary</button>
                            <button class="control-button" onclick="showOverallProgressModal()">📈 Overall Progress</button>
                            <button class="control-button" onclick="showViewTargetsModal()">🎯 View Targets</button>
                            <button class="control-button" onclick="showParentMessagesHistory()">📬 View Messages</button>
                        </div>

                        <button class="logout-button" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p id="footerText">Secure Cloud connection - Choose your access level above</p>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Enter Progress</h2>
                <span class="close" onclick="closeModal('progressModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group" id="linesInputGroup">
                        <label class="form-label">Lines (will auto-convert to pages & Juz)</label>
                        <input type="number" class="form-input" id="linesInput" placeholder="e.g., 26 lines" min="1">
                        <div id="conversionDisplay" style="margin-top: 8px; font-size: 12px; color: #10A37F;"></div>
                    </div>
                    <div class="form-group" id="amountInputGroup" style="display: none;">
                        <label class="form-label">Amount/Pages</label>
                        <input type="text" class="form-input" id="amountInput" placeholder="e.g., 5 lines, 1 page">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade</label>
                        <div class="grade-buttons">
                            <div class="grade-button" data-grade="excellent" onclick="selectGrade('excellent')">Excellent</div>
                            <div class="grade-button" data-grade="good" onclick="selectGrade('good')">Good</div>
                            <div class="grade-button" data-grade="okay" onclick="selectGrade('okay')">Okay</div>
                            <div class="grade-button" data-grade="poor" onclick="selectGrade('poor')">Poor</div>
                        </div>
                    </div>
                    <button class="save-button" onclick="saveProgress()">Save Progress</button>
                    <button class="clear-button" onclick="clearProgress()">Clear Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Students Modal -->
    <div id="manageStudentsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">🧑‍🧑‍🧒‍🧒 Manage Students</h2>
                <span class="close" onclick="closeModal('manageStudentsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid #E5E5EA; padding-bottom: 16px; flex-wrap: wrap;">
                    <button class="manage-tab-button active" onclick="switchManageTab('remove')" id="removeTab">➖ Remove</button>
                    <button class="manage-tab-button" onclick="switchManageTab('recovery')" id="recoveryTab">🔄 Recover</button>
                    <button class="manage-tab-button" onclick="switchManageTab('codes')" id="codesTab">🔑 View AC</button>
                </div>

                <!-- Remove Student Section -->
                <div id="removeStudentSection" class="manage-section" style="display: none;">
                    <div class="homework-section">
                        <div class="homework-section-title">
                            ➖ Remove Student
                        </div>
                        <div class="entry-form">
                            <div class="form-group">
                                <label class="form-label">Select Student to Remove</label>
                                <select class="form-select" id="removeStudentSelect">
                                    <option value="">Choose student to remove</option>
                                </select>
                            </div>
                            
                            <!-- Remove from active list option -->
                            <div style="background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 12px; color: #856404;">
                                ⚠️ <strong>Soft Remove:</strong> This will remove from active student list but keep all data in Firebase for future recovery.
                            </div>
                            <button class="save-button" style="background: #FF9500; margin-bottom: 16px;" onclick="removeStudent()">Remove from Active List</button>
                            
                            <!-- Permanent delete option -->
                            <div style="background: #FEF2F2; border: 2px solid #FF3B30; border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 12px; color: #991B1B;">
                                🚨 <strong>PERMANENT DELETE:</strong> This will completely remove ALL student data from Firebase forever. This action CANNOT be undone!
                                <div style="margin-top: 8px; font-weight: 600;">This will delete:</div>
                                <ul style="margin: 4px 0 0 20px; font-size: 11px;">
                                    <li>All daily progress records</li>
                                    <li>All Juz progress data</li>
                                    <li>All homework assignments</li>
                                    <li>Student profile information</li>
                                    <li>Parent access code</li>
                                </ul>
                            </div>
                            <button class="save-button permanent-delete" onclick="permanentlyDeleteStudent()">🗑️ PERMANENTLY DELETE</button>
                        </div>
                    </div>
                </div>

                <!-- Recovery Center Section -->
                <div id="recoverySection" class="manage-section" style="display: none;">
                    <div class="homework-section">
                        <div class="homework-section-title">
                            🔄 Recovery Center
                        </div>
                        <div style="background: #E8F4FD; border: none; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center; font-size: 14px; color: #1E40AF;">
                            <strong>📂 Soft-removed students are stored here</strong><br>
                            These students were removed from active list but their data is preserved in Firebase
                        </div>
                        <div id="softRemovedStudentsList">
                            <!-- Soft-removed students will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- View Access Codes Section -->
                <div id="accessCodesSection" class="manage-section" style="display: none;">
                    <div class="homework-section">
                        <div class="homework-section-title">
                            🔑 Student Access Codes
                        </div>
                        <div style="background: #E8F4FD; border: none; border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center; font-size: 14px; color: #1E40AF;">
                            <strong>📱 Share these codes with parents so they can access their child's progress</strong>
                        </div>
                        <div id="accessCodesList">
                            <!-- Access codes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Student Overview Modal -->
    <div id="updateStudentOverviewModal" class="modal large-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Update Student Overview</h2>
                <span class="close" onclick="closeModal('updateStudentOverviewModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="overviewStudentSelect">
                            <option value="">Choose student</option>
                        </select>
                    </div>
                    
                    <div id="overviewForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Hifz Start Date</label>
                            <input type="date" class="form-input" id="hifzStartDate">
                        </div>
                        
                        <h3 style="margin: 30px 0 20px 0; font-size: 20px; font-weight: 600; color: #1C1C1E;">Juz Progress (1-30)</h3>
                        
                        <div id="juzProgressContainer">
                            <!-- Juz cards will be generated here -->
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="save-button" onclick="saveStudentOverview()">Save Overview</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Progress Modal (Parents & Office) -->
    <div id="overallProgressModal" class="modal large-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Overall Progress</h2>
                <span class="close" onclick="closeModal('overallProgressModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="overallProgressContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Homework Modal -->
    <div id="assignHomeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📚 Assign Homework</h2>
                <span class="close" onclick="closeModal('assignHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="homework-section">
                    <div class="homework-section-title">
                        📝 Homework Details
                    </div>
                    <div class="entry-form">
                        <div class="form-group">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" id="homeworkStudentSelect">
                                <option value="">Choose student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Homework Type</label>
                            <select class="form-select" id="homeworkTypeSelect">
                                <option value="">Select homework type</option>
                                <option value="sabak">Sabak - New Lessons</option>
                                <option value="para">Sabak Para - Previous Lessons</option>
                                <option value="dhor">Dhor - Revision</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-input" id="homeworkDueDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="homework-description" id="homeworkDescriptionInput" placeholder="Enter homework details and instructions..."></textarea>
                        </div>
                        <button class="save-button" onclick="assignHomework()">Assign Homework</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View All Homework Modal (Teacher) -->
    <div id="viewAllHomeworkModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">📋 All Homework Assignments</h2>
                <span class="close" onclick="closeModal('viewAllHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="allHomeworkContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- View Homework Modal (Parent) -->
    <div id="viewHomeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📚 Your Homework</h2>
                <span class="close" onclick="closeModal('viewHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="homeworkContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Homework Summary Modal (Parent) -->
    <div id="homeworkSummaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📊 Homework Summary</h2>
                <span class="close" onclick="closeModal('homeworkSummaryModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="homeworkSummaryContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Send Message Modal -->
    <div id="sendMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💬 Send Message to Parent</h2>
                <span class="close" onclick="closeModal('sendMessageModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="homework-section">
                    <div class="homework-section-title">
                        📝 Message Details
                    </div>
                    <div class="entry-form">
                        <div class="form-group">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" id="messageStudentSelect">
                                <option value="">Choose student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message Type</label>
                            <div class="grade-buttons" style="gap: 8px;">
                                <div class="grade-button" data-type="info" onclick="selectMessageType('info')">ℹ️ Info</div>
                                <div class="grade-button" data-type="reminder" onclick="selectMessageType('reminder')">⏰ Reminder</div>
                                <div class="grade-button" data-type="urgent" onclick="selectMessageType('urgent')">🚨 Urgent</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <textarea class="homework-description" id="messageContent" 
                                    placeholder="Enter your message to the parent..."></textarea>
                        </div>
                        <button class="save-button" onclick="sendMessage()">Send Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parent Message Modal -->
    <div id="parentMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">💬 New Message from Ustaadh</h2>
                <span class="close" onclick="closeModal('parentMessageModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="parentMessageContent">
                    <!-- Message content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Parent Messages History Modal -->
    <div id="parentMessagesHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📬 All Messages</h2>
                <span class="close" onclick="closeModal('parentMessagesHistoryModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="parentMessagesHistoryContent">
                    <!-- Messages history will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Message Management Modal -->
    <div id="manageMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📬 Message Management</h2>
                <span class="close" onclick="closeModal('manageMessagesModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="allMessagesContent">
                    <!-- Messages will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Holiday Modal -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Holidays</h2>
                <span class="close" onclick="closeModal('holidayModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Holiday Name</label>
                        <input type="text" class="form-input" id="holidayName" placeholder="e.g., Eid al-Fitr">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="holidayStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="holidayEndDate">
                    </div>
                    <button class="save-button" onclick="addHoliday()">Add Holiday</button>
                    
                    <div id="holidayList" class="holiday-list">
                        <!-- Holiday list will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Targets Modal -->
    <div id="studentTargetsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">🎯 Student Targets</h2>
                <span class="close" onclick="closeModal('studentTargetsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Academic Year</label>
                        <select class="form-select" id="targetYearSelect" onchange="loadTargetYearOptions()">
                            <option value="">Choose academic year</option>
                            <option value="2024-2025">2024-2025</option>
                            <option value="2025-2026">2025-2026</option>
                            <option value="2026-2027">2026-2027</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="targetStudentGroup" style="display: none;">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="targetStudentSelect" onchange="loadStudentTargets()">
                            <option value="">Choose student</option>
                        </select>
                    </div>
                    
                    <div id="targetFormSection" style="display: none;">
                        <!-- Yearly Target Section -->
                        <div class="homework-section" style="margin-bottom: 30px;">
                            <div class="homework-section-title">
                                📅 <span id="yearlyTargetTitle">Yearly Target</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yearly Target Description</label>
                                <textarea class="homework-description" id="yearlyTargetText" 
                                        placeholder="Enter yearly target for this student..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yearly Target Status</label>
                                <div class="grade-buttons">
                                    <div class="grade-button" data-status="above" onclick="selectTargetStatus('yearly', 'above')" 
                                        style="background: #34C759; color: white;">Above Target</div>
                                    <div class="grade-button" data-status="on" onclick="selectTargetStatus('yearly', 'on')" 
                                        style="background: #007AFF; color: white;">On Target</div>
                                    <div class="grade-button" data-status="below" onclick="selectTargetStatus('yearly', 'below')" 
                                        style="background: #FF3B30; color: white;">Below Target</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Targets Section -->
                        <div class="homework-section">
                            <div class="homework-section-title">
                                📆 Monthly Targets
                            </div>
                            <div id="monthlyTargetsContainer">
                                <!-- Monthly target fields will be generated here -->
                            </div>
                        </div>
                        
                        <button class="save-button" onclick="saveStudentTargets()" style="margin-top: 30px;">
                            💾 Save All Targets
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Targets Modal (Parent) -->
    <div id="viewTargetsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">🎯 Student Targets</h2>
                <span class="close" onclick="closeModal('viewTargetsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="viewTargetsContent">
                    <!-- Targets will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="importDataModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">📥 Import Student Data</h2>
                <span class="close" onclick="closeModal('importDataModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="homework-section">
                    <div class="homework-section-title">
                        📊 Upload Sabak Data
                    </div>
                    
                    <div style="background: #e8f4fd; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <strong>📝 Expected Format:</strong><br>
                        • CSV or Excel files (.csv, .xlsx, .xls)<br>
                        • Columns: Student Name, Date, Sabak, Grade, Absent<br><br>
                        <strong>📋 Example:</strong><br>
                        <code>Rayhan Rahman, 2024-09-03, 14 Lines, excellent, no</code>
                    </div>
                    
                    <div class="entry-form">
                        <div class="form-group">
                            <label class="form-label">Select Student for Import</label>
                            <select class="form-select" id="importStudentSelect">
                                <option value="">Choose student to import data for</option>
                            </select>
                        </div>
                    
                        <div class="form-group">
                            <label class="form-label">Select File to Import</label>
                            <input type="file" class="form-input" id="importFile" 
                                   accept=".xlsx,.xls,.csv" 
                                   onchange="handleFileSelection()">
                        </div>
                        
                        <div id="filePreview" style="display: none;">
                            <div class="homework-section-title">
                                📋 File Preview
                            </div>
                            <div id="previewContent" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 15px;">
                                <!-- Preview content will be loaded here -->
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Import Options</label>
                                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; gap: 6px;">
                                            <input type="checkbox" id="skipDuplicates" checked>
                                            <span style="font-size: 14px;">Skip duplicate entries</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="save-button" onclick="processImportData()" id="importButton">
                                📥 Import Data
                            </button>
                        </div>
                        
                        <div id="importProgress" style="display: none;">
                            <div style="background: #e8f4fd; border-radius: 8px; padding: 16px; text-align: center;">
                                <div class="loading-spinner" style="display: inline-block; margin-right: 10px;"></div>
                                <span id="importProgressText">Processing data...</span>
                            </div>
                        </div>
                        
                        <div id="importResults" style="display: none;">
                            <div class="homework-section-title">
                                ✅ Import Results
                            </div>
                            <div id="resultsContent">
                                <!-- Results will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Academic Year Modal -->
        <div id="academicYearModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">📅 Set Academic Year</h2>
                    <span class="close" onclick="closeModal('academicYearModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="homework-section">
                        <div class="homework-section-title">
                            🎓 Choose Active Academic Year
                        </div>
                        <div class="entry-form">
                            <div class="form-group">
                                <label class="form-label">Academic Year (September - August)</label>
                                <select class="form-select" id="academicYearSelect">
                                    <option value="2024-2025">September 2024 - August 2025</option>
                                    <option value="2025-2026">September 2025 - August 2026</option>
                                    <option value="2026-2027">September 2026 - August 2027</option>
                                    <option value="2027-2028">September 2027 - August 2028</option>
                                </select>
                            </div>
                            <div style="background: #E8F4FD; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                                <strong>📢 Important:</strong> This sets what academic year Parents and Office users can see. They will only have access to data from the selected academic year.
                            </div>
                            <button class="save-button" onclick="saveAcademicYear()">Save Academic Year</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Day Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dayModalTitle">Day Progress</h2>
                <span class="close" onclick="closeModal('dayModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="dayProgressList"></div>
                
                <!-- Legend for colored dots -->
                <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 12px; border-top: 1px solid #E5E5EA;">
                    <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 12px; text-align: center;">Progress Indicators</div>
                    <div style="display: flex; justify-content: center; gap: 20px; font-size: 11px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #34C759; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Excellent</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #8E44AD; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Good</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #FF9500; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Okay</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #FF3B30; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Poor</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="exportPDFModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export Student PDF Report</h2>
                <span class="close" onclick="closeModal('exportPDFModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="pdfStudentSelect">
                            <option value="">Choose student for PDF report</option>
                            <option value="all">All Students (Combined Report)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" id="pdfReportType">
                            <option value="current-month">Current Month Progress</option>
                            <option value="yearly-summary">Yearly Summary</option>
                            <option value="monthly-detailed">Monthly Detailed</option>
                            <option value="overall-progress">Overall Progress</option>
                        </select>
                    </div>
                    <div class="form-group" id="monthYearPicker" style="display: none;">
                        <label class="form-label">Select Month & Year</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-select" id="monthSelect" style="flex: 1;">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select class="form-select" id="yearSelect" style="flex: 1;">
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="academicYearPicker" style="display: none;">
                        <label class="form-label">Select Academic Year</label>
                        <select class="form-select" id="academicYearSelect">
                            <option value="2024-2025">2024-2025</option>
                            <option value="2025-2026">2025-2026</option>
                            <option value="2026-2027">2026-2027</option>
                        </select>
                    </div>
                    <button class="save-button pdf-export-button" onclick="generateSelectedPDF()" id="generatePDFBtn">
                        <div class="loading-spinner" id="modalPdfSpinner"></div>
                        <span id="modalPdfBtnText">📄 Generate PDF Report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUserType = null; // 'teacher', 'office', 'parent'
        let currentUser = null; // Firebase user object
        let currentStudent = null;
        let currentProgressType = null;
        let currentDate = null;
        let currentDisplayMonth = new Date().getMonth() + 1;
        let currentDisplayYear = new Date().getFullYear();
        let selectedGrade = null;
        let selectedProfile = null;
        let studentUnsubscribes = []; // For Firebase listeners

        // Access codes
        const teacherCode = 'P455word';
        const officeCode = 'sjoffice25';

        // FIXED: Dynamic student access codes mapping - will be loaded from Firebase
        let studentAccessCodes = {};

        const progressTypes = ['sabak', 'para', 'dhor'];

        // Manage Students Modal Functions
        function showManageStudentsModal() {
            if (currentUserType !== 'teacher') return;
            
            // Reset to remove tab (first available tab)
            switchManageTab('remove');
            
            document.getElementById('manageStudentsModal').style.display = 'block';
        }

        function switchManageTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.manage-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName === 'remove' ? 'removeTab' : tabName === 'recovery' ? 'recoveryTab' : 'codesTab').classList.add('active');
            
            // Show/hide sections
            document.getElementById('removeStudentSection').style.display = tabName === 'remove' ? 'block' : 'none';
            document.getElementById('recoverySection').style.display = tabName === 'recovery' ? 'block' : 'none';
            document.getElementById('accessCodesSection').style.display = tabName === 'codes' ? 'block' : 'none';
            
            // Load data for specific tabs
            if (tabName === 'remove') {
                loadRemoveStudentDropdown();
            } else if (tabName === 'recovery') {
                loadSoftRemovedStudents();
            } else if (tabName === 'codes') {
                loadAccessCodes();
            }
        }

        async function loadRemoveStudentDropdown() {
            try {
                const students = await window.getStudents();
                const select = document.getElementById('removeStudentSelect');
                select.innerHTML = '<option value="">Choose student to remove</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading students for removal:', error);
            }
        }

        async function loadAccessCodes() {
            try {
                const students = await window.getStudents();
                const accessCodesList = document.getElementById('accessCodesList');
                
                if (students.length === 0) {
                    accessCodesList.innerHTML = `
                        <div class="no-students-message">
                            <div style="font-size: 48px; margin-bottom: 16px;">👥</div>
                            <h3 style="font-size: 18px; margin-bottom: 8px;">No Students Found</h3>
                            <p>Add students first to generate access codes.</p>
                        </div>
                    `;
                    return;
                }
                
                accessCodesList.innerHTML = '';
                
                students.forEach(student => {
                    const accessCodeItem = document.createElement('div');
                    accessCodeItem.className = 'access-code-item';
                    
                    accessCodeItem.innerHTML = `
                        <div class="access-code-info">
                            <h3>${student.name}</h3>
                        </div>
                        <div class="access-code-display">
                            <span>${student.accessCode}</span>
                            <button class="copy-button" onclick="copyAccessCode('${student.accessCode}', this)">
                                Copy
                            </button>
                        </div>
                    `;
                    
                    accessCodesList.appendChild(accessCodeItem);
                });
            } catch (error) {
                console.error('Error loading access codes:', error);
                document.getElementById('accessCodesList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #FF3B30;">
                        <p>Error loading access codes. Please try again.</p>
                    </div>
                `;
            }
        }

        function copyAccessCode(accessCode, buttonElement) {
            // Copy to clipboard
            navigator.clipboard.writeText(accessCode).then(() => {
                // Update button text and style temporarily
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy access code:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = accessCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = 'Copy';
                    buttonElement.classList.remove('copied');
                }, 2000);
            });
        }

        // Conversion functions
        function convertLinesToPagesAndJuz(lines, quranType) {
            if (!lines || lines <= 0) return { pages: 0, juz: 0, fraction: '' };
            
            const linesPerPage = quranType;
            const pagesPerJuz = quranType === 13 ? 26 : 20;
            
            const pages = lines / linesPerPage;
            const juz = pages / pagesPerJuz;
            
            let fraction = '';
            if (juz >= 1) {
                const wholeJuz = Math.floor(juz);
                const remainingJuz = juz - wholeJuz;
                if (remainingJuz >= 0.875) {
                    fraction = `${wholeJuz + 1} Juz`;
                } else if (remainingJuz >= 0.625) {
                    fraction = `${wholeJuz} & 3/4 Juz`;
                } else if (remainingJuz >= 0.375) {
                    fraction = `${wholeJuz} & 1/2 Juz`;
                } else if (remainingJuz >= 0.125) {
                    fraction = `${wholeJuz} & 1/4 Juz`;
                } else {
                    fraction = `${wholeJuz} Juz`;
                }
            } else if (juz >= 0.875) {
                fraction = '1 Juz';
            } else if (juz >= 0.625) {
                fraction = '3/4 Juz';
            } else if (juz >= 0.375) {
                fraction = '1/2 Juz';
            } else if (juz >= 0.125) {
                fraction = '1/4 Juz';
            } else {
                fraction = `${Math.round(pages * 100) / 100} pages`;
            }
            
            return {
                pages: Math.round(pages * 100) / 100,
                juz: Math.round(juz * 1000) / 1000,
                fraction: fraction
            };
        }

        // Add this new function right after the convertLinesToPagesAndJuz function
        function convertJuzToFraction(juzDecimal) {
            if (!juzDecimal || juzDecimal <= 0) return '0 Juz';
            
            const wholeJuz = Math.floor(juzDecimal);
            const fractionalPart = juzDecimal - wholeJuz;
            
            // Round UP to nearest quarter
            let fraction = '';
            if (fractionalPart < 0.125) {
                fraction = '0';
            } else if (fractionalPart < 0.375) {
                fraction = '1/4';
            } else if (fractionalPart < 0.625) {
                fraction = '1/2';
            } else if (fractionalPart < 0.875) {
                fraction = '3/4';
            } else {
                // Round up to next whole Juz
                return `${wholeJuz + 1} Juz`;
            }
            
            if (wholeJuz === 0) {
                return fraction === '0' ? '0 Juz' : `${fraction} Juz`;
            } else {
                return fraction === '0' ? `${wholeJuz} Juz` : `${wholeJuz} & ${fraction} Juz`;
            }
        }

        function updateConversionDisplay() {
            const linesInput = document.getElementById('linesInput');
            const conversionDisplay = document.getElementById('conversionDisplay');
            const lines = parseInt(linesInput.value) || 0;
            
            if (lines > 0 && currentStudent) {
                window.getStudents().then(students => {
                    const student = students.find(s => s.id === currentStudent);
                    const quranType = student ? student.quranType || 13 : 13;
                    
                    const conversion = convertLinesToPagesAndJuz(lines, quranType);
                    conversionDisplay.innerHTML = `📊 ${lines} lines = ${conversion.pages} pages = ${conversion.fraction}`;
                    conversionDisplay.style.display = 'block';
                });
            } else {
                conversionDisplay.style.display = 'none';
            }
        }

        // Overdue check with 8PM cutoff
        function isHomeworkOverdue(dueDate) {
            const now = new Date();
            const dueDateObj = new Date(dueDate);
            
            // Set due date to 8 PM (20:00) on the due date
            dueDateObj.setHours(20, 0, 0, 0);
            
            return now > dueDateObj;
        }

        // Initialize app
        function init() {
            updateCurrentDate();
            initializeFirebaseConnection();
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        async function initializeFirebaseConnection() {
            try {
                // Check if Firebase modules are loaded
                if (!window.firebase || !window.firebaseModules) {
                    throw new Error('Firebase modules not loaded. Please refresh the page.');
                }
                
                // Set up auth state listener
                const { onAuthStateChanged } = window.firebaseModules;
                const { auth } = window.firebase;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        // For authenticated users, show main interface directly
                        if (currentUserType && currentStudent) {
                            showMainInterface();
                        }
                    } else {
                        currentUser = null;
                        showProfileSelection();
                    }
                });
                
                // Initialize default data if needed - this will clear old data and add fresh students
                await initializeDefaultData();
                
                // Update status to connected
                updateCloudStatus('connected', '✅ Cloud Sync Ready');
                
                // Show profile selection by default
                showProfileSelection();
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                updateCloudStatus('disconnected', '❌ Connection failed');
                showError('Firebase initialization failed: ' + error.message);
            }
        }

        function updateCloudStatus(status, message) {
            const cloudStatus = document.getElementById('cloudStatus');
            cloudStatus.className = `cloud-status ${status}`;
            cloudStatus.textContent = message;
        }

        async function initializeDefaultData() {
            try {
                // Load students from CSV and build access codes
                const students = await window.getStudents();
                studentAccessCodes = {};
                
                students.forEach(student => {
                    if (student.accessCode) {
                        studentAccessCodes[student.accessCode] = {
                            studentId: student.id,
                            studentName: student.name
                        };
                    }
                });
                
                console.log(`Loaded ${students.length} students from CSV`);
                console.log(`Built ${Object.keys(studentAccessCodes).length} access codes`);
                
            } catch (error) {
                console.error('Error loading CSV data:', error);
            }
        }

        async function buildStudentAccessCodes() {
            try {
                const students = await window.getStudents();
                studentAccessCodes = {};
                
                students.forEach(student => {
                    if (student.accessCode) {
                        studentAccessCodes[student.accessCode.toLowerCase()] = {
                            studentId: student.id,
                            studentName: student.name
                        };
                    }
                });
                
                console.log(`Built ${Object.keys(studentAccessCodes).length} access codes`);
                
            } catch (error) {
                console.error('Error building student access codes:', error);
                throw error;
            }
        }

        function showProfileSelection() {
            document.getElementById('profileSelection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('appControls').style.display = 'none';
            document.getElementById('permissionNotice').style.display = 'none';
        }

        function selectProfile(profileType) {
            selectedProfile = profileType;
            
            // Remove selected class from all options
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelector(`[data-profile="${profileType}"]`).classList.add('selected');
            
            // Enable continue button
            document.getElementById('continueButton').disabled = false;
        }

        function continueToLogin() {
            if (!selectedProfile) return;
            
            currentUserType = selectedProfile;
            
            document.getElementById('profileSelection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Update login form based on profile
            const loginTitle = document.getElementById('loginTitle');
            const accessCodeLabel = document.getElementById('accessCodeLabel');
            const accessCodeInput = document.getElementById('accessCode');
            
            switch(selectedProfile) {
                case 'teacher':
                    loginTitle.textContent = '📖 Ustaadh Login';
                    accessCodeLabel.textContent = 'Ustaadh Access Code';
                    accessCodeInput.placeholder = 'Enter Ustaadh access code';
                    break;
                case 'office':
                    loginTitle.textContent = '🕌 Office Login';
                    accessCodeLabel.textContent = 'Office Access Code';
                    accessCodeInput.placeholder = 'Enter office access code';
                    break;
                case 'parent':
                    loginTitle.textContent = '👨‍👩‍👧‍👦 Parent Login';
                    accessCodeLabel.textContent = 'Student Access Code';
                    accessCodeInput.placeholder = 'Enter your child\'s access code';
                    break;
            }
            
            accessCodeInput.value = '';
        }

        function goBackToProfiles() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('profileSelection').style.display = 'block';
            selectedProfile = null;
            currentUserType = null;
            document.getElementById('continueButton').disabled = true;
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        async function login() {
            const accessCode = document.getElementById('accessCode').value.trim();
            
            if (!accessCode) {
                showError('Please enter the access code');
                return;
            }

            // Show loading state
            const loginButton = document.querySelector('.login-button');
            const originalText = loginButton.textContent;
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;

            let loginSuccess = false;
            let foundStudent = null;

            try {
                switch(currentUserType) {
                    case 'teacher':
                        if (accessCode === teacherCode) {
                            loginSuccess = true;
                        }
                        break;
                    case 'office':
                        if (accessCode === officeCode) {
                            loginSuccess = true;
                        }
                        break;
                    case 'parent':
                        // ENHANCED: Multiple attempts to build access codes for parent login
                        console.log('Parent login attempt with code:', accessCode.toLowerCase());
                        
                        let attempts = 0;
                        const maxAttempts = 3;
                        
                        while (attempts < maxAttempts && !loginSuccess) {
                            attempts++;
                            console.log(`Access code build attempt ${attempts}/${maxAttempts}`);
                            
                            try {
                                // Force rebuild access codes
                                await buildStudentAccessCodes();
                                console.log('Access codes after rebuild:', Object.keys(studentAccessCodes));
                                
                                // Check if any codes were loaded
                                if (Object.keys(studentAccessCodes).length === 0) {
                                    console.warn('No access codes loaded, retrying...');
                                    if (attempts < maxAttempts) {
                                        // Wait before retry
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                        continue;
                                    }
                                }
                                
                                const studentInfo = studentAccessCodes[accessCode.toLowerCase()];
                                if (studentInfo) {
                                    loginSuccess = true;
                                    currentStudent = studentInfo.studentId;
                                    console.log('Parent login successful for student:', studentInfo.studentName);
                                    break;
                                } else {
                                    console.log('Access code not found in loaded codes');
                                    console.log('Available codes:', Object.keys(studentAccessCodes));
                                    console.log('Looking for:', accessCode.toLowerCase());
                                    
                                    // Try direct Firebase query as fallback
                                    console.log('Attempting direct Firebase fallback...');
                                    const students = await window.getStudents();
                                    const directMatch = students.find(s => 
                                        s.accessCode && s.accessCode.toLowerCase().trim() === accessCode.toLowerCase().trim()
                                    );
                                    
                                    if (directMatch) {
                                        console.log('Found student via direct Firebase query:', directMatch.name);
                                        loginSuccess = true;
                                        currentStudent = directMatch.id;
                                        
                                        // Update access codes with found student
                                        studentAccessCodes[accessCode.toLowerCase()] = {
                                            studentId: directMatch.id,
                                            studentName: directMatch.name
                                        };
                                        break;
                                    }
                                }
                                
                            } catch (error) {
                                console.error(`Access code build attempt ${attempts} failed:`, error);
                                if (attempts >= maxAttempts) {
                                    throw error;
                                }
                                // Wait before retry
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        break;
                }

                if (loginSuccess) {
                    // Sign in to Firebase anonymously for demo
                    try {
                        const { signInWithEmailAndPassword } = window.firebaseModules;
                        const { auth } = window.firebase;
                        
                        // Use dummy account for demo (you can create these in Firebase Console)
                        const email = `${currentUserType}@hifz.com`;
                        const password = `${currentUserType}123`;
                        
                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                        } catch (authError) {
                            // If account doesn't exist, continue without Firebase auth for demo
                            console.log('Auth account not found, continuing with local auth');
                        }
                        
                        showMainInterface();
                    } catch (error) {
                        console.error('Login error:', error);
                        showMainInterface(); // Continue anyway for demo
                    }
                } else {
                    let errorMsg;
                    if (currentUserType === 'parent') {
                        errorMsg = `Invalid student access code: "${accessCode}"`;
                        
                        // Enhanced diagnostic info
                        const totalCodes = Object.keys(studentAccessCodes).length;
                        if (totalCodes === 0) {
                            errorMsg += '\n\nNo access codes loaded. Please contact the teacher.';
                            console.error('DIAGNOSTIC: No access codes in memory');
                        } else {
                            errorMsg += `\n\nAccess code not found. ${totalCodes} codes are loaded.`;
                            console.error('DIAGNOSTIC: Access codes loaded but code not found');
                            console.error('Available codes:', Object.keys(studentAccessCodes));
                        }
                    } else {
                        errorMsg = `Invalid ${currentUserType} access code`;
                    }
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Login process failed:', error);
                showError('Login failed: ' + error.message);
            } finally {
                // Reset button state
                loginButton.textContent = originalText;
                loginButton.disabled = false;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showMainInterface() {
            // Always start on current month when showing main interface
            currentDisplayMonth = new Date().getMonth() + 1;
            currentDisplayYear = new Date().getFullYear();

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('appControls').style.display = 'block';
            
            // Update UI based on user type
            updateUIForUserType();
            updateUserInfo();
            loadStudentsAndInitialize();
        }

        // ===== UPDATE: updateUIForUserType Function =====
        // FIND this function and UPDATE the teacher case:

        function updateUIForUserType() {
            const container = document.querySelector('.container');
            const absentButton = document.getElementById('absentButton');
            const didNotGiveButton = document.getElementById('didNotGiveButton'); // ADD THIS LINE
            const teacherControls = document.getElementById('teacherControls');
            const officeControls = document.getElementById('officeControls');
            const parentControls = document.getElementById('parentControls');
            const controlsTitle = document.getElementById('controlsTitle');
            
            // Reset classes
            container.classList.remove('parent-mode');
            
            // Update progress rows
            const progressRows = document.querySelectorAll('.progress-row');
            progressRows.forEach(row => {
                row.classList.remove('read-only');
            });
            
            switch(currentUserType) {
                case 'teacher':
                    absentButton.style.display = 'inline-block';
                    didNotGiveButton.style.display = 'inline-block'; // ADD THIS LINE
                    teacherControls.style.display = 'block';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Ustaadh Controls';
                    break;
                    
                case 'office':
                    absentButton.style.display = 'none';
                    didNotGiveButton.style.display = 'none'; // ADD THIS LINE
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'block';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Office Controls';
                    
                    // Progress rows are read-only for office
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    break;
                    
                case 'parent':
                    container.classList.add('parent-mode');
                    absentButton.style.display = 'none';
                    didNotGiveButton.style.display = 'none'; // ADD THIS LINE
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'block';
                    controlsTitle.textContent = 'Parent View';
                    
                    // Progress rows are read-only for parents
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    
                    // Show parent check section
                    document.getElementById('parentCheckSection').style.display = 'block';
                    break;
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const footerText = document.getElementById('footerText');
            
            switch(currentUserType) {
                case 'teacher':
                    userInfo.textContent = '📖 Ustaadh - Full Access';
                    footerText.textContent = 'Track daily student progress with Firebase real-time sync';
                    break;
                case 'office':
                    userInfo.textContent = '🕌 Office - Read-Only Access';
                    footerText.textContent = 'View student progress and generate reports';
                    break;
                case 'parent':
                    const studentInfo = Object.values(studentAccessCodes).find(s => s.studentId === currentStudent);
                    const studentName = studentInfo ? studentInfo.studentName : 'Student';
                    userInfo.textContent = `👨‍👩‍👧‍👦 Parent - ${studentName}'s Progress`;
                    footerText.textContent = `Track ${studentName}'s Hifz progress in real-time`;
                    break;
            }
            userInfo.style.display = 'block';
        }

        async function loadStudentsAndInitialize() {
            try {
                // Load academic year first
                currentAcademicYear = await getCurrentAcademicYear();
                
                const students = await window.getStudents();
                
                // Load holiday cache
                await updateHolidayCache();
                
                if (currentUserType === 'parent') {
                    // Parents only see their child
                    if (currentStudent) {
                        await setupStudentListeners([currentStudent]);
                        selectStudent(currentStudent);
                        // Check for homework
                        await checkForHomework();
                        // ADD THIS LINE:
                        await checkForMessages();
                    }
                } else {
                    // Teachers and office see all students
                    await setupStudentListeners(students.map(s => s.id));
                    populateStudentTabs(students);
                    if (students.length > 0) {
                        selectStudent(students[0].id);
                    }
                }
                
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Error loading students: ' + error.message);
            }
        }

        function populateStudentTabs(students) {
            const tabsContainer = document.getElementById('studentTabs');
            tabsContainer.innerHTML = '';
            
            // Sort students alphabetically by name
            students.sort((a, b) => a.name.localeCompare(b.name));
            
            if (currentUserType === 'parent') {
                // Parents only see their child's tab
                const student = students.find(s => s.id === currentStudent);
                if (student) {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab active';
                    tab.innerHTML = student.name;
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                }
            } else {
                // Teachers and office staff see all students
                students.forEach(student => {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab';
                    tab.innerHTML = student.name;
                    tab.onclick = () => selectStudent(student.id);
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                });
            }
        }

        async function setupStudentListeners(studentIds) {
            // Clean up existing listeners
            studentUnsubscribes.forEach(unsubscribe => unsubscribe());
            studentUnsubscribes = [];
            
            // Set up new listeners for each student
            const { onSnapshot, doc } = window.firebaseModules;
            const { db } = window.firebase;
            
            studentIds.forEach(studentId => {
                const unsubscribe = onSnapshot(doc(db, 'progress', studentId), (doc) => {
                    if (doc.exists()) {
                        // Update UI if this is the current student
                        if (studentId === currentStudent) {
                            updateTodaysProgress();
                            updateStats();
                            generateCalendar();
                            // Check for homework if parent
                            if (currentUserType === 'parent') {
                                checkForHomework();
                            }
                        }
                    }
                });
                studentUnsubscribes.push(unsubscribe);
            });
        }

        async function selectStudent(studentId) {
            currentStudent = studentId;
            
            if (currentUserType !== 'parent') {
                document.querySelectorAll('.student-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.studentId === studentId) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // Show student name
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('selectedStudentName').textContent = student.name;
                document.getElementById('studentNameDisplay').style.display = 'block';
            }
            
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            
            // Check for homework if parent
            if (currentUserType === 'parent') {
                await checkForHomework();
            }
        }

        // NEW FUNCTIONS FOR JUZ OVERVIEW

        // Calculate duration between two dates
        function calculateDuration(startDate, endDate = null) {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            let days = end.getDate() - start.getDate();
            
            if (days < 0) {
                months--;
                days += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
            }
            
            if (months < 0) {
                years--;
                months += 12;
            }
            
            return { years, months, days };
        }

        function formatDuration(duration) {
            const { years, months, days } = duration;
            const parts = [];
            
            if (years > 0) {
                parts.push(`${years} ${years === 1 ? 'Year' : 'Years'}`);
            }
            if (months > 0) {
                parts.push(`${months} ${months === 1 ? 'Month' : 'Months'}`);
            }
            if (days > 0) {
                parts.push(`${days} ${days === 1 ? 'Day' : 'Days'}`);
            }
            
            // If all components are 0, return "0 Days"
            if (parts.length === 0) {
                return '0 Days';
            }
            
            return parts.join(' ');
        }

        function showUpdateStudentOverviewModal() {
            if (currentUserType !== 'teacher') return;
            
            // Populate student dropdown
            window.getStudents().then(students => {
                const select = document.getElementById('overviewStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Reset form
            document.getElementById('overviewForm').style.display = 'none';
            document.getElementById('hifzStartDate').value = '';
            
            document.getElementById('updateStudentOverviewModal').style.display = 'block';
        }

        async function onOverviewStudentChange() {
            const studentId = document.getElementById('overviewStudentSelect').value;
            const overviewForm = document.getElementById('overviewForm');
            
            if (!studentId) {
                overviewForm.style.display = 'none';
                return;
            }
            
            // Load existing data
            const juzData = await getStudentJuzProgress(studentId);
            
            // Show form
            overviewForm.style.display = 'block';
            
            // Set Hifz start date if available
            if (juzData.hifzStartDate) {
                document.getElementById('hifzStartDate').value = juzData.hifzStartDate;
            }
            
            // Generate Juz cards
            generateJuzCards(juzData.juzProgress || {});
        }

        function generateJuzCards(juzProgress) {
            const container = document.getElementById('juzProgressContainer');
            container.innerHTML = '';
            
            // Create cards for all 30 Juz
            for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                const juzData = juzProgress[juzNumber] || {};
                
                const card = document.createElement('div');
                card.className = 'juz-card';
                card.id = `juz-${juzNumber}`;
                
                let statusClass = 'not-started';
                let statusText = 'Not Started';
                let durationHtml = '';
                
                if (juzData.startDate && juzData.finishDate) {
                    statusClass = 'completed';
                    statusText = 'Completed';
                    const duration = calculateDuration(juzData.startDate, juzData.finishDate);
                    durationHtml = `<div class="juz-duration">${formatDuration(duration)}</div>`;
                } else if (juzData.startDate) {
                    statusClass = 'current';
                    statusText = 'Currently On';
                    const duration = calculateDuration(juzData.startDate);
                    durationHtml = `<div class="juz-duration">${formatDuration(duration)} (ongoing)</div>`;
                }
                
                card.innerHTML = `
                    <div class="juz-number">Juz ${juzNumber}</div>
                    <div class="juz-status ${statusClass}">${statusText}</div>
                    <div class="date-input-group">
                        <div class="date-input-row">
                            <label>Start:</label>
                            <input type="date" id="juz-${juzNumber}-start" value="${juzData.startDate || ''}" 
                                   onchange="updateJuzDate(${juzNumber}, 'startDate', this.value)">
                        </div>
                        <div class="date-input-row">
                            <label>Finish:</label>
                            <input type="date" id="juz-${juzNumber}-finish" value="${juzData.finishDate || ''}"
                                   onchange="updateJuzDate(${juzNumber}, 'finishDate', this.value)">
                        </div>
                    </div>
                    ${durationHtml}
                `;
                
                container.appendChild(card);
            }
        }

        function updateJuzDate(juzNumber, dateType, value) {
            const card = document.getElementById(`juz-${juzNumber}`);
            const startInput = document.getElementById(`juz-${juzNumber}-start`);
            const finishInput = document.getElementById(`juz-${juzNumber}-finish`);
            
            const startDate = startInput.value;
            const finishDate = finishInput.value;
            
            // Debug logging
            console.log(`Updating Juz ${juzNumber} ${dateType} to: ${value}`);
            console.log(`Current values - Start: ${startDate}, Finish: ${finishDate}`);
            
            // Update status and duration
            let statusClass = 'not-started';
            let statusText = 'Not Started';
            let durationHtml = '';
            
            if (startDate && finishDate) {
                statusClass = 'completed';
                statusText = 'Completed';
                const duration = calculateDuration(startDate, finishDate);
                durationHtml = `<div class="juz-duration">${formatDuration(duration)}</div>`;
            } else if (startDate) {
                statusClass = 'current';
                statusText = 'Currently On';
                const duration = calculateDuration(startDate);
                durationHtml = `<div class="juz-duration">${formatDuration(duration)} (ongoing)</div>`;
            }
            
            // Update card appearance
            card.className = `juz-card ${statusClass}`;
            card.querySelector('.juz-status').className = `juz-status ${statusClass}`;
            card.querySelector('.juz-status').textContent = statusText;
            
            // Update duration display
            const existingDuration = card.querySelector('.juz-duration');
            if (existingDuration) {
                existingDuration.remove();
            }
            
            if (durationHtml) {
                card.insertAdjacentHTML('beforeend', durationHtml);
            }
        }

        async function saveStudentOverview() {
            const studentId = document.getElementById('overviewStudentSelect').value;
            const hifzStartDate = document.getElementById('hifzStartDate').value;
            
            if (!studentId) {
                alert('Please select a student');
                return;
            }
            
            if (!hifzStartDate) {
                alert('Please set the Hifz start date');
                return;
            }
            
            // Collect all Juz data using specific IDs
            const juzProgress = {};
            
            for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                const startInput = document.getElementById(`juz-${juzNumber}-start`);
                const finishInput = document.getElementById(`juz-${juzNumber}-finish`);
                
                const startDate = startInput ? startInput.value : '';
                const finishDate = finishInput ? finishInput.value : '';
                
                // Debug logging
                console.log(`Juz ${juzNumber}: Start="${startDate}", Finish="${finishDate}"`);
                
                if (startDate || finishDate) {
                    juzProgress[juzNumber] = {};
                    if (startDate) juzProgress[juzNumber].startDate = startDate;
                    if (finishDate) juzProgress[juzNumber].finishDate = finishDate;
                }
            }
            
            // Debug the final data structure
            console.log('Final juzProgress data:', juzProgress);
            
            // Save to Firebase
            try {
                await saveStudentJuzProgress(studentId, {
                    hifzStartDate: hifzStartDate,
                    juzProgress: juzProgress,
                    lastUpdated: new Date().toISOString()
                });
                
                closeModal('updateStudentOverviewModal');
                alert('Student overview updated successfully!');
                
            } catch (error) {
                console.error('Error saving student overview:', error);
                alert('Error saving overview: ' + error.message);
            }
        }

        async function saveStudentJuzProgress(studentId, data) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await setDoc(doc(db, 'juzProgress', studentId), data);
                console.log(`Juz progress saved for ${studentId}`);
            } catch (error) {
                console.error('Error saving juz progress:', error);
                throw error;
            }
        }

        async function getStudentJuzProgress(studentId) {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const juzDoc = await getDoc(doc(db, 'juzProgress', studentId));
                if (juzDoc.exists()) {
                    return juzDoc.data();
                }
                return { hifzStartDate: null, juzProgress: {} };
            } catch (error) {
                console.error('Error fetching juz progress:', error);
                return { hifzStartDate: null, juzProgress: {} };
            }
        }

        // UPDATED - Overall Progress Modal for Parents & Office with dropdown selector
        async function showOverallProgressModal() {
            if (currentUserType === 'parent' && !currentStudent) return;
            
            try {
                let students = [];
                let targetStudentId = currentStudent;
                
                // Office users can see all students with dropdown selector
                if (currentUserType === 'office') {
                    students = await window.getStudents();
                    if (students.length === 0) {
                        alert('No students found');
                        return;
                    }
                    
                    // Show modal with student selector first
                    const content = document.getElementById('overallProgressContent');
                    content.innerHTML = `
                        <div class="homework-section">
                            <div class="homework-section-title">
                                👤 Select Student
                            </div>
                            <div class="entry-form">
                                <div class="form-group">
                                    <label class="form-label">Choose Student to View Progress</label>
                                    <select class="form-select" id="officeStudentSelect" onchange="loadSelectedStudentProgress()">
                                        <option value="">Select a student...</option>
                                        ${students.map(student => `<option value="${student.id}">${student.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="selectedStudentProgress" style="display: none;">
                            <!-- Student progress will be loaded here -->
                        </div>
                    `;
                    
                    document.getElementById('overallProgressModal').style.display = 'block';
                    return;
                } else if (currentUserType === 'parent') {
                    students = await window.getStudents();
                }
                
                const student = students.find(s => s.id === targetStudentId);
                const juzData = await getStudentJuzProgress(targetStudentId);
                
                const content = document.getElementById('overallProgressContent');
                
                if (!juzData.hifzStartDate) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Hifz Data Available</h3>
                            <p style="color: #8E8E93; font-size: 16px;">The Ustaadh hasn't set up ${student ? student.name + "'s" : 'this student\'s'} Hifz progress tracking yet.</p>
                        </div>
                    `;
                } else {
                    // Calculate total Hifz duration
                    const totalDuration = calculateDuration(juzData.hifzStartDate);
                    
                    // Generate progress content
                    let progressHtml = `
                        <!-- Hifz Duration Card -->
                        <div class="hifz-duration-card">
                            <div class="hifz-duration-title">📖 ${student ? student.name + "'s" : 'Student'} HIFZ DURATION</div>
                            <div class="hifz-duration-time">${formatDuration(totalDuration)}</div>
                            <div class="hifz-duration-date">As of ${new Date().toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'long', 
                                day: 'numeric',
                                year: 'numeric'
                            })}</div>
                        </div>
                        
                        <div class="homework-section">
                            <div class="homework-section-title">
                                📖 Juz Progress Overview
                            </div>
                            <div class="progress-list">
                    `;
                    
                    // Process Juz data - only show ones with dates
                    const juzEntries = [];
                    
                    for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                        const juzInfo = juzData.juzProgress[juzNumber];
                        if (juzInfo && juzInfo.startDate) {
                            juzEntries.push({ number: juzNumber, ...juzInfo });
                        }
                    }
                    
                    // Sort by start date
                    juzEntries.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    
                    if (juzEntries.length === 0) {
                        progressHtml += `
                            <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                                <div style="font-size: 40px; margin-bottom: 16px;">📚</div>
                                <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 600; color: #1C1C1E;">No Juz Progress Yet</h3>
                                <p>The Ustaadh will update Juz progress as the student advances.</p>
                            </div>
                        `;
                    } else {
                        juzEntries.forEach(juz => {
                            const isCompleted = juz.startDate && juz.finishDate;
                            const statusClass = isCompleted ? 'completed' : 'current';
                            const statusText = isCompleted ? 'Completed' : 'Currently On';
                            
                            const startDateStr = new Date(juz.startDate).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            });
                            
                            let dateRangeHtml = `Started: ${startDateStr}`;
                            let durationHtml = '';
                            
                            if (isCompleted) {
                                const finishDateStr = new Date(juz.finishDate).toLocaleDateString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric',
                                    year: 'numeric'
                                });
                                dateRangeHtml = `${startDateStr} - ${finishDateStr}`;
                                
                                const duration = calculateDuration(juz.startDate, juz.finishDate);
                                durationHtml = `<div class="progress-item-duration">Time Taken: ${formatDuration(duration)}</div>`;
                            } else {
                                const duration = calculateDuration(juz.startDate);
                                durationHtml = `<div class="progress-item-duration">Duration: ${formatDuration(duration)} (ongoing)</div>`;
                            }
                            
                            progressHtml += `
                                <div class="progress-item ${statusClass}">
                                    <div class="progress-item-header">
                                        <div class="progress-item-juz">Juz ${juz.number}</div>
                                        <div class="progress-item-status ${statusClass}">${statusText}</div>
                                    </div>
                                    <div class="progress-item-details">
                                        ${dateRangeHtml}
                                        ${durationHtml}
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    progressHtml += '</div></div>';
                    content.innerHTML = progressHtml;
                }
                
                document.getElementById('overallProgressModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading overall progress:', error);
                alert('Error loading progress: ' + error.message);
            }
        }

        // NEW - Function to load selected student progress for Office users
        async function loadSelectedStudentProgress() {
            const selectedStudentId = document.getElementById('officeStudentSelect').value;
            const progressContainer = document.getElementById('selectedStudentProgress');
            
            if (!selectedStudentId) {
                progressContainer.style.display = 'none';
                return;
            }
            
            try {
                const students = await window.getStudents();
                const student = students.find(s => s.id === selectedStudentId);
                const juzData = await getStudentJuzProgress(selectedStudentId);
                
                if (!juzData.hifzStartDate) {
                    progressContainer.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Hifz Data Available</h3>
                            <p style="color: #8E8E93; font-size: 16px;">The Ustaadh hasn't set up ${student.name}'s Hifz progress tracking yet.</p>
                        </div>
                    `;
                } else {
                    // Calculate total Hifz duration
                    const totalDuration = calculateDuration(juzData.hifzStartDate);
                    
                    // Generate progress content
                    let progressHtml = `
                        <!-- Hifz Duration Card -->
                        <div class="hifz-duration-card">
                            <div class="hifz-duration-title">📖 ${student.name}'s HIFZ DURATION</div>
                            <div class="hifz-duration-time">${formatDuration(totalDuration)}</div>
                            <div class="hifz-duration-date">As of ${new Date().toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'long', 
                                day: 'numeric',
                                year: 'numeric'
                            })}</div>
                        </div>
                        
                        <div class="homework-section">
                            <div class="homework-section-title">
                                📖 Juz Progress Overview
                            </div>
                            <div class="progress-list">
                    `;
                    
                    // Process Juz data - only show ones with dates
                    const juzEntries = [];
                    
                    for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                        const juzInfo = juzData.juzProgress[juzNumber];
                        if (juzInfo && juzInfo.startDate) {
                            juzEntries.push({ number: juzNumber, ...juzInfo });
                        }
                    }
                    
                    // Sort by start date
                    juzEntries.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    
                    if (juzEntries.length === 0) {
                        progressHtml += `
                            <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                                <div style="font-size: 40px; margin-bottom: 16px;">📚</div>
                                <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 600; color: #1C1C1E;">No Juz Progress Yet</h3>
                                <p>The Ustaadh will update Juz progress as the student advances.</p>
                            </div>
                        `;
                    } else {
                        juzEntries.forEach(juz => {
                            const isCompleted = juz.startDate && juz.finishDate;
                            const statusClass = isCompleted ? 'completed' : 'current';
                            const statusText = isCompleted ? 'Completed' : 'Currently On';
                            
                            const startDateStr = new Date(juz.startDate).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            });
                            
                            let dateRangeHtml = `Started: ${startDateStr}`;
                            let durationHtml = '';
                            
                            if (isCompleted) {
                                const finishDateStr = new Date(juz.finishDate).toLocaleDateString('en-US', { 
                                    month: 'short', 
                                    day: 'numeric',
                                    year: 'numeric'
                                });
                                dateRangeHtml = `${startDateStr} - ${finishDateStr}`;
                                
                                const duration = calculateDuration(juz.startDate, juz.finishDate);
                                durationHtml = `<div class="progress-item-duration">Time Taken: ${formatDuration(duration)}</div>`;
                            } else {
                                const duration = calculateDuration(juz.startDate);
                                durationHtml = `<div class="progress-item-duration">Duration: ${formatDuration(duration)} (ongoing)</div>`;
                            }
                            
                            progressHtml += `
                                <div class="progress-item ${statusClass}">
                                    <div class="progress-item-header">
                                        <div class="progress-item-juz">Juz ${juz.number}</div>
                                        <div class="progress-item-status ${statusClass}">${statusText}</div>
                                    </div>
                                    <div class="progress-item-details">
                                        ${dateRangeHtml}
                                        ${durationHtml}
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    progressHtml += '</div></div>';
                    progressContainer.innerHTML = progressHtml;
                }
                
                progressContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading student progress:', error);
                alert('Error loading student progress: ' + error.message);
            }
        }

        // Helper function for Office to select student
        async function showStudentSelector(studentNames) {
            return new Promise((resolve) => {
                const selection = prompt(`Select a student:\n${studentNames.map((name, index) => `${index + 1}. ${name}`).join('\n')}\n\nEnter the number (1-${studentNames.length}) or cancel:`);
                
                if (selection === null) {
                    resolve(-1); // User cancelled
                    return;
                }
                
                const index = parseInt(selection) - 1;
                if (index >= 0 && index < studentNames.length) {
                    resolve(index);
                } else {
                    alert('Invalid selection');
                    resolve(-1);
                }
            });
        }

        // Homework Functions
        async function checkForHomework() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const homeworkSection = document.getElementById('homeworkSection');
                
                if (homework && homework.length > 0) {
                    // Check if there's any pending (incomplete and not marked as did not give) homework
                    const pendingHomework = homework.filter(hw => !hw.completed && hw.status !== 'did-not-give');
                    
                    if (pendingHomework.length > 0) {
                        const latestHomework = pendingHomework[0]; // Get the latest homework
                        
                        // Update homework notification
                        const dueDateObj = new Date(latestHomework.dueDate);
                        const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        // FIXED: Show proper subject name
                        const subjectDisplay = latestHomework.type === 'para' ? 'Sabak Para' : 
                                             latestHomework.type.charAt(0).toUpperCase() + latestHomework.type.slice(1);
                        
                        document.getElementById('homeworkNotificationDesc').textContent = 
                            `${subjectDisplay} homework assigned`;
                        document.getElementById('homeworkDueDate').textContent = `Due: ${dueDateStr}`;
                        
                        homeworkSection.style.display = 'block';
                        return;
                    }
                }
                
                // No homework found
                homeworkSection.style.display = 'none';
                
            } catch (error) {
                console.error('Error checking for homework:', error);
                document.getElementById('homeworkSection').style.display = 'none';
            }
        }

        function showViewAllHomeworkModal() {
            if (currentUserType !== 'teacher') return;
            
            loadAllHomework();
            document.getElementById('viewAllHomeworkModal').style.display = 'block';
        }

        // UPDATED - Homework Summary Modal function for parents with better styling
        async function showHomeworkSummaryModal() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const content = document.getElementById('homeworkSummaryContent');
                
                if (!homework || homework.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Homework Assigned</h3>
                            <p style="color: #8E8E93; font-size: 16px;">No homework has been assigned yet.</p>
                        </div>
                    `;
                } else {
                    // Show all homework with summary at top
                    const totalHomework = homework.length;
                    const completedHomework = homework.filter(hw => hw.completed).length;
                    const pendingHomework = homework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length;
                    const didNotGiveHomework = homework.filter(hw => hw.status === 'did-not-give').length;
                    const overdueHomework = homework.filter(hw => !hw.completed && hw.status !== 'did-not-give' && isHomeworkOverdue(hw.dueDate)).length;
                    
                    let homeworkHtml = `
                        <!-- Summary Section -->
                        <div class="homework-summary-section">
                            <h3 class="homework-summary-title">📊 Homework Summary</h3>
                            <div class="homework-summary-grid">
                                <div class="homework-summary-stat">
                                    <div class="homework-summary-number" style="color: #1C1C1E;">${totalHomework}</div>
                                    <div class="homework-summary-label">Total</div>
                                </div>
                                <div class="homework-summary-stat">
                                    <div class="homework-summary-number" style="color: #34C759;">${completedHomework}</div>
                                    <div class="homework-summary-label">Completed</div>
                                </div>
                                <div class="homework-summary-stat">
                                    <div class="homework-summary-number" style="color: #FF9500;">${pendingHomework}</div>
                                    <div class="homework-summary-label">Pending</div>
                                </div>
                                <div class="homework-summary-stat">
                                    <div class="homework-summary-number" style="color: #FFB84D;">${overdueHomework}</div>
                                    <div class="homework-summary-label">Overdue</div>
                                </div>
                            </div>
                            ${didNotGiveHomework > 0 ? `
                                <div style="margin-top: 12px; padding: 12px; background: #FEF2F2; border-radius: 8px; text-align: center;">
                                    <span style="color: #991B1B; font-weight: 600;">${didNotGiveHomework} homework(s) marked as Did Not Give</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="homework-section">
                            <div class="homework-section-title">
                                📋 All Homework
                            </div>
                    `;
                    
                    homework.forEach((hw, index) => {
                        const dueDateObj = new Date(hw.dueDate);
                        const isOverdue = !hw.completed && hw.status !== 'did-not-give' && isHomeworkOverdue(hw.dueDate);
                        
                        const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        
                        // FIXED: Show proper subject name
                        const typeDisplay = hw.type === 'para' ? 'Sabak Para' : 
                                          hw.type.charAt(0).toUpperCase() + hw.type.slice(1);
                        
                        let statusHtml = '';
                        let statusColor = '';
                        if (hw.status === 'did-not-give') {
                            statusHtml = '<span style="color: #991B1B; font-weight: 600; font-size: 12px;">Did Not Give</span>';
                            statusColor = '#FEF2F2';
                        } else if (hw.completed) {
                            statusHtml = '<span style="color: #34C759; font-weight: 600; font-size: 12px;">Completed</span>';
                            statusColor = '#D1FAE5';
                        } else if (isOverdue) {
                            statusHtml = '<span style="color: #EA580C; font-weight: 600; font-size: 12px;">Overdue</span>';
                            statusColor = '#FFE4CC';
                        } else {
                            statusHtml = '<span style="color: #C2410C; font-weight: 600; font-size: 12px;">Pending</span>';
                            statusColor = '#FED7AA';
                        }
                        
                        const descriptionHtml = hw.description ? 
                            `<div class="homework-description-display">
                                <strong style="color: #1E40AF; font-size: 14px;">Instructions:</strong><br>
                                ${hw.description}
                            </div>` : '';
                        
                        homeworkHtml += `
                            <div class="homework-item ${hw.completed ? 'completed' : hw.status === 'did-not-give' ? 'did-not-give' : isOverdue ? 'overdue' : ''}">
                                <div class="homework-header">
                                    <div>
                                        <h3 class="homework-student-name">${typeDisplay} Homework</h3>
                                        <p class="homework-details">Due: ${dueDateStr}</p>
                                    </div>
                                    <div style="padding: 6px 12px; background: ${statusColor}; border-radius: 20px; line-height: 1; display: inline-flex; align-items: center;">
                                        ${statusHtml}
                                    </div>
                                </div>
                                
                                ${descriptionHtml}
                            </div>
                        `;
                    });
                    
                    homeworkHtml += '</div>';
                    content.innerHTML = homeworkHtml;
                }
                
                document.getElementById('homeworkSummaryModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching homework summary:', error);
                alert('Error loading homework summary: ' + error.message);
            }
        }

        async function loadAllHomework(filter = 'all') {
            try {
                const { getDocs, collection } = window.firebaseModules;
                const { db } = window.firebase;
                
                const querySnapshot = await getDocs(collection(db, 'homework'));
                const allHomework = [];
                
                querySnapshot.forEach((doc) => {
                    allHomework.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by assigned date (newest first)
                allHomework.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                // Get student names
                const students = await window.getStudents();
                
                // Filter homework based on selection
                let filteredHomework = allHomework;
                if (filter === 'pending') {
                    filteredHomework = allHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give');
                } else if (filter === 'completed') {
                    filteredHomework = allHomework.filter(hw => hw.completed);
                } else if (filter === 'overdue') {
                    filteredHomework = allHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give' && isHomeworkOverdue(hw.dueDate));
                } else if (filter === 'did-not-give') {
                    filteredHomework = allHomework.filter(hw => hw.status === 'did-not-give');
                }
                
                displayAllHomework(filteredHomework, students, filter, allHomework);
                
            } catch (error) {
                console.error('Error loading homework:', error);
            }
        }

        // UPDATED - Display homework with better styling
        function displayAllHomework(homework, students, currentFilter, allHomework) {
            const content = document.getElementById('allHomeworkContent');
            
            const filtersHtml = `
                <div class="homework-filters">
                    <div class="filter-button ${currentFilter === 'all' ? 'active' : ''}" onclick="loadAllHomework('all')">All</div>
                    <div class="filter-button ${currentFilter === 'pending' ? 'active' : ''}" onclick="loadAllHomework('pending')">Pending</div>
                    <div class="filter-button ${currentFilter === 'completed' ? 'active' : ''}" onclick="loadAllHomework('completed')">Completed</div>
                    <div class="filter-button ${currentFilter === 'overdue' ? 'active' : ''}" onclick="loadAllHomework('overdue')">Overdue</div>
                    <div class="filter-button ${currentFilter === 'did-not-give' ? 'active' : ''}" onclick="loadAllHomework('did-not-give')">Did Not Give</div>
                </div>
            `;
            
            // Add summary for teachers
            const totalCount = allHomework.length;
            const completedCount = allHomework.filter(hw => hw.completed).length;
            const pendingCount = allHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length;
            const overdueCount = allHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give' && isHomeworkOverdue(hw.dueDate)).length;
            const didNotGiveCount = allHomework.filter(hw => hw.status === 'did-not-give').length;
            
            const summaryHtml = `
                <div class="homework-summary-section">
                    <h3 class="homework-summary-title">📊 Overall Homework Summary</h3>
                    <div class="homework-summary-grid">
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #1C1C1E;">${totalCount}</div>
                            <div class="homework-summary-label">Total</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #34C759;">${completedCount}</div>
                            <div class="homework-summary-label">Completed</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FF9500;">${pendingCount}</div>
                            <div class="homework-summary-label">Pending</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FFB84D;">${overdueCount}</div>
                            <div class="homework-summary-label">Overdue</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FF3B30;">${didNotGiveCount}</div>
                            <div class="homework-summary-label">Did Not Give</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (homework.length === 0) {
                content.innerHTML = summaryHtml + filtersHtml + `
                    <div class="no-homework">
                        <div style="font-size: 48px; margin-bottom: 16px;">📚</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">No Homework Found</h3>
                        <p>No homework matches the current filter.</p>
                    </div>
                `;
                return;
            }
            
            let homeworkListHtml = '';
            
            homework.forEach(hw => {
                const student = students.find(s => s.id === hw.studentId);
                const studentName = student ? student.name : 'Unknown Student';
                
                const dueDateObj = new Date(hw.dueDate);
                const isOverdue = !hw.completed && hw.status !== 'did-not-give' && isHomeworkOverdue(hw.dueDate);
                
                const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const typeDisplay = hw.type === 'para' ? 'Sabak Para' : 
                                hw.type.charAt(0).toUpperCase() + hw.type.slice(1);
                
                let statusHtml = '';
                let itemClass = '';
                if (hw.status === 'did-not-give') {
                    statusHtml = '<span class="homework-status did-not-give">Did Not Give</span>';
                    itemClass = 'did-not-give';
                } else if (hw.completed) {
                    statusHtml = '<span class="homework-status completed">Completed</span>';
                    itemClass = 'completed';
                } else if (isOverdue) {
                    statusHtml = '<span class="homework-status overdue">Overdue</span>';
                    itemClass = 'overdue';
                } else {
                    statusHtml = '<span class="homework-status pending">Pending</span>';
                }
                
                const descriptionHtml = hw.description ? 
                    `<div class="homework-description-display">${hw.description}</div>` : '';
                
                let actionButtonsHtml = '';
                if (hw.status === 'did-not-give') {
                    actionButtonsHtml = `
                        <button class="homework-toggle" onclick="updateHomeworkStatus('${hw.id}', 'pending')" 
                                style="background: #10A37F;">
                            ✓ Mark as Given
                        </button>
                        <button class="homework-toggle incomplete" onclick="deleteHomework('${hw.id}')" 
                                style="background: #FF3B30;">
                            🗑️ Delete
                        </button>
                    `;
                } else if (hw.completed) {
                    actionButtonsHtml = `
                        <button class="homework-toggle incomplete" onclick="toggleHomeworkCompletion('${hw.id}', false)">
                            ↩️ Mark Incomplete
                        </button>
                        <button class="homework-toggle did-not-give" onclick="updateHomeworkStatus('${hw.id}', 'did-not-give')">
                            🚫 Did Not Give
                        </button>
                        <button class="homework-toggle incomplete" onclick="deleteHomework('${hw.id}')" 
                                style="background: #FF3B30;">
                            🗑️ Delete
                        </button>
                    `;
                } else {
                    actionButtonsHtml = `
                        <button class="homework-toggle" onclick="toggleHomeworkCompletion('${hw.id}', true)">
                            ✓ Mark Complete
                        </button>
                        <button class="homework-toggle did-not-give" onclick="updateHomeworkStatus('${hw.id}', 'did-not-give')">
                            🚫 Did Not Give
                        </button>
                        <button class="homework-toggle incomplete" onclick="deleteHomework('${hw.id}')" 
                                style="background: #FF3B30;">
                            🗑️ Delete
                        </button>
                    `;
                }
                
                homeworkListHtml += `
                    <div class="homework-item ${itemClass}">
                        <div class="homework-header">
                            <div>
                                <div class="homework-student-name">${studentName}</div>
                                <div class="homework-details">
                                    <span class="homework-type-badge" style="
                                        background-color: ${hw.type === 'sabak' ? '#E8F5E8' : hw.type === 'para' ? '#F3E5F5' : hw.type === 'dhor' ? '#FFF3E0' : '#E8F5E8'}; 
                                        color: ${hw.type === 'sabak' ? '#2E7D32' : hw.type === 'para' ? '#7B1FA2' : hw.type === 'dhor' ? '#E65100' : '#2E7D32'}; 
                                        padding: 6px 12px; 
                                        border-radius: 16px; 
                                        font-size: 12px; 
                                        font-weight: 600; 
                                        display: inline-flex; 
                                        align-items: center; 
                                        gap: 4px;
                                    ">${typeDisplay}</span>
                                    Due: ${dueDateStr}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${statusHtml}
                            </div>
                        </div>
                        
                        ${descriptionHtml}
                        
                        <div class="homework-actions">
                            ${actionButtonsHtml}
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = summaryHtml + filtersHtml + homeworkListHtml;
        }

        async function updateHomeworkStatus(homeworkId, status) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const updateData = { status: status };
                if (status === 'did-not-give') {
                    updateData.didNotGiveDate = new Date().toISOString();
                } else if (status === 'pending') {
                    updateData.didNotGiveDate = null;
                }
                
                await updateDoc(doc(db, 'homework', homeworkId), updateData);
                
                // Reload the homework list
                const activeFilter = document.querySelector('.filter-button.active').textContent.toLowerCase().replace(' ', '-').replace('did-not-give', 'did-not-give');
                loadAllHomework(activeFilter);
                
            } catch (error) {
                console.error('Error updating homework status:', error);
                alert('Error updating homework: ' + error.message);
            }
        }

        async function toggleHomeworkCompletion(homeworkId, completed) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await updateDoc(doc(db, 'homework', homeworkId), {
                    completed: completed,
                    completedDate: completed ? new Date().toISOString() : null
                });
                
                // Reload the homework list
                const activeFilter = document.querySelector('.filter-button.active').textContent.toLowerCase().replace(' ', '-').replace('did-not-give', 'did-not-give');
                loadAllHomework(activeFilter);
                
            } catch (error) {
                console.error('Error updating homework completion:', error);
                alert('Error updating homework: ' + error.message);
            }
        }

        async function deleteHomework(homeworkId) {
            if (!confirm('Are you sure you want to delete this homework assignment?')) {
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await deleteDoc(doc(db, 'homework', homeworkId));
                
                // Reload the homework list
                const activeFilter = document.querySelector('.filter-button.active').textContent.toLowerCase().replace(' ', '-').replace('did-not-give', 'did-not-give');
                loadAllHomework(activeFilter);
                
            } catch (error) {
                console.error('Error deleting homework:', error);
                alert('Error deleting homework: ' + error.message);
            }
        }

        function showAssignHomeworkModal() {
            if (currentUserType !== 'teacher') return;
            
            // Populate student dropdown
            window.getStudents().then(students => {
                const select = document.getElementById('homeworkStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Reset form
            document.getElementById('homeworkTypeSelect').value = '';
            document.getElementById('homeworkDueDate').value = '';
            document.getElementById('homeworkDescriptionInput').value = '';
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('homeworkDueDate').value = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('assignHomeworkModal').style.display = 'block';
        }

        async function assignHomework() {
            if (currentUserType !== 'teacher') return;
            
            const studentId = document.getElementById('homeworkStudentSelect').value;
            const type = document.getElementById('homeworkTypeSelect').value;
            const dueDate = document.getElementById('homeworkDueDate').value;
            const description = document.getElementById('homeworkDescriptionInput').value.trim();
            
            if (!studentId || !type || !dueDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const homeworkData = {
                    studentId: studentId,
                    type: type,
                    dueDate: dueDate,
                    description: description,
                    assignedDate: new Date().toISOString(),
                    assignedBy: 'Ustaadh',
                    completed: false,
                    status: 'pending'
                };
                
                // Save homework assignment
                await saveHomeworkAssignment(homeworkData);
                
                closeModal('assignHomeworkModal');
                
                const students = await window.getStudents();
                const student = students.find(s => s.id === studentId);
                const studentName = student ? student.name : 'Student';
                
                // FIXED: Show proper subject name
                const typeDisplay = type === 'para' ? 'Sabak Para' : 
                                  type.charAt(0).toUpperCase() + type.slice(1);
                
                alert(`${typeDisplay} homework assigned to ${studentName} successfully!`);
                
            } catch (error) {
                console.error('Error assigning homework:', error);
                alert('Error assigning homework: ' + error.message);
            }
        }

        async function saveHomeworkAssignment(homeworkData) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Create unique ID for homework
                const homeworkId = `${homeworkData.studentId}_${Date.now()}`;
                
                await setDoc(doc(db, 'homework', homeworkId), homeworkData);
                console.log('Homework assignment saved:', homeworkId);
            } catch (error) {
                console.error('Error saving homework assignment:', error);
                throw error;
            }
        }

        async function getStudentHomework(studentId) {
            try {
                const { getDocs, collection, query, where } = window.firebaseModules;
                const { db } = window.firebase;
                
                const q = query(
                    collection(db, 'homework'), 
                    where('studentId', '==', studentId)
                );
                
                const querySnapshot = await getDocs(q);
                const homework = [];
                
                querySnapshot.forEach((doc) => {
                    const homeworkData = { id: doc.id, ...doc.data() };
                    
                    // Filter by academic year for Parents and Office
                    if ((currentUserType === 'parent' || currentUserType === 'office') && 
                        currentAcademicYear) {
                        const assignedDate = homeworkData.assignedDate.split('T')[0]; // Get date part
                        if (!isDateInAcademicYear(assignedDate, currentAcademicYear)) {
                            return; // Skip homework outside academic year
                        }
                    }
                    
                    homework.push(homeworkData);
                });
                
                // Sort by assigned date (newest first)
                homework.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                return homework;
            } catch (error) {
                console.error('Error fetching student homework:', error);
                return [];
            }
        }

        // UPDATED - View Homework Modal with better styling
        async function showViewHomeworkModal() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const content = document.getElementById('homeworkContent');
                
                if (!homework || homework.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 18px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Homework Assigned</h3>
                            <p style="color: #8E8E93; font-size: 14px;">No homework has been assigned yet.</p>
                        </div>
                    `;
                } else {
                    // Show only current/pending homework (not completed and not marked as did not give)
                    const currentHomework = homework.filter(hw => !hw.completed && hw.status !== 'did-not-give');
                    
                    if (currentHomework.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                                <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                                <h3 style="font-size: 18px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">All Homework Complete!</h3>
                                <p style="color: #8E8E93; font-size: 14px;">Great work! You have completed all assigned homework.</p>
                            </div>
                        `;
                    } else {
                        let homeworkHtml = '<div class="homework-section"><div class="homework-section-title">📚 Current Homework</div>';
                        
                        currentHomework.forEach((hw, index) => {
                            const dueDateObj = new Date(hw.dueDate);
                            const isOverdue = isHomeworkOverdue(hw.dueDate);
                            
                            const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            
                            // FIXED: Show proper subject name
                            const typeDisplay = hw.type === 'para' ? 'Sabak Para' : 
                                              hw.type.charAt(0).toUpperCase() + hw.type.slice(1);
                            
                            let statusHtml = '';
                            let statusColor = '';
                            if (isOverdue) {
                                statusHtml = '<span style="color: #EA580C; font-weight: 600; font-size: 12px;">Overdue</span>';
                                statusColor = '#FFE4CC';
                            } else {
                                statusHtml = '<span style="color: #C2410C; font-weight: 600; font-size: 12px;">Pending</span>';
                                statusColor = '#FED7AA';
                            }
                            
                            const descriptionHtml = hw.description ? 
                                `<div class="homework-description-display">
                                    <strong style="color: #1E40AF; font-size: 14px;">Instructions:</strong><br>
                                    ${hw.description}
                                </div>` : '';
                            
                            homeworkHtml += `
                                <div class="homework-item ${isOverdue ? 'overdue' : ''}">
                                    <div class="homework-header">
                                        <div>
                                            <h3 class="homework-student-name">${typeDisplay} Homework</h3>
                                            <p class="homework-details">Due: ${dueDateStr}</p>
                                        </div>
                                        <div style="padding: 6px 12px; background: ${statusColor}; border-radius: 20px; line-height: 1; display: inline-flex; align-items: center;">
                                            ${statusHtml}
                                        </div>
                                    </div>
                                    
                                    ${descriptionHtml}
                                </div>
                            `;
                        });
                        
                        homeworkHtml += '</div>';
                        content.innerHTML = homeworkHtml;
                    }
                }
                
                document.getElementById('viewHomeworkModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching homework:', error);
                alert('Error loading homework: ' + error.message);
            }
        }

        // Student Targets Functions
        function showStudentTargetsModal() {
            if (currentUserType !== 'teacher') return;
            
            // Populate student dropdown
            window.getStudents().then(students => {
                const select = document.getElementById('targetStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Reset form
            document.getElementById('targetFormSection').style.display = 'none';
            
            document.getElementById('studentTargetsModal').style.display = 'block';
        }

        function showStudentTargetsModal() {
            if (currentUserType !== 'teacher') return;
            
            // Reset form
            document.getElementById('targetYearSelect').value = '';
            document.getElementById('targetStudentGroup').style.display = 'none';
            document.getElementById('targetFormSection').style.display = 'none';
            
            document.getElementById('studentTargetsModal').style.display = 'block';
        }

        function loadTargetYearOptions() {
            const selectedYear = document.getElementById('targetYearSelect').value;
            const studentGroup = document.getElementById('targetStudentGroup');
            const yearlyTargetTitle = document.getElementById('yearlyTargetTitle');
            
            if (!selectedYear) {
                studentGroup.style.display = 'none';
                document.getElementById('targetFormSection').style.display = 'none';
                return;
            }
            
            // Update yearly target title
            yearlyTargetTitle.textContent = `Yearly Target (${selectedYear})`;
            
            // Show student selector and populate it
            studentGroup.style.display = 'block';
            
            window.getStudents().then(students => {
                const select = document.getElementById('targetStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
        }

        async function loadStudentTargets() {
            const studentId = document.getElementById('targetStudentSelect').value;
            const selectedYear = document.getElementById('targetYearSelect').value;
            const formSection = document.getElementById('targetFormSection');
            
            if (!studentId || !selectedYear) {
                formSection.style.display = 'none';
                return;
            }
            
            // Show form
            formSection.style.display = 'block';
            
            // Generate monthly target fields for selected year
            generateMonthlyTargetFieldsForYear(selectedYear);
            
            // Load existing targets
            try {
                const targets = await getStudentTargetsForYear(studentId, selectedYear);
                
                // Load yearly target
                if (targets.yearly) {
                    document.getElementById('yearlyTargetText').value = targets.yearly.text || '';
                    if (targets.yearly.status) {
                        selectTargetStatus('yearly', targets.yearly.status);
                    }
                }
                
                // Load monthly targets
                if (targets.monthly) {
                    Object.keys(targets.monthly).forEach(monthKey => {
                        const monthData = targets.monthly[monthKey];
                        const textArea = document.querySelector(`[data-month="${monthKey}"] .target-textarea`);
                        if (textArea) {
                            textArea.value = monthData.text || '';
                        }
                        if (monthData.status) {
                            selectTargetStatus(monthKey, monthData.status);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading targets:', error);
            }
        }

        function generateMonthlyTargetFieldsForYear(academicYear) {
            const container = document.getElementById('monthlyTargetsContainer');
            container.innerHTML = '';
            
            // Generate months based on academic year
            let months = [];
            const [startYear, endYear] = academicYear.split('-');
            
            // Academic year months (September to August)
            months = [
                { key: `${startYear}-09`, display: `September ${startYear}` },
                { key: `${startYear}-10`, display: `October ${startYear}` },
                { key: `${startYear}-11`, display: `November ${startYear}` },
                { key: `${startYear}-12`, display: `December ${startYear}` },
                { key: `${endYear}-01`, display: `January ${endYear}` },
                { key: `${endYear}-02`, display: `February ${endYear}` },
                { key: `${endYear}-03`, display: `March ${endYear}` },
                { key: `${endYear}-04`, display: `April ${endYear}` },
                { key: `${endYear}-05`, display: `May ${endYear}` },
                { key: `${endYear}-06`, display: `June ${endYear}` },
                { key: `${endYear}-07`, display: `July ${endYear}` },
                { key: `${endYear}-08`, display: `August ${endYear}` }
            ];
            
            months.forEach(month => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'monthly-target-item';
                monthDiv.setAttribute('data-month', month.key);
                
                monthDiv.innerHTML = `
                    <div class="monthly-target-header">
                        📅 ${month.display}
                    </div>
                    <textarea class="target-textarea" 
                              placeholder="Enter target for ${month.display}..."></textarea>
                    <div class="target-status-buttons">
                        <div class="target-status-button" data-status="above" 
                             onclick="selectTargetStatus('${month.key}', 'above')">
                            Above Target
                        </div>
                        <div class="target-status-button" data-status="on" 
                             onclick="selectTargetStatus('${month.key}', 'on')">
                            On Target
                        </div>
                        <div class="target-status-button" data-status="below" 
                             onclick="selectTargetStatus('${month.key}', 'below')">
                            Below Target
                        </div>
                    </div>
                `;
                
                container.appendChild(monthDiv);
            });
        }

        function selectTargetStatus(targetType, status) {
            if (targetType === 'yearly') {
                // Handle yearly target status
                document.querySelectorAll('#targetFormSection .grade-button').forEach(btn => {
                    btn.classList.remove('selected');
                    // Reset to original colors
                    if (btn.dataset.status === 'above') {
                        btn.style.background = '#34C759';
                        btn.style.color = 'white';
                    } else if (btn.dataset.status === 'on') {
                        btn.style.background = '#007AFF';
                        btn.style.color = 'white';
                    } else if (btn.dataset.status === 'below') {
                        btn.style.background = '#FF3B30';
                        btn.style.color = 'white';
                    }
                });
                
                const selectedBtn = document.querySelector(`#targetFormSection .grade-button[data-status="${status}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                    // Make selected button darker
                    if (status === 'above') {
                        selectedBtn.style.background = '#2FB344';
                    } else if (status === 'on') {
                        selectedBtn.style.background = '#0051D5';
                    } else if (status === 'below') {
                        selectedBtn.style.background = '#D70015';
                    }
                }
            } else {
                // Handle monthly target status
                const monthDiv = document.querySelector(`[data-month="${targetType}"]`);
                if (monthDiv) {
                    monthDiv.querySelectorAll('.target-status-button').forEach(btn => {
                        btn.classList.remove('selected', 'above', 'on', 'below');
                    });
                    
                    const selectedBtn = monthDiv.querySelector(`.target-status-button[data-status="${status}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected', status);
                    }
                }
            }
        }

        async function saveStudentTargets() {
            const studentId = document.getElementById('targetStudentSelect').value;
            const selectedYear = document.getElementById('targetYearSelect').value;
            
            if (!studentId || !selectedYear) {
                alert('Please select both academic year and student');
                return;
            }
            
            try {
                const targets = {
                    academicYear: selectedYear,
                    yearly: {
                        text: document.getElementById('yearlyTargetText').value.trim(),
                        status: getSelectedYearlyStatus()
                    },
                    monthly: {},
                    lastUpdated: new Date().toISOString(),
                    updatedBy: 'Ustaadh'
                };
                
                // Collect monthly targets
                document.querySelectorAll('.monthly-target-item').forEach(monthDiv => {
                    const monthKey = monthDiv.getAttribute('data-month');
                    const text = monthDiv.querySelector('.target-textarea').value.trim();
                    const status = getSelectedMonthlyStatus(monthDiv);
                    
                    if (text || status) {
                        targets.monthly[monthKey] = {
                            text: text,
                            status: status
                        };
                    }
                });
                
                // Save to Firebase with year-specific key
                await saveTargetsToFirebaseWithYear(studentId, selectedYear, targets);
                
                alert('Targets saved successfully!');
                
            } catch (error) {
                console.error('Error saving targets:', error);
                alert('Error saving targets: ' + error.message);
            }
        }

        function getSelectedYearlyStatus() {
            const selectedBtn = document.querySelector('#targetFormSection .grade-button.selected');
            return selectedBtn ? selectedBtn.dataset.status : null;
        }

        function getSelectedMonthlyStatus(monthDiv) {
            const selectedBtn = monthDiv.querySelector('.target-status-button.selected');
            return selectedBtn ? selectedBtn.dataset.status : null;
        }

        async function saveTargetsToFirebase(studentId, targets) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await setDoc(doc(db, 'studentTargets', studentId), targets);
                console.log(`Targets saved for student ${studentId}`);
            } catch (error) {
                console.error('Error saving targets to Firebase:', error);
                throw error;
            }
        }

        async function saveTargetsToFirebaseWithYear(studentId, academicYear, targets) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const targetId = `${studentId}_${academicYear}`;
                await setDoc(doc(db, 'studentTargets', targetId), targets);
                console.log(`Targets saved for student ${studentId} for year ${academicYear}`);
            } catch (error) {
                console.error('Error saving targets to Firebase:', error);
                throw error;
            }
        }

        async function getStudentTargetsForYear(studentId, academicYear) {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const targetId = `${studentId}_${academicYear}`;
                const targetDoc = await getDoc(doc(db, 'studentTargets', targetId));
                if (targetDoc.exists()) {
                    return targetDoc.data();
                }
                return { yearly: {}, monthly: {} };
            } catch (error) {
                console.error('Error fetching student targets:', error);
                return { yearly: {}, monthly: {} };
            }
        }

        // Office function to view all student targets
        async function showOfficeStudentTargetsModal() {
            if (currentUserType !== 'office') return;
            
            try {
                const students = await window.getStudents();
                
                if (students.length === 0) {
                    alert('No students found');
                    return;
                }
                
                // Create a modal to show all targets
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px;">
                        <div class="modal-header">
                            <h2 class="modal-title">🎯 All Student Targets Overview</h2>
                            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="entry-form">
                                <div class="form-group">
                                    <label class="form-label">Select Academic Year</label>
                                    <select class="form-select" id="officeTargetYearSelect" onchange="loadAllStudentTargetsForYear()">
                                        <option value="">Choose academic year</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2025-2026">2025-2026</option>
                                        <option value="2026-2027">2026-2027</option>
                                    </select>
                                </div>
                                
                                <div id="allTargetsDisplay" style="display: none;">
                                    <!-- All targets will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Error showing office targets modal:', error);
                alert('Error loading targets: ' + error.message);
            }
        }

        async function loadAllStudentTargetsForYear() {
            const selectedYear = document.getElementById('officeTargetYearSelect').value;
            const display = document.getElementById('allTargetsDisplay');
            
            if (!selectedYear) {
                display.style.display = 'none';
                return;
            }
            
            try {
                const students = await window.getStudents();
                let allTargetsHtml = '';
                
                for (const student of students) {
                    const targets = await getStudentTargetsForYear(student.id, selectedYear);
                    
                    allTargetsHtml += `
                        <div class="target-view-section">
                            <div class="target-view-title">
                                👤 ${student.name}
                            </div>
                    `;
                    
                    if (targets.yearly && targets.yearly.text) {
                        const statusBadge = targets.yearly.status ? 
                            `<span class="target-status-badge ${targets.yearly.status}">
                                ${targets.yearly.status === 'above' ? 'Above Target' : 
                                  targets.yearly.status === 'on' ? 'On Target' : 'Below Target'}
                            </span>` : '';
                        
                        allTargetsHtml += `
                            <div class="target-view-item">
                                <div class="target-view-month">Yearly Target (${selectedYear})</div>
                                <div class="target-view-text">${targets.yearly.text}</div>
                                ${statusBadge}
                            </div>
                        `;
                    } else {
                        allTargetsHtml += `
                            <div class="target-view-item">
                                <div class="target-view-text" style="color: #8E8E93; font-style: italic;">No yearly target set</div>
                            </div>
                        `;
                    }
                    
                    allTargetsHtml += '</div>';
                }
                
                display.innerHTML = allTargetsHtml;
                display.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading all student targets:', error);
                display.innerHTML = '<p style="color: #FF3B30; text-align: center;">Error loading targets</p>';
                display.style.display = 'block';
            }
        }

        async function getStudentTargets(studentId) {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const targetDoc = await getDoc(doc(db, 'studentTargets', studentId));
                if (targetDoc.exists()) {
                    return targetDoc.data();
                }
                return { yearly: {}, monthly: {} };
            } catch (error) {
                console.error('Error fetching student targets:', error);
                return { yearly: {}, monthly: {} };
            }
        }

        // View Targets Modal (Parent)
        async function showViewTargetsModal() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                // FIXED: Use current academic year for parents
                const academicYear = currentAcademicYear || await getCurrentAcademicYear();
                const targets = await getStudentTargetsForYear(currentStudent, academicYear);
                const content = document.getElementById('viewTargetsContent');
                
                if (!targets || (!targets.yearly?.text && Object.keys(targets.monthly || {}).length === 0)) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">🎯</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Targets Set</h3>
                            <p style="color: #8E8E93; font-size: 16px;">The Ustaadh hasn't set any targets for academic year ${academicYear} yet.</p>
                        </div>
                    `;
                } else {
                    let contentHtml = '';
                    
                    // Yearly Target
                    if (targets.yearly && targets.yearly.text) {
                        const statusBadge = targets.yearly.status ? 
                            `<span class="target-status-badge ${targets.yearly.status}">
                                ${targets.yearly.status === 'above' ? 'Above Target' : 
                                targets.yearly.status === 'on' ? 'On Target' : 'Below Target'}
                            </span>` : '';
                        
                        contentHtml += `
                            <div class="target-view-section">
                                <div class="target-view-title">
                                    📅 Yearly Target (${academicYear})
                                </div>
                                <div class="target-view-item ${targets.yearly.status ? targets.yearly.status + '-target' : ''}">
                                    <div class="target-view-text">${targets.yearly.text}</div>
                                    ${statusBadge}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Monthly Targets - FIXED: Use correct academic year months
                    const monthlyTargets = targets.monthly || {};
                    const hasMonthlyTargets = Object.keys(monthlyTargets).some(key => monthlyTargets[key].text);
                    
                    if (hasMonthlyTargets) {
                        contentHtml += `
                            <div class="target-view-section">
                                <div class="target-view-title">
                                    📆 Monthly Targets (${academicYear})
                                </div>
                        `;
                        
                        // FIXED: Generate month names for the correct academic year
                        const [startYear, endYear] = academicYear.split('-');
                        const monthNames = {
                            [`${startYear}-09`]: `September ${startYear}`,
                            [`${startYear}-10`]: `October ${startYear}`,
                            [`${startYear}-11`]: `November ${startYear}`,
                            [`${startYear}-12`]: `December ${startYear}`,
                            [`${endYear}-01`]: `January ${endYear}`,
                            [`${endYear}-02`]: `February ${endYear}`,
                            [`${endYear}-03`]: `March ${endYear}`,
                            [`${endYear}-04`]: `April ${endYear}`,
                            [`${endYear}-05`]: `May ${endYear}`,
                            [`${endYear}-06`]: `June ${endYear}`,
                            [`${endYear}-07`]: `July ${endYear}`,
                            [`${endYear}-08`]: `August ${endYear}`
                        };
                        
                        // Only show months that exist in the current academic year
                        Object.keys(monthNames).forEach(monthKey => {
                            const monthData = monthlyTargets[monthKey];
                            if (monthData && monthData.text) {
                                const statusBadge = monthData.status ? 
                                    `<span class="target-status-badge ${monthData.status}">
                                        ${monthData.status === 'above' ? 'Above Target' : 
                                        monthData.status === 'on' ? 'On Target' : 'Below Target'}
                                    </span>` : '';
                                
                                contentHtml += `
                                    <div class="target-view-item ${monthData.status ? monthData.status + '-target' : ''}">
                                        <div class="target-view-month">${monthNames[monthKey]}</div>
                                        <div class="target-view-text">${monthData.text}</div>
                                        ${statusBadge}
                                    </div>
                                `;
                            }
                        });
                        
                        contentHtml += '</div>';
                    }
                    
                    content.innerHTML = contentHtml;
                }
                
                document.getElementById('viewTargetsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading targets:', error);
                alert('Error loading targets: ' + error.message);
            }
        }

        // NEW: Office Targets Modal (like parents view)
        async function showOfficeTargetsModal() {
            if (currentUserType !== 'office') return;
            
            try {
                const students = await window.getStudents();
                
                if (students.length === 0) {
                    alert('No students found');
                    return;
                }
                
                // Create modal similar to parent targets view
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2 class="modal-title">🎯 Student Targets</h2>
                            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="entry-form">
                                <div class="form-group">
                                    <label class="form-label">Select Student</label>
                                    <select class="form-select" id="officeTargetsStudentSelect" onchange="loadOfficeStudentTargets()">
                                        <option value="">Choose student</option>
                                        ${students.map(student => `<option value="${student.id}">${student.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div id="officeTargetsContent">
                                    <!-- Targets will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
            } catch (error) {
                console.error('Error showing office targets modal:', error);
                alert('Error loading targets: ' + error.message);
            }
        }

        async function loadOfficeStudentTargets() {
            const studentId = document.getElementById('officeTargetsStudentSelect').value;
            const content = document.getElementById('officeTargetsContent');
            
            if (!studentId) {
                content.innerHTML = '';
                return;
            }
            
            try {
                // Use current academic year
                const academicYear = currentAcademicYear || await getCurrentAcademicYear();
                const targets = await getStudentTargetsForYear(studentId, academicYear);
                const students = await window.getStudents();
                const student = students.find(s => s.id === studentId);
                
                if (!targets || (!targets.yearly?.text && Object.keys(targets.monthly || {}).length === 0)) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">🎯</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Targets Set</h3>
                            <p style="color: #8E8E93; font-size: 16px;">No targets have been set for ${student.name} in academic year ${academicYear}.</p>
                        </div>
                    `;
                } else {
                    // Display targets similar to parent view
                    let contentHtml = '';
                    
                    // Yearly Target
                    if (targets.yearly && targets.yearly.text) {
                        const statusBadge = targets.yearly.status ? 
                            `<span class="target-status-badge ${targets.yearly.status}">
                                ${targets.yearly.status === 'above' ? 'Above Target' : 
                                targets.yearly.status === 'on' ? 'On Target' : 'Below Target'}
                            </span>` : '';
                        
                        contentHtml += `
                            <div class="target-view-section">
                                <div class="target-view-title">
                                    📅 Yearly Target (${academicYear})
                                </div>
                                <div class="target-view-item ${targets.yearly.status ? targets.yearly.status + '-target' : ''}">
                                    <div class="target-view-text">${targets.yearly.text}</div>
                                    ${statusBadge}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Monthly Targets - same logic as parent view but using academic year months
                    const monthlyTargets = targets.monthly || {};
                    const hasMonthlyTargets = Object.keys(monthlyTargets).some(key => monthlyTargets[key].text);
                    
                    if (hasMonthlyTargets) {
                        contentHtml += `
                            <div class="target-view-section">
                                <div class="target-view-title">
                                    📆 Monthly Targets
                                </div>
                        `;
                        
                        // Generate month names for academic year
                        const [startYear, endYear] = academicYear.split('-');
                        const monthNames = {
                            [`${startYear}-09`]: `September ${startYear}`,
                            [`${startYear}-10`]: `October ${startYear}`,
                            [`${startYear}-11`]: `November ${startYear}`,
                            [`${startYear}-12`]: `December ${startYear}`,
                            [`${endYear}-01`]: `January ${endYear}`,
                            [`${endYear}-02`]: `February ${endYear}`,
                            [`${endYear}-03`]: `March ${endYear}`,
                            [`${endYear}-04`]: `April ${endYear}`,
                            [`${endYear}-05`]: `May ${endYear}`,
                            [`${endYear}-06`]: `June ${endYear}`,
                            [`${endYear}-07`]: `July ${endYear}`,
                            [`${endYear}-08`]: `August ${endYear}`
                        };
                        
                        Object.keys(monthNames).forEach(monthKey => {
                            const monthData = monthlyTargets[monthKey];
                            if (monthData && monthData.text) {
                                const statusBadge = monthData.status ? 
                                    `<span class="target-status-badge ${monthData.status}">
                                        ${monthData.status === 'above' ? 'Above Target' : 
                                        monthData.status === 'on' ? 'On Target' : 'Below Target'}
                                    </span>` : '';
                                
                                contentHtml += `
                                    <div class="target-view-item ${monthData.status ? monthData.status + '-target' : ''}">
                                        <div class="target-view-month">${monthNames[monthKey]}</div>
                                        <div class="target-view-text">${monthData.text}</div>
                                        ${statusBadge}
                                    </div>
                                `;
                            }
                        });
                        
                        contentHtml += '</div>';
                    }
                    
                    content.innerHTML = contentHtml;
                }
                
            } catch (error) {
                console.error('Error loading student targets:', error);
                content.innerHTML = '<p style="color: #FF3B30; text-align: center;">Error loading targets</p>';
            }
        }

        // Message Functions
        async function saveMessage(messageData) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const messageId = `${messageData.studentId}_${Date.now()}`;
                
                await setDoc(doc(db, 'messages', messageId), {
                    ...messageData,
                    messageId: messageId,
                    sentDate: new Date().toISOString(),
                    read: false
                });
                
                console.log('Message saved:', messageId);
            } catch (error) {
                console.error('Error saving message:', error);
                throw error;
            }
        }

        async function getStudentMessages(studentId) {
            try {
                const { getDocs, collection, query, where } = window.firebaseModules;
                const { db } = window.firebase;
                
                const q = query(
                    collection(db, 'messages'), 
                    where('studentId', '==', studentId)
                );
                
                const querySnapshot = await getDocs(q);
                const messages = [];
                
                querySnapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by sent date (newest first)
                messages.sort((a, b) => new Date(b.sentDate) - new Date(a.sentDate));
                
                return messages;
            } catch (error) {
                console.error('Error fetching messages:', error);
                return [];
            }
        }

        async function markMessageAsRead(messageId) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await updateDoc(doc(db, 'messages', messageId), {
                    read: true,
                    readDate: new Date().toISOString()
                });
                
                console.log('Message marked as read:', messageId);
            } catch (error) {
                console.error('Error marking message as read:', error);
                throw error;
            }
        }

        async function getAllMessages() {
            try {
                const { getDocs, collection, orderBy, query } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Try to get all messages first to see what's there
                const messagesRef = collection(db, 'messages');
                const querySnapshot = await getDocs(messagesRef);
                const messages = [];
                
                console.log('Raw message documents found:', querySnapshot.size);
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('Message document:', doc.id, data);
                    
                    // Make sure we have the messageId field
                    messages.push({ 
                        messageId: doc.id, // Use document ID as messageId
                        id: doc.id, 
                        ...data 
                    });
                });
                
                // Sort by sentDate manually if needed
                messages.sort((a, b) => {
                    const dateA = new Date(a.sentDate || 0);
                    const dateB = new Date(b.sentDate || 0);
                    return dateB - dateA; // Newest first
                });
                
                console.log('Processed messages:', messages);
                return messages;
                
            } catch (error) {
                console.error('Error fetching all messages:', error);
                return [];
            }
        }

        // Academic Year Management Functions
        let currentAcademicYear = null;

        async function showAcademicYearModal() {
            if (currentUserType !== 'teacher') return;
            
            // Load current academic year setting
            const academicYear = await getCurrentAcademicYear();
            document.getElementById('academicYearSelect').value = academicYear || '2024-2025';
            
            document.getElementById('academicYearModal').style.display = 'block';
        }

        async function saveAcademicYear() {
            const selectedYear = document.getElementById('academicYearSelect').value;
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await setDoc(doc(db, 'config', 'academicYear'), {
                    currentYear: selectedYear,
                    setBy: 'Ustaadh',
                    setDate: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                });
                
                currentAcademicYear = selectedYear;
                closeModal('academicYearModal');
                
                alert(`Academic Year set to: ${selectedYear}\n\nParents and Office users will now only see data from this academic year.`);
                
                // Refresh data for current user if needed
                if (currentUserType === 'office' || currentUserType === 'parent') {
                    updateTodaysProgress();
                    updateStats();
                    generateCalendar();
                }
                
            } catch (error) {
                console.error('Error saving academic year:', error);
                alert('Error saving academic year: ' + error.message);
            }
        }

        async function getCurrentAcademicYear() {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const academicYearDoc = await getDoc(doc(db, 'config', 'academicYear'));
                if (academicYearDoc.exists()) {
                    return academicYearDoc.data().currentYear;
                }
                return '2024-2025'; // Default
            } catch (error) {
                console.error('Error fetching academic year:', error);
                return '2024-2025';
            }
        }

        // Helper function to get academic year date range
        function getAcademicYearDateRange(academicYear) {
            const [startYear, endYear] = academicYear.split('-');
            return {
                start: `${startYear}-09-01`, // September 1st
                end: `${endYear}-08-31`,     // August 31st
                startYear: parseInt(startYear),
                endYear: parseInt(endYear)
            };
        }

        // Helper function to check if date is in academic year
        function isDateInAcademicYear(dateString, academicYear) {
            const dateRange = getAcademicYearDateRange(academicYear);
            return dateString >= dateRange.start && dateString <= dateRange.end;
        }

        // Add event listener for overview student select
        document.addEventListener('DOMContentLoaded', function() {
            const overviewSelect = document.getElementById('overviewStudentSelect');
            if (overviewSelect) {
                overviewSelect.addEventListener('change', onOverviewStudentChange);
            }
        });

        // Make functions available globally
        window.showUpdateStudentOverviewModal = showUpdateStudentOverviewModal;
        window.onOverviewStudentChange = onOverviewStudentChange;
        window.updateJuzDate = updateJuzDate;
        window.saveStudentOverview = saveStudentOverview;
        window.showOverallProgressModal = showOverallProgressModal;

        window.getStudents = async function() {
            // Hardcoded student data instead of fetching from CSV
            const students = [
                { id: 'arafat_rayyan', name: 'Arafat Rayyan', quranType: 13, accessCode: '151110' },
                { id: 'ayyan_miah', name: 'Ayyan Miah', quranType: 13, accessCode: '120416' },
                { id: 'ishaq_noor', name: 'Ishaq Noor', quranType: 15, accessCode: '070213' },
                { id: 'ismail_hussain', name: 'Ismail Hussain', quranType: 15, accessCode: '220218' },
                { id: 'naveed_khan', name: 'Naveed Khan', quranType: 13, accessCode: '030213' },
                { id: 'rayhan_rahman', name: 'Rayhan Rahman', quranType: 13, accessCode: '290914' }
            ];
            
            return students.sort((a, b) => a.name.localeCompare(b.name));
        };

        window.getStudentData = async function(studentId) {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const progressDoc = await getDoc(doc(db, 'progress', studentId));
                const studentDoc = await getDoc(doc(db, 'students', studentId));
                
                let progressData = {};
                if (progressDoc.exists()) {
                    progressData = progressDoc.data();
                }
                
                let studentInfo = {};
                if (studentDoc.exists()) {
                    studentInfo = studentDoc.data();
                }
                
                return { ...progressData, ...studentInfo };
            } catch (error) {
                console.error('Error fetching student data:', error);
                return {};
            }
        };

        window.saveStudentData = async function(studentId, data) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Separate student info from progress data
                const { quranType, name, parentEmail, accessCode, ...progressData } = data;
                
                // Save progress data
                await setDoc(doc(db, 'progress', studentId), progressData);
                
                // Save student info if available
                if (quranType || name || parentEmail || accessCode) {
                    await setDoc(doc(db, 'students', studentId), {
                        quranType: quranType || 13,
                        name: name || '',
                        parentEmail: parentEmail || '',
                        accessCode: accessCode || '',
                        lastUpdated: new Date().toISOString()
                    });
                }
                
                console.log(`Student data saved for ${studentId}`);
            } catch (error) {
                console.error('Error saving student data:', error);
                throw error;
            }
        };

        function getDateKey(date = new Date()) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        async function updateTodaysProgress() {
            if (!currentStudent) return;
            
            const today = new Date();
            const todayKey = getDateKey(today);
            const studentData = await window.getStudentData(currentStudent);
            const todayData = studentData[todayKey] || {};
            
            // Check if today is weekend or holiday
            const isWeekendToday = isWeekend(today);
            const isHolidayToday = isHolidayDate(today);
            const holidayInfo = getHolidayInfo(today);
            
            // Get UI elements
            const progressSectionTitle = document.getElementById('progressSectionTitle');
            const progressContainer = document.getElementById('todayProgressContainer');
            const absentButton = document.getElementById('absentButton');
            
            if (isWeekendToday) {
                // Weekend mode - show mosque closed message
                progressSectionTitle.textContent = 'Weekend - Mosque Closed';
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                
                // Show weekend closed message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🕌</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Mosque Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No regular classes</p>
                        <div style="margin-top: 20px; padding: 12px; background: #E8F4FD; border-radius: 8px; font-size: 14px; color: #1E40AF;">
                            Classes resume on Monday
                        </div>
                    </div>
                `;
                
                // Hide parent check section on weekends
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            } else if (isHolidayToday && holidayInfo) {
                // Holiday mode - show holiday message
                progressSectionTitle.textContent = `Holiday - ${holidayInfo.name}`;
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                
                // Show holiday message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Maktab Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Holiday - ${holidayInfo.name}</p>
                        <div style="margin-top: 20px; padding: 12px; background: #FFF3CD; border-radius: 8px; font-size: 14px; color: #856404;">
                            🗓️ Holiday Period
                        </div>
                    </div>
                `;
                
                // Hide parent check section on holidays
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            }
            
            // Weekday mode - restore normal progress display
            progressSectionTitle.textContent = 'Today\'s Progress';
            
            // Show absent button for teachers
            if (currentUserType === 'teacher' && absentButton) {
                absentButton.style.display = 'inline-block';
            }
            
            // Restore progress rows structure if it was changed
            progressContainer.innerHTML = `
                <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                    <div class="progress-info">
                        <div class="progress-icon sabak">📖</div>
                        <div class="progress-details">
                            <h4>Sabak</h4>
                            <p>New Lesson</p>
                        </div>
                    </div>
                    <div class="progress-status" id="sabakStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                    <div class="progress-info">
                        <div class="progress-icon para">🔄</div>
                        <div class="progress-details">
                            <h4>Sabak Para</h4>
                            <p>Previous Lessons</p>
                        </div>
                    </div>
                    <div class="progress-status" id="paraStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                    <div class="progress-info">
                        <div class="progress-icon dhor">💭</div>
                        <div class="progress-details">
                            <h4>Dhor</h4>
                            <p>Revision</p>
                        </div>
                    </div>
                    <div class="progress-status" id="dhorStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
            `;
            
            // Update UI based on user type for weekdays
            updateUIForUserType();
            
            // Update progress display
            progressTypes.forEach(type => {
                const statusEl = document.getElementById(`${type}Status`);
                const entry = todayData[type];
                
                if (entry) {
                    if (type === 'sabak' && entry.lines) {
                        const conversionInfo = entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : '';
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <span class="amount-badge">${entry.lines} lines</span>
                                    <span class="grade-badge ${entry.grade}"></span>
                                    ${parentCheckHtml}
                                </div>
                                ${conversionInfo}
                            </div>
                        `;
                    } else {
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <span class="amount-badge">${entry.amount || entry.lines + ' lines'}</span>
                                <span class="grade-badge ${entry.grade}"></span>
                                ${parentCheckHtml}
                            </div>
                        `;
                    }
                } else {
                    statusEl.innerHTML = '<span class="amount-badge">--</span>';
                }
            });

            // Update absent button for teachers
            if (currentUserType === 'teacher' && absentButton) {
                const progressContainer = document.getElementById('todayProgressContainer');
                const isAbsent = todayData.absent || false;
                
                if (isAbsent) {
                    absentButton.textContent = '✓ Present';
                    absentButton.classList.add('active');
                    progressContainer.classList.add('absent');
                } else {
                    absentButton.textContent = '🔴 Absent';
                    absentButton.classList.remove('active');
                    progressContainer.classList.remove('absent');
                }
            }

            // Update parent check section and button for parents (only on weekdays)
            if (currentUserType === 'parent') {
                const parentCheckSection = document.getElementById('parentCheckSection');
                const parentCheckButton = document.getElementById('parentCheckButton');
                
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'block';
                }
                
                if (parentCheckButton) {
                    if (todayData.parentChecked) {
                        parentCheckButton.textContent = '✓ Checked';
                        parentCheckButton.classList.add('checked');
                    } else {
                        parentCheckButton.textContent = '✓ Mark as Checked';
                        parentCheckButton.classList.remove('checked');
                    }
                }
            }
        }

        async function updateStats() {
            if (!currentStudent) return;
            
            const studentData = await window.getStudentData(currentStudent);
            const stats = { sabak: 0, para: 0, dhor: 0 };
            
            const currentMonth = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}`;
            
            // Update the monthly progress title with current viewing month/year
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'];
            const monthlyProgressTitle = document.getElementById('monthlyProgressTitle');
            if (monthlyProgressTitle) {
                monthlyProgressTitle.textContent = `${monthNames[currentDisplayMonth - 1]} ${currentDisplayYear} Progress`;
            }
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                // Filter by academic year for Parents and Office
                if (currentUserType === 'parent' || currentUserType === 'office') {
                    if (!currentAcademicYear || !isDateInAcademicYear(date, currentAcademicYear)) {
                        return; // Skip dates outside academic year
                    }
                }
                
                if (date.startsWith(currentMonth)) {
                    progressTypes.forEach(type => {
                        if (dayData[type]) {
                            stats[type]++;
                        }
                    });
                }
            });
            
            document.getElementById('sabakCount').textContent = stats.sabak;
            document.getElementById('paraCount').textContent = stats.para;
            document.getElementById('dhorCount').textContent = stats.dhor;
        }

        function openProgressModal(type, title) {
            // Only allow teachers to open progress modal
            if (currentUserType !== 'teacher') return;
            
            currentProgressType = type;
            currentDate = null;
            document.getElementById('modalTitle').textContent = `${title} Progress`;
            
            // Show appropriate input fields based on type
            const linesInputGroup = document.getElementById('linesInputGroup');
            const amountInputGroup = document.getElementById('amountInputGroup');
            const linesInput = document.getElementById('linesInput');
            const amountInput = document.getElementById('amountInput');
            
            if (type === 'sabak') {
                linesInputGroup.style.display = 'block';
                amountInputGroup.style.display = 'none';
                linesInput.value = '';
            } else {
                linesInputGroup.style.display = 'none';
                amountInputGroup.style.display = 'block';
                amountInput.value = '';
            }
            
            selectedGrade = null;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateConversionDisplay();
            document.getElementById('progressModal').style.display = 'block';
            
            linesInput.addEventListener('input', updateConversionDisplay);
        }

        function selectGrade(grade) {
            selectedGrade = grade;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-grade="${grade}"]`).classList.add('selected');
        }

        async function saveProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            let entryData = {
                grade: selectedGrade,
                timestamp: new Date().toISOString()
            };
            
            if (currentProgressType === 'sabak') {
                const lines = parseInt(document.getElementById('linesInput').value) || 0;
                if (!lines || !selectedGrade) {
                    alert('Please enter number of lines and select a grade');
                    return;
                }
                
                const students = await window.getStudents();
                const student = students.find(s => s.id === currentStudent);
                const quranType = student ? student.quranType || 13 : 13;
                
                const conversion = convertLinesToPagesAndJuz(lines, quranType);
                
                entryData.lines = lines;
                entryData.amount = `${lines} lines`;
                entryData.pages = conversion.pages;
                entryData.juz = conversion.juz;
                entryData.fraction = conversion.fraction;
                entryData.quranType = quranType;
            } else {
                const amount = document.getElementById('amountInput').value.trim();
                if (!amount || !selectedGrade) {
                    alert('Please enter amount and select a grade');
                    return;
                }
                
                entryData.amount = amount;
            }
            
            const dateKey = currentDate || getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[dateKey]) {
                studentData[dateKey] = {};
            }
            
            studentData[dateKey][currentProgressType] = entryData;
            
            await window.saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            closeModal('progressModal');
            
            if (currentDate && currentDate !== getDateKey()) {
                setTimeout(() => {
                    const dayNumber = parseInt(currentDate.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        async function clearProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            const dateKey = currentDate || getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (studentData[dateKey] && studentData[dateKey][currentProgressType]) {
                delete studentData[dateKey][currentProgressType];
                
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                await window.saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('progressModal');
                
                if (currentDate && currentDate !== getDateKey()) {
                    setTimeout(() => {
                        const dayNumber = parseInt(currentDate.split('-')[2]);
                        openDayModal(dayNumber);
                    }, 200);
                }
            }
        }

        // ===== NEW FUNCTION: Toggle Did Not Give =====
        async function toggleDidNotGive() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const today = getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[today]) {
                studentData[today] = {};
            }
            
            const isCurrentlyDidNotGive = studentData[today].didNotGive || false;
            
            if (isCurrentlyDidNotGive) {
                delete studentData[today].didNotGive;
                if (Object.keys(studentData[today]).length === 0) {
                    delete studentData[today];
                }
            } else {
                // Clear any existing absent status and progress when marking as "did not give"
                studentData[today] = { didNotGive: true };
            }
            
            await window.saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
        }

        // ===== UPDATED FUNCTION: Toggle Absent =====
        async function toggleAbsent() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const today = getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[today]) {
                studentData[today] = {};
            }
            
            const isCurrentlyAbsent = studentData[today].absent || false;
            
            if (isCurrentlyAbsent) {
                delete studentData[today].absent;
                if (Object.keys(studentData[today]).length === 0) {
                    delete studentData[today];
                }
            } else {
                // Clear any existing "did not give" status and progress when marking as absent
                studentData[today] = { absent: true };
            }
            
            await window.saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
        }

        // ===== NEW FUNCTION: Mark Day as Did Not Give =====
        async function markDayDidNotGive(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            studentData[dateKey] = { didNotGive: true };
            
            await window.saveStudentData(currentStudent, studentData);
            generateCalendar();
            closeModal('dayModal');
            
            setTimeout(() => {
                const dayNumber = parseInt(dateKey.split('-')[2]);
                openDayModal(dayNumber);
            }, 200);
        }

        // ===== NEW FUNCTION: Remove Did Not Give Status =====
        async function removeDidNotGive(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            if (studentData[dateKey] && studentData[dateKey].didNotGive) {
                delete studentData[dateKey].didNotGive;
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                await window.saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('dayModal');
                
                setTimeout(() => {
                    const dayNumber = parseInt(dateKey.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        async function toggleParentCheck(dateKey = null) {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            const targetDate = dateKey || getDateKey();
            
            // Get button references
            const dayModal = document.getElementById('dayModal');
            let parentCheckButton = null;
            
            if (dayModal && dayModal.style.display === 'block') {
                parentCheckButton = dayModal.querySelector('button[onclick*="toggleParentCheck"]');
            }
            
            const mainParentCheckButton = document.getElementById('parentCheckButton');
            
            // Get current state
            let currentData;
            try {
                currentData = await window.getStudentData(currentStudent);
            } catch (error) {
                console.error('Error getting student data:', error);
                return;
            }
            
            if (!currentData[targetDate]) {
                currentData[targetDate] = {};
            }
            
            const wasChecked = currentData[targetDate].parentChecked || false;
            const isNowChecked = !wasChecked;
            
            // IMMEDIATELY update UI (optimistic update)
            if (parentCheckButton) {
                const buttonText = isNowChecked ? '✓ Checked by Parent' : '✓ Mark as Checked';
                const buttonColor = isNowChecked ? '#8E8E93' : '#34C759';
                
                parentCheckButton.textContent = buttonText;
                parentCheckButton.style.background = buttonColor;
                
                // Brief animation
                parentCheckButton.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    parentCheckButton.style.transform = 'scale(1)';
                }, 150);
            }
            
            if (mainParentCheckButton && (!dateKey || dateKey === getDateKey())) {
                if (isNowChecked) {
                    mainParentCheckButton.textContent = '✓ Checked';
                    mainParentCheckButton.classList.add('checked');
                } else {
                    mainParentCheckButton.textContent = '✓ Mark as Checked';
                    mainParentCheckButton.classList.remove('checked');
                }
            }
            
            // Update parent status indicators in modal
            if (dayModal && dayModal.style.display === 'block') {
                const parentStatusRows = dayModal.querySelectorAll('div[style*="background: #F0F9FF"], div[style*="background: #FEF2F2"]');
                parentStatusRows.forEach(row => {
                    if (row.textContent.includes('Reviewed by Parent') || row.textContent.includes('Not yet reviewed')) {
                        if (isNowChecked) {
                            row.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600;';
                            row.innerHTML = '✓ Reviewed by Parent';
                        } else {
                            row.style.cssText = 'padding: 16px 24px; background: #FEF2F2; border-top: 1px solid #FECACA; text-align: center; color: #DC2626; font-size: 14px; font-weight: 600;';
                            row.innerHTML = '✗ Not yet reviewed by Parent';
                        }
                    }
                });
            }
            
            // Show immediate success message
            const successMessage = document.createElement('div');
            successMessage.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10A37F;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            successMessage.textContent = isNowChecked ? '✓ Marked as checked' : '✓ Unmarked';
            document.body.appendChild(successMessage);
            
            setTimeout(() => {
                if (document.body.contains(successMessage)) {
                    document.body.removeChild(successMessage);
                }
            }, 2000);
            
            // Now save in background (don't block UI)
            try {
                // Update data
                currentData[targetDate].parentChecked = isNowChecked;
                currentData[targetDate].parentCheckTimestamp = new Date().toISOString();
                
                // Save with retry logic
                let saveSuccess = false;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (!saveSuccess && attempts < maxAttempts) {
                    attempts++;
                    console.log(`Parent check save attempt ${attempts}/${maxAttempts}`);
                    
                    try {
                        await window.saveStudentData(currentStudent, currentData);
                        saveSuccess = true;
                        console.log(`Parent check ${isNowChecked ? 'marked' : 'unmarked'} for ${targetDate} (attempt ${attempts})`);
                        
                    } catch (saveError) {
                        console.error(`Save attempt ${attempts} failed:`, saveError);
                        
                        if (attempts >= maxAttempts) {
                            throw saveError;
                        }
                        
                        // Wait before retry (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempts));
                    }
                }
                
                // Update other UI components in background (non-blocking)
                setTimeout(async () => {
                    try {
                        if (!dateKey || dateKey === getDateKey()) {
                            await updateTodaysProgress();
                        }
                        generateCalendar();
                    } catch (uiError) {
                        console.warn('Non-critical UI update error:', uiError);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error saving parent check:', error);
                
                // REVERT UI on save failure
                if (parentCheckButton) {
                    const buttonText = wasChecked ? '✓ Checked by Parent' : '✓ Mark as Checked';
                    const buttonColor = wasChecked ? '#8E8E93' : '#34C759';
                    
                    parentCheckButton.textContent = buttonText;
                    parentCheckButton.style.background = buttonColor;
                }
                
                if (mainParentCheckButton && (!dateKey || dateKey === getDateKey())) {
                    if (wasChecked) {
                        mainParentCheckButton.textContent = '✓ Checked';
                        mainParentCheckButton.classList.add('checked');
                    } else {
                        mainParentCheckButton.textContent = '✓ Mark as Checked';
                        mainParentCheckButton.classList.remove('checked');
                    }
                }
                
                // Revert parent status indicators
                if (dayModal && dayModal.style.display === 'block') {
                    const parentStatusRows = dayModal.querySelectorAll('div[style*="background: #F0F9FF"], div[style*="background: #FEF2F2"]');
                    parentStatusRows.forEach(row => {
                        if (row.textContent.includes('Reviewed by Parent') || row.textContent.includes('Not yet reviewed')) {
                            if (wasChecked) {
                                row.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600;';
                                row.innerHTML = '✓ Reviewed by Parent';
                            } else {
                                row.style.cssText = 'padding: 16px 24px; background: #FEF2F2; border-top: 1px solid #FECACA; text-align: center; color: #DC2626; font-size: 14px; font-weight: 600;';
                                row.innerHTML = '✗ Not yet reviewed by Parent';
                            }
                        }
                    });
                }
                
                // Log error for debugging but don't show to user since optimistic update worked
                console.warn('Background save may have failed, but UI was updated optimistically:', error);
            }
        }

        // ===== COMPLETE: generateCalendar Function =====
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('monthTitle');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthTitle.textContent = `${monthNames[currentDisplayMonth - 1]} ${currentDisplayYear}`;
            
            grid.innerHTML = '';
            
            // Show all 7 days of the week including weekends
            const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            dayHeaders.forEach(header => {
                const headerEl = document.createElement('div');
                headerEl.className = 'day-header';
                headerEl.textContent = header;
                grid.appendChild(headerEl);
            });
            
            const firstDay = new Date(currentDisplayYear, currentDisplayMonth - 1, 1);
            const lastDay = new Date(currentDisplayYear, currentDisplayMonth, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get the first Monday of the calendar grid
            const startDate = new Date(firstDay);
            const dayOfWeek = firstDay.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0, Sunday = 6
            startDate.setDate(firstDay.getDate() - daysToSubtract);
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentDisplayYear && 
                                today.getMonth() + 1 === currentDisplayMonth;
            const todayDate = today.getDate();
            
            // Generate calendar grid (6 weeks = 42 days)
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const day = currentDate.getDate();
                const isCurrentMonthDay = currentDate.getMonth() + 1 === currentDisplayMonth;
                const dayOfWeek = currentDate.getDay();
                const isWeekendDay = (dayOfWeek === 0 || dayOfWeek === 6); // Saturday = 6, Sunday = 0
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div style="opacity: ${isCurrentMonthDay ? '1' : '0.3'}">${day}</div>`;
                
                // Add click handler only for current month days
                if (isCurrentMonthDay) {
                    dayEl.style.cursor = 'pointer';
                    dayEl.addEventListener('click', function() {
                        openDayModal(day);
                    });
                }
                
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Style weekends - just lighter text, no special background
                if (isWeekendDay && isCurrentMonthDay) {
                    dayEl.classList.add('weekend');
                }
                
                // Check if it's a holiday - holidays override weekend styling
                if (isCurrentMonthDay && isHolidayDate(currentDate)) {
                    dayEl.classList.add('holiday');
                    const holidayInfo = getHolidayInfo(currentDate);
                    if (holidayInfo) {
                        dayEl.title = `Holiday: ${holidayInfo.name}`;
                    }
                }
                
                if (currentStudent && isCurrentMonthDay) {
                    window.getStudentData(currentStudent).then(studentData => {
                        const dayData = studentData[dateKey];
                        
                        // Filter by academic year for Parents and Office
                        if ((currentUserType === 'parent' || currentUserType === 'office') && 
                            currentAcademicYear && 
                            !isDateInAcademicYear(dateKey, currentAcademicYear)) {
                            return; // Don't show data outside academic year
                        }
                        
                        if (dayData) {
                            dayEl.classList.add('has-data');
                            
                            if (dayData.absent) {
                                const absentIndicator = document.createElement('div');
                                absentIndicator.style.cssText = 'width: 8px; height: 8px; background: #FF3B30; border-radius: 50%; margin-top: 2px;';
                                dayEl.appendChild(absentIndicator);
                            } else if (dayData.didNotGive) {
                                // UPDATED: Add orange dot for "did not give" days
                                const didNotGiveIndicator = document.createElement('div');
                                didNotGiveIndicator.style.cssText = 'width: 8px; height: 8px; background: #FF9500; border-radius: 50%; margin-top: 2px;';
                                dayEl.appendChild(didNotGiveIndicator);
                            } else {
                                const indicators = document.createElement('div');
                                indicators.className = 'day-indicators';
                                
                                // Show progress indicators (only for weekdays)
                                if (!isWeekendDay) {
                                    progressTypes.forEach(type => {
                                        if (dayData[type]) {
                                            const indicator = document.createElement('div');
                                            indicator.className = `indicator ${type}`;
                                            indicators.appendChild(indicator);
                                        }
                                    });
                                }
                                
                                // Add parent check indicator (blue tick)
                                if (dayData.parentChecked) {
                                    const parentIndicator = document.createElement('div');
                                    parentIndicator.className = 'parent-check-tick';
                                    parentIndicator.textContent = '✓';
                                    parentIndicator.title = 'Checked by Parent';
                                    indicators.appendChild(parentIndicator);
                                }
                                
                                dayEl.appendChild(indicators);
                            }
                        }
                    });
                }
                
                if (isCurrentMonth && day === todayDate && isCurrentMonthDay) {
                    dayEl.classList.add('today');
                }
                
                grid.appendChild(dayEl);
            }
        }

        // ===== COMPLETE: updateTodaysProgress Function =====
        async function updateTodaysProgress() {
            if (!currentStudent) return;
            
            const today = new Date();
            const todayKey = getDateKey(today);
            const studentData = await window.getStudentData(currentStudent);
            const todayData = studentData[todayKey] || {};
            
            // Check if today is weekend or holiday
            const isWeekendToday = isWeekend(today);
            const isHolidayToday = isHolidayDate(today);
            const holidayInfo = getHolidayInfo(today);
            
            // Get UI elements
            const progressSectionTitle = document.getElementById('progressSectionTitle');
            const progressContainer = document.getElementById('todayProgressContainer');
            const absentButton = document.getElementById('absentButton');
            const didNotGiveButton = document.getElementById('didNotGiveButton');
            
            if (isWeekendToday) {
                // Weekend mode - show mosque closed message
                progressSectionTitle.textContent = 'Weekend - Mosque Closed';
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                if (didNotGiveButton) {
                    didNotGiveButton.style.display = 'none';
                }
                
                // Show weekend closed message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🕌</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Mosque Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No regular classes</p>
                        <div style="margin-top: 20px; padding: 12px; background: #E8F4FD; border-radius: 8px; font-size: 14px; color: #1E40AF;">
                            Classes resume on Monday
                        </div>
                    </div>
                `;
                
                // Hide parent check section on weekends
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            } else if (isHolidayToday && holidayInfo) {
                // Holiday mode - show holiday message
                progressSectionTitle.textContent = `Holiday - ${holidayInfo.name}`;
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                if (didNotGiveButton) {
                    didNotGiveButton.style.display = 'none';
                }
                
                // Show holiday message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Maktab Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Holiday - ${holidayInfo.name}</p>
                        <div style="margin-top: 20px; padding: 12px; background: #FFF3CD; border-radius: 8px; font-size: 14px; color: #856404;">
                            🗓️ Holiday Period
                        </div>
                    </div>
                `;
                
                // Hide parent check section on holidays
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            } else if (todayData.didNotGive) {
                // UPDATED: Did Not Give mode - show special message
                progressSectionTitle.textContent = 'Did Not Give Today';
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                if (didNotGiveButton) {
                    didNotGiveButton.style.display = 'none';
                }
                
                // Get student name for personalized message
                const students = await window.getStudents();
                const student = students.find(s => s.id === currentStudent);
                const studentName = student ? student.name : 'Student';
                
                // Show did not give message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #FF9500;">
                        <div style="font-size: 48px; margin-bottom: 20px;">😔</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">${studentName} did not give anything today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Please make sure he learns at home</p>
                        <div style="margin-top: 20px; padding: 12px; background: #FFF3E0; border-radius: 8px; font-size: 14px; color: #F57C00;">
                            📚 Home practice is important for progress
                        </div>
                    </div>
                `;
                
                // Hide parent check section when did not give
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            }
            
            // Weekday mode - restore normal progress display
            progressSectionTitle.textContent = 'Today\'s Progress';
            
            // UPDATED: Show buttons for teachers
            if (currentUserType === 'teacher') {
                if (absentButton) {
                    absentButton.style.display = 'inline-block';
                }
                if (didNotGiveButton) {
                    didNotGiveButton.style.display = 'inline-block';
                }
            }
            
            // Restore progress rows structure if it was changed
            progressContainer.innerHTML = `
                <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                    <div class="progress-info">
                        <div class="progress-icon sabak">📖</div>
                        <div class="progress-details">
                            <h4>Sabak</h4>
                            <p>New Lesson</p>
                        </div>
                    </div>
                    <div class="progress-status" id="sabakStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                    <div class="progress-info">
                        <div class="progress-icon para">🔄</div>
                        <div class="progress-details">
                            <h4>Sabak Para</h4>
                            <p>Previous Lessons</p>
                        </div>
                    </div>
                    <div class="progress-status" id="paraStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                    <div class="progress-info">
                        <div class="progress-icon dhor">💭</div>
                        <div class="progress-details">
                            <h4>Dhor</h4>
                            <p>Revision</p>
                        </div>
                    </div>
                    <div class="progress-status" id="dhorStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
            `;
            
            // Update UI based on user type for weekdays
            updateUIForUserType();
            
            // Update progress display
            progressTypes.forEach(type => {
                const statusEl = document.getElementById(`${type}Status`);
                const entry = todayData[type];
                
                if (entry) {
                    if (type === 'sabak' && entry.lines) {
                        const conversionInfo = entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : '';
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <span class="amount-badge">${entry.lines} lines</span>
                                    <span class="grade-badge ${entry.grade}"></span>
                                    ${parentCheckHtml}
                                </div>
                                ${conversionInfo}
                            </div>
                        `;
                    } else {
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <span class="amount-badge">${entry.amount || entry.lines + ' lines'}</span>
                                <span class="grade-badge ${entry.grade}"></span>
                                ${parentCheckHtml}
                            </div>
                        `;
                    }
                } else {
                    statusEl.innerHTML = '<span class="amount-badge">--</span>';
                }
            });

            // UPDATED: Update absent and did not give buttons for teachers
            if (currentUserType === 'teacher' && absentButton && didNotGiveButton) {
                const progressContainer = document.getElementById('todayProgressContainer');
                const isAbsent = todayData.absent || false;
                const isDidNotGive = todayData.didNotGive || false;
                
                if (isAbsent) {
                    absentButton.textContent = '✓ Present';
                    absentButton.classList.add('active');
                    didNotGiveButton.textContent = '🟠 Did Not Give';
                    didNotGiveButton.classList.remove('active');
                    progressContainer.classList.add('absent');
                    progressContainer.classList.remove('did-not-give');
                } else if (isDidNotGive) {
                    didNotGiveButton.textContent = '✓ Gave Today';
                    didNotGiveButton.classList.add('active');
                    absentButton.textContent = '🔴 Absent';
                    absentButton.classList.remove('active');
                    progressContainer.classList.add('did-not-give');
                    progressContainer.classList.remove('absent');
                } else {
                    absentButton.textContent = '🔴 Absent';
                    absentButton.classList.remove('active');
                    didNotGiveButton.textContent = '🟠 Did Not Give';
                    didNotGiveButton.classList.remove('active');
                    progressContainer.classList.remove('absent', 'did-not-give');
                }
            }

            // Update parent check section and button for parents (only on weekdays)
            if (currentUserType === 'parent') {
                const parentCheckSection = document.getElementById('parentCheckSection');
                const parentCheckButton = document.getElementById('parentCheckButton');
                
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'block';
                }
                
                if (parentCheckButton) {
                    if (todayData.parentChecked) {
                        parentCheckButton.textContent = '✓ Checked';
                        parentCheckButton.classList.add('checked');
                    } else {
                        parentCheckButton.textContent = '✓ Mark as Checked';
                        parentCheckButton.classList.remove('checked');
                    }
                }
            }
        }

        // ===== COMPLETE: openDayModal Function =====
        async function openDayModal(day) {
            if (!currentStudent) return;
            
            const dateKey = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(currentDisplayYear, currentDisplayMonth - 1, day);
            const isWeekendDay = isWeekend(date);
            const isHolidayDay = isHolidayDate(date);
            const holidayInfo = getHolidayInfo(date);
            
            const studentData = await window.getStudentData(currentStudent);
            const dayData = studentData[dateKey] || {};
            
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            document.getElementById('dayModalTitle').textContent = dateStr;
            
            const progressList = document.getElementById('dayProgressList');
            progressList.innerHTML = '';
            
            if (isWeekendDay) {
                // Weekend view
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🕌</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Mosque Closed</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No classes</p>
                    </div>
                `;
            } else if (isHolidayDay && holidayInfo) {
                // Holiday view
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Maktab Closed</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Holiday - ${holidayInfo.name}</p>
                    </div>
                `;
            } else {
                // Weekday view
                if (dayData.absent) {
                    // Get student name for personalized message
                    const students = await window.getStudents();
                    const student = students.find(s => s.id === currentStudent);
                    const studentName = student ? student.name : 'Student';
                    
                    let absentHtml = `
                        <div style="text-align: center; padding: 50px 30px; color: #FF3B30;">
                            <div style="font-size: 48px; margin-bottom: 20px;">😴</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">${studentName} was Absent</h3>
                            <p style="color: #8E8E93; font-size: 16px; margin-bottom: 20px;">No progress recorded for this day</p>
                    `;
                    
                    if (currentUserType === 'teacher') {
                        absentHtml += `
                            <button onclick="removeAbsent('${dateKey}')" style="
                                background: #10A37F; color: white; border: none; 
                                padding: 14px 24px; border-radius: 10px; 
                                font-size: 16px; font-weight: 600; 
                                cursor: pointer; margin-top: 20px;
                            ">Mark as Present</button>
                        `;
                    }
                    
                    absentHtml += '</div>';
                    progressList.innerHTML = absentHtml;
                } else if (dayData.didNotGive) {
                    // UPDATED: Did Not Give view
                    // Get student name for personalized message
                    const students = await window.getStudents();
                    const student = students.find(s => s.id === currentStudent);
                    const studentName = student ? student.name : 'Student';
                    
                    let didNotGiveHtml = `
                        <div style="text-align: center; padding: 50px 30px; color: #FF9500;">
                            <div style="font-size: 48px; margin-bottom: 20px;">😔</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">${studentName} did not give anything today</h3>
                            <p style="color: #8E8E93; font-size: 16px; margin-bottom: 20px;">Please make sure he learns at home</p>
                    `;
                    
                    if (currentUserType === 'teacher') {
                        didNotGiveHtml += `
                            <button onclick="removeDidNotGive('${dateKey}')" style="
                                background: #10A37F; color: white; border: none; 
                                padding: 14px 24px; border-radius: 10px; 
                                font-size: 16px; font-weight: 600; 
                                cursor: pointer; margin-top: 20px;
                            ">Mark as Gave Today</button>
                        `;
                    }
                    
                    didNotGiveHtml += '</div>';
                    progressList.innerHTML = didNotGiveHtml;
                } else {
                    // UPDATED: Add absent and did not give buttons for teachers only on non-absent/non-did-not-give days
                    if (currentUserType === 'teacher') {
                        const buttonDiv = document.createElement('div');
                        buttonDiv.style.marginBottom = '20px';
                        buttonDiv.innerHTML = `
                            <div style="display: flex; gap: 8px;">
                                <button onclick="markDayAbsent('${dateKey}')" style="
                                    background: #FF3B30; color: white; border: none; 
                                    padding: 14px 24px; border-radius: 10px; 
                                    font-size: 16px; font-weight: 600; 
                                    cursor: pointer; flex: 1;
                                ">🔴 Mark as Absent</button>
                                <button onclick="markDayDidNotGive('${dateKey}')" style="
                                    background: #FF9500; color: white; border: none; 
                                    padding: 14px 24px; border-radius: 10px; 
                                    font-size: 16px; font-weight: 600; 
                                    cursor: pointer; flex: 1;
                                ">🟠 Did Not Give</button>
                            </div>
                        `;
                        progressList.appendChild(buttonDiv);
                    }
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'today-progress';
                    progressContainer.style.marginTop = '20px';
                    
                    const progressData = [
                        { type: 'sabak', title: 'Sabak', icon: '📖' },
                        { type: 'para', title: 'Sabak Para', icon: '🔄' },
                        { type: 'dhor', title: 'Dhor', icon: '💭' }
                    ];
                    
                    progressData.forEach((item, index) => {
                        const entry = dayData[item.type];
                        
                        const progressRow = document.createElement('div');
                        progressRow.className = 'progress-row';
                        progressRow.style.padding = '24px';
                        progressRow.style.margin = '0 -8px';
                        
                        if (index < progressData.length - 1) {
                            progressRow.style.borderBottom = '1px solid #F2F2F7';
                        }
                        
                        let statusHtml = '<span class="amount-badge">--</span>';
                        if (entry) {
                            if (item.type === 'sabak' && entry.lines) {
                                statusHtml = `
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div style="display: flex; gap: 4px;">
                                            <span class="amount-badge">${entry.lines} lines</span>
                                            <span class="grade-badge ${entry.grade}"></span>
                                        </div>
                                        ${entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : ''}
                                    </div>
                                `;
                            } else {
                                statusHtml = `
                                    <div style="display: flex; gap: 4px;">
                                        <span class="amount-badge">${entry.amount}</span>
                                        <span class="grade-badge ${entry.grade}"></span>
                                    </div>
                                `;
                            }
                        }
                        
                        progressRow.innerHTML = `
                            <div class="progress-info">
                                <div class="progress-icon ${item.type}">${item.icon}</div>
                                <div class="progress-details">
                                    <h4>${item.title}</h4>
                                    <p style="color: #8E8E93; font-size: 14px;">${item.type === 'sabak' ? 'New Lesson' : item.type === 'para' ? 'Previous Lessons' : 'Revision'}</p>
                                </div>
                            </div>
                            <div class="progress-status">${statusHtml}</div>
                        `;
                        
                        // Only make clickable for teachers
                        if (currentUserType === 'teacher') {
                            progressRow.style.cursor = 'pointer';
                            progressRow.addEventListener('click', function() {
                                currentProgressType = item.type;
                                currentDate = dateKey;
                                document.getElementById('modalTitle').textContent = `${item.title}`;
                                
                                const linesInputGroup = document.getElementById('linesInputGroup');
                                const amountInputGroup = document.getElementById('amountInputGroup');
                                const linesInput = document.getElementById('linesInput');
                                const amountInput = document.getElementById('amountInput');
                                
                                if (item.type === 'sabak') {
                                    linesInputGroup.style.display = 'block';
                                    amountInputGroup.style.display = 'none';
                                    
                                    if (entry) {
                                        linesInput.value = entry.lines || '';
                                    } else {
                                        linesInput.value = '';
                                    }
                                } else {
                                    linesInputGroup.style.display = 'none';
                                    amountInputGroup.style.display = 'block';
                                    
                                    if (entry) {
                                        amountInput.value = entry.amount || '';
                                    } else {
                                        amountInput.value = '';
                                    }
                                }
                                
                                if (entry) {
                                    selectedGrade = entry.grade;
                                    document.querySelectorAll('.grade-button').forEach(btn => {
                                        btn.classList.remove('selected');
                                    });
                                    document.querySelector(`[data-grade="${entry.grade}"]`).classList.add('selected');
                                } else {
                                    selectedGrade = null;
                                    document.querySelectorAll('.grade-button').forEach(btn => {
                                        btn.classList.remove('selected');
                                    });
                                }
                                
                                updateConversionDisplay();
                                closeModal('dayModal');
                                document.getElementById('progressModal').style.display = 'block';
                                
                                linesInput.addEventListener('input', updateConversionDisplay);
                            });
                        }
                        
                        progressContainer.appendChild(progressRow);
                    });
                    
                    // Add parent check section for any weekday
                    if (!isWeekendDay && !isHolidayDay) {
                        // Parent check button for parents
                        if (currentUserType === 'parent') {
                            const parentCheckRow = document.createElement('div');
                            parentCheckRow.style.cssText = 'padding: 16px 24px; border-top: 1px solid #F2F2F7; background: #F8F9FA;';
                            
                            const isChecked = dayData.parentChecked || false;
                            const buttonText = isChecked ? '✓ Checked by Parent' : '✓ Mark as Checked';
                            const buttonColor = isChecked ? '#8E8E93' : '#34C759';
                            
                            parentCheckRow.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #1C1C1E;">Parent Review</h4>
                                    </div>
                                    <button onclick="toggleParentCheck('${dateKey}')" style="
                                        background: ${buttonColor}; color: white; border: none; 
                                        padding: 12px 16px; border-radius: 8px; 
                                        font-size: 14px; font-weight: 600; 
                                        cursor: pointer; min-width: 140px;
                                    ">${buttonText}</button>
                                </div>
                            `;
                            progressContainer.appendChild(parentCheckRow);
                        }
                        
                        // Parent check status for teachers and office (show both checked and unchecked status)
                        else if (currentUserType === 'teacher' || currentUserType === 'office') {
                            const parentStatusRow = document.createElement('div');
                            if (dayData.parentChecked) {
                                parentStatusRow.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600;';
                                parentStatusRow.innerHTML = '✓ Reviewed by Parent';
                            } else {
                                parentStatusRow.style.cssText = 'padding: 16px 24px; background: #FEF2F2; border-top: 1px solid #FECACA; text-align: center; color: #DC2626; font-size: 14px; font-weight: 600;';
                                parentStatusRow.innerHTML = '✗ Not yet reviewed by Parent';
                            }
                            progressContainer.appendChild(parentStatusRow);
                        }
                    }
                    
                    progressList.appendChild(progressContainer);
                }
            }
            
            document.getElementById('dayModal').style.display = 'block';
        }

        async function markDayAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            studentData[dateKey] = { absent: true };
            
            await window.saveStudentData(currentStudent, studentData);
            generateCalendar();
            closeModal('dayModal');
            
            setTimeout(() => {
                const dayNumber = parseInt(dateKey.split('-')[2]);
                openDayModal(dayNumber);
            }, 200);
        }

        async function removeAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            if (studentData[dateKey] && studentData[dateKey].absent) {
                delete studentData[dateKey].absent;
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                await window.saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('dayModal');
                
                setTimeout(() => {
                    const dayNumber = parseInt(dateKey.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        async function changeMonth(direction) {
            // For parents and office users, restrict navigation to academic year only
            if (currentUserType === 'parent' || currentUserType === 'office') {
                const academicYear = currentAcademicYear || await getCurrentAcademicYear();
                
                if (academicYear) {
                    const [startYear, endYear] = academicYear.split('-');
                    const academicStartMonth = 9; // September
                    const academicEndMonth = 8;   // August
                    
                    // Calculate the new month/year
                    let newMonth = currentDisplayMonth + direction;
                    let newYear = currentDisplayYear;
                    
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear++;
                    } else if (newMonth < 1) {
                        newMonth = 12;
                        newYear--;
                    }
                    
                    // Check if the new date is within academic year bounds
                    let isWithinBounds = false;
                    
                    // Check if in start year (September to December)
                    if (newYear == parseInt(startYear) && newMonth >= academicStartMonth) {
                        isWithinBounds = true;
                    }
                    // Check if in end year (January to August)  
                    else if (newYear == parseInt(endYear) && newMonth <= academicEndMonth) {
                        isWithinBounds = true;
                    }
                    
                    // Only update if within bounds
                    if (isWithinBounds) {
                        currentDisplayMonth = newMonth;
                        currentDisplayYear = newYear;
                    } else {
                        // Show a brief message that they've reached the limit
                        const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                                        'July', 'August', 'September', 'October', 'November', 'December'];
                        
                        if (direction > 0) {
                            // Trying to go forward past August of end year
                            console.log(`Navigation limited to academic year ${academicYear}`);
                        } else {
                            // Trying to go back past September of start year  
                            console.log(`Navigation limited to academic year ${academicYear}`);
                        }
                        return; // Exit without updating
                    }
                } else {
                    // Fallback if no academic year is set
                    currentDisplayMonth += direction;
                    
                    if (currentDisplayMonth > 12) {
                        currentDisplayMonth = 1;
                        currentDisplayYear++;
                    } else if (currentDisplayMonth < 1) {
                        currentDisplayMonth = 12;
                        currentDisplayYear--;
                    }
                }
            } else {
                // Teachers have unlimited navigation
                currentDisplayMonth += direction;
                
                if (currentDisplayMonth > 12) {
                    currentDisplayMonth = 1;
                    currentDisplayYear++;
                } else if (currentDisplayMonth < 1) {
                    currentDisplayMonth = 12;
                    currentDisplayYear--;
                }
            }
            
            generateCalendar();
            updateStats();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function loadSoftRemovedStudents() {
            try {
                const { getDocs, collection } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Get active students list
                const activeStudents = await window.getStudents();
                const activeStudentIds = activeStudents.map(s => s.id);
                
                // Get all students who have progress data
                const progressSnapshot = await getDocs(collection(db, 'progress'));
                const studentsWithData = [];
                
                progressSnapshot.forEach((doc) => {
                    const studentId = doc.id;
                    if (!activeStudentIds.includes(studentId)) {
                        // This student has data but is not in active list = soft removed
                        studentsWithData.push({
                            id: studentId,
                            progressData: doc.data()
                        });
                    }
                });
                
                // Also check students collection for additional info
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                const studentInfoMap = {};
                studentsSnapshot.forEach((doc) => {
                    studentInfoMap[doc.id] = doc.data();
                });
                
                // Also check juzProgress collection
                const juzSnapshot = await getDocs(collection(db, 'juzProgress'));
                const juzProgressMap = {};
                juzSnapshot.forEach((doc) => {
                    juzProgressMap[doc.id] = doc.data();
                });
                
                // Combine all soft-removed students
                const allSoftRemovedIds = new Set([
                    ...studentsWithData.map(s => s.id),
                    ...Object.keys(studentInfoMap).filter(id => !activeStudentIds.includes(id)),
                    ...Object.keys(juzProgressMap).filter(id => !activeStudentIds.includes(id))
                ]);
                
                const softRemovedList = document.getElementById('softRemovedStudentsList');
                
                if (allSoftRemovedIds.size === 0) {
                    softRemovedList.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">✨</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Soft-Removed Students</h3>
                            <p style="color: #8E8E93; font-size: 16px;">All student data is either active or has been permanently deleted.</p>
                        </div>
                    `;
                    return;
                }
                
                softRemovedList.innerHTML = '';
                
                // Process each soft-removed student
                for (const studentId of allSoftRemovedIds) {
                    const studentInfo = studentInfoMap[studentId];
                    const progressData = studentsWithData.find(s => s.id === studentId)?.progressData || {};
                    const juzData = juzProgressMap[studentId];
                    
                    // Count progress entries
                    const progressDays = Object.keys(progressData).length;
                    const hasJuzData = !!juzData;
                    
                    // Get student name
                    const studentName = studentInfo?.name || `Student_${studentId}`;
                    const accessCode = studentInfo?.accessCode || 'Unknown';
                    
                    const softRemovedItem = document.createElement('div');
                    softRemovedItem.className = 'access-code-item';
                    softRemovedItem.style.borderLeft = '4px solid #FF9500';
                    
                    softRemovedItem.innerHTML = `
                        <div style="flex: 1;">
                            <h3 style="font-size: 16px; font-weight: 600; color: #1C1C1E; margin-bottom: 8px;">
                                📚 ${studentName}
                            </h3>
                            <div style="font-size: 12px; color: #8E8E93; margin-bottom: 8px;">
                                <strong>Access Code:</strong> ${accessCode}
                            </div>
                            <div style="font-size: 12px; color: #8E8E93; display: flex; gap: 16px; flex-wrap: wrap;">
                                <span>📊 Progress Days: <strong>${progressDays}</strong></span>
                                <span>📖 Juz Data: <strong>${hasJuzData ? 'Yes' : 'No'}</strong></span>
                            </div>
                            ${studentInfo ? `
                                <div style="font-size: 11px; color: #10A37F; margin-top: 4px;">
                                    ✅ Complete student profile available
                                </div>
                            ` : `
                                <div style="font-size: 11px; color: #FF9500; margin-top: 4px;">
                                    ⚠️ Only progress data available (no profile)
                                </div>
                            `}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px; min-width: 140px;">
                            <button class="copy-button" onclick="restoreSoftRemovedStudent('${studentId}', '${studentName}', '${accessCode}')" 
                                    style="background: #10A37F; padding: 8px 16px;">
                                🔄 Restore Student
                            </button>
                            <button class="copy-button" onclick="permanentlyDeleteFromRecovery('${studentId}', '${studentName}')" 
                                    style="background: #FF3B30; padding: 8px 16px;">
                                🗑️ Delete Forever
                            </button>
                        </div>
                    `;
                    
                    softRemovedList.appendChild(softRemovedItem);
                }
                
            } catch (error) {
                console.error('Error loading soft-removed students:', error);
                document.getElementById('softRemovedStudentsList').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #FF3B30;">
                        <p>❌ Error loading soft-removed students. Please try again.</p>
                    </div>
                `;
            }
        }

        async function restoreSoftRemovedStudent(studentId, studentName, accessCode) {
            if (currentUserType !== 'teacher') return;
            
            if (!confirm(`Restore ${studentName} to the active student list?\n\nThis will make them visible again and restore access via their access code: ${accessCode}`)) {
                return;
            }
            
            try {
                const { getDoc, setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Get current active students
                const activeStudents = await window.getStudents();
                
                // Check if student ID already exists
                if (activeStudents.find(s => s.id === studentId)) {
                    alert('A student with this ID already exists in the active list.');
                    return;
                }
                
                // Get student info from Firebase
                const studentDoc = await getDoc(doc(db, 'students', studentId));
                let studentInfo = {};
                
                if (studentDoc.exists()) {
                    studentInfo = studentDoc.data();
                } else {
                    // Create basic student info if none exists
                    studentInfo = {
                        name: studentName,
                        accessCode: accessCode,
                        quranType: 13,
                        parentEmail: `${studentId}@hifz.com`,
                        restored: true,
                        restoredDate: new Date().toISOString()
                    };
                }
                
                // Add to active students list
                const restoredStudent = {
                    id: studentId,
                    name: studentInfo.name || studentName,
                    accessCode: studentInfo.accessCode || accessCode,
                    quranType: studentInfo.quranType || 13,
                    parentEmail: studentInfo.parentEmail || `${studentId}@hifz.com`
                };
                
                activeStudents.push(restoredStudent);
                
                // Save updated students list
                await setDoc(doc(db, 'config', 'students'), {
                    list: activeStudents,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update student info in Firebase (mark as restored)
                await setDoc(doc(db, 'students', studentId), {
                    ...studentInfo,
                    restored: true,
                    restoredDate: new Date().toISOString()
                });
                
                // Rebuild access codes and update UI
                await buildStudentAccessCodes();
                populateStudentTabs(activeStudents);
                loadSoftRemovedStudents(); // Refresh recovery list
                loadAccessCodes(); // Refresh access codes tab
                
                alert(`✅ ${studentName} has been successfully restored to the active student list!\n\nThey can now be accessed using access code: ${accessCode}`);
                
            } catch (error) {
                console.error('Error restoring student:', error);
                alert('❌ Error restoring student: ' + error.message);
            }
        }

        async function permanentlyDeleteFromRecovery(studentId, studentName) {
            if (currentUserType !== 'teacher') return;
            
            // Same safety confirmations as permanent delete
            if (!confirm(`⚠️ PERMANENT DELETION WARNING ⚠️\n\nYou are about to PERMANENTLY DELETE all data for:\n${studentName}\n\nThis soft-removed student will be completely erased from Firebase.\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?`)) {
                return;
            }
            
            if (!confirm(`🚨 FINAL CONFIRMATION 🚨\n\nThis is your LAST CHANCE to cancel!\n\nContinue with PERMANENT DELETION of ${studentName}?`)) {
                return;
            }
            
            // Ask user to type student name for extra confirmation
            const typedName = prompt(`To proceed with PERMANENT DELETION, please type the student's exact name:\n\n"${studentName}"\n\nType the name exactly as shown:`);
            
            if (typedName !== studentName) {
                alert('Name does not match. Deletion cancelled for safety.');
                return;
            }
            
            try {
                const { deleteDoc, doc, getDocs, collection, query, where } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Delete all data for this student (same as permanentlyDeleteStudent)
                const deletePromises = [];
                
                // 1. Delete student progress data
                try {
                    deletePromises.push(deleteDoc(doc(db, 'progress', studentId)));
                } catch (error) {
                    console.log(`No progress data found for ${studentId}`);
                }
                
                // 2. Delete student info
                try {
                    deletePromises.push(deleteDoc(doc(db, 'students', studentId)));
                } catch (error) {
                    console.log(`No student info found for ${studentId}`);
                }
                
                // 3. Delete Juz progress data
                try {
                    deletePromises.push(deleteDoc(doc(db, 'juzProgress', studentId)));
                } catch (error) {
                    console.log(`No Juz progress found for ${studentId}`);
                }
                
                // 4. Delete all homework assignments for this student
                try {
                    const homeworkQuery = query(
                        collection(db, 'homework'), 
                        where('studentId', '==', studentId)
                    );
                    const homeworkSnapshot = await getDocs(homeworkQuery);
                    
                    homeworkSnapshot.forEach((homeworkDoc) => {
                        deletePromises.push(deleteDoc(doc(db, 'homework', homeworkDoc.id)));
                    });
                } catch (error) {
                    console.log(`Error querying homework for ${studentId}:`, error);
                }
                
                // Execute all deletions
                await Promise.all(deletePromises);
                
                // Refresh the recovery list
                loadSoftRemovedStudents();
                
                alert(`✅ PERMANENT DELETION COMPLETE\n\n${studentName} and ALL associated data has been permanently deleted from Firebase.\n\nThis action cannot be undone.`);
                
            } catch (error) {
                console.error('Error permanently deleting from recovery:', error);
                alert('❌ Error during permanent deletion: ' + error.message);
            }
        }

        async function removeStudent() {
            if (currentUserType !== 'teacher') return;
            
            const select = document.getElementById('removeStudentSelect');
            const studentId = select.value;
            
            if (!studentId) {
                alert('Please select a student to remove');
                return;
            }
            
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to remove ${student.name} from the active student list? Their data will be preserved in Firebase for potential recovery.`)) {
                return;
            }
            
            const updatedStudents = students.filter(s => s.id !== studentId);
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Save updated students list
                await setDoc(doc(db, 'config', 'students'), {
                    list: updatedStudents,
                    lastUpdated: new Date().toISOString()
                });
                
                // FIXED: Rebuild access codes after removing student
                await buildStudentAccessCodes();
                
                populateStudentTabs(updatedStudents);
                
                // Reload dropdowns and access codes
                loadRemoveStudentDropdown();
                loadAccessCodes();
                
                if (currentStudent === studentId) {
                    if (updatedStudents.length > 0) {
                        selectStudent(updatedStudents[0].id);
                    } else {
                        currentStudent = null;
                        updateTodaysProgress();
                        updateStats();
                        generateCalendar();
                    }
                }
                
                alert(`${student.name} has been removed from active students. Their progress data is preserved in Firebase.`);
            } catch (error) {
                console.error('Error removing student:', error);
                alert('Error removing student: ' + error.message);
            }
        }

        async function permanentlyDeleteStudent() {
            if (currentUserType !== 'teacher') return;
            
            const select = document.getElementById('removeStudentSelect');
            const studentId = select.value;
            
            if (!studentId) {
                alert('Please select a student to permanently delete');
                return;
            }
            
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found');
                return;
            }
            
            // Multiple confirmation dialogs for permanent deletion
            if (!confirm(`⚠️ PERMANENT DELETION WARNING ⚠️\n\nYou are about to PERMANENTLY DELETE all data for:\n${student.name}\n\nThis will remove:\n• All daily progress records\n• All Juz progress data\n• All homework assignments\n• Student profile information\n• Parent access code\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?`)) {
                return;
            }
            
            if (!confirm(`🚨 FINAL CONFIRMATION 🚨\n\nType the student's name to confirm:\n${student.name}\n\nThis is your LAST CHANCE to cancel!\n\nContinue with PERMANENT DELETION?`)) {
                return;
            }
            
            // Ask user to type student name for extra confirmation
            const typedName = prompt(`To proceed with PERMANENT DELETION, please type the student's exact name:\n\n"${student.name}"\n\nType the name exactly as shown:`);
            
            if (typedName !== student.name) {
                alert('Name does not match. Deletion cancelled for safety.');
                return;
            }
            
            try {
                const { deleteDoc, doc, getDocs, collection, query, where, setDoc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Show progress indicator
                const button = document.querySelector('.save-button.permanent-delete');
                const originalText = button.textContent;
                button.textContent = '🗑️ DELETING...';
                button.disabled = true;
                
                // 1. Delete from active students list
                const updatedStudents = students.filter(s => s.id !== studentId);
                await setDoc(doc(db, 'config', 'students'), {
                    list: updatedStudents,
                    lastUpdated: new Date().toISOString()
                });
                
                // 2. Delete student progress data
                try {
                    await deleteDoc(doc(db, 'progress', studentId));
                    console.log(`Deleted progress data for ${studentId}`);
                } catch (error) {
                    console.log(`No progress data found for ${studentId}`);
                }
                
                // 3. Delete student info
                try {
                    await deleteDoc(doc(db, 'students', studentId));
                    console.log(`Deleted student info for ${studentId}`);
                } catch (error) {
                    console.log(`No student info found for ${studentId}`);
                }
                
                // 4. Delete Juz progress data
                try {
                    await deleteDoc(doc(db, 'juzProgress', studentId));
                    console.log(`Deleted Juz progress for ${studentId}`);
                } catch (error) {
                    console.log(`No Juz progress found for ${studentId}`);
                }
                
                // 5. Delete all homework assignments for this student
                try {
                    const homeworkQuery = query(
                        collection(db, 'homework'), 
                        where('studentId', '==', studentId)
                    );
                    const homeworkSnapshot = await getDocs(homeworkQuery);
                    
                    const deletePromises = [];
                    homeworkSnapshot.forEach((homeworkDoc) => {
                        deletePromises.push(deleteDoc(doc(db, 'homework', homeworkDoc.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    console.log(`Deleted ${deletePromises.length} homework assignments for ${studentId}`);
                } catch (error) {
                    console.log(`Error deleting homework for ${studentId}:`, error);
                }
                
                // 6. Rebuild access codes
                await buildStudentAccessCodes();
                
                // 7. Update UI
                populateStudentTabs(updatedStudents);
                loadRemoveStudentDropdown();
                loadAccessCodes();
                
                // 8. Handle current student selection
                if (currentStudent === studentId) {
                    if (updatedStudents.length > 0) {
                        selectStudent(updatedStudents[0].id);
                    } else {
                        currentStudent = null;
                        updateTodaysProgress();
                        updateStats();
                        generateCalendar();
                    }
                }
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
                // Reset dropdown selection
                select.value = '';
                
                alert(`✅ PERMANENT DELETION COMPLETE\n\n${student.name} and ALL associated data has been permanently deleted from Firebase.\n\nThis action cannot be undone.`);
                
            } catch (error) {
                console.error('Error permanently deleting student:', error);
                alert('❌ Error during permanent deletion: ' + error.message);
                
                // Reset button on error
                const button = document.querySelector('.save-button.permanent-delete');
                button.textContent = '🗑️ PERMANENTLY DELETE';
                button.disabled = false;
            }
        }

        // Message Functions
        let selectedMessageType = null;

        function showSendMessageModal() {
            if (currentUserType !== 'teacher') return;
            
            // Populate student dropdown
            window.getStudents().then(students => {
                const select = document.getElementById('messageStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Reset form
            document.getElementById('messageContent').value = '';
            selectedMessageType = null;
            document.querySelectorAll('.grade-button[data-type]').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.getElementById('sendMessageModal').style.display = 'block';
        }

        function selectMessageType(type) {
            selectedMessageType = type;
            
            // Remove selected class and type-specific classes from all buttons
            document.querySelectorAll('.grade-button[data-type]').forEach(btn => {
                btn.classList.remove('selected', 'info', 'reminder', 'urgent');
            });
            
            // Add selected class and type-specific class to clicked button
            const selectedButton = document.querySelector(`[data-type="${type}"]`);
            selectedButton.classList.add('selected', type);
        }

        async function sendMessage() {
            if (currentUserType !== 'teacher') return;
            
            const studentId = document.getElementById('messageStudentSelect').value;
            const content = document.getElementById('messageContent').value.trim();
            
            if (!studentId || !selectedMessageType || !content) {
                alert('Please fill in all fields and select a message type');
                return;
            }
            
            try {
                const messageData = {
                    studentId: studentId,
                    type: selectedMessageType,
                    content: content,
                    sentBy: 'Ustaadh'
                };
                
                await saveMessage(messageData);
                
                closeModal('sendMessageModal');
                
                const students = await window.getStudents();
                const student = students.find(s => s.id === studentId);
                const studentName = student ? student.name : 'Student';
                
                alert(`Message sent to ${studentName}'s parent successfully!`);
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }

        async function checkForMessages() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const messages = await getStudentMessages(currentStudent);
                const unreadMessages = messages.filter(msg => !msg.read);
                
                if (unreadMessages.length > 0) {
                    // Show the latest unread message
                    showParentMessageModal(unreadMessages[0]);
                }
                
            } catch (error) {
                console.error('Error checking for messages:', error);
            }
        }

        function showParentMessageModal(message) {
            const content = document.getElementById('parentMessageContent');
            
            const messageTypeIcons = {
                'info': 'ℹ️',
                'reminder': '⏰',
                'urgent': '🚨'
            };
            
            const messageTypeColors = {
                'info': '#DBEAFE',
                'reminder': '#FED7AA', 
                'urgent': '#FEE2E2'
            };
            
            const messageTypeTextColors = {
                'info': '#1E40AF',
                'reminder': '#C2410C',
                'urgent': '#991B1B'
            };
            
            const sentDate = new Date(message.sentDate).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
            
            content.innerHTML = `
                <div class="message-notification">
                    <div class="message-notification-title">
                        ${messageTypeIcons[message.type]} New Message from Ustaadh
                    </div>
                    <div class="message-notification-desc">
                        You have received a ${message.type} message
                    </div>
                </div>
                
                <div class="message-item unread">
                    <div class="message-header">
                        <span class="message-type-badge ${message.type}">${messageTypeIcons[message.type]} ${message.type.toUpperCase()}</span>
                        <span class="message-date">${sentDate}</span>
                    </div>
                    
                    <div class="message-content">
                        ${message.content}
                    </div>
                    
                    <div class="message-actions">
                        <button class="message-review-btn" onclick="reviewMessage('${message.messageId}')">
                            ✓ Review & Dismiss
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('parentMessageModal').style.display = 'block';
        }

        async function reviewMessage(messageId) {
            try {
                await markMessageAsRead(messageId);
                closeModal('parentMessageModal');
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10A37F;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                successDiv.textContent = '✓ Message reviewed';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error reviewing message:', error);
                alert('Error reviewing message: ' + error.message);
            }
        }

        async function showParentMessagesHistory() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const messages = await getStudentMessages(currentStudent);
                const content = document.getElementById('parentMessagesHistoryContent');
                
                if (messages.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📬</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">No Messages</h3>
                            <p style="color: #8E8E93; font-size: 16px;">You haven't received any messages from the Ustaadh yet.</p>
                        </div>
                    `;
                } else {
                    let messagesHtml = '';
                    
                    messages.forEach(message => {
                        const messageTypeIcons = {
                            'info': 'ℹ️',
                            'reminder': '⏰',
                            'urgent': '🚨'
                        };
                        
                        const sentDate = new Date(message.sentDate).toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                        
                        const readStatus = message.read ? 'read' : 'unread';
                        
                        messagesHtml += `
                            <div class="message-item ${readStatus}">
                                <div class="message-header">
                                    <span class="message-type-badge ${message.type}">${messageTypeIcons[message.type]} ${message.type.toUpperCase()}</span>
                                    <span class="message-date">${sentDate}</span>
                                </div>
                                
                                <div class="message-content">
                                    ${message.content}
                                </div>
                                
                                ${!message.read ? `
                                    <div class="message-actions">
                                        <button class="message-review-btn" onclick="reviewMessageFromHistory('${message.messageId}')">
                                            ✓ Mark as Read
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    content.innerHTML = messagesHtml;
                }
                
                document.getElementById('parentMessagesHistoryModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading messages history:', error);
                alert('Error loading messages: ' + error.message);
            }
        }

        async function reviewMessageFromHistory(messageId) {
            try {
                await markMessageAsRead(messageId);
                
                // Refresh the history display
                showParentMessagesHistory();
                
            } catch (error) {
                console.error('Error marking message as read:', error);
                alert('Error updating message: ' + error.message);
            }
        }

        // Updated Message Management Functions - FIXED
        let currentMessageFilter = 'all';
        let allMessagesData = [];

        async function showManageMessagesModal() {
            if (currentUserType !== 'teacher') return;
            
            try {
                const messages = await getAllMessages();
                const students = await window.getStudents();
                allMessagesData = messages;
                
                console.log('Messages found:', messages.length);
                console.log('Students found:', students.length);
                
                // Reset filter
                currentMessageFilter = 'all';
                
                // Display messages with summary
                await displayFilteredMessages(messages, students, 'all');
                
                document.getElementById('manageMessagesModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading messages management:', error);
                alert('Error loading messages: ' + error.message);
            }
        }

        async function filterMessages(filterType) {
            currentMessageFilter = filterType;
            
            // Filter and display messages
            let filteredMessages = allMessagesData;
            
            switch(filterType) {
                case 'read':
                    filteredMessages = allMessagesData.filter(msg => msg.read);
                    break;
                case 'unread':
                    filteredMessages = allMessagesData.filter(msg => !msg.read);
                    break;
                case 'info':
                    filteredMessages = allMessagesData.filter(msg => msg.type === 'info');
                    break;
                case 'reminder':
                    filteredMessages = allMessagesData.filter(msg => msg.type === 'reminder');
                    break;
                case 'urgent':
                    filteredMessages = allMessagesData.filter(msg => msg.type === 'urgent');
                    break;
                default:
                    filteredMessages = allMessagesData;
            }
            
            const students = await window.getStudents();
            await displayFilteredMessages(filteredMessages, students, filterType);
        }

        async function displayFilteredMessages(messages, students, filterType = 'all') {
            const content = document.getElementById('allMessagesContent');
            
            console.log('Displaying messages:', messages.length);
            console.log('Students available:', students.length);
            
            // Calculate message stats (same logic as homework)
            const totalCount = allMessagesData.length;
            const readCount = allMessagesData.filter(msg => msg.read).length;
            const unreadCount = totalCount - readCount;
            const infoCount = allMessagesData.filter(msg => msg.type === 'info').length;
            const reminderCount = allMessagesData.filter(msg => msg.type === 'reminder').length;
            const urgentCount = allMessagesData.filter(msg => msg.type === 'urgent').length;
            
            // Summary section - EXACT same structure as homework
            const summaryHtml = `
                <div class="homework-summary-section">
                    <h3 class="homework-summary-title">📊 Overall Message Summary</h3>
                    <div class="homework-summary-grid">
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #1C1C1E;">${totalCount}</div>
                            <div class="homework-summary-label">Total</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #10A37F;">${readCount}</div>
                            <div class="homework-summary-label">Read</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FF9500;">${unreadCount}</div>
                            <div class="homework-summary-label">Unread</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #3B82F6;">${infoCount}</div>
                            <div class="homework-summary-label">Info</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FF9500;">${reminderCount}</div>
                            <div class="homework-summary-label">Reminder</div>
                        </div>
                        <div class="homework-summary-stat">
                            <div class="homework-summary-number" style="color: #FF3B30;">${urgentCount}</div>
                            <div class="homework-summary-label">Urgent</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Filter buttons - EXACT same structure as homework
            const filtersHtml = `
                <div class="homework-filters">
                    <div class="filter-button ${filterType === 'all' ? 'active' : ''}" data-filter="all" onclick="filterMessages('all')">All</div>
                    <div class="filter-button ${filterType === 'unread' ? 'active' : ''}" data-filter="unread" onclick="filterMessages('unread')">Unread</div>
                    <div class="filter-button ${filterType === 'read' ? 'active' : ''}" data-filter="read" onclick="filterMessages('read')">Read</div>
                    <div class="filter-button ${filterType === 'info' ? 'active' : ''}" data-filter="info" onclick="filterMessages('info')">Info</div>
                    <div class="filter-button ${filterType === 'reminder' ? 'active' : ''}" data-filter="reminder" onclick="filterMessages('reminder')">Reminder</div>
                    <div class="filter-button ${filterType === 'urgent' ? 'active' : ''}" data-filter="urgent" onclick="filterMessages('urgent')">Urgent</div>
                </div>
            `;
            
            if (messages.length === 0) {
                const filterText = filterType === 'all' ? '' : ` (${filterType})`;
                content.innerHTML = summaryHtml + filtersHtml + `
                    <div class="no-homework">
                        <div style="font-size: 48px; margin-bottom: 16px;">📭</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">No Messages Found</h3>
                        <p>No messages match the current filter${filterText}.</p>
                    </div>
                `;
                return;
            }
            
            let messagesHtml = '';
            
            messages.forEach(message => {
                const student = students.find(s => s.id === message.studentId);
                const studentName = student ? student.name : `Student ID: ${message.studentId}`;
                
                const messageTypeIcons = {
                    'info': 'ℹ️',
                    'reminder': '⏰', 
                    'urgent': '🚨'
                };
                
                const sentDate = new Date(message.sentDate).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                
                const readStatus = message.read ? 'read' : 'unread';
                const itemClass = message.read ? 'completed' : 'pending';
                const messagePreview = message.content && message.content.length > 100 ? 
                    message.content.substring(0, 100) + '...' : (message.content || 'No content');
                
                // Message item - EXACT same structure as homework item
                messagesHtml += `
                    <div class="homework-item ${itemClass}">
                        <div class="homework-header">
                            <div>
                                <div class="homework-student-name">${studentName}</div>
                                <div class="homework-details">
                                    <span class="message-type-badge" style="
                                        background-color: ${message.type === 'info' ? '#E3F2FD' : message.type === 'reminder' ? '#FFF3E0' : message.type === 'urgent' ? '#FFEBEE' : '#E3F2FD'}; 
                                        color: ${message.type === 'info' ? '#1565C0' : message.type === 'reminder' ? '#E65100' : message.type === 'urgent' ? '#C62828' : '#1565C0'}; 
                                        padding: 6px 12px; 
                                        border-radius: 16px; 
                                        font-size: 12px; 
                                        font-weight: 600; 
                                        display: inline-flex; 
                                        align-items: center; 
                                        gap: 4px;
                                    ">${messageTypeIcons[message.type] || '📧'} ${(message.type || 'message').toUpperCase()}</span>
                                    Sent: ${sentDate}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="homework-status ${readStatus}">${message.read ? 'Read' : 'Unread'}</span>
                            </div>
                        </div>
                        
                        <div class="homework-description-display">
                            ${messagePreview}
                        </div>
                        
                        <div class="homework-actions">
                            <button class="homework-toggle incomplete" onclick="deleteMessageAndRefresh('${message.messageId || message.id}')" 
                                    style="background: #FF3B30;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = summaryHtml + filtersHtml + messagesHtml;
        }

        async function deleteMessageAndRefresh(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }
            
            try {
                await deleteMessage(messageId);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10A37F;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                successDiv.textContent = '✓ Message deleted successfully';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 2000);
                
                // Refresh the messages display
                const messages = await getAllMessages();
                allMessagesData = messages;
                await filterMessages(currentMessageFilter);
                
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Error deleting message: ' + error.message);
            }
        }

        async function deleteMessage(messageId) {
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await deleteDoc(doc(db, 'messages', messageId));
                console.log('Message deleted:', messageId);
            } catch (error) {
                console.error('Error deleting message:', error);
                throw error;
            }
        }

        // Weekend detection
        function isWeekend(date = new Date()) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday = 0, Saturday = 6
        }

        // Holiday management functions
        async function getHolidays() {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const holidaysDoc = await getDoc(doc(db, 'config', 'holidays'));
                if (holidaysDoc.exists()) {
                    return holidaysDoc.data().list || [];
                }
                return [];
            } catch (error) {
                console.error('Error fetching holidays:', error);
                return [];
            }
        }

        async function saveHolidays(holidays) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await setDoc(doc(db, 'config', 'holidays'), {
                    list: holidays,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving holidays:', error);
                throw error;
            }
        }

        function showHolidayModal() {
            if (currentUserType !== 'teacher') return;
            
            document.getElementById('holidayName').value = '';
            document.getElementById('holidayStartDate').value = '';
            document.getElementById('holidayEndDate').value = '';
            
            loadHolidayList();
            document.getElementById('holidayModal').style.display = 'block';
        }

        async function loadHolidayList() {
            const holidays = await getHolidays();
            const holidayList = document.getElementById('holidayList');
            
            if (holidays.length === 0) {
                holidayList.innerHTML = '<p style="color: #8E8E93; font-size: 14px; text-align: center; padding: 20px;">No holidays added yet</p>';
                return;
            }
            
            holidayList.innerHTML = '';
            holidays.forEach((holiday, index) => {
                const holidayItem = document.createElement('div');
                holidayItem.className = 'holiday-item';
                
                const startDate = new Date(holiday.startDate).toLocaleDateString();
                const endDate = new Date(holiday.endDate).toLocaleDateString();
                const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
                
                holidayItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: #1C1C1E;">${holiday.name}</div>
                        <div style="font-size: 12px; color: #8E8E93;">${dateRange}</div>
                    </div>
                    <button onclick="removeHoliday(${index})" class="holiday-remove-btn">Remove</button>
                `;
                holidayList.appendChild(holidayItem);
            });
        }

        async function addHoliday() {
            const name = document.getElementById('holidayName').value.trim();
            const startDate = document.getElementById('holidayStartDate').value;
            const endDate = document.getElementById('holidayEndDate').value;
            
            if (!name || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date');
                return;
            }
            
            const holidays = await getHolidays();
            holidays.push({
                name: name,
                startDate: startDate,
                endDate: endDate,
                created: new Date().toISOString()
            });
            
            try {
                await saveHolidays(holidays);
                await updateHolidayCache(); // Update the cache
                loadHolidayList();
                generateCalendar(); // Refresh calendar to show new holiday
                
                // Clear form
                document.getElementById('holidayName').value = '';
                document.getElementById('holidayStartDate').value = '';
                document.getElementById('holidayEndDate').value = '';
                
                alert(`Holiday "${name}" added successfully!`);
            } catch (error) {
                alert('Error adding holiday: ' + error.message);
            }
        }

        async function removeHoliday(index) {
            const holidays = await getHolidays();
            const holiday = holidays[index];
            
            if (confirm(`Remove "${holiday.name}" holiday?`)) {
                holidays.splice(index, 1);
                await saveHolidays(holidays);
                await updateHolidayCache(); // Update the cache
                loadHolidayList();
                generateCalendar(); // Refresh calendar to remove holiday indicators
            }
        }

        // Updated holiday check function
        let cachedHolidays = [];
        
        async function updateHolidayCache() {
            cachedHolidays = await getHolidays();
        }
        
        function isHolidayDate(date = new Date()) {
            const dateStr = getDateKey(date);
            
            return cachedHolidays.some(holiday => {
                const start = new Date(holiday.startDate);
                const end = new Date(holiday.endDate);
                const checkDate = new Date(dateStr);
                
                return checkDate >= start && checkDate <= end;
            });
        }
        
        function getHolidayInfo(date = new Date()) {
            const dateStr = getDateKey(date);
            
            const holiday = cachedHolidays.find(holiday => {
                const start = new Date(holiday.startDate);
                const end = new Date(holiday.endDate);
                const checkDate = new Date(dateStr);
                
                return checkDate >= start && checkDate <= end;
            });
            
            return holiday || null;
        }

        function exportStudentPDF() {
            document.getElementById('exportPDFModal').style.display = 'block';
            
            // Populate student dropdown for PDF export
            window.getStudents().then(students => {
                const select = document.getElementById('pdfStudentSelect');
                const existingOptions = select.querySelectorAll('option');
                
                // Clear existing options except first two
                for (let i = existingOptions.length - 1; i >= 2; i--) {
                    existingOptions[i].remove();
                }
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Add event listener for report type change
            const reportTypeSelect = document.getElementById('pdfReportType');
            const monthYearPicker = document.getElementById('monthYearPicker');
            const academicYearPicker = document.getElementById('academicYearPicker');
            
            reportTypeSelect.addEventListener('change', function() {
                // Hide all pickers first
                monthYearPicker.style.display = 'none';
                academicYearPicker.style.display = 'none';
                
                if (this.value === 'monthly-detailed') {
                    monthYearPicker.style.display = 'block';
                    // Set default to current month/year
                    const now = new Date();
                    document.getElementById('monthSelect').value = String(now.getMonth() + 1).padStart(2, '0');
                    document.getElementById('yearSelect').value = now.getFullYear();
                } else if (this.value === 'yearly-summary') {
                    academicYearPicker.style.display = 'block';
                    // Set default to current academic year
                    getCurrentAcademicYear().then(currentAcademicYear => {
                        document.getElementById('academicYearSelect').value = currentAcademicYear || '2024-2025';
                    });
                }
            });
        }

        async function generateSelectedPDF() {
            const studentId = document.getElementById('pdfStudentSelect').value;
            const reportType = document.getElementById('pdfReportType').value;
            
            if (!studentId) {
                alert('Please select a student for PDF report');
                return;
            }
            
            // Show loading
            const btn = document.getElementById('generatePDFBtn');
            const spinner = document.getElementById('modalPdfSpinner');
            const btnText = document.getElementById('modalPdfBtnText');
            
            spinner.style.display = 'inline-block';
            btnText.textContent = 'Generating PDF...';
            btn.disabled = true;
            
            try {
                if (studentId === 'all') {
                    // FIXED: Use the corrected function
                    await generateAllStudentsPDF(reportType);
                } else {
                    // Individual reports remain the same
                    if (reportType === 'yearly-summary') {
                        const selectedAcademicYear = document.getElementById('academicYearSelect').value;
                        await generateYearlySummaryPDF(studentId, selectedAcademicYear);
                    } else if (reportType === 'monthly-detailed') {
                        const selectedMonth = document.getElementById('monthSelect').value;
                        const selectedYear = document.getElementById('yearSelect').value;
                        await generateMonthlyDetailedPDF(studentId, selectedYear, selectedMonth);
                    } else if (reportType === 'overall-progress') {
                        await generateOverallProgressPDF(studentId);
                    } else {
                        await generateSingleStudentPDF(studentId, reportType);
                    }
                }
                
                closeModal('exportPDFModal');
                alert('PDF report generated successfully!');
                
            } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF: ' + error.message);
            } finally {
                // Hide loading
                spinner.style.display = 'none';
                btnText.textContent = '📄 Generate PDF Report';
                btn.disabled = false;
            }
        }

        async function generateAllStudentsPDF(reportType) {
            const students = await window.getStudents();
            if (students.length === 0) {
                alert('No students found');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Get report type display name
            const reportTypeNames = {
                'current-month': 'Current Month Progress',
                'yearly-summary': 'Yearly Summary',
                'monthly-detailed': 'Monthly Detailed',
                'overall-progress': 'Overall Progress'
            };
            const reportTypeName = reportTypeNames[reportType] || 'Progress Report';
            
            // Cover Page
            pdf.setFillColor(16, 163, 127);
            roundedRect(10, 10, 190, 50, 6, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('📖 All Students Report', 20, 30);
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'normal');
            pdf.text(reportTypeName, 20, 45);
            
            pdf.setFontSize(12);
            pdf.text(`Generated on ${new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            })}`, 20, 55);
            
            // Student List Section
            let yPos = 80;
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Total Students: ${students.length}`, 20, yPos);
            yPos += 20;
            
            // Create a nice student list with boxes
            const studentsPerColumn = 15;
            const columnsNeeded = Math.ceil(students.length / studentsPerColumn);
            
            for (let col = 0; col < columnsNeeded; col++) {
                const startIndex = col * studentsPerColumn;
                const endIndex = Math.min(startIndex + studentsPerColumn, students.length);
                const columnStudents = students.slice(startIndex, endIndex);
                
                const xPos = 20 + (col * 90); // 90 units per column
                let columnYPos = yPos;
                
                columnStudents.forEach((student, index) => {
                    // Student box
                    pdf.setFillColor(248, 249, 250);
                    roundedRect(xPos, columnYPos - 5, 85, 12, 2, 'F');
                    
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(xPos, columnYPos - 5, 85, 12, 2, 'S');
                    
                    // Student number and name
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`${startIndex + index + 1}. ${student.name}`, xPos + 3, columnYPos + 2);
                    
                    columnYPos += 15;
                });
            }
            
            // Add note about report contents
            yPos = 220;
            pdf.setFillColor(232, 244, 253);
            roundedRect(20, yPos, 170, 30, 4, 'F');
            
            pdf.setTextColor(30, 64, 175);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Report Contents', 25, yPos + 10);
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text(`• Individual ${reportTypeName} for each student`, 25, yPos + 18);
            pdf.text('• Each student report starts on a new page', 25, yPos + 24);
            
            // Generate individual reports for each student
            for (let i = 0; i < students.length; i++) {
                const student = students[i];
                
                // Add new page for each student
                pdf.addPage();
                
                try {
                    // Generate the appropriate report type for this student
                    if (reportType === 'yearly-summary') {
                        const selectedAcademicYear = document.getElementById('academicYearSelect')?.value || '2024-2025';
                        await generateYearlySummaryPDF(student.id, selectedAcademicYear, pdf, true);
                    } else if (reportType === 'monthly-detailed') {
                        const selectedMonth = document.getElementById('monthSelect')?.value || String(new Date().getMonth() + 1).padStart(2, '0');
                        const selectedYear = document.getElementById('yearSelect')?.value || new Date().getFullYear().toString();
                        await generateMonthlyDetailedPDF(student.id, selectedYear, selectedMonth, pdf, true);
                    } else if (reportType === 'overall-progress') {
                        await generateOverallProgressPDF(student.id, pdf, true);
                    } else {
                        // Default to current month progress
                        await generateSingleStudentPDF(student.id, reportType, pdf, true);
                    }
                } catch (error) {
                    console.error(`Error generating report for ${student.name}:`, error);
                    
                    // Add error page for this student
                    pdf.setTextColor(255, 59, 48);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Error generating report for ${student.name}`, 20, 50);
                    
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    pdf.text('Please try generating this student\'s report individually.', 20, 70);
                }
            }
            
            // Save the combined PDF
            const fileName = `All_Students_${reportTypeName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);
        }

        // Updated individual PDF generation functions to support skipSave parameter
        async function generateSingleStudentPDF(studentId, reportType, providedPDF = null, skipSave = false) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const homework = await getStudentHomework(studentId);
            
            // Create PDF or use provided one
            const { jsPDF } = window.jspdf;
            const pdf = providedPDF || new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Helper function to add table headers (for new pages)
            function addTableHeaders(yPosition) {
                const colStarts = [20, 35, 65, 90, 115, 150];
                const colWidths = [15, 30, 25, 25, 35, 35];
                const tableWidth = 165;
                const rowHeight = 8;
                
                // Table headers background
                pdf.setFillColor(240, 240, 240);
                pdf.rect(20, yPosition, tableWidth, rowHeight, 'F');
                
                // Headers border
                pdf.setDrawColor(200, 200, 200);
                pdf.setLineWidth(0.3);
                pdf.rect(20, yPosition, tableWidth, rowHeight, 'S');
                
                // Vertical lines for columns
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPosition, x, yPosition + rowHeight);
                }
                
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                
                const headers = ['Date', 'Sabak', 'Sabak Para', 'Dhor', 'Status', 'Parent Review'];
                headers.forEach(function(header, index) {
                    centerTextInColumn(header, colStarts[index], colWidths[index], yPosition + 5);
                });
                
                return yPosition + rowHeight;
            }
            
            // IMPROVED HEADER - Professional design
            // Main header background (smaller green section)
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            // White section below
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 20, 'F');
            
            // Title in green section
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('MONTHLY PROGRESS REPORT', 105, 15, { align: 'center' });
            
            // Student name and date in white section
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            pdf.text(monthYear, 105, 39, { align: 'center' });
            
            // Decorative line
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 55;
            
            // Monthly Progress Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Progress', 20, yPos);
            yPos += 10;
            
            // Calculate monthly stats with "did not give" tracking
            const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
            const monthlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(currentMonth)) {
                    if (dayData.absent) {
                        monthlyStats.absent++;
                    } else if (dayData.didNotGive) {
                        monthlyStats.didNotGive++;
                    } else {
                        ['sabak', 'para', 'dhor'].forEach(function(type) {
                            if (dayData[type]) monthlyStats[type]++;
                        });
                    }
                }
            });
            
            // Monthly Progress Boxes
            const boxWidth = 38;
            const boxHeight = 22;
            const spacing = 6;
            const startX = 20;
            
            const progressBoxes = [
                { label: 'SABAK', value: monthlyStats.sabak, color: [16, 163, 127] },
                { label: 'SABAK PARA', value: monthlyStats.para, color: [142, 68, 173] },
                { label: 'DHOR', value: monthlyStats.dhor, color: [255, 149, 0] },
                { label: 'ABSENT', value: monthlyStats.absent, color: [255, 59, 48] }
            ];
            
            progressBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Homework Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Homework Summary', 20, yPos);
            yPos += 10;
            
            // Calculate homework stats
            const homeworkStats = {
                total: homework.length,
                completed: homework.filter(hw => hw.completed).length,
                pending: homework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length,
                didNotDo: homework.filter(hw => hw.status === 'did-not-give').length
            };
            
            const homeworkBoxes = [
                { label: 'TOTAL', value: homeworkStats.total, color: [28, 28, 30] },
                { label: 'COMPLETED', value: homeworkStats.completed, color: [52, 199, 89] },
                { label: 'PENDING', value: homeworkStats.pending, color: [255, 149, 0] },
                { label: 'DID NOT DO', value: homeworkStats.didNotDo, color: [255, 59, 48] }
            ];
            
            homeworkBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Sabak Summary Section  
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 10;
            
            // Calculate total sabak for the month
            let totalLines = 0;
            let totalPages = 0;
            let totalJuz = 0;
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(currentMonth) && dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                    if (dayData.sabak.lines) {
                        totalLines += dayData.sabak.lines;
                    }
                    if (dayData.sabak.pages) {
                        totalPages += dayData.sabak.pages;
                    }
                    if (dayData.sabak.juz) {
                        totalJuz += dayData.sabak.juz;
                    }
                }
            });
            
            const sabakBoxes = [
                { label: 'LINES', value: totalLines, color: [16, 163, 127] },
                { label: 'PAGES', value: Math.round(totalPages * 10) / 10, color: [142, 68, 173] },
                { label: 'JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            // Use wider boxes for Sabak Summary (3 boxes instead of 4)
            const sabakBoxWidth = 50;
            const sabakSpacing = 8;
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (sabakBoxWidth + sabakSpacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, sabakBoxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (sabakBoxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (sabakBoxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 35;
            
            // Daily Breakdown Table
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Daily Breakdown', 20, yPos);
            yPos += 15;
            
            // Consistent table setup throughout
            const rowHeight = 8;
            const pageBottomMargin = 280;
            const colStarts = [20, 35, 65, 90, 115, 150];
            const colWidths = [15, 30, 25, 25, 35, 35];
            const tableWidth = 165;
            
            // Add table headers
            yPos = addTableHeaders(yPos);
            
            // Get days in current month
            const year = new Date().getFullYear();
            const month = new Date().getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Generate table rows for each day
            for (let day = 1; day <= daysInMonth; day++) {
                // Check if we need a new page BEFORE adding the row
                if (yPos + rowHeight > pageBottomMargin) {
                    if (!skipSave || providedPDF) {
                        pdf.addPage();
                        yPos = 20;
                        
                        // Add headers on new page
                        yPos = addTableHeaders(yPos);
                    } else {
                        break; // Don't add more pages in single reports
                    }
                }
                
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = studentData[dateKey] || {};
                
                // Determine row background color
                let rowColor = [255, 255, 255]; // White (Present)
                if (dayData.absent) {
                    rowColor = [255, 235, 235]; // Light Red (Absent)
                } else if (dayData.didNotGive) {
                    rowColor = [255, 243, 224]; // Light Orange (Did Not Give)
                }
                
                // Row background - use EXACT tableWidth
                pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                
                // Row border - use EXACT tableWidth  
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.2);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                
                // Vertical lines - use EXACT column positions
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPos, x, yPos + rowHeight);
                }
                
                // Cell content - ALL CENTERED
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(7);
                pdf.setFont(undefined, 'normal');
                
                // Date - Centered
                centerTextInColumn(day.toString(), colStarts[0], colWidths[0], yPos + 5);
                
                // Sabak - Centered (truncate if too long)
                let sabakText = dayData.sabak ? (dayData.sabak.amount || `${dayData.sabak.lines} lines`) : '--';
                if (sabakText.length > 10) sabakText = sabakText.substring(0, 8) + '..';
                centerTextInColumn(sabakText, colStarts[1], colWidths[1], yPos + 5);
                
                // Sabak Para - Centered (truncate if too long)
                let paraText = dayData.para ? dayData.para.amount : '--';
                if (paraText.length > 8) paraText = paraText.substring(0, 6) + '..';
                centerTextInColumn(paraText, colStarts[2], colWidths[2], yPos + 5);
                
                // Dhor - Centered (truncate if too long)
                let dhorText = dayData.dhor ? dayData.dhor.amount : '--';
                if (dhorText.length > 8) dhorText = dhorText.substring(0, 6) + '..';
                centerTextInColumn(dhorText, colStarts[3], colWidths[3], yPos + 5);
                
                // Status - Centered
                let statusText = 'Present';
                let statusColor = [52, 199, 89]; // Green
                if (dayData.absent) {
                    statusText = 'Absent';
                    statusColor = [255, 59, 48]; // Red
                } else if (dayData.didNotGive) {
                    statusText = 'Did Not Give';
                    statusColor = [255, 149, 0]; // Orange
                }
                
                pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 5);
                
                // Parent Review - Centered
                const parentReview = dayData.parentChecked ? '✓' : '✗';
                const parentColor = dayData.parentChecked ? [52, 199, 89] : [255, 59, 48];
                pdf.setTextColor(parentColor[0], parentColor[1], parentColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(parentReview, colStarts[5], colWidths[5], yPos + 5);
                
                yPos += rowHeight;
            }
            
            // Save PDF only if not part of combined report
            if (!skipSave) {
                pdf.save(student.name + '_monthly_report.pdf');
            }
        }

        function logPDFDebugInfo(functionName, studentId, reportType) {
            console.log(`=== PDF Debug Info ===`);
            console.log(`Function: ${functionName}`);
            console.log(`Student ID: ${studentId}`);
            console.log(`Report Type: ${reportType}`);
            console.log(`Timestamp: ${new Date().toISOString()}`);
            console.log(`======================`);
        }

        // STEP 7: Error handling wrapper for combined reports
        async function safeGenerateCombinedReport(generatorFunction, ...args) {
            try {
                await generatorFunction(...args);
            } catch (error) {
                console.error('Error in combined report generation:', error);
                
                // Add error page to PDF
                const pdf = args[args.length - 2]; // PDF should be second to last argument
                if (pdf) {
                    pdf.setTextColor(255, 59, 48);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Report Generation Error', 20, 50);
                    
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    pdf.text('An error occurred while generating this report.', 20, 70);
                    pdf.text('Please try generating individually.', 20, 85);
                }
                
                throw error; // Re-throw to be caught by parent function
            }
        }

        function showResetModal() {
            if (currentUserType !== 'teacher') return;
            
            if (confirm('Are you sure you want to reset ALL student data? This cannot be undone.')) {
                if (confirm('This will permanently delete all progress records. Continue?')) {
                    alert('Reset functionality would be implemented here');
                }
            }
        }

        async function logout() {
            try {
                // Clean up listeners
                studentUnsubscribes.forEach(unsubscribe => unsubscribe());
                studentUnsubscribes = [];
                
                // Sign out from Firebase
                if (currentUser) {
                    await window.firebaseModules.signOut(window.firebase.auth);
                }
                
                // Reset state
                currentStudent = null;
                currentUserType = null;
                currentUser = null;
                selectedProfile = null;
                
                // Reset to current month
                currentDisplayMonth = new Date().getMonth() + 1;
                currentDisplayYear = new Date().getFullYear();
                
                // Show profile selection
                showProfileSelection();
                
            } catch (error) {
                console.error('Error during logout:', error);
                // Force logout anyway
                currentStudent = null;
                currentUserType = null;
                currentUser = null;
                selectedProfile = null;
                
                // Reset to current month
                currentDisplayMonth = new Date().getMonth() + 1;
                currentDisplayYear = new Date().getFullYear();
                
                showProfileSelection();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['progressModal', 'manageStudentsModal', 'assignHomeworkModal', 'viewHomeworkModal', 'homeworkSummaryModal', 'viewAllHomeworkModal', 'exportPDFModal', 'dayModal', 'holidayModal', 'updateStudentOverviewModal', 'overallProgressModal', 'studentTargetsModal', 'viewTargetsModal', 'sendMessageModal', 'parentMessageModal', 'parentMessagesHistoryModal', 'manageMessagesModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };

        // Allow Enter key for login
        document.addEventListener('DOMContentLoaded', function() {
            const accessCodeInput = document.getElementById('accessCode');
            if (accessCodeInput) {
                accessCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // Add event listener for lines input
            const linesInput = document.getElementById('linesInput');
            if (linesInput) {
                linesInput.addEventListener('input', updateConversionDisplay);
            }
        });

        function initializeApp() {
            try {
                // Always start on current month when app initializes
                currentDisplayMonth = new Date().getMonth() + 1;
                currentDisplayYear = new Date().getFullYear();
                
                updateCurrentDate();
                initializeFirebaseConnection();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Add global error handler for debugging
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
        });

// Ensure all functions are available globally for onclick handlers
        window.selectProfile = selectProfile;
        window.continueToLogin = continueToLogin;
        window.goBackToProfiles = goBackToProfiles;
        window.login = login;
        window.buildStudentAccessCodes = buildStudentAccessCodes;
        window.openProgressModal = openProgressModal;
        window.selectGrade = selectGrade;
        window.saveProgress = saveProgress;
        window.clearProgress = clearProgress;
        window.toggleAbsent = toggleAbsent;
        window.toggleParentCheck = toggleParentCheck;
        window.changeMonth = changeMonth;
        window.closeModal = closeModal;
        window.openDayModal = openDayModal;
        window.markDayAbsent = markDayAbsent;
        window.removeAbsent = removeAbsent;
        window.showManageStudentsModal = showManageStudentsModal;
        window.switchManageTab = switchManageTab;
        window.copyAccessCode = copyAccessCode;
        window.removeStudent = removeStudent;
        window.permanentlyDeleteStudent = permanentlyDeleteStudent;
        window.loadSoftRemovedStudents = loadSoftRemovedStudents;
        window.restoreSoftRemovedStudent = restoreSoftRemovedStudent;
        window.permanentlyDeleteFromRecovery = permanentlyDeleteFromRecovery;
        window.showUpdateStudentOverviewModal = showUpdateStudentOverviewModal;
        window.onOverviewStudentChange = onOverviewStudentChange;
        window.updateJuzDate = updateJuzDate;
        window.saveStudentOverview = saveStudentOverview;
        window.showOverallProgressModal = showOverallProgressModal;
        window.loadSelectedStudentProgress = loadSelectedStudentProgress;
        window.showHolidayModal = showHolidayModal;
        window.addHoliday = addHoliday;
        window.removeHoliday = removeHoliday;
        window.showAssignHomeworkModal = showAssignHomeworkModal;
        window.assignHomework = assignHomework;
        window.showViewHomeworkModal = showViewHomeworkModal;
        window.showHomeworkSummaryModal = showHomeworkSummaryModal;
        window.showViewAllHomeworkModal = showViewAllHomeworkModal;
        window.loadAllHomework = loadAllHomework;
        window.updateHomeworkStatus = updateHomeworkStatus;
        window.toggleHomeworkCompletion = toggleHomeworkCompletion;
        window.deleteHomework = deleteHomework;
        window.showAcademicYearModal = showAcademicYearModal;
        window.saveAcademicYear = saveAcademicYear;
        window.getCurrentAcademicYear = getCurrentAcademicYear;
        window.getAcademicYearDateRange = getAcademicYearDateRange;
        window.isDateInAcademicYear = isDateInAcademicYear;
        window.showOfficeTargetsModal = showOfficeTargetsModal;
        window.loadOfficeStudentTargets = loadOfficeStudentTargets;
        window.showStudentTargetsModal = showStudentTargetsModal;
        window.loadTargetYearOptions = loadTargetYearOptions;
        window.loadStudentTargets = loadStudentTargets;
        window.generateMonthlyTargetFieldsForYear = generateMonthlyTargetFieldsForYear;
        window.selectTargetStatus = selectTargetStatus;
        window.saveStudentTargets = saveStudentTargets;
        window.showOfficeStudentTargetsModal = showOfficeStudentTargetsModal;
        window.loadAllStudentTargetsForYear = loadAllStudentTargetsForYear;
        window.showViewTargetsModal = showViewTargetsModal;
        window.showSendMessageModal = showSendMessageModal;
        window.selectMessageType = selectMessageType;
        window.sendMessage = sendMessage;
        window.checkForMessages = checkForMessages;
        window.showParentMessageModal = showParentMessageModal;
        window.reviewMessage = reviewMessage;
        window.showParentMessagesHistory = showParentMessagesHistory;
        window.reviewMessageFromHistory = reviewMessageFromHistory;
        window.showManageMessagesModal = showManageMessagesModal;
        window.filterMessages = filterMessages;
        window.confirmDeleteMessage = confirmDeleteMessage;
        window.deleteMessageAndRefresh = deleteMessageAndRefresh;
        window.exportStudentPDF = exportStudentPDF;
        window.generateSelectedPDF = generateSelectedPDF;
        window.generateAllStudentsPDF = generateAllStudentsPDF;
        window.generateSingleStudentPDFForCombined = generateSingleStudentPDFForCombined;
        window.generateYearlySummaryPDFForCombined = generateYearlySummaryPDFForCombined;
        window.generateMonthlyDetailedPDFForCombined = generateMonthlyDetailedPDFForCombined;
        window.generateOverallProgressPDFForCombined = generateOverallProgressPDFForCombined;
        window.showResetModal = showResetModal;
        window.logout = logout;

        async function generateYearlySummaryPDF(studentId, academicYear = null, providedPDF = null, skipSave = false) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const juzData = await getStudentJuzProgress(studentId);
            
            // ADDED: Fetch target data for the student and academic year
            const targetYear = academicYear || await getCurrentAcademicYear();
            const targetData = await getStudentTargetsForYear(studentId, targetYear);
            
            const { jsPDF } = window.jspdf;
            const pdf = providedPDF || new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Define constants at the top - SMALLER for better fit
            const startX = 20;
            const boxWidth = 50;
            const boxHeight = 18;
            const spacing = 3;
            
            // IMPROVED HEADER - Professional design matching monthly report
            // Main header background (smaller green section)
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            // White section below
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 18, 'F'); // REDUCED height
            
            // Title in green section
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('YEARLY SUMMARY REPORT', 105, 15, { align: 'center' });
            
            // Student name and academic year in white section
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const displayYear = academicYear || new Date().getFullYear();
            pdf.text('Academic Year: ' + displayYear, 105, 39, { align: 'center' });
            
            // Decorative line
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 50; // REDUCED starting position
            
            // Hifz Duration Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12); // REDUCED font size
            pdf.setFont(undefined, 'bold');
            pdf.text('Hifz Journey Overview', 20, yPos);
            yPos += 8; // REDUCED spacing
            
            if (juzData.hifzStartDate) {
                // Calculate duration
                const totalDuration = calculateDuration(juzData.hifzStartDate);
                const durationText = formatDuration(totalDuration);
                
                // Duration box - SMALLER
                pdf.setFillColor(255, 255, 255);
                roundedRect(20, yPos, 170, 18, 2, 'F'); // REDUCED height
                
                // Top colored bar
                pdf.setFillColor(16, 163, 127);
                roundedRect(20, yPos, 170, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(20, yPos, 170, 18, 2, 'S');
                
                // Duration text
                pdf.setTextColor(16, 163, 127);
                pdf.setFontSize(14); // REDUCED font size
                pdf.setFont(undefined, 'bold');
                pdf.text('Total Hifz Duration: ' + durationText, 30, yPos + 10);
                
                pdf.setFontSize(9); // REDUCED font size
                pdf.setFont(undefined, 'normal');
                pdf.text('Started: ' + new Date(juzData.hifzStartDate).toLocaleDateString(), 30, yPos + 15);
                
                yPos += 25; // REDUCED spacing
                
                // Find current Juz
                const completedJuz = Object.values(juzData.juzProgress || {}).filter(juz => juz.startDate && juz.finishDate).length;
                const currentJuzEntries = Object.entries(juzData.juzProgress || {}).filter(([juzNum, juz]) => juz.startDate && !juz.finishDate);
                const remainingJuz = 30 - completedJuz - currentJuzEntries.length;
                
                // FIXED: Show actual Juz number in box instead of count
                let currentJuzDisplay = '0';
                if (currentJuzEntries.length > 0) {
                    currentJuzDisplay = currentJuzEntries[0][0]; // Get the actual Juz number
                    
                    // Show which Juz currently on
                    pdf.setTextColor(59, 130, 246);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Currently working on: Juz ${currentJuzDisplay}`, 20, yPos);
                    yPos += 12;
                }
                
                // Juz Progress Summary - SMALLER boxes
                const juzBoxes = [
                    { label: 'COMPLETED', value: completedJuz, color: [52, 199, 89] },
                    { label: 'CURRENT', value: currentJuzDisplay, color: [59, 130, 246] }, // FIXED: Show actual Juz number
                    { label: 'REMAINING', value: remainingJuz, color: [142, 142, 147] }
                ];
                
                juzBoxes.forEach(function(box, index) {
                    const x = startX + (index * (boxWidth + spacing));
                    
                    // Box background
                    pdf.setFillColor(255, 255, 255);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                    
                    // Top colored bar
                    pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                    roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                    
                    // Border
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                    
                    // Number - Centered
                    pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                    pdf.setFontSize(12); // REDUCED font size
                    pdf.setFont(undefined, 'bold');
                    const numWidth = pdf.getTextWidth(box.value.toString());
                    pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                    
                    // Label - Centered
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(6);
                    pdf.setFont(undefined, 'normal');
                    const labelWidth = pdf.getTextWidth(box.label);
                    pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
                });
                
                yPos += 25; // REDUCED spacing
            } else {
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('No Hifz start date recorded', 30, yPos + 8);
                yPos += 20;
            }
            
            // Calculate yearly stats for selected academic year
            let targetYear_calc;
            if (academicYear) {
                const [startYear, endYear] = academicYear.split('-');
                targetYear_calc = { start: startYear, end: endYear, academicYear: academicYear };
            } else {
                const currentYear = new Date().getFullYear();
                targetYear_calc = { start: currentYear.toString(), end: currentYear.toString(), academicYear: currentYear.toString() };
            }
            
            const yearlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0, totalDays: 0 };
            let totalLines = 0;
            let totalPages = 0;
            let totalJuz = 0;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                // Filter by academic year if specified
                if (academicYear && !isDateInAcademicYear(date, academicYear)) {
                    return;
                } else if (!academicYear && !date.startsWith(targetYear_calc.start)) {
                    return;
                }
                
                yearlyStats.totalDays++;
                if (dayData.absent) {
                    yearlyStats.absent++;
                } else if (dayData.didNotGive) {
                    yearlyStats.didNotGive++;
                } else {
                    ['sabak', 'para', 'dhor'].forEach(type => {
                        if (dayData[type]) yearlyStats[type]++;
                    });
                    
                    // Calculate Sabak totals
                    if (dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                        if (dayData.sabak.lines) {
                            totalLines += dayData.sabak.lines;
                        }
                        if (dayData.sabak.pages) {
                            totalPages += dayData.sabak.pages;
                        }
                        if (dayData.sabak.juz) {
                            totalJuz += dayData.sabak.juz;
                        }
                    }
                }
            });
            
            // Sabak Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12); // REDUCED font size
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 8; // REDUCED spacing
            
            const sabakBoxes = [
                { label: 'SABAK DAYS', value: yearlyStats.sabak, color: [16, 163, 127] },
                { label: 'TOTAL LINES', value: totalLines, color: [142, 68, 173] },
                { label: 'TOTAL JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(12); // REDUCED font size
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
            });
            
            yPos += 25; // REDUCED spacing
            
            // Monthly Breakdown Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12); // REDUCED font size
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Breakdown', 20, yPos);
            yPos += 10; // REDUCED spacing
            
            // UPDATED: Generate monthly breakdown table with Target column (7 columns now)
            const colStarts = [20, 45, 65, 85, 105, 125, 145];    // ADDED 7th column
            const colWidths = [25, 20, 20, 20, 20, 20, 20];       // ADDED 7th width
            const tableWidth = 145;                                // INCREASED table width
            const rowHeight = 8;                                   // INCREASED row height as requested
            
            // Table headers
            pdf.setFillColor(240, 240, 240);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
            
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
            
            // UPDATED: Vertical lines for 7 columns
            for (let i = 0; i <= colStarts.length; i++) {
                const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                pdf.line(x, yPos, x, yPos + rowHeight);
            }
            
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(7); // REDUCED font size
            pdf.setFont(undefined, 'bold');
            
            // UPDATED: Added 'Target' to headers
            const headers = ['Month', 'Sabak', 'Para', 'Dhor', 'Absent', 'Did Not Give', 'Target'];
            headers.forEach(function(header, index) {
                centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 5);
            });
            
            yPos += rowHeight;
            
            // Generate monthly data - COMPACT
            if (academicYear) {
                const [startYear, endYear] = academicYear.split('-');
                const months = [
                    { key: `${startYear}-09`, name: 'Sep' }, // SHORTENED month names
                    { key: `${startYear}-10`, name: 'Oct' },
                    { key: `${startYear}-11`, name: 'Nov' },
                    { key: `${startYear}-12`, name: 'Dec' },
                    { key: `${endYear}-01`, name: 'Jan' },
                    { key: `${endYear}-02`, name: 'Feb' },
                    { key: `${endYear}-03`, name: 'Mar' },
                    { key: `${endYear}-04`, name: 'Apr' },
                    { key: `${endYear}-05`, name: 'May' },
                    { key: `${endYear}-06`, name: 'Jun' },
                    { key: `${endYear}-07`, name: 'Jul' },
                    { key: `${endYear}-08`, name: 'Aug' }
                ];
                
                months.forEach((month, index) => {
                    // Calculate monthly stats
                    const monthStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
                    
                    Object.entries(studentData).forEach(([date, dayData]) => {
                        if (date.startsWith(month.key)) {
                            if (dayData.absent) {
                                monthStats.absent++;
                            } else if (dayData.didNotGive) {
                                monthStats.didNotGive++;
                            } else {
                                ['sabak', 'para', 'dhor'].forEach(type => {
                                    if (dayData[type]) monthStats[type]++;
                                });
                            }
                        }
                    });
                    
                    // ADDED: Get target status for this month
                    let targetStatus = '--';
                    let targetColor = [142, 142, 147]; // Default gray
                    
                    if (targetData.monthly && targetData.monthly[month.key] && targetData.monthly[month.key].status) {
                        const status = targetData.monthly[month.key].status;
                        switch(status) {
                            case 'above':
                                targetStatus = 'Above';
                                targetColor = [52, 199, 89]; // Green
                                break;
                            case 'on':
                                targetStatus = 'On';
                                targetColor = [59, 130, 246]; // Blue
                                break;
                            case 'below':
                                targetStatus = 'Below';
                                targetColor = [255, 59, 48]; // Red
                                break;
                        }
                    }
                    
                    // Row background
                    const rowColor = index % 2 === 0 ? [255, 255, 255] : [248, 249, 250];
                    pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                    
                    // Row border
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.2);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                    
                    // UPDATED: Vertical lines for 7 columns
                    for (let i = 0; i <= colStarts.length; i++) {
                        const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                        pdf.line(x, yPos, x, yPos + rowHeight);
                    }
                    
                    // Cell content
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(7); // INCREASED font size for better readability
                    pdf.setFont(undefined, 'normal');
                    
                    centerTextInColumn(month.name, colStarts[0], colWidths[0], yPos + 5);
                    centerTextInColumn(monthStats.sabak.toString(), colStarts[1], colWidths[1], yPos + 5);
                    centerTextInColumn(monthStats.para.toString(), colStarts[2], colWidths[2], yPos + 5);
                    centerTextInColumn(monthStats.dhor.toString(), colStarts[3], colWidths[3], yPos + 5);
                    centerTextInColumn(monthStats.absent.toString(), colStarts[4], colWidths[4], yPos + 5);
                    centerTextInColumn(monthStats.didNotGive.toString(), colStarts[5], colWidths[5], yPos + 5);
                    
                    // ADDED: Target status with appropriate color
                    pdf.setTextColor(targetColor[0], targetColor[1], targetColor[2]);
                    pdf.setFont(undefined, 'bold');
                    centerTextInColumn(targetStatus, colStarts[6], colWidths[6], yPos + 5);
                    
                    yPos += rowHeight;
                });
            }
            
            // Save PDF only if not part of combined report
            if (!skipSave) {
                const fileName = student.name + '_yearly_summary_' + displayYear + '.pdf';
                pdf.save(fileName);
            }
        }

        // COMPLETE MONTHLY DETAILED PDF - Same design as current month but for selected month/year
        async function generateMonthlyDetailedPDF(studentId, year, month, providedPDF = null, skipSave = false) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const homework = await getStudentHomework(studentId);
            
            // Create PDF or use provided one
            const { jsPDF } = window.jspdf;
            const pdf = providedPDF || new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Helper function to add table headers (for new pages)
            function addTableHeaders(yPosition) {
                // Consistent column definitions used everywhere
                const colStarts = [20, 35, 65, 90, 115, 150];
                const colWidths = [15, 30, 25, 25, 35, 35];
                const tableWidth = 165; // Total table width
                const rowHeight = 8;
                
                // Table headers background
                pdf.setFillColor(240, 240, 240);
                pdf.rect(20, yPosition, tableWidth, rowHeight, 'F');
                
                // Headers border
                pdf.setDrawColor(200, 200, 200);
                pdf.setLineWidth(0.3);
                pdf.rect(20, yPosition, tableWidth, rowHeight, 'S');
                
                // Vertical lines for columns
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPosition, x, yPosition + rowHeight);
                }
                
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'bold');
                
                const headers = ['Date', 'Sabak', 'Sabak Para', 'Dhor', 'Status', 'Parent Review'];
                headers.forEach(function(header, index) {
                    centerTextInColumn(header, colStarts[index], colWidths[index], yPosition + 5);
                });
                
                return yPosition + rowHeight;
            }
            
            // IMPROVED HEADER - Professional design
            // Main header background (smaller green section)
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            // White section below
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 20, 'F');
            
            // Title in green section
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('MONTHLY PROGRESS REPORT', 105, 15, { align: 'center' });
            
            // Student name and selected month/year in white section
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const monthYear = `${monthNames[parseInt(month) - 1]} ${year}`;
            pdf.text(monthYear, 105, 39, { align: 'center' });
            
            // Decorative line
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 55;
            
            // Monthly Progress Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Progress', 20, yPos);
            yPos += 10;
            
            // Calculate monthly stats for SELECTED month with "did not give" tracking
            const selectedMonth = `${year}-${String(month).padStart(2, '0')}`;
            const monthlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(selectedMonth)) {
                    if (dayData.absent) {
                        monthlyStats.absent++;
                    } else if (dayData.didNotGive) {
                        monthlyStats.didNotGive++;
                    } else {
                        ['sabak', 'para', 'dhor'].forEach(function(type) {
                            if (dayData[type]) monthlyStats[type]++;
                        });
                    }
                }
            });
            
            // Monthly Progress Boxes
            const boxWidth = 38;
            const boxHeight = 22;
            const spacing = 6;
            const startX = 20;
            
            const progressBoxes = [
                { label: 'SABAK', value: monthlyStats.sabak, color: [16, 163, 127] },
                { label: 'SABAK PARA', value: monthlyStats.para, color: [142, 68, 173] },
                { label: 'DHOR', value: monthlyStats.dhor, color: [255, 149, 0] },
                { label: 'ABSENT', value: monthlyStats.absent, color: [255, 59, 48] }
            ];
            
            progressBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Homework Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Homework Summary', 20, yPos);
            yPos += 10;
            
            // Filter homework for selected month
            const selectedMonthHomework = homework.filter(hw => {
                const assignedDate = new Date(hw.assignedDate);
                const hwMonth = `${assignedDate.getFullYear()}-${String(assignedDate.getMonth() + 1).padStart(2, '0')}`;
                return hwMonth === selectedMonth;
            });
            
            // Calculate homework stats for selected month
            const homeworkStats = {
                total: selectedMonthHomework.length,
                completed: selectedMonthHomework.filter(hw => hw.completed).length,
                pending: selectedMonthHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length,
                didNotDo: selectedMonthHomework.filter(hw => hw.status === 'did-not-give').length
            };
            
            const homeworkBoxes = [
                { label: 'TOTAL', value: homeworkStats.total, color: [28, 28, 30] },
                { label: 'COMPLETED', value: homeworkStats.completed, color: [52, 199, 89] },
                { label: 'PENDING', value: homeworkStats.pending, color: [255, 149, 0] },
                { label: 'DID NOT DO', value: homeworkStats.didNotDo, color: [255, 59, 48] }
            ];
            
            homeworkBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Sabak Summary Section  
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 10;
            
            // Calculate total sabak for the SELECTED month
            let totalLines = 0;
            let totalPages = 0;
            let totalJuz = 0;
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(selectedMonth) && dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                    if (dayData.sabak.lines) {
                        totalLines += dayData.sabak.lines;
                    }
                    if (dayData.sabak.pages) {
                        totalPages += dayData.sabak.pages;
                    }
                    if (dayData.sabak.juz) {
                        totalJuz += dayData.sabak.juz;
                    }
                }
            });
            
            const sabakBoxes = [
                { label: 'LINES', value: totalLines, color: [16, 163, 127] },
                { label: 'PAGES', value: Math.round(totalPages * 10) / 10, color: [142, 68, 173] },
                { label: 'JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            // Use wider boxes for Sabak Summary (3 boxes instead of 4)
            const sabakBoxWidth = 50;
            const sabakSpacing = 8;
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (sabakBoxWidth + sabakSpacing));
                
                // Box background
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, sabakBoxWidth, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'S');
                
                // Number - Centered
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (sabakBoxWidth - numWidth)/2, yPos + 12);
                
                // Label - Centered
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (sabakBoxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 35;
            
            // Daily Breakdown Table
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Daily Breakdown', 20, yPos);
            yPos += 15;
            
            // Consistent table setup throughout
            const rowHeight = 8;
            const pageBottomMargin = 280;
            const colStarts = [20, 35, 65, 90, 115, 150];
            const colWidths = [15, 30, 25, 25, 35, 35];
            const tableWidth = 165; // Total table width
            
            // Add table headers
            yPos = addTableHeaders(yPos);
            
            // Get days in SELECTED month
            const selectedYear = parseInt(year);
            const selectedMonthNum = parseInt(month) - 1; // JavaScript months are 0-based
            const daysInMonth = new Date(selectedYear, selectedMonthNum + 1, 0).getDate();
            
            // Generate table rows for each day
            for (let day = 1; day <= daysInMonth; day++) {
                // Check if we need a new page BEFORE adding the row
                if (yPos + rowHeight > pageBottomMargin) {
                    if (!skipSave || providedPDF) {
                        pdf.addPage();
                        yPos = 20;
                        
                        // Add headers on new page
                        yPos = addTableHeaders(yPos);
                    } else {
                        break; // Don't add more pages in single reports
                    }
                }
                
                const dateKey = `${selectedYear}-${String(selectedMonthNum + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = studentData[dateKey] || {};
                
                // Determine row background color
                let rowColor = [255, 255, 255]; // White (Present)
                if (dayData.absent) {
                    rowColor = [255, 235, 235]; // Light Red (Absent)
                } else if (dayData.didNotGive) {
                    rowColor = [255, 243, 224]; // Light Orange (Did Not Give)
                }
                
                // Row background - use EXACT tableWidth
                pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                
                // Row border - use EXACT tableWidth  
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.2);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                
                // Vertical lines - use EXACT column positions
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPos, x, yPos + rowHeight);
                }
                
                // Cell content - ALL CENTERED
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(7);
                pdf.setFont(undefined, 'normal');
                
                // Date - Centered
                centerTextInColumn(day.toString(), colStarts[0], colWidths[0], yPos + 5);
                
                // Sabak - Centered (truncate if too long)
                let sabakText = dayData.sabak ? (dayData.sabak.amount || `${dayData.sabak.lines} lines`) : '--';
                if (sabakText.length > 10) sabakText = sabakText.substring(0, 8) + '..';
                centerTextInColumn(sabakText, colStarts[1], colWidths[1], yPos + 5);
                
                // Sabak Para - Centered (truncate if too long)
                let paraText = dayData.para ? dayData.para.amount : '--';
                if (paraText.length > 8) paraText = paraText.substring(0, 6) + '..';
                centerTextInColumn(paraText, colStarts[2], colWidths[2], yPos + 5);
                
                // Dhor - Centered (truncate if too long)
                let dhorText = dayData.dhor ? dayData.dhor.amount : '--';
                if (dhorText.length > 8) dhorText = dhorText.substring(0, 6) + '..';
                centerTextInColumn(dhorText, colStarts[3], colWidths[3], yPos + 5);
                
                // Status - Centered
                let statusText = 'Present';
                let statusColor = [52, 199, 89]; // Green
                if (dayData.absent) {
                    statusText = 'Absent';
                    statusColor = [255, 59, 48]; // Red
                } else if (dayData.didNotGive) {
                    statusText = 'Did Not Give';
                    statusColor = [255, 149, 0]; // Orange
                }
                
                pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 5);
                
                // Parent Review - Centered
                const parentReview = dayData.parentChecked ? '✓' : '✗';
                const parentColor = dayData.parentChecked ? [52, 199, 89] : [255, 59, 48];
                pdf.setTextColor(parentColor[0], parentColor[1], parentColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(parentReview, colStarts[5], colWidths[5], yPos + 5);
                
                yPos += rowHeight;
            }
            
            // Save PDF only if not part of combined report
            if (!skipSave) {
                const fileName = `${student.name}_${monthNames[parseInt(month) - 1]}_${year}_detailed.pdf`;
                pdf.save(fileName);
            }
        }

        async function generateOverallProgressPDF(studentId, providedPDF = null, skipSave = false) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const juzData = await getStudentJuzProgress(studentId);
            
            const { jsPDF } = window.jspdf;
            const pdf = providedPDF || new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // PROFESSIONAL HEADER - Matching other reports
            // Main header background
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            // White section below
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 18, 'F');
            
            // Title in green section
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('OVERALL PROGRESS REPORT', 105, 15, { align: 'center' });
            
            // Student name in white section
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('Complete Hifz Journey Overview', 105, 39, { align: 'center' });
            
            // Decorative line
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 48;
            
            if (!juzData.hifzStartDate) {
                // No data message
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'normal');
                pdf.text('No Hifz progress data available', 105, yPos + 50, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text('Please contact the Ustaadh to set up Hifz tracking', 105, yPos + 70, { align: 'center' });
            } else {
                // Hifz Duration Section - COMPACT
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Hifz Journey Overview', 20, yPos);
                yPos += 6;
                
                // Calculate total duration
                const totalDuration = calculateDuration(juzData.hifzStartDate);
                const durationText = formatDuration(totalDuration);
                
                // Duration card - SMALLER
                pdf.setFillColor(255, 255, 255);
                roundedRect(20, yPos, 170, 16, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(16, 163, 127);
                roundedRect(20, yPos, 170, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(20, yPos, 170, 16, 2, 'S');
                
                // Duration text
                pdf.setTextColor(16, 163, 127);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Total Hifz Duration: ' + durationText, 25, yPos + 8);
                
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                const startDateStr = new Date(juzData.hifzStartDate).toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                pdf.text('Started: ' + startDateStr, 25, yPos + 13);
                
                yPos += 22;
                
                // Calculate Juz statistics
                const completedJuz = [];
                const currentJuz = [];
                const notStartedJuz = [];
                
                for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                    const juzInfo = juzData.juzProgress[juzNumber];
                    if (juzInfo && juzInfo.startDate && juzInfo.finishDate) {
                        completedJuz.push({ number: juzNumber, ...juzInfo });
                    } else if (juzInfo && juzInfo.startDate && !juzInfo.finishDate) {
                        currentJuz.push({ number: juzNumber, ...juzInfo });
                    } else {
                        notStartedJuz.push(juzNumber);
                    }
                }
                
                // Progress Summary Boxes - COMPACT
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Progress Summary', 20, yPos);
                yPos += 6;
                
                const boxWidth = 50;
                const boxHeight = 18;
                const spacing = 8;
                const startX = 20;
                
                // Show actual Juz number instead of count for CURRENT
                const currentJuzNumber = currentJuz.length > 0 ? currentJuz[0].number : 0;
                
                const progressBoxes = [
                    { label: 'COMPLETED', value: completedJuz.length, color: [52, 199, 89] },
                    { label: 'CURRENT', value: currentJuzNumber, color: [59, 130, 246] },
                    { label: 'REMAINING', value: notStartedJuz.length, color: [142, 142, 147] }
                ];
                
                progressBoxes.forEach(function(box, index) {
                    const x = startX + (index * (boxWidth + spacing));
                    
                    // Box background
                    pdf.setFillColor(255, 255, 255);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                    
                    // Top colored bar
                    pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                    roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                    
                    // Border
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                    
                    // Number - Centered
                    pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    const numWidth = pdf.getTextWidth(box.value.toString());
                    pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                    
                    // Label - Centered
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(6);
                    pdf.setFont(undefined, 'normal');
                    const labelWidth = pdf.getTextWidth(box.label);
                    pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
                });
                
                yPos += 24;
                
                // Detailed Progress Table - WITH FULL DATES
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Detailed Juz Progress', 20, yPos);
                yPos += 8;
                
                // Combine and sort all Juz with data
                const allJuzWithData = [...completedJuz, ...currentJuz].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                if (allJuzWithData.length === 0) {
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    pdf.text('No Juz progress recorded yet', 20, yPos + 8);
                    yPos += 16;
                } else {
                    // Table setup - Slightly adjusted widths for full dates
                    const rowHeight = 8;
                    const colStarts = [20, 35, 75, 115, 155]; // Adjusted to accommodate full dates
                    const colWidths = [15, 40, 40, 40, 30];   // Increased date column widths
                    const tableWidth = 165;
                    
                    // Table headers
                    pdf.setFillColor(240, 240, 240);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setLineWidth(0.3);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                    
                    // Vertical lines for 5 columns
                    for (let i = 0; i <= colStarts.length; i++) {
                        const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                        pdf.line(x, yPos, x, yPos + rowHeight);
                    }
                    
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(7);
                    pdf.setFont(undefined, 'bold');
                    
                    const headers = ['Juz', 'Start Date', 'End Date', 'Duration', 'Status'];
                    headers.forEach(function(header, index) {
                        centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 5);
                    });
                    
                    yPos += rowHeight;
                    
                    // Add rows for each Juz - REMOVE LAST ROW
                    const maxRows = Math.min(allJuzWithData.length, 21); // Remove last row (-1)
                    
                    for (let i = 0; i < maxRows; i++) {
                        const juz = allJuzWithData[i];
                        const isCompleted = juz.startDate && juz.finishDate;
                        
                        // Row background
                        let rowColor = isCompleted ? [240, 253, 244] : [239, 246, 255];
                        pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                        pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                        
                        // Row border
                        pdf.setDrawColor(220, 220, 220);
                        pdf.setLineWidth(0.2);
                        pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                        
                        // Vertical lines for 5 columns
                        for (let j = 0; j <= colStarts.length; j++) {
                            const x = j === colStarts.length ? (20 + tableWidth) : colStarts[j];
                            pdf.line(x, yPos, x, yPos + rowHeight);
                        }
                        
                        // Cell content
                        pdf.setTextColor(28, 28, 30);
                        pdf.setFontSize(6);
                        pdf.setFont(undefined, 'normal');
                        
                        // Juz number
                        centerTextInColumn(juz.number.toString(), colStarts[0], colWidths[0], yPos + 5);
                        
                        // UPDATED: Start date with full year
                        const startDate = new Date(juz.startDate).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            year: 'numeric'  // ADDED: Include year
                        });
                        centerTextInColumn(startDate, colStarts[1], colWidths[1], yPos + 5);
                        
                        // UPDATED: End date with full year
                        const endDate = isCompleted ? 
                            new Date(juz.finishDate).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'  // ADDED: Include year
                            }) : '--';
                        centerTextInColumn(endDate, colStarts[2], colWidths[2], yPos + 5);
                        
                        // Duration - FULL TEXT FORMAT
                        let durationText;
                        if (isCompleted) {
                            const duration = calculateDuration(juz.startDate, juz.finishDate);
                            durationText = formatDuration(duration);
                        } else {
                            const duration = calculateDuration(juz.startDate);
                            durationText = formatDuration(duration);
                        }
                        centerTextInColumn(durationText, colStarts[3], colWidths[3], yPos + 5);
                        
                        // Status
                        const statusText = isCompleted ? 'Completed' : 'Current';
                        const statusColor = isCompleted ? [52, 199, 89] : [59, 130, 246];
                        pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                        pdf.setFont(undefined, 'bold');
                        centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 5);
                        
                        yPos += rowHeight;
                    }
                    
                    yPos += 6;
                }
                
                // Remaining Juz Section - COMPACT
                if (notStartedJuz.length > 0) {
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Remaining Juz to Complete', 20, yPos);
                    yPos += 6;
                    
                    // Show remaining Juz in a compact format
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(9);
                    pdf.setFont(undefined, 'normal');
                    
                    let remainingText = 'Juz ' + notStartedJuz.join(', ');
                    pdf.text(remainingText, 20, yPos);
                    yPos += 10;
                    
                    // Progress percentage
                    const progressPercentage = Math.round((completedJuz.length / 30) * 100);
                    pdf.setTextColor(16, 163, 127);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Overall Progress: ${progressPercentage}% Complete`, 20, yPos);
                }
            }
            
            // Save PDF only if not part of combined report
            if (!skipSave) {
                const fileName = student.name + '_overall_progress.pdf';
                pdf.save(fileName);
            }
        }

        async function generateAllStudentsPDF(reportType) {
            const students = await window.getStudents();
            if (students.length === 0) {
                alert('No students found');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // FIXED: Get report type display name with proper mapping
            const reportTypeNames = {
                'current-month': 'Current Month Progress',
                'yearly-summary': 'Yearly Summary',
                'monthly-detailed': 'Monthly Detailed',
                'overall-progress': 'Overall Progress'
            };
            const reportTypeName = reportTypeNames[reportType] || 'Progress Report';
            
            // FIXED: Get form values safely with fallbacks
            const selectedAcademicYear = document.getElementById('academicYearSelect')?.value || '2024-2025';
            const selectedMonth = document.getElementById('monthSelect')?.value || String(new Date().getMonth() + 1).padStart(2, '0');
            const selectedYear = document.getElementById('yearSelect')?.value || new Date().getFullYear().toString();
            
            // Cover Page
            pdf.setFillColor(16, 163, 127);
            roundedRect(10, 10, 190, 50, 6, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            pdf.text('All Students Report', 20, 30);
            
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'normal');
            pdf.text(reportTypeName, 20, 45);
            
            pdf.setFontSize(12);
            pdf.text(`Generated on ${new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            })}`, 20, 55);
            
            // Student List Section
            let yPos = 80;
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text(`Total Students: ${students.length}`, 20, yPos);
            yPos += 20;
            
            // Create a nice student list with boxes
            const studentsPerColumn = 15;
            const columnsNeeded = Math.ceil(students.length / studentsPerColumn);
            
            for (let col = 0; col < columnsNeeded; col++) {
                const startIndex = col * studentsPerColumn;
                const endIndex = Math.min(startIndex + studentsPerColumn, students.length);
                const columnStudents = students.slice(startIndex, endIndex);
                
                const xPos = 20 + (col * 90);
                let columnYPos = yPos;
                
                columnStudents.forEach((student, index) => {
                    pdf.setFillColor(248, 249, 250);
                    roundedRect(xPos, columnYPos - 5, 85, 12, 2, 'F');
                    
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(xPos, columnYPos - 5, 85, 12, 2, 'S');
                    
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`${startIndex + index + 1}. ${student.name}`, xPos + 3, columnYPos + 2);
                    
                    columnYPos += 15;
                });
            }
            
            // Add note about report contents
            yPos = 220;
            pdf.setFillColor(232, 244, 253);
            roundedRect(20, yPos, 170, 30, 4, 'F');
            
            pdf.setTextColor(30, 64, 175);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Report Contents', 25, yPos + 10);
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text(`• Individual ${reportTypeName} for each student`, 25, yPos + 18);
            pdf.text('• Each student report starts on a new page', 25, yPos + 24);
            
            // FIXED: Generate individual reports for each student with proper page management
            for (let i = 0; i < students.length; i++) {
                const student = students[i];
                
                // FIXED: Add new page for each student BEFORE generating content
                pdf.addPage();
                
                try {
                    // FIXED: Call specialized combined report functions instead of regular ones
                    if (reportType === 'yearly-summary') {
                        await generateYearlySummaryPDFForCombined(student.id, selectedAcademicYear, pdf);
                    } else if (reportType === 'monthly-detailed') {
                        await generateMonthlyDetailedPDFForCombined(student.id, selectedYear, selectedMonth, pdf);
                    } else if (reportType === 'overall-progress') {
                        await generateOverallProgressPDFForCombined(student.id, pdf);
                    } else {
                        // Default to current month progress
                        await generateSingleStudentPDFForCombined(student.id, pdf);
                    }
                } catch (error) {
                    console.error(`Error generating report for ${student.name}:`, error);
                    
                    // FIXED: Clear the page and add error message properly positioned
                    pdf.setTextColor(255, 59, 48);
                    pdf.setFontSize(16);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Error generating report for ${student.name}`, 20, 50);
                    
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'normal');
                    pdf.text('Please try generating this student\'s report individually.', 20, 70);
                }
            }
            
            // Save the combined PDF
            const fileName = `All_Students_${reportTypeName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);
        }

        // STEP 2: Create specialized functions for combined reports that start fresh on each page

        async function generateSingleStudentPDFForCombined(studentId, pdf) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const homework = await getStudentHomework(studentId);
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Header - starts at top of fresh page
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 20, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('MONTHLY PROGRESS REPORT', 105, 15, { align: 'center' });
            
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            pdf.text(monthYear, 105, 39, { align: 'center' });
            
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 55;
            
            // Monthly Progress Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Progress', 20, yPos);
            yPos += 10;
            
            // Calculate monthly stats
            const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
            const monthlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(currentMonth)) {
                    if (dayData.absent) {
                        monthlyStats.absent++;
                    } else if (dayData.didNotGive) {
                        monthlyStats.didNotGive++;
                    } else {
                        ['sabak', 'para', 'dhor'].forEach(function(type) {
                            if (dayData[type]) monthlyStats[type]++;
                        });
                    }
                }
            });
            
            // Progress boxes
            const boxWidth = 38;
            const boxHeight = 22;
            const spacing = 6;
            const startX = 20;
            
            const progressBoxes = [
                { label: 'SABAK', value: monthlyStats.sabak, color: [16, 163, 127] },
                { label: 'SABAK PARA', value: monthlyStats.para, color: [142, 68, 173] },
                { label: 'DHOR', value: monthlyStats.dhor, color: [255, 149, 0] },
                { label: 'ABSENT', value: monthlyStats.absent, color: [255, 59, 48] }
            ];
            
            progressBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Homework Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Homework Summary', 20, yPos);
            yPos += 10;
            
            const homeworkStats = {
                total: homework.length,
                completed: homework.filter(hw => hw.completed).length,
                pending: homework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length,
                didNotDo: homework.filter(hw => hw.status === 'did-not-give').length
            };
            
            const homeworkBoxes = [
                { label: 'TOTAL', value: homeworkStats.total, color: [28, 28, 30] },
                { label: 'COMPLETED', value: homeworkStats.completed, color: [52, 199, 89] },
                { label: 'PENDING', value: homeworkStats.pending, color: [255, 149, 0] },
                { label: 'DID NOT DO', value: homeworkStats.didNotDo, color: [255, 59, 48] }
            ];
            
            homeworkBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Sabak Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 10;
            
            let totalLines = 0, totalPages = 0, totalJuz = 0;
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(currentMonth) && dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                    if (dayData.sabak.lines) totalLines += dayData.sabak.lines;
                    if (dayData.sabak.pages) totalPages += dayData.sabak.pages;
                    if (dayData.sabak.juz) totalJuz += dayData.sabak.juz;
                }
            });
            
            const sabakBoxes = [
                { label: 'LINES', value: totalLines, color: [16, 163, 127] },
                { label: 'PAGES', value: Math.round(totalPages * 10) / 10, color: [142, 68, 173] },
                { label: 'JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            const sabakBoxWidth = 50;
            const sabakSpacing = 8;
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (sabakBoxWidth + sabakSpacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, sabakBoxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (sabakBoxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (sabakBoxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 35;
            
            // CONDENSED Daily Breakdown Table for combined report
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Daily Breakdown (Top 10 Days)', 20, yPos);
            yPos += 10;
            
            // Get days with data in current month and show top 10
            const year = new Date().getFullYear();
            const month = new Date().getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const rowHeight = 6; // Smaller rows for combined report
            const colStarts = [20, 35, 65, 90, 115, 150];
            const colWidths = [15, 30, 25, 25, 35, 35];
            const tableWidth = 165;
            
            // Table headers
            pdf.setFillColor(240, 240, 240);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
            
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
            
            for (let i = 0; i <= colStarts.length; i++) {
                const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                pdf.line(x, yPos, x, yPos + rowHeight);
            }
            
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(6);
            pdf.setFont(undefined, 'bold');
            
            const headers = ['Date', 'Sabak', 'Sabak Para', 'Dhor', 'Status', 'Parent Review'];
            headers.forEach(function(header, index) {
                centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 4);
            });
            
            yPos += rowHeight;
            
            // Show only first 10 days or days with data (whichever is fewer)
            const maxDaysToShow = Math.min(10, daysInMonth);
            
            for (let day = 1; day <= maxDaysToShow; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = studentData[dateKey] || {};
                
                // Determine row background color
                let rowColor = [255, 255, 255];
                if (dayData.absent) {
                    rowColor = [255, 235, 235];
                } else if (dayData.didNotGive) {
                    rowColor = [255, 243, 224];
                }
                
                pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.2);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPos, x, yPos + rowHeight);
                }
                
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                
                centerTextInColumn(day.toString(), colStarts[0], colWidths[0], yPos + 4);
                
                let sabakText = dayData.sabak ? (dayData.sabak.amount || `${dayData.sabak.lines} lines`) : '--';
                if (sabakText.length > 10) sabakText = sabakText.substring(0, 8) + '..';
                centerTextInColumn(sabakText, colStarts[1], colWidths[1], yPos + 4);
                
                let paraText = dayData.para ? dayData.para.amount : '--';
                if (paraText.length > 8) paraText = paraText.substring(0, 6) + '..';
                centerTextInColumn(paraText, colStarts[2], colWidths[2], yPos + 4);
                
                let dhorText = dayData.dhor ? dayData.dhor.amount : '--';
                if (dhorText.length > 8) dhorText = dhorText.substring(0, 6) + '..';
                centerTextInColumn(dhorText, colStarts[3], colWidths[3], yPos + 4);
                
                let statusText = 'Present';
                let statusColor = [52, 199, 89];
                if (dayData.absent) {
                    statusText = 'Absent';
                    statusColor = [255, 59, 48];
                } else if (dayData.didNotGive) {
                    statusText = 'Did Not Give';
                    statusColor = [255, 149, 0];
                }
                
                pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 4);
                
                const parentReview = dayData.parentChecked ? '✓' : '✗';
                const parentColor = dayData.parentChecked ? [52, 199, 89] : [255, 59, 48];
                pdf.setTextColor(parentColor[0], parentColor[1], parentColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(parentReview, colStarts[5], colWidths[5], yPos + 4);
                
                yPos += rowHeight;
            }
        }

        // STEP 3: Create complete specialized functions for combined reports

        async function generateYearlySummaryPDFForCombined(studentId, academicYear, pdf) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const juzData = await getStudentJuzProgress(studentId);
            
            // ADDED: Fetch target data for the student and academic year
            const targetYear = academicYear || await getCurrentAcademicYear();
            const targetData = await getStudentTargetsForYear(studentId, targetYear);
            
            // Helper function for rounded rectangles
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            // Helper function to center text in column
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Define constants at the top
            const startX = 20;
            const boxWidth = 50;
            const boxHeight = 18;
            const spacing = 3;
            
            // PROFESSIONAL HEADER - Fresh start on new page
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 18, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('YEARLY SUMMARY REPORT', 105, 15, { align: 'center' });
            
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const displayYear = academicYear || new Date().getFullYear();
            pdf.text('Academic Year: ' + displayYear, 105, 39, { align: 'center' });
            
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 50;
            
            // Hifz Duration Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Hifz Journey Overview', 20, yPos);
            yPos += 8;
            
            if (juzData.hifzStartDate) {
                // Calculate duration
                const totalDuration = calculateDuration(juzData.hifzStartDate);
                const durationText = formatDuration(totalDuration);
                
                // Duration box
                pdf.setFillColor(255, 255, 255);
                roundedRect(20, yPos, 170, 18, 2, 'F');
                
                pdf.setFillColor(16, 163, 127);
                roundedRect(20, yPos, 170, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(20, yPos, 170, 18, 2, 'S');
                
                pdf.setTextColor(16, 163, 127);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Total Hifz Duration: ' + durationText, 25, yPos + 8);
                
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                pdf.text('Started: ' + new Date(juzData.hifzStartDate).toLocaleDateString(), 25, yPos + 13);
                
                yPos += 25;
                
                // Find current Juz
                const completedJuz = Object.values(juzData.juzProgress || {}).filter(juz => juz.startDate && juz.finishDate).length;
                const currentJuzEntries = Object.entries(juzData.juzProgress || {}).filter(([juzNum, juz]) => juz.startDate && !juz.finishDate);
                const remainingJuz = 30 - completedJuz - currentJuzEntries.length;
                
                let currentJuzDisplay = '0';
                if (currentJuzEntries.length > 0) {
                    currentJuzDisplay = currentJuzEntries[0][0];
                    
                    pdf.setTextColor(59, 130, 246);
                    pdf.setFontSize(11);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Currently working on: Juz ${currentJuzDisplay}`, 20, yPos);
                    yPos += 12;
                }
                
                // Juz Progress Summary
                const juzBoxes = [
                    { label: 'COMPLETED', value: completedJuz, color: [52, 199, 89] },
                    { label: 'CURRENT', value: currentJuzDisplay, color: [59, 130, 246] },
                    { label: 'REMAINING', value: remainingJuz, color: [142, 142, 147] }
                ];
                
                juzBoxes.forEach(function(box, index) {
                    const x = startX + (index * (boxWidth + spacing));
                    
                    pdf.setFillColor(255, 255, 255);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                    
                    pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                    roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                    
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                    
                    pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    const numWidth = pdf.getTextWidth(box.value.toString());
                    pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                    
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(6);
                    pdf.setFont(undefined, 'normal');
                    const labelWidth = pdf.getTextWidth(box.label);
                    pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
                });
                
                yPos += 25;
            } else {
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('No Hifz start date recorded', 30, yPos + 8);
                yPos += 20;
            }
            
            // Calculate yearly stats for selected academic year
            let targetYear_calc;
            if (academicYear) {
                const [startYear, endYear] = academicYear.split('-');
                targetYear_calc = { start: startYear, end: endYear, academicYear: academicYear };
            } else {
                const currentYear = new Date().getFullYear();
                targetYear_calc = { start: currentYear.toString(), end: currentYear.toString(), academicYear: currentYear.toString() };
            }
            
            const yearlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0, totalDays: 0 };
            let totalLines = 0;
            let totalPages = 0;
            let totalJuz = 0;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                // Filter by academic year if specified
                if (academicYear && !isDateInAcademicYear(date, academicYear)) {
                    return;
                } else if (!academicYear && !date.startsWith(targetYear_calc.start)) {
                    return;
                }
                
                yearlyStats.totalDays++;
                if (dayData.absent) {
                    yearlyStats.absent++;
                } else if (dayData.didNotGive) {
                    yearlyStats.didNotGive++;
                } else {
                    ['sabak', 'para', 'dhor'].forEach(type => {
                        if (dayData[type]) yearlyStats[type]++;
                    });
                    
                    // Calculate Sabak totals
                    if (dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                        if (dayData.sabak.lines) {
                            totalLines += dayData.sabak.lines;
                        }
                        if (dayData.sabak.pages) {
                            totalPages += dayData.sabak.pages;
                        }
                        if (dayData.sabak.juz) {
                            totalJuz += dayData.sabak.juz;
                        }
                    }
                }
            });
            
            // Sabak Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 8;
            
            const sabakBoxes = [
                { label: 'SABAK DAYS', value: yearlyStats.sabak, color: [16, 163, 127] },
                { label: 'TOTAL LINES', value: totalLines, color: [142, 68, 173] },
                { label: 'TOTAL JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
            });
            
            yPos += 25;
            
            // Monthly Breakdown Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Breakdown', 20, yPos);
            yPos += 10;
            
            // UPDATED: Generate monthly breakdown table with Target column (7 columns now)
            const colStarts = [20, 45, 65, 85, 105, 125, 145];    // ADDED 7th column
            const colWidths = [25, 20, 20, 20, 20, 20, 20];       // ADDED 7th width
            const tableWidth = 145;                                // INCREASED table width
            const rowHeight = 8;
            
            // Table headers
            pdf.setFillColor(240, 240, 240);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
            
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
            
            // UPDATED: Vertical lines for 7 columns
            for (let i = 0; i <= colStarts.length; i++) {
                const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                pdf.line(x, yPos, x, yPos + rowHeight);
            }
            
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(7);
            pdf.setFont(undefined, 'bold');
            
            // UPDATED: Added 'Target' to headers
            const headers = ['Month', 'Sabak', 'Para', 'Dhor', 'Absent', 'Did Not Give', 'Target'];
            headers.forEach(function(header, index) {
                centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 5);
            });
            
            yPos += rowHeight;
            
            // Generate monthly data
            if (academicYear) {
                const [startYear, endYear] = academicYear.split('-');
                const months = [
                    { key: `${startYear}-09`, name: 'Sep' },
                    { key: `${startYear}-10`, name: 'Oct' },
                    { key: `${startYear}-11`, name: 'Nov' },
                    { key: `${startYear}-12`, name: 'Dec' },
                    { key: `${endYear}-01`, name: 'Jan' },
                    { key: `${endYear}-02`, name: 'Feb' },
                    { key: `${endYear}-03`, name: 'Mar' },
                    { key: `${endYear}-04`, name: 'Apr' },
                    { key: `${endYear}-05`, name: 'May' },
                    { key: `${endYear}-06`, name: 'Jun' },
                    { key: `${endYear}-07`, name: 'Jul' },
                    { key: `${endYear}-08`, name: 'Aug' }
                ];
                
                months.forEach((month, index) => {
                    // Calculate monthly stats
                    const monthStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
                    
                    Object.entries(studentData).forEach(([date, dayData]) => {
                        if (date.startsWith(month.key)) {
                            if (dayData.absent) {
                                monthStats.absent++;
                            } else if (dayData.didNotGive) {
                                monthStats.didNotGive++;
                            } else {
                                ['sabak', 'para', 'dhor'].forEach(type => {
                                    if (dayData[type]) monthStats[type]++;
                                });
                            }
                        }
                    });
                    
                    // ADDED: Get target status for this month
                    let targetStatus = '--';
                    let targetColor = [142, 142, 147]; // Default gray
                    
                    if (targetData.monthly && targetData.monthly[month.key] && targetData.monthly[month.key].status) {
                        const status = targetData.monthly[month.key].status;
                        switch(status) {
                            case 'above':
                                targetStatus = 'Above';
                                targetColor = [52, 199, 89]; // Green
                                break;
                            case 'on':
                                targetStatus = 'On';
                                targetColor = [59, 130, 246]; // Blue
                                break;
                            case 'below':
                                targetStatus = 'Below';
                                targetColor = [255, 59, 48]; // Red
                                break;
                        }
                    }
                    
                    // Row background
                    const rowColor = index % 2 === 0 ? [255, 255, 255] : [248, 249, 250];
                    pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                    
                    // Row border
                    pdf.setDrawColor(220, 220, 220);
                    pdf.setLineWidth(0.2);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                    
                    // UPDATED: Vertical lines for 7 columns
                    for (let i = 0; i <= colStarts.length; i++) {
                        const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                        pdf.line(x, yPos, x, yPos + rowHeight);
                    }
                    
                    // Cell content
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(7);
                    pdf.setFont(undefined, 'normal');
                    
                    centerTextInColumn(month.name, colStarts[0], colWidths[0], yPos + 5);
                    centerTextInColumn(monthStats.sabak.toString(), colStarts[1], colWidths[1], yPos + 5);
                    centerTextInColumn(monthStats.para.toString(), colStarts[2], colWidths[2], yPos + 5);
                    centerTextInColumn(monthStats.dhor.toString(), colStarts[3], colWidths[3], yPos + 5);
                    centerTextInColumn(monthStats.absent.toString(), colStarts[4], colWidths[4], yPos + 5);
                    centerTextInColumn(monthStats.didNotGive.toString(), colStarts[5], colWidths[5], yPos + 5);
                    
                    // ADDED: Target status with appropriate color
                    pdf.setTextColor(targetColor[0], targetColor[1], targetColor[2]);
                    pdf.setFont(undefined, 'bold');
                    centerTextInColumn(targetStatus, colStarts[6], colWidths[6], yPos + 5);
                    
                    yPos += rowHeight;
                });
            }
        }

        async function generateMonthlyDetailedPDFForCombined(studentId, year, month, pdf) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const homework = await getStudentHomework(studentId);
            
            // Helper functions
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Fresh header
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 20, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('MONTHLY PROGRESS REPORT', 105, 15, { align: 'center' });
            
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                            'July', 'August', 'September', 'October', 'November', 'December'];
            const monthYear = `${monthNames[parseInt(month) - 1]} ${year}`;
            pdf.text(monthYear, 105, 39, { align: 'center' });
            
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 55;
            
            // Monthly Progress Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Monthly Progress', 20, yPos);
            yPos += 10;
            
            // Calculate monthly stats for SELECTED month
            const selectedMonth = `${year}-${String(month).padStart(2, '0')}`;
            const monthlyStats = { sabak: 0, para: 0, dhor: 0, absent: 0, didNotGive: 0 };
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(selectedMonth)) {
                    if (dayData.absent) {
                        monthlyStats.absent++;
                    } else if (dayData.didNotGive) {
                        monthlyStats.didNotGive++;
                    } else {
                        ['sabak', 'para', 'dhor'].forEach(function(type) {
                            if (dayData[type]) monthlyStats[type]++;
                        });
                    }
                }
            });
            
            // Monthly Progress Boxes
            const boxWidth = 38;
            const boxHeight = 22;
            const spacing = 6;
            const startX = 20;
            
            const progressBoxes = [
                { label: 'SABAK', value: monthlyStats.sabak, color: [16, 163, 127] },
                { label: 'SABAK PARA', value: monthlyStats.para, color: [142, 68, 173] },
                { label: 'DHOR', value: monthlyStats.dhor, color: [255, 149, 0] },
                { label: 'ABSENT', value: monthlyStats.absent, color: [255, 59, 48] }
            ];
            
            progressBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Homework Summary Section
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Homework Summary', 20, yPos);
            yPos += 10;
            
            // Filter homework for selected month
            const selectedMonthHomework = homework.filter(hw => {
                const assignedDate = new Date(hw.assignedDate);
                const hwMonth = `${assignedDate.getFullYear()}-${String(assignedDate.getMonth() + 1).padStart(2, '0')}`;
                return hwMonth === selectedMonth;
            });
            
            // Calculate homework stats for selected month
            const homeworkStats = {
                total: selectedMonthHomework.length,
                completed: selectedMonthHomework.filter(hw => hw.completed).length,
                pending: selectedMonthHomework.filter(hw => !hw.completed && hw.status !== 'did-not-give').length,
                didNotDo: selectedMonthHomework.filter(hw => hw.status === 'did-not-give').length
            };
            
            const homeworkBoxes = [
                { label: 'TOTAL', value: homeworkStats.total, color: [28, 28, 30] },
                { label: 'COMPLETED', value: homeworkStats.completed, color: [52, 199, 89] },
                { label: 'PENDING', value: homeworkStats.pending, color: [255, 149, 0] },
                { label: 'DID NOT DO', value: homeworkStats.didNotDo, color: [255, 59, 48] }
            ];
            
            homeworkBoxes.forEach(function(box, index) {
                const x = startX + (index * (boxWidth + spacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 32;
            
            // Sabak Summary Section  
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Sabak Summary', 20, yPos);
            yPos += 10;
            
            // Calculate total sabak for the SELECTED month
            let totalLines = 0;
            let totalPages = 0;
            let totalJuz = 0;
            
            Object.entries(studentData).forEach(function([date, dayData]) {
                if (date.startsWith(selectedMonth) && dayData.sabak && !dayData.absent && !dayData.didNotGive) {
                    if (dayData.sabak.lines) {
                        totalLines += dayData.sabak.lines;
                    }
                    if (dayData.sabak.pages) {
                        totalPages += dayData.sabak.pages;
                    }
                    if (dayData.sabak.juz) {
                        totalJuz += dayData.sabak.juz;
                    }
                }
            });
            
            const sabakBoxes = [
                { label: 'LINES', value: totalLines, color: [16, 163, 127] },
                { label: 'PAGES', value: Math.round(totalPages * 10) / 10, color: [142, 68, 173] },
                { label: 'JUZ', value: convertJuzToFraction(totalJuz), color: [255, 149, 0] }
            ];
            
            // Use wider boxes for Sabak Summary (3 boxes instead of 4)
            const sabakBoxWidth = 50;
            const sabakSpacing = 8;
            
            sabakBoxes.forEach(function(box, index) {
                const x = startX + (index * (sabakBoxWidth + sabakSpacing));
                
                pdf.setFillColor(255, 255, 255);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'F');
                
                pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                roundedRect(x, yPos, sabakBoxWidth, 2, 2, 'F');
                
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(x, yPos, sabakBoxWidth, boxHeight, 2, 'S');
                
                pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                const numWidth = pdf.getTextWidth(box.value.toString());
                pdf.text(box.value.toString(), x + (sabakBoxWidth - numWidth)/2, yPos + 12);
                
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                const labelWidth = pdf.getTextWidth(box.label);
                pdf.text(box.label, x + (sabakBoxWidth - labelWidth)/2, yPos + 18);
            });
            
            yPos += 35;
            
            // CONDENSED Daily Breakdown Table for combined report
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text('Daily Breakdown (First 15 Days)', 20, yPos);
            yPos += 10;
            
            // Get days in SELECTED month
            const selectedYear = parseInt(year);
            const selectedMonthNum = parseInt(month) - 1; // JavaScript months are 0-based
            const daysInMonth = new Date(selectedYear, selectedMonthNum + 1, 0).getDate();
            
            const rowHeight = 6; // Smaller rows for combined report
            const colStarts = [20, 35, 65, 90, 115, 150];
            const colWidths = [15, 30, 25, 25, 35, 35];
            const tableWidth = 165;
            
            // Table headers
            pdf.setFillColor(240, 240, 240);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
            
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.3);
            pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
            
            for (let i = 0; i <= colStarts.length; i++) {
                const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                pdf.line(x, yPos, x, yPos + rowHeight);
            }
            
            pdf.setTextColor(28, 28, 30);
            pdf.setFontSize(6);
            pdf.setFont(undefined, 'bold');
            
            const headers = ['Date', 'Sabak', 'Sabak Para', 'Dhor', 'Status', 'Parent Review'];
            headers.forEach(function(header, index) {
                centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 4);
            });
            
            yPos += rowHeight;
            
            // Show only first 15 days or total days (whichever is fewer) for combined report
            const maxDaysToShow = Math.min(15, daysInMonth);
            
            for (let day = 1; day <= maxDaysToShow; day++) {
                const dateKey = `${selectedYear}-${String(selectedMonthNum + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = studentData[dateKey] || {};
                
                // Determine row background color
                let rowColor = [255, 255, 255];
                if (dayData.absent) {
                    rowColor = [255, 235, 235];
                } else if (dayData.didNotGive) {
                    rowColor = [255, 243, 224];
                }
                
                pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                
                pdf.setDrawColor(220, 220, 220);
                pdf.setLineWidth(0.2);
                pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                
                for (let i = 0; i <= colStarts.length; i++) {
                    const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                    pdf.line(x, yPos, x, yPos + rowHeight);
                }
                
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(6);
                pdf.setFont(undefined, 'normal');
                
                centerTextInColumn(day.toString(), colStarts[0], colWidths[0], yPos + 4);
                
                let sabakText = dayData.sabak ? (dayData.sabak.amount || `${dayData.sabak.lines} lines`) : '--';
                if (sabakText.length > 10) sabakText = sabakText.substring(0, 8) + '..';
                centerTextInColumn(sabakText, colStarts[1], colWidths[1], yPos + 4);
                
                let paraText = dayData.para ? dayData.para.amount : '--';
                if (paraText.length > 8) paraText = paraText.substring(0, 6) + '..';
                centerTextInColumn(paraText, colStarts[2], colWidths[2], yPos + 4);
                
                let dhorText = dayData.dhor ? dayData.dhor.amount : '--';
                if (dhorText.length > 8) dhorText = dhorText.substring(0, 6) + '..';
                centerTextInColumn(dhorText, colStarts[3], colWidths[3], yPos + 4);
                
                let statusText = 'Present';
                let statusColor = [52, 199, 89];
                if (dayData.absent) {
                    statusText = 'Absent';
                    statusColor = [255, 59, 48];
                } else if (dayData.didNotGive) {
                    statusText = 'Did Not Give';
                    statusColor = [255, 149, 0];
                }
                
                pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 4);
                
                const parentReview = dayData.parentChecked ? '✓' : '✗';
                const parentColor = dayData.parentChecked ? [52, 199, 89] : [255, 59, 48];
                pdf.setTextColor(parentColor[0], parentColor[1], parentColor[2]);
                pdf.setFont(undefined, 'bold');
                centerTextInColumn(parentReview, colStarts[5], colWidths[5], yPos + 4);
                
                yPos += rowHeight;
            }
        }

        async function generateOverallProgressPDFForCombined(studentId, pdf) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const juzData = await getStudentJuzProgress(studentId);
            
            // Helper functions
            function roundedRect(x, y, width, height, radius, style) {
                if (typeof pdf.roundedRect !== 'undefined') {
                    pdf.roundedRect(x, y, width, height, radius, radius, style);
                } else {
                    pdf.rect(x, y, width, height, style);
                }
            }
            
            function centerTextInColumn(text, colStart, colWidth, yPos) {
                const textWidth = pdf.getTextWidth(text);
                const centerX = colStart + (colWidth / 2) - (textWidth / 2);
                pdf.text(text, centerX, yPos);
            }
            
            // Fresh header
            pdf.setFillColor(16, 163, 127);
            pdf.rect(0, 0, 210, 25, 'F');
            
            pdf.setFillColor(250, 250, 250);
            pdf.rect(0, 25, 210, 18, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.text('OVERALL PROGRESS REPORT', 105, 15, { align: 'center' });
            
            pdf.setTextColor(60, 60, 60);
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.text(student.name.toUpperCase(), 105, 32, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('Complete Hifz Journey Overview', 105, 39, { align: 'center' });
            
            pdf.setDrawColor(16, 163, 127);
            pdf.setLineWidth(0.5);
            pdf.line(20, 42, 190, 42);
            
            let yPos = 48;
            
            if (!juzData.hifzStartDate) {
                // No data message
                pdf.setTextColor(142, 142, 147);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'normal');
                pdf.text('No Hifz progress data available', 105, yPos + 50, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text('Please contact the Ustaadh to set up Hifz tracking', 105, yPos + 70, { align: 'center' });
            } else {
                // Hifz Duration Section - COMPACT
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Hifz Journey Overview', 20, yPos);
                yPos += 6;
                
                // Calculate total duration
                const totalDuration = calculateDuration(juzData.hifzStartDate);
                const durationText = formatDuration(totalDuration);
                
                // Duration card - SMALLER
                pdf.setFillColor(255, 255, 255);
                roundedRect(20, yPos, 170, 16, 2, 'F');
                
                // Top colored bar
                pdf.setFillColor(16, 163, 127);
                roundedRect(20, yPos, 170, 2, 2, 'F');
                
                // Border
                pdf.setDrawColor(229, 229, 234);
                pdf.setLineWidth(0.3);
                roundedRect(20, yPos, 170, 16, 2, 'S');
                
                // Duration text
                pdf.setTextColor(16, 163, 127);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('Total Hifz Duration: ' + durationText, 25, yPos + 8);
                
                pdf.setFontSize(8);
                pdf.setFont(undefined, 'normal');
                const startDateStr = new Date(juzData.hifzStartDate).toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                pdf.text('Started: ' + startDateStr, 25, yPos + 13);
                
                yPos += 22;
                
                // Calculate Juz statistics
                const completedJuz = [];
                const currentJuz = [];
                const notStartedJuz = [];
                
                for (let juzNumber = 1; juzNumber <= 30; juzNumber++) {
                    const juzInfo = juzData.juzProgress[juzNumber];
                    if (juzInfo && juzInfo.startDate && juzInfo.finishDate) {
                        completedJuz.push({ number: juzNumber, ...juzInfo });
                    } else if (juzInfo && juzInfo.startDate && !juzInfo.finishDate) {
                        currentJuz.push({ number: juzNumber, ...juzInfo });
                    } else {
                        notStartedJuz.push(juzNumber);
                    }
                }
                
                // Progress Summary Boxes - COMPACT
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Progress Summary', 20, yPos);
                yPos += 6;
                
                const boxWidth = 50;
                const boxHeight = 18;
                const spacing = 8;
                const startX = 20;
                
                // Show actual Juz number instead of count for CURRENT
                const currentJuzNumber = currentJuz.length > 0 ? currentJuz[0].number : 0;
                
                const progressBoxes = [
                    { label: 'COMPLETED', value: completedJuz.length, color: [52, 199, 89] },
                    { label: 'CURRENT', value: currentJuzNumber, color: [59, 130, 246] },
                    { label: 'REMAINING', value: notStartedJuz.length, color: [142, 142, 147] }
                ];
                
                progressBoxes.forEach(function(box, index) {
                    const x = startX + (index * (boxWidth + spacing));
                    
                    // Box background
                    pdf.setFillColor(255, 255, 255);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'F');
                    
                    // Top colored bar
                    pdf.setFillColor(box.color[0], box.color[1], box.color[2]);
                    roundedRect(x, yPos, boxWidth, 2, 2, 'F');
                    
                    // Border
                    pdf.setDrawColor(229, 229, 234);
                    pdf.setLineWidth(0.3);
                    roundedRect(x, yPos, boxWidth, boxHeight, 2, 'S');
                    
                    // Number - Centered
                    pdf.setTextColor(box.color[0], box.color[1], box.color[2]);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    const numWidth = pdf.getTextWidth(box.value.toString());
                    pdf.text(box.value.toString(), x + (boxWidth - numWidth)/2, yPos + 10);
                    
                    // Label - Centered
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(6);
                    pdf.setFont(undefined, 'normal');
                    const labelWidth = pdf.getTextWidth(box.label);
                    pdf.text(box.label, x + (boxWidth - labelWidth)/2, yPos + 15);
                });
                
                yPos += 24;
                
                // Detailed Progress Table - CONDENSED for combined report
                pdf.setTextColor(28, 28, 30);
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text('Detailed Juz Progress', 20, yPos);
                yPos += 8;
                
                // Combine and sort all Juz with data
                const allJuzWithData = [...completedJuz, ...currentJuz].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                
                if (allJuzWithData.length === 0) {
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'normal');
                    pdf.text('No Juz progress recorded yet', 20, yPos + 8);
                    yPos += 16;
                } else {
                    // Table setup - EXACTLY SAME AS INDIVIDUAL REPORT
                    const rowHeight = 8;
                    const colStarts = [20, 35, 75, 115, 155]; // Same as individual report
                    const colWidths = [15, 40, 40, 40, 30];   // Same as individual report
                    const tableWidth = 165;
                    
                    // Table headers
                    pdf.setFillColor(240, 240, 240);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                    
                    pdf.setDrawColor(200, 200, 200);
                    pdf.setLineWidth(0.3);
                    pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                    
                    // Vertical lines for 5 columns (same as individual)
                    for (let i = 0; i <= colStarts.length; i++) {
                        const x = i === colStarts.length ? (20 + tableWidth) : colStarts[i];
                        pdf.line(x, yPos, x, yPos + rowHeight);
                    }
                    
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(7); // Same as individual report
                    pdf.setFont(undefined, 'bold');
                    
                    const headers = ['Juz', 'Start Date', 'End Date', 'Duration', 'Status'];
                    headers.forEach(function(header, index) {
                        centerTextInColumn(header, colStarts[index], colWidths[index], yPos + 5);
                    });
                    
                    yPos += rowHeight;
                    
                    // Add rows for ALL Juz entries (same as individual report - no limit)
                    for (let i = 0; i < allJuzWithData.length; i++) {
                        const juz = allJuzWithData[i];
                        const isCompleted = juz.startDate && juz.finishDate;
                        
                        // Row background
                        let rowColor = isCompleted ? [240, 253, 244] : [239, 246, 255];
                        pdf.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
                        pdf.rect(20, yPos, tableWidth, rowHeight, 'F');
                        
                        // Row border
                        pdf.setDrawColor(220, 220, 220);
                        pdf.setLineWidth(0.2);
                        pdf.rect(20, yPos, tableWidth, rowHeight, 'S');
                        
                        // Vertical lines for 5 columns
                        for (let j = 0; j <= colStarts.length; j++) {
                            const x = j === colStarts.length ? (20 + tableWidth) : colStarts[j];
                            pdf.line(x, yPos, x, yPos + rowHeight);
                        }
                        
                        // Cell content
                        pdf.setTextColor(28, 28, 30);
                        pdf.setFontSize(6); // Same as individual report
                        pdf.setFont(undefined, 'normal');
                        
                        // Juz number
                        centerTextInColumn(juz.number.toString(), colStarts[0], colWidths[0], yPos + 5);
                        
                        // UPDATED: Start date with full year (SAME AS INDIVIDUAL)
                        const startDate = new Date(juz.startDate).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            year: 'numeric'  // Full year like individual report
                        });
                        centerTextInColumn(startDate, colStarts[1], colWidths[1], yPos + 5);
                        
                        // UPDATED: End date with full year (SAME AS INDIVIDUAL)
                        const endDate = isCompleted ? 
                            new Date(juz.finishDate).toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'  // Full year like individual report
                            }) : '--';
                        centerTextInColumn(endDate, colStarts[2], colWidths[2], yPos + 5);
                        
                        // Duration - FULL TEXT FORMAT (SAME AS INDIVIDUAL)
                        let durationText;
                        if (isCompleted) {
                            const duration = calculateDuration(juz.startDate, juz.finishDate);
                            durationText = formatDuration(duration); // Same as individual report
                        } else {
                            const duration = calculateDuration(juz.startDate);
                            durationText = formatDuration(duration); // Same as individual report
                        }
                        centerTextInColumn(durationText, colStarts[3], colWidths[3], yPos + 5);
                        
                        // Status
                        const statusText = isCompleted ? 'Completed' : 'Current';
                        const statusColor = isCompleted ? [52, 199, 89] : [59, 130, 246];
                        pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                        pdf.setFont(undefined, 'bold');
                        centerTextInColumn(statusText, colStarts[4], colWidths[4], yPos + 5);
                        
                        yPos += rowHeight;
                    }
                    
                    yPos += 6;
                }
                
                // Remaining Juz Section - VERY COMPACT
                if (notStartedJuz.length > 0) {
                    pdf.setTextColor(28, 28, 30);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('Remaining Juz to Complete', 20, yPos);
                    yPos += 6;
                    
                    // Show remaining Juz in a very compact format
                    pdf.setTextColor(142, 142, 147);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    
                    // Break into multiple lines if too many
                    const chunkSize = 15; // Show 15 juz per line
                    for (let i = 0; i < notStartedJuz.length; i += chunkSize) {
                        const chunk = notStartedJuz.slice(i, i + chunkSize);
                        let remainingText = 'Juz ' + chunk.join(', ');
                        pdf.text(remainingText, 20, yPos);
                        yPos += 8;
                    }
                    
                    yPos += 4;
                    
                    // Progress percentage
                    const progressPercentage = Math.round((completedJuz.length / 30) * 100);
                    pdf.setTextColor(16, 163, 127);
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Overall Progress: ${progressPercentage}% Complete`, 20, yPos);
                }
            }
        }

        // Make new PDF functions available globally
        window.generateYearlySummaryPDF = generateYearlySummaryPDF;
        window.generateMonthlyDetailedPDF = generateMonthlyDetailedPDF;
        window.generateOverallProgressPDF = generateOverallProgressPDF;
        window.generateAllStudentsPDF = generateAllStudentsPDF;

        // ===== IMPORT DATA FUNCTIONS =====
        let importedData = null;

        async function showImportDataModal() {
            if (currentUserType !== 'teacher') return;
            
            // Reset modal state
            document.getElementById('importFile').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResults').style.display = 'none';
            importedData = null;
            
            // Populate student dropdown
            try {
                const students = await window.getStudents();
                const select = document.getElementById('importStudentSelect');
                select.innerHTML = '<option value="">Choose student to import data for</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading students for import:', error);
            }
            
            document.getElementById('importDataModal').style.display = 'block';
        }

        async function handleFileSelection() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const fileExtension = file.name.toLowerCase().split('.').pop();
            const supportedTypes = ['xlsx', 'xls', 'csv'];
            
            if (!supportedTypes.includes(fileExtension)) {
                alert('Please select a valid Excel (.xlsx, .xls) or CSV (.csv) file');
                fileInput.value = '';
                return;
            }
            
            try {
                // Use FileReader API instead of window.fs.readFile
                const fileData = await readFileAsArrayBuffer(file);
                await parseImportFile(fileData, fileExtension, file.name);
            } catch (error) {
                console.error('Error reading file:', error);
                alert('Error reading file. Please make sure the file is not corrupted.');
            }
        }

        // Add this new helper function
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(e) {
                    reject(new Error('Failed to read file'));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function parseImportFile(fileData, fileType, fileName) {
            try {
                let parsedData = [];
                
                if (fileType === 'csv') {
                    // Parse CSV using Papaparse
                    const csvText = new TextDecoder().decode(new Uint8Array(fileData));
                    const result = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.trim().toLowerCase()
                    });
                    
                    if (result.errors.length > 0) {
                        console.warn('CSV parsing warnings:', result.errors);
                    }
                    
                    parsedData = result.data;
                } else {
                    // Parse Excel using SheetJS
                    const workbook = XLSX.read(fileData, {
                        cellStyles: true,
                        cellFormulas: true,
                        cellDates: true,
                        cellNF: true,
                        sheetStubs: true
                    });
                    
                    // Use the first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON with header normalization
                    parsedData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        defval: ''
                    });
                    
                    // Convert to object format with normalized headers
                    if (parsedData.length > 0) {
                        const headers = parsedData[0].map(h => String(h).trim().toLowerCase());
                        const dataRows = parsedData.slice(1);
                        
                        parsedData = dataRows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        }).filter(row => Object.values(row).some(val => val !== ''));
                    } else {
                        parsedData = [];
                    }
                }
                
                if (parsedData.length === 0) {
                    alert('No data found in the file. Please check your file format.');
                    return;
                }
                
                importedData = parsedData;
                displayFilePreview(parsedData, fileName);
                
            } catch (error) {
                console.error('Error parsing file:', error);
                alert('Error parsing file: ' + error.message);
            }
        }

        function displayFilePreview(data, fileName) {
            const previewDiv = document.getElementById('filePreview');
            const previewContent = document.getElementById('previewContent');
            
            // Analyze data structure
            const sampleRows = data.slice(0, 5);
            const totalRows = data.length;
            const headers = Object.keys(data[0] || {});
            
            let previewHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>📁 File:</strong> ${fileName}<br>
                    <strong>📊 Total Rows:</strong> ${totalRows}<br>
                    <strong>📋 Columns Found:</strong> ${headers.join(', ')}<br>
                    <strong>⚠️ Note:</strong> Student names in CSV will be ignored - all data will be imported for the selected student above
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>🔍 Data Preview (first 5 rows):</strong>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: #10A37F; color: white;">
            `;
            
            headers.forEach(header => {
                previewHtml += `<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">${header}</th>`;
            });
            previewHtml += '</tr></thead><tbody>';
            
            sampleRows.forEach((row, index) => {
                previewHtml += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">`;
                headers.forEach(header => {
                    const value = row[header] || '';
                    previewHtml += `<td style="padding: 6px; border: 1px solid #ddd;">${value}</td>`;
                });
                previewHtml += '</tr>';
            });
            
            previewHtml += '</tbody></table>';
            
            if (totalRows > 5) {
                previewHtml += `<div style="margin-top: 10px; color: #8E8E93; font-size: 12px;">... and ${totalRows - 5} more rows</div>`;
            }
            
            previewContent.innerHTML = previewHtml;
            previewDiv.style.display = 'block';
        }

        async function processImportData() {
            if (!importedData || importedData.length === 0) {
                alert('No data to import');
                return;
            }
            
            // Get selected student
            const selectedStudentId = document.getElementById('importStudentSelect').value;
            if (!selectedStudentId) {
                alert('Please select a student first');
                return;
            }
            
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            
            // Show progress
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('importProgressText').textContent = 'Analyzing data...';
            
            try {
                const results = {
                    totalRows: importedData.length,
                    entriesImported: 0,
                    entriesSkipped: 0,
                    errors: []
                };
                
                // Get existing student data
                const studentData = await window.getStudentData(selectedStudentId);
                
                // Process each row
                for (let i = 0; i < importedData.length; i++) {
                    const row = importedData[i];
                    
                    document.getElementById('importProgressText').textContent = 
                        `Processing row ${i + 1} of ${importedData.length}...`;
                    
                    try {
                        const dateStr = parseDate(row['date'] || '');
                        
                        if (!dateStr) {
                            results.errors.push(`Row ${i + 1}: Missing or invalid date`);
                            continue;
                        }
                        
                        // Check for duplicates
                        if (skipDuplicates && studentData[dateStr]) {
                            results.entriesSkipped++;
                            continue;
                        }
                        
                        // Create day entry
                        const dayEntry = {};
                        
                        // Handle absent status
                        const absent = String(row['absent'] || '').toLowerCase();
                        if (absent === 'yes' || absent === 'true' || absent === '1') {
                            dayEntry.absent = true;
                        } else {
                            // Process Sabak only
                            const sabakAmount = String(row['sabak'] || '').trim();
                            if (sabakAmount && sabakAmount !== '0' && sabakAmount !== '-') {
                                const grade = normalizeGrade(row['grade'] || 'good');
                                
                                dayEntry['sabak'] = {
                                    amount: sabakAmount,
                                    grade: grade,
                                    timestamp: new Date().toISOString()
                                };
                                
                                // Special handling for sabak lines conversion
                                if (/^\d+\s*lines?$/i.test(sabakAmount)) {
                                    const lines = parseInt(sabakAmount.match(/\d+/)[0]);
                                    // Get student's Quran type
                                    const students = await window.getStudents();
                                    const student = students.find(s => s.id === selectedStudentId);
                                    const quranType = student ? student.quranType || 13 : 13;
                                    const conversion = convertLinesToPagesAndJuz(lines, quranType);
                                    
                                    dayEntry['sabak'].lines = lines;
                                    dayEntry['sabak'].pages = conversion.pages;
                                    dayEntry['sabak'].juz = conversion.juz;
                                    dayEntry['sabak'].fraction = conversion.fraction;
                                    dayEntry['sabak'].quranType = quranType;
                                }
                            }
                        }
                        
                        // Save day entry if it has data
                        if (Object.keys(dayEntry).length > 0) {
                            studentData[dateStr] = dayEntry;
                            results.entriesImported++;
                        }
                        
                    } catch (error) {
                        results.errors.push(`Row ${i + 1}: ${error.message}`);
                    }
                }
                
                // Save all data at once
                await window.saveStudentData(selectedStudentId, studentData);
                
                // Show results
                displayImportResults(results);
                
                // Refresh UI if current student is the imported one
                if (currentStudent === selectedStudentId) {
                    updateTodaysProgress();
                    updateStats();
                    generateCalendar();
                }
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: ' + error.message);
            } finally {
                document.getElementById('importProgress').style.display = 'none';
            }
        }

        function displayImportResults(results) {
            const resultsDiv = document.getElementById('importResults');
            const resultsContent = document.getElementById('resultsContent');
            
            let resultsHtml = `
                <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #E5E5EA;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 16px; background: #F0FDF4; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #16A34A;">${results.entriesImported}</div>
                            <div style="font-size: 12px; color: #8E8E93; font-weight: 600;">ENTRIES IMPORTED</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #FEF3C7; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #D97706;">${results.entriesSkipped}</div>
                            <div style="font-size: 12px; color: #8E8E93; font-weight: 600;">ENTRIES SKIPPED</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <strong>📊 Import Summary:</strong><br>
                        • Total rows processed: ${results.totalRows}<br>
                        • Selected student: Import completed<br>
                        • Entries imported: ${results.entriesImported}<br>
                        • Entries skipped: ${results.entriesSkipped}<br>
                        • Errors: ${results.errors.length}
                    </div>
            `;
            
            if (results.errors.length > 0) {
                resultsHtml += `
                    <div style="margin-top: 16px;">
                        <strong style="color: #FF3B30;">⚠️ Errors Encountered:</strong><br>
                        <div style="max-height: 150px; overflow-y: auto; background: #FEF2F2; padding: 12px; border-radius: 8px; margin-top: 8px;">
                `;
                
                results.errors.slice(0, 10).forEach(error => {
                    resultsHtml += `<div style="font-size: 12px; color: #991B1B; margin-bottom: 4px;">• ${error}</div>`;
                });
                
                if (results.errors.length > 10) {
                    resultsHtml += `<div style="font-size: 12px; color: #991B1B;">... and ${results.errors.length - 10} more errors</div>`;
                }
                
                resultsHtml += '</div></div>';
            }
            
            resultsHtml += '</div>';
            
            resultsContent.innerHTML = resultsHtml;
            resultsDiv.style.display = 'block';
        }

        // Helper Functions
        function parseDate(dateInput) {
            if (!dateInput) return null;
            
            const dateStr = String(dateInput).trim();
            console.log('Parsing date:', dateStr);
            
            // Handle various date formats - prioritize DD/MM/YYYY
            try {
                // Check for DD/MM/YYYY format first (most common in CSV exports)
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                    const parts = dateStr.split('/');
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    // Validate day and month ranges to determine DD/MM vs MM/DD
                    if (day > 12) {
                        // Must be DD/MM/YYYY since day > 12
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        }
                    } else if (month > 12) {
                        // Must be MM/DD/YYYY since month > 12
                        const date = new Date(year, day - 1, month);
                        if (!isNaN(date.getTime())) {
                            return `${year}-${String(day).padStart(2, '0')}-${String(month).padStart(2, '0')}`;
                        }
                    } else {
                        // Ambiguous - assume DD/MM/YYYY (European format)
                        const date = new Date(year, month - 1, day);
                        if (!isNaN(date.getTime())) {
                            console.log(`Assuming DD/MM/YYYY: ${dateStr} → ${year}-${month}-${day}`);
                            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        }
                    }
                }
                
                // Check for DD-MM-YYYY format
                if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateStr)) {
                    const [day, month, year] = dateStr.split('-').map(n => parseInt(n));
                    const date = new Date(year, month - 1, day);
                    if (!isNaN(date.getTime())) {
                        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }
                
                // Check for YYYY-MM-DD format (already correct)
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
                    const date = new Date(dateStr);
                    if (!isNaN(date.getTime())) {
                        return dateStr;
                    }
                }
                
                // Check for MM/DD/YYYY format (US format)
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                    const [month, day, year] = dateStr.split('/').map(n => parseInt(n));
                    const date = new Date(year, month - 1, day);
                    if (!isNaN(date.getTime())) {
                        console.log(`Using MM/DD/YYYY: ${dateStr} → ${year}-${month}-${day}`);
                        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    }
                }
                
                // Fallback to Date constructor
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
            } catch (error) {
                console.error('Date parsing error:', error);
            }
            
            return null;
        }

        // Function to fix existing incorrectly parsed dates
        async function fixExistingDates(studentId) {
            console.log('Fixing existing incorrect dates for student:', studentId);
            
            const studentData = await window.getStudentData(studentId);
            const correctedData = {};
            let fixCount = 0;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                // Fix dates that were parsed as 200X instead of 2024
                if (date.match(/^200[0-9]-09-/)) {
                    const correctDate = date.replace(/^200[0-9]/, '2024');
                    correctedData[correctDate] = dayData;
                    fixCount++;
                    console.log(`Fixed: ${date} → ${correctDate}`);
                } else {
                    // Keep correctly formatted dates
                    correctedData[date] = dayData;
                }
            });
            
            if (fixCount > 0) {
                await window.saveStudentData(studentId, correctedData);
                console.log(`Fixed ${fixCount} dates`);
                
                // Refresh UI
                currentDisplayMonth = 9;
                currentDisplayYear = 2024;
                await updateTodaysProgress();
                await updateStats();
                generateCalendar();
                
                alert(`Fixed ${fixCount} incorrectly parsed dates! Your data should now be visible.`);
            }
            
            return fixCount;
        }

        function normalizeGrade(gradeInput) {
            const grade = String(gradeInput).toLowerCase().trim();
            
            const gradeMap = {
                'excellent': 'excellent',
                'exc': 'excellent',
                'e': 'excellent',
                '4': 'excellent',
                'good': 'good',
                'very good': 'good', // Convert "Very Good" to "good"
                'g': 'good',
                '3': 'good',
                'okay': 'okay',
                'ok': 'okay',
                'o': 'okay',
                '2': 'okay',
                'poor': 'poor',
                'p': 'poor',
                '1': 'poor',
                'bad': 'poor'
            };
            
            return gradeMap[grade] || 'good';
        }

        function generateAccessCode() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Make import functions available globally
        window.showImportDataModal = showImportDataModal;
        window.handleFileSelection = handleFileSelection;
        window.processImportData = processImportData;
        window.fixExistingDates = fixExistingDates;
    </script>
</body>
</html>
