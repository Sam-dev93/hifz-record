<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="📖 Hifz Record">
    <meta name="theme-color" content="#F2F2F7">
    <title>📖 Hifz Record - Progress Tracking</title>
    
    <!-- Firebase SDK v12 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, onSnapshot, deleteDoc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';
        
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuA7Nr0A2eyxDJ3-TY5ODXCMy1uYk9UPM",
            authDomain: "hifz-record-dee0e.firebaseapp.com",
            projectId: "hifz-record-dee0e",
            storageBucket: "hifz-record-dee0e.firebasestorage.app",
            messagingSenderId: "619664875996",
            appId: "1:619664875996:web:43ad2a1e69d4a02837ef19"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = { auth, db };
        window.firebaseModules = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc,
            getDocs,
            collection,
            onSnapshot,
            deleteDoc,
            updateDoc,
            query,
            where
        };
    </script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #F2F2F7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            color: #1C1C1E;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F2F2F7;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1024px;
                padding: 0 20px;
            }
        }

        .header {
            background: #F2F2F7;
            padding: 20px;
            text-align: center;
            border-radius: 0;
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px 40px;
            }
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1C1C1E;
        }

        @media (min-width: 768px) {
            .app-title {
                font-size: 36px;
            }
        }

        .current-date {
            font-size: 16px;
            font-weight: 500;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .current-date {
                font-size: 18px;
            }
        }

        .cloud-status {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            color: #1C1C1E;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .cloud-status.connected {
            background: rgba(16, 163, 127, 0.2);
            color: #0D7A5F;
        }

        .cloud-status.connecting {
            background: rgba(255, 149, 0, 0.2);
            color: #E65100;
        }

        .cloud-status.disconnected {
            background: rgba(255, 59, 48, 0.2);
            color: #C62828;
        }

        .user-info {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(16, 163, 127, 0.1);
            border-radius: 12px;
            color: #1C1C1E;
            font-size: 14px;
            font-weight: 600;
        }

        /* Profile Selection */
        .profile-selection { 
            margin: 20px; 
            display: block; 
        }

        @media (min-width: 768px) {
            .profile-selection {
                margin: 40px auto;
                max-width: 600px;
            }
        }

        .profile-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .profile-card {
                padding: 40px;
            }
        }

        .profile-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .profile-title {
                font-size: 28px;
                margin-bottom: 30px;
            }
        }

        .profile-option {
            background: #F8F9FA;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .profile-option {
                padding: 20px;
                gap: 16px;
            }
        }

        .profile-option:hover {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.05);
        }

        .profile-option.selected {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.1);
        }

        .profile-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .profile-icon {
                font-size: 32px;
                width: 50px;
            }
        }

        .profile-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        @media (min-width: 768px) {
            .profile-info h3 {
                font-size: 18px;
            }
        }

        .profile-info p {
            font-size: 12px;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .profile-info p {
                font-size: 14px;
            }
        }

        .continue-button {
            width: 100%;
            padding: 14px;
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        @media (min-width: 768px) {
            .continue-button {
                padding: 18px;
                font-size: 18px;
            }
        }

        .continue-button:hover {
            background: #0D7A5F;
        }

        .continue-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        /* Login styles */
        .login-section { 
            margin: 20px; 
            display: none; 
        }

        @media (min-width: 768px) {
            .login-section {
                margin: 40px auto;
                max-width: 500px;
            }
        }
        
        .login-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .login-card {
                padding: 40px;
            }
        }
        
        .login-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .login-title {
                font-size: 28px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #8E8E93;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 10px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }
        
        .login-button { 
            width: 100%; 
            padding: 14px; 
            background: #10A37F; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .login-button {
                padding: 18px;
                font-size: 18px;
            }
        }
        
        .login-button:hover { 
            background: #0D7A5F; 
        }

        .back-button {
            background: #8E8E93;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .error-message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
            display: none;
            background: #FF3B30;
            color: white;
        }

        /* Permission Notice */
        .permission-notice {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid #10A37F;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 15px 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #0D7A5F;
            display: none;
        }

        @media (min-width: 768px) {
            .permission-notice {
                margin: 20px 40px;
                font-size: 16px;
            }
        }

        .permission-notice.read-only {
            background: rgba(255, 149, 0, 0.1);
            border-color: #FF9500;
            color: #E65100;
        }

        /* Hide student selector for parent users */
        .parent-mode .student-selector {
            display: none;
        }

        /* Main app styles */
        .main-content { 
            display: none; 
            padding: 10px 20px 20px 20px; 
        }

        @media (min-width: 768px) {
            .main-content {
                padding: 15px 40px 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 40px;
                align-items: start;
            }

            .main-left {
                order: 1;
            }

            .main-right {
                order: 2;
            }
        }
        
        .student-selector { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .student-selector {
                margin-bottom: 30px;
            }
        }
        
        .student-tabs { 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 4px; 
        }

        @media (min-width: 768px) {
            .student-tabs {
                gap: 12px;
                flex-wrap: wrap;
                overflow-x: visible;
            }
        }
        
        .student-tab { 
            min-width: 100px; 
            max-width: 140px;
            padding: 12px 16px; 
            background: white; 
            border: 1px solid #E5E5EA; 
            border-radius: 20px; 
            color: #8E8E93; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .student-tab {
                min-width: 120px;
                max-width: 160px;
                padding: 14px 20px;
                font-size: 14px;
            }
        }
        
        .student-tab.active { 
            background: #10A37F; 
            border-color: #10A37F; 
            color: white; 
        }

        .stats-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 16px; 
            margin-bottom: 24px; 
        }

        @media (min-width: 768px) {
            .stats-container {
                gap: 20px;
                margin-bottom: 32px;
            }
        }
        
        .stat-card { 
            background: white; 
            padding: 24px; 
            border-radius: 24px; 
            border: 1px solid #E5E5EA; 
            text-align: center; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); 
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10A37F, #0D7A5F);
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 32px 24px;
            }
        }
        
        .stat-number { 
            font-size: 36px; 
            font-weight: 800; 
            margin-bottom: 8px; 
            background: linear-gradient(135deg, #10A37F, #0D7A5F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (min-width: 768px) {
            .stat-number {
                font-size: 42px;
                margin-bottom: 12px;
            }
        }
        
        .stat-label { 
            font-size: 14px; 
            color: #6B7280; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 16px;
            }
        }
        
        .stat-card.sabak .stat-number { 
            background: linear-gradient(135deg, #10A37F, #0D7A5F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.sabak::before {
            background: linear-gradient(90deg, #10A37F, #0D7A5F);
        }
        
        .stat-card.para .stat-number { 
            background: linear-gradient(135deg, #8E44AD, #7C3AED);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.para::before {
            background: linear-gradient(90deg, #8E44AD, #7C3AED);
        }
        
        .stat-card.dhor .stat-number { 
            background: linear-gradient(135deg, #FF9500, #F59E0B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.dhor::before {
            background: linear-gradient(90deg, #FF9500, #F59E0B);
        }

        .section { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .section {
                margin-bottom: 30px;
            }
        }
        
        .section-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 12px; 
            padding-left: 4px; 
        }

        @media (min-width: 768px) {
            .section-title {
                font-size: 22px;
                margin-bottom: 16px;
            }
        }

        .today-progress { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }
        
        .progress-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 18px; 
            border-bottom: 1px solid #F2F2F7; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .progress-row {
                padding: 20px 24px;
            }
        }

        .progress-row.read-only {
            cursor: default;
        }
        
        .progress-row:last-child { 
            border-bottom: none; 
        }
        
        .progress-row:hover:not(.read-only) { 
            background: #F8F9FA; 
        }
        
        .progress-info { 
            display: flex; 
            align-items: center; 
        }
        
        .progress-icon { 
            width: 40px; 
            height: 40px; 
            background: #F2F2F7; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 12px; 
            font-size: 18px; 
        }

        @media (min-width: 768px) {
            .progress-icon {
                width: 50px;
                height: 50px;
                margin-right: 16px;
                font-size: 22px;
            }
        }
        
        .progress-icon.sabak { 
            background: rgba(16, 163, 127, 0.1); 
            color: #10A37F; 
        }
        
        .progress-icon.para { 
            background: rgba(142, 68, 173, 0.1); 
            color: #8E44AD; 
        }
        
        .progress-icon.dhor { 
            background: rgba(255, 149, 0, 0.1); 
            color: #FF9500; 
        }
        
        .progress-details h4 { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 2px; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .progress-details h4 {
                font-size: 18px;
            }
        }
        
        .progress-details p { 
            font-size: 13px; 
            color: #8E8E93; 
        }

        @media (min-width: 768px) {
            .progress-details p {
                font-size: 14px;
            }
        }
        
        .progress-status { 
            display: flex; 
            align-items: center; 
            gap: 6px;
            white-space: nowrap;
        }
        
        .amount-badge { 
            background: #F2F2F7; 
            color: #8E8E93; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
        }

        @media (min-width: 768px) {
            .amount-badge {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
        
        .grade-badge { 
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .grade-badge {
                width: 16px;
                height: 16px;
            }
        }
        
        .grade-badge.excellent { 
            background: #34C759; 
        }
        
        .grade-badge.good { 
            background: #10A37F; 
        }
        
        .grade-badge.okay { 
            background: #FF9500; 
        }
        
        .grade-badge.poor { 
            background: #FF3B30; 
        }

        .parent-check-button { 
            background: #34C759; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .parent-check-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .parent-check-button.checked { 
            background: #8E8E93; 
        }

        .conversion-badge {
            background: rgba(16, 163, 127, 0.1);
            color: #10A37F;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        @media (min-width: 768px) {
            .conversion-badge {
                font-size: 11px;
                padding: 3px 8px;
            }
        }

        .parent-check-indicator {
            color: #007AFF;
            font-size: 14px;
            font-weight: 600;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-check-indicator {
                font-size: 16px;
            }
        }

        .parent-pending-indicator {
            color: #FF3B30;
            font-size: 12px;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-pending-indicator {
                font-size: 14px;
            }
        }

        .absent-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .absent-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .absent-button.active { 
            background: #8E8E93; 
        }

        .absent-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        .today-progress.absent { 
            opacity: 0.5; 
            pointer-events: none; 
        }

        /* Homework Button */
        .homework-button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .homework-button:hover {
            background: #2563EB;
        }

        @media (min-width: 768px) {
            .homework-button {
                font-size: 16px;
                padding: 16px 32px;
            }
        }

        /* Calendar styles */
        .calendar-container { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .calendar-container {
                padding: 30px;
            }
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 4px; 
            margin-top: 12px; 
        }

        @media (min-width: 768px) {
            .calendar-grid {
                gap: 8px;
                margin-top: 16px;
            }
        }
        
        .day-header { 
            font-weight: 600; 
            text-align: center; 
            padding: 10px; 
            color: #8E8E93; 
            font-size: 12px; 
        }

        @media (min-width: 768px) {
            .day-header {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #F2F2F7; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            border: 1px solid #E5E5EA; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            position: relative; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .calendar-day {
                border-radius: 12px;
                font-size: 14px;
            }
        }
        
        .calendar-day:hover { 
            background: #E5E5EA; 
        }
        
        .calendar-day.today { 
            border: 2px solid #10A37F; 
            background: #F2F2F7;
            font-weight: 700;
        }
        
        .calendar-day.has-data { 
            background: white; 
            border-color: #10A37F; 
        }

        .calendar-day.holiday {
            background: #FFF3CD !important;
            border-color: #FF9500 !important;
            color: #856404 !important;
        }

        .calendar-day.weekend {
            color: #B8B8B8;
        }
        
        .day-indicators { 
            display: flex; 
            gap: 1px; 
            margin-top: 2px; 
            align-items: center;
        }
        
        .indicator { 
            width: 4px; 
            height: 4px; 
            border-radius: 50%; 
        }

        @media (min-width: 768px) {
            .indicator {
                width: 6px;
                height: 6px;
            }
        }
        
        .indicator.sabak { 
            background: #10A37F; 
        }
        
        .indicator.para { 
            background: #8E44AD; 
        }
        
        .indicator.dhor { 
            background: #FF9500; 
        }

        .indicator.homework {
            background: #3B82F6;
        }

        .parent-check-tick {
            color: #007AFF;
            font-size: 8px;
            font-weight: bold;
            margin-left: 1px;
        }

        @media (min-width: 768px) {
            .parent-check-tick {
                font-size: 10px;
                margin-left: 2px;
            }
        }
        
        .nav-arrow { 
            background: white; 
            border: 1px solid #E5E5EA; 
            color: #10A37F; 
            padding: 10px 14px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .nav-arrow {
                padding: 12px 18px;
                font-size: 18px;
            }
        }
        
        .month-navigation { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 16px; 
            padding: 0 4px; 
        }

        @media (min-width: 768px) {
            .month-navigation {
                margin-bottom: 20px;
            }
        }
        
        .month-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            text-align: center; 
            flex: 1; 
            margin: 0 12px; 
        }

        @media (min-width: 768px) {
            .month-title {
                font-size: 22px;
            }
        }

        /* Modal styles - UPDATED WITH FIXED CLOSE BUTTON */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(5px); 
        }
        
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 0; /* Remove default padding */
            border-radius: 20px; 
            width: 95%; 
            max-width: 600px; 
            position: relative; 
            max-height: 85vh; 
            overflow: hidden; /* Changed from auto to prevent double scroll */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 800px;
                margin: 3% auto;
                width: 90%;
            }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 25px 25px 20px 25px; 
            border-bottom: 1px solid #F2F2F7; 
            background: white;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 1001;
            border-radius: 20px 20px 0 0;
        }

        @media (min-width: 768px) {
            .modal-header {
                padding: 35px 35px 25px 35px;
            }
        }

        .modal-body {
            padding: 35px 25px 25px 25px;
            max-height: calc(85vh - 100px); /* Adjust based on header height */
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-body {
                padding: 45px 35px 35px 35px;
                max-height: calc(85vh - 120px);
            }
        }
        
        .modal-title { 
            font-size: 24px; 
            font-weight: 700; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .modal-title {
                font-size: 28px;
            }
        }
        
        .close { 
            color: #8E8E93; 
            font-size: 32px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: color 0.3s ease; 
            padding: 8px; 
            line-height: 1; 
            position: relative;
            z-index: 1002;
        }

        @media (min-width: 768px) {
            .close {
                font-size: 36px;
            }
        }

        .close:hover {
            color: #1C1C1E;
        }
        
        .entry-form { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }

        @media (min-width: 768px) {
            .entry-form {
                gap: 30px;
            }
        }
        
        .grade-buttons { 
            display: flex; 
            gap: 12px; 
        }

        @media (min-width: 768px) {
            .grade-buttons {
                gap: 16px;
            }
        }
        
        .grade-button { 
            flex: 1; 
            padding: 16px; 
            border: 1px solid #E5E5EA; 
            border-radius: 12px; 
            background: #F2F2F7; 
            color: #8E8E93; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .grade-button {
                padding: 20px;
                font-size: 18px;
            }
        }
        
        .grade-button.selected { 
            background: #10A37F; 
            border-color: #10A37F; 
            color: white; 
        }
        
        .save-button { 
            background: #10A37F; 
            color: white; 
            border: none; 
            padding: 18px; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .save-button {
                padding: 22px;
                font-size: 20px;
            }
        }
        
        .clear-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 15px; 
        }

        @media (min-width: 768px) {
            .clear-button {
                padding: 20px;
                font-size: 18px;
                margin-top: 20px;
            }
        }

        .form-select { 
            width: 100%; 
            padding: 16px 20px; 
            border: 1px solid #E5E5EA; 
            border-radius: 12px; 
            background: #F2F2F7; 
            color: #1C1C1E; 
            font-size: 18px; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .form-select {
                padding: 20px 24px;
                font-size: 20px;
            }
        }
        
        .form-select:focus { 
            outline: none; 
            border-color: #10A37F; 
            background: white; 
        }

        /* Homework checkbox styles */
        .homework-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .homework-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            border: 1px solid #E5E5EA;
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .homework-checkbox:hover {
            background: #F8F9FA;
        }

        .homework-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin: 0;
            cursor: pointer;
        }

        .homework-checkbox-content {
            flex: 1;
        }

        .homework-checkbox-title {
            font-size: 18px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 6px;
        }

        .homework-checkbox-desc {
            font-size: 16px;
            color: #8E8E93;
        }

        .homework-description {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 16px;
            resize: vertical;
            margin-top: 12px;
        }

        .homework-description:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }

        /* Controls */
        .app-controls { 
            margin: 10px 20px 20px 20px; 
            display: none;
        }

        @media (min-width: 768px) {
            .app-controls {
                margin: 15px 40px 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .app-controls {
                margin: 0;
            }
        }
        
        .controls-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .controls-card {
                padding: 30px;
            }
        }
        
        .controls-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 16px; 
        }

        @media (min-width: 768px) {
            .controls-title {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }
        
        .control-button { 
            width: 100%; 
            padding: 12px; 
            background: #F2F2F7; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            color: #1C1C1E; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 8px; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }

        @media (min-width: 768px) {
            .control-button {
                padding: 16px;
                font-size: 16px;
                margin-bottom: 12px;
            }
        }
        
        .control-button.danger { 
            background: #FF3B30; 
            border-color: #FF3B30; 
            color: white; 
        }
        
        .pdf-export-button { 
            background: linear-gradient(135deg, #10A37F, #0D7A5F) !important; 
            color: white !important; 
            border: none !important; 
        }
        
        .loading-spinner { 
            display: none; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #ffffff; 
            border-top: 2px solid transparent; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 20px; 
            color: #8E8E93; 
            font-size: 12px;
            background: #F2F2F7;
        }

        @media (min-width: 768px) {
            .footer {
                font-size: 14px;
                padding: 30px;
                background: #F2F2F7;
            }
        }
        
        .logout-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 16px auto; 
            display: block; 
        }

        @media (min-width: 768px) {
            .logout-button {
                padding: 16px 32px;
                font-size: 16px;
            }
        }

        .access-code-info {
            background: #E8F4FD;
            border: 1px solid #3B82F6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #1E40AF;
        }

        .access-code-info strong {
            color: #1E40AF;
        }

        @media (min-width: 768px) {
            .access-code-info {
                font-size: 16px;
                padding: 16px;
            }
        }

        /* Holiday list styles */
        .holiday-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .holiday-item {
            background: #F8F9FA;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .holiday-remove-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Homework notification styles */
        .homework-notification {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3B82F6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
        }

        .homework-notification-title {
            font-size: 16px;
            font-weight: 600;
            color: #1E40AF;
            margin-bottom: 8px;
        }

        .homework-notification-desc {
            font-size: 14px;
            color: #1E40AF;
            margin-bottom: 12px;
        }

        .homework-due-date {
            font-size: 12px;
            color: #1E40AF;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Homework management styles */
        .homework-item {
            background: white;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .homework-item.completed {
            background: #F0F9FF;
            border-color: #34C759;
        }

        .homework-item.overdue {
            background: #FEF2F2;
            border-color: #FF3B30;
        }

        .homework-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .homework-student-name {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        .homework-type-badge {
            background: #3B82F6;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .homework-type-badge.sabak {
            background: #10A37F;
        }

        .homework-type-badge.para {
            background: #8E44AD;
        }

        .homework-type-badge.dhor {
            background: #FF9500;
        }

        .homework-details {
            color: #8E8E93;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .homework-description {
            background: #F8F9FA;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #1C1C1E;
            margin-bottom: 12px;
        }

        .homework-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .homework-toggle {
            background: #34C759;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .homework-toggle.incomplete {
            background: #FF3B30;
        }

        .homework-toggle:hover {
            opacity: 0.8;
        }

        .homework-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .homework-status.completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .homework-status.pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .homework-status.overdue {
            background: #FEE2E2;
            color: #991B1B;
        }

        .homework-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-button {
            background: #F2F2F7;
            border: 1px solid #E5E5EA;
            color: #8E8E93;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-button.active {
            background: #10A37F;
            border-color: #10A37F;
            color: white;
        }

        .no-homework {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">📖 Hifz Record</h1>
            <div class="current-date" id="currentDate">Loading...</div>
            <div class="cloud-status connecting" id="cloudStatus">🔄 Connecting to Firebase...</div>
            <div class="user-info" id="userInfo" style="display: none;"></div>
        </div>

        <!-- Profile Selection -->
        <div class="profile-selection" id="profileSelection">
            <div class="profile-card">
                <h2 class="profile-title">Select Your Profile</h2>
                
                <div class="profile-option" onclick="selectProfile('teacher')" data-profile="teacher">
                    <div class="profile-icon">📖</div>
                    <div class="profile-info">
                        <h3>Ustaadh</h3>
                        <p>Full access - Add/edit progress, manage students, reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('office')" data-profile="office">
                    <div class="profile-icon">🕌</div>
                    <div class="profile-info">
                        <h3>Office</h3>
                        <p>Read-only - View all students, generate reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('parent')" data-profile="parent">
                    <div class="profile-icon">👨‍👩‍👧‍👦</div>
                    <div class="profile-info">
                        <h3>Parent</h3>
                        <p>View your child's progress only</p>
                    </div>
                </div>

                <button class="continue-button" onclick="continueToLogin()" id="continueButton" disabled>
                    Continue
                </button>
            </div>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="login-card">
                <button class="back-button" onclick="goBackToProfiles()">← Back to Profiles</button>
                <h2 class="login-title" id="loginTitle">Login</h2>
                <div class="error-message" id="errorMessage"></div>
                
                <div class="form-group">
                    <label class="form-label" id="accessCodeLabel">Access Code</label>
                    <input type="password" class="form-input" id="accessCode" placeholder="Enter access code">
                </div>

                <button class="login-button" onclick="login()">Login</button>
                
                <!-- Access Code Info -->
                <div class="access-code-info">
                    <div style="font-weight: 600; margin-bottom: 8px;">📝 Need Your Access Code?</div>
                    <div>If you need your access code please contact Ustaadh:</div>
                    <div style="margin-top: 8px;"><strong>sam.dev247@gmail.com</strong></div>
                </div>
            </div>
        </div>

        <!-- Permission Notice -->
        <div class="permission-notice" id="permissionNotice"></div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="main-left">
                <!-- Student Selector -->
                <div class="student-selector">
                    <div class="student-tabs" id="studentTabs"></div>
                </div>

                <!-- Student Name Display -->
                <div class="section" id="studentNameDisplay" style="display: none;">
                    <h2 class="section-title" style="text-align: center; font-size: 20px; color: #10A37F; margin-bottom: 8px;" id="selectedStudentName"></h2>
                </div>

                <!-- Statistics -->
                <div class="section">
                    <h2 class="section-title">Monthly Progress</h2>
                    <div class="stats-container">
                        <div class="stat-card sabak">
                            <div class="stat-number" id="sabakCount">0</div>
                            <div class="stat-label">Sabak</div>
                        </div>
                        <div class="stat-card para">
                            <div class="stat-number" id="paraCount">0</div>
                            <div class="stat-label">Sabak Para</div>
                        </div>
                        <div class="stat-card dhor">
                            <div class="stat-number" id="dhorCount">0</div>
                            <div class="stat-label">Dhor</div>
                        </div>
                    </div>
                </div>

                <!-- Homework Section (for Parents) -->
                <div class="section" id="homeworkSection" style="display: none;">
                    <div id="homeworkNotification" class="homework-notification">
                        <div class="homework-notification-title">New Homework Assigned</div>
                        <div class="homework-notification-desc" id="homeworkNotificationDesc">You have new homework from your teacher</div>
                        <div class="homework-due-date" id="homeworkDueDate">Due: Tomorrow</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="homework-button" onclick="showViewHomeworkModal()" style="flex: 1; margin-top: 0;">
                                View Homework
                            </button>
                            <button class="homework-button" onclick="showParentAllHomeworkModal()" style="flex: 1; margin-top: 0; background: #8E44AD;">
                                All Homework
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Today's Progress -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="progressSectionTitle">Today's Progress</h2>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="absent-button" onclick="toggleAbsent()" id="absentButton" style="display: none;">
                                🔴 Absent
                            </button>
                        </div>
                    </div>
                    
                    <div class="today-progress" id="todayProgressContainer">
                        <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                            <div class="progress-info">
                                <div class="progress-icon sabak">📖</div>
                                <div class="progress-details">
                                    <h4>Sabak</h4>
                                    <p>New Lesson</p>
                                </div>
                            </div>
                            <div class="progress-status" id="sabakStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                            <div class="progress-info">
                                <div class="progress-icon para">🔄</div>
                                <div class="progress-details">
                                    <h4>Sabak Para</h4>
                                    <p>Previous Lessons</p>
                                </div>
                            </div>
                            <div class="progress-status" id="paraStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                            <div class="progress-info">
                                <div class="progress-icon dhor">💭</div>
                                <div class="progress-details">
                                    <h4>Dhor</h4>
                                    <p>Revision</p>
                                </div>
                            </div>
                            <div class="progress-status" id="dhorStatus">
                                <span class="amount-badge">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parent Check Section -->
                <div class="section" id="parentCheckSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="parentCheckTitle">Checked by Parent</h2>
                        <button class="parent-check-button" onclick="toggleParentCheck()" id="parentCheckButton">
                            ✓ Mark as Checked
                        </button>
                    </div>
                    <div style="background: white; border-radius: 16px; padding: 16px; border: 1px solid #E5E5EA; font-size: 14px; color: #8E8E93;" id="parentCheckDescription">
                        Mark when you have reviewed your child's progress for today
                        <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                            <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                            <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-right">
                <!-- Monthly Calendar -->
                <div class="section">
                    <div class="month-navigation">
                        <button class="nav-arrow" onclick="changeMonth(-1)">‹</button>
                        <h3 class="month-title" id="monthTitle">Loading...</h3>
                        <button class="nav-arrow" onclick="changeMonth(1)">›</button>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <!-- App Controls -->
                <div class="app-controls" id="appControls">
                    <div class="controls-card">
                        <h3 class="controls-title" id="controlsTitle">Controls</h3>
                        
                        <!-- Ustaadh Controls -->
                        <div id="teacherControls" style="display: none;">
                            <button class="control-button" onclick="showAddStudentModal()">➕ Add New Student</button>
                            <button class="control-button" onclick="showRemoveStudentModal()">➖ Remove Student</button>
                            <button class="control-button" onclick="showAssignHomeworkModal()">📚 Assign Homework</button>
                            <button class="control-button" onclick="showViewAllHomeworkModal()">📋 View All Homework</button>
                            <button class="control-button" onclick="showHolidayModal()">🗓️ Manage Holidays</button>
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="pdfSpinner"></div>
                                <span id="pdfBtnText">📄 Export Student PDF</span>
                            </button>
                            <button class="control-button danger" onclick="showResetModal()">🗑️ Reset All Data</button>
                        </div>

                        <!-- Office Controls -->
                        <div id="officeControls" style="display: none;">
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="officePdfSpinner"></div>
                                <span id="officePdfBtnText">📄 Export Student PDF</span>
                            </button>
                        </div>

                        <!-- Parent Controls -->
                        <div id="parentControls" style="display: none;">
                            <p style="color: #8E8E93; font-size: 14px; margin-bottom: 16px;">Parent access - view your child's progress</p>
                        </div>

                        <button class="logout-button" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p id="footerText">Secure Firebase connection - Choose your access level above</p>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Enter Progress</h2>
                <span class="close" onclick="closeModal('progressModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group" id="linesInputGroup">
                        <label class="form-label">Lines (will auto-convert to pages & Juz)</label>
                        <input type="number" class="form-input" id="linesInput" placeholder="e.g., 26 lines" min="1">
                        <div id="conversionDisplay" style="margin-top: 8px; font-size: 12px; color: #10A37F;"></div>
                    </div>
                    <div class="form-group" id="amountInputGroup" style="display: none;">
                        <label class="form-label">Amount/Pages</label>
                        <input type="text" class="form-input" id="amountInput" placeholder="e.g., 5 lines, 1 page">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade</label>
                        <div class="grade-buttons">
                            <div class="grade-button" data-grade="excellent" onclick="selectGrade('excellent')">Excellent</div>
                            <div class="grade-button" data-grade="good" onclick="selectGrade('good')">Good</div>
                            <div class="grade-button" data-grade="okay" onclick="selectGrade('okay')">Okay</div>
                            <div class="grade-button" data-grade="poor" onclick="selectGrade('poor')">Poor</div>
                        </div>
                    </div>
                    <button class="save-button" onclick="saveProgress()">Save Progress</button>
                    <button class="clear-button" onclick="clearProgress()">Clear Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Homework Modal -->
    <div id="assignHomeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Homework</h2>
                <span class="close" onclick="closeModal('assignHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="homeworkStudentSelect">
                            <option value="">Choose student</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Homework Type</label>
                        <select class="form-select" id="homeworkTypeSelect">
                            <option value="">Select homework type</option>
                            <option value="sabak">Sabak - New Lessons</option>
                            <option value="para">Sabak Para - Previous Lessons</option>
                            <option value="dhor">Dhor - Revision</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="homeworkDueDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="homework-description" id="homeworkDescriptionInput" placeholder="Enter homework details and instructions..."></textarea>
                    </div>
                    <button class="save-button" onclick="assignHomework()">Assign Homework</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View All Homework Modal (Teacher) -->
    <div id="viewAllHomeworkModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">All Homework Assignments</h2>
                <span class="close" onclick="closeModal('viewAllHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="allHomeworkContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- View Homework Modal (Parent) -->
    <div id="viewHomeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Your Homework</h2>
                <span class="close" onclick="closeModal('viewHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="homeworkContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Parent All Homework Modal -->
    <div id="parentAllHomeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">All Your Child's Homework</h2>
                <span class="close" onclick="closeModal('parentAllHomeworkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="parentAllHomeworkContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Student</h2>
                <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Student Name</label>
                        <input type="text" class="form-input" id="newStudentName" placeholder="Enter student name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quran Type</label>
                        <select class="form-select" id="newQuranType">
                            <option value="13">13 Line Quran (26 pages = 1 Juz)</option>
                            <option value="15">15 Line Quran (20 pages = 1 Juz)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parent Access Code</label>
                        <input type="text" class="form-input" id="newParentCode" placeholder="Create parent access code (8 characters)">
                    </div>
                    <button class="save-button" onclick="addStudent()">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Student Modal -->
    <div id="removeStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Remove Student</h2>
                <span class="close" onclick="closeModal('removeStudentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Student to Remove</label>
                        <select class="form-select" id="removeStudentSelect">
                            <option value="">Choose student to remove</option>
                        </select>
                    </div>
                    <div style="background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 12px; color: #856404;">
                        ⚠️ <strong>Warning:</strong> This will keep the data in Firebase but remove from active student list.
                    </div>
                    <button class="save-button" style="background: #FF3B30;" onclick="removeStudent()">Remove Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Holiday Modal -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Holidays</h2>
                <span class="close" onclick="closeModal('holidayModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Holiday Name</label>
                        <input type="text" class="form-input" id="holidayName" placeholder="e.g., Eid al-Fitr">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="holidayStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="holidayEndDate">
                    </div>
                    <button class="save-button" onclick="addHoliday()">Add Holiday</button>
                    
                    <div id="holidayList" class="holiday-list">
                        <!-- Holiday list will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Modal -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dayModalTitle">Day Progress</h2>
                <span class="close" onclick="closeModal('dayModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="dayProgressList"></div>
                
                <!-- Legend for colored dots -->
                <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 12px; border-top: 1px solid #E5E5EA;">
                    <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 12px; text-align: center;">Progress Indicators</div>
                    <div style="display: flex; justify-content: center; gap: 20px; font-size: 11px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #34C759; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Excellent</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #10A37F; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Good</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #FF9500; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Okay</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="width: 12px; height: 12px; background: #FF3B30; border-radius: 50%; display: inline-block;"></span>
                            <span style="color: #8E8E93;">Poor</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="exportPDFModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export Student PDF Report</h2>
                <span class="close" onclick="closeModal('exportPDFModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-form">
                    <div class="form-group">
                        <label class="form-label">Select Student</label>
                        <select class="form-select" id="pdfStudentSelect">
                            <option value="">Choose student for PDF report</option>
                            <option value="all">All Students (Combined Report)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" id="pdfReportType">
                            <option value="current-month">Current Month Progress</option>
                            <option value="yearly-summary">Yearly Summary</option>
                            <option value="yearly-detailed">Yearly Detailed</option>
                        </select>
                    </div>
                    <button class="save-button pdf-export-button" onclick="generateSelectedPDF()" id="generatePDFBtn">
                        <div class="loading-spinner" id="modalPdfSpinner"></div>
                        <span id="modalPdfBtnText">📄 Generate PDF Report</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUserType = null; // 'teacher', 'office', 'parent'
        let currentUser = null; // Firebase user object
        let currentStudent = null;
        let currentProgressType = null;
        let currentDate = null;
        let currentDisplayMonth = new Date().getMonth() + 1;
        let currentDisplayYear = new Date().getFullYear();
        let selectedGrade = null;
        let selectedProfile = null;
        let studentUnsubscribes = []; // For Firebase listeners

        // Access codes
        const teacherCode = 'P455word';
        const officeCode = 'sjoffice25';

        // Updated student access codes mapping
        const studentAccessCodes = {
            'ra123456': { studentId: 'raqib_awal', studentName: 'Raqib Awal' },
            'ah123456': { studentId: 'ahsan_haque', studentName: 'Ahsan Haque' },
            'ar123456': { studentId: 'arafat_rayyan', studentName: 'Arafat Rayyan' },
            'in123456': { studentId: 'ishaq_noor', studentName: 'Ishaq Noor' },
            'nk123456': { studentId: 'naveed_khan', studentName: 'Naveed Khan' },
            'rr123456': { studentId: 'rayhan_rahman', studentName: 'Rayhan Rahman' },
            'ih123456': { studentId: 'ismail_hussain', studentName: 'Ismail Hussain' },
            'sn123456': { studentId: 'sulaiman_noor', studentName: 'Sulaiman Noor' },
            'am123456': { studentId: 'ayyan_miah', studentName: 'Ayyan Miah' },
            'aq123456': { studentId: 'abdul_qadir', studentName: 'Abdul Qadir' },
            'as123456': { studentId: 'abdullah_sheriwala', studentName: 'Abdullah Sheriwala' }
        };

        // Updated default students data - cleared old students and added new ones alphabetically
        const defaultStudents = [
            { id: 'abdul_qadir', name: 'Abdul Qadir', parentEmail: 'parent1@hifz.com', quranType: 13, accessCode: 'aq123456' },
            { id: 'abdullah_sheriwala', name: 'Abdullah Sheriwala', parentEmail: 'parent2@hifz.com', quranType: 13, accessCode: 'as123456' },
            { id: 'ahsan_haque', name: 'Ahsan Haque', parentEmail: 'parent3@hifz.com', quranType: 13, accessCode: 'ah123456' },
            { id: 'arafat_rayyan', name: 'Arafat Rayyan', parentEmail: 'parent4@hifz.com', quranType: 13, accessCode: 'ar123456' },
            { id: 'ayyan_miah', name: 'Ayyan Miah', parentEmail: 'parent5@hifz.com', quranType: 13, accessCode: 'am123456' },
            { id: 'ishaq_noor', name: 'Ishaq Noor', parentEmail: 'parent6@hifz.com', quranType: 13, accessCode: 'in123456' },
            { id: 'ismail_hussain', name: 'Ismail Hussain', parentEmail: 'parent7@hifz.com', quranType: 13, accessCode: 'ih123456' },
            { id: 'naveed_khan', name: 'Naveed Khan', parentEmail: 'parent8@hifz.com', quranType: 13, accessCode: 'nk123456' },
            { id: 'raqib_awal', name: 'Raqib Awal', parentEmail: 'parent9@hifz.com', quranType: 13, accessCode: 'ra123456' },
            { id: 'rayhan_rahman', name: 'Rayhan Rahman', parentEmail: 'parent10@hifz.com', quranType: 13, accessCode: 'rr123456' },
            { id: 'sulaiman_noor', name: 'Sulaiman Noor', parentEmail: 'parent11@hifz.com', quranType: 13, accessCode: 'sn123456' }
        ];

        const progressTypes = ['sabak', 'para', 'dhor'];

        // Conversion functions
        function convertLinesToPagesAndJuz(lines, quranType) {
            if (!lines || lines <= 0) return { pages: 0, juz: 0, fraction: '' };
            
            const linesPerPage = quranType;
            const pagesPerJuz = quranType === 13 ? 26 : 20;
            
            const pages = lines / linesPerPage;
            const juz = pages / pagesPerJuz;
            
            let fraction = '';
            if (juz >= 1) {
                const wholeJuz = Math.floor(juz);
                const remainingJuz = juz - wholeJuz;
                if (remainingJuz >= 0.875) {
                    fraction = `${wholeJuz + 1} Juz`;
                } else if (remainingJuz >= 0.625) {
                    fraction = `${wholeJuz} & 3/4 Juz`;
                } else if (remainingJuz >= 0.375) {
                    fraction = `${wholeJuz} & 1/2 Juz`;
                } else if (remainingJuz >= 0.125) {
                    fraction = `${wholeJuz} & 1/4 Juz`;
                } else {
                    fraction = `${wholeJuz} Juz`;
                }
            } else if (juz >= 0.875) {
                fraction = '1 Juz';
            } else if (juz >= 0.625) {
                fraction = '3/4 Juz';
            } else if (juz >= 0.375) {
                fraction = '1/2 Juz';
            } else if (juz >= 0.125) {
                fraction = '1/4 Juz';
            } else {
                fraction = `${Math.round(pages * 100) / 100} pages`;
            }
            
            return {
                pages: Math.round(pages * 100) / 100,
                juz: Math.round(juz * 1000) / 1000,
                fraction: fraction
            };
        }

        function updateConversionDisplay() {
            const linesInput = document.getElementById('linesInput');
            const conversionDisplay = document.getElementById('conversionDisplay');
            const lines = parseInt(linesInput.value) || 0;
            
            if (lines > 0 && currentStudent) {
                window.getStudents().then(students => {
                    const student = students.find(s => s.id === currentStudent);
                    const quranType = student ? student.quranType || 13 : 13;
                    
                    const conversion = convertLinesToPagesAndJuz(lines, quranType);
                    conversionDisplay.innerHTML = `📊 ${lines} lines = ${conversion.pages} pages = ${conversion.fraction}`;
                    conversionDisplay.style.display = 'block';
                });
            } else {
                conversionDisplay.style.display = 'none';
            }
        }

        // Initialize app
        function init() {
            updateCurrentDate();
            initializeFirebaseConnection();
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        async function initializeFirebaseConnection() {
            try {
                // Check if Firebase modules are loaded
                if (!window.firebase || !window.firebaseModules) {
                    throw new Error('Firebase modules not loaded. Please refresh the page.');
                }
                
                // Set up auth state listener
                const { onAuthStateChanged } = window.firebaseModules;
                const { auth } = window.firebase;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        // For authenticated users, show main interface directly
                        if (currentUserType && currentStudent) {
                            showMainInterface();
                        }
                    } else {
                        currentUser = null;
                        showProfileSelection();
                    }
                });
                
                // Initialize default data if needed - this will clear old data and add fresh students
                await initializeDefaultData();
                
                // Update status to connected
                updateCloudStatus('connected', '✅ Firebase Ready');
                
                // Show profile selection by default
                showProfileSelection();
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                updateCloudStatus('disconnected', '❌ Connection failed');
                showError('Firebase initialization failed: ' + error.message);
            }
        }

        function updateCloudStatus(status, message) {
            const cloudStatus = document.getElementById('cloudStatus');
            cloudStatus.className = `cloud-status ${status}`;
            cloudStatus.textContent = message;
        }

        async function initializeDefaultData() {
            try {
                const { getDoc, doc, setDoc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Always reset with fresh student data
                await setDoc(doc(db, 'config', 'students'), {
                    list: defaultStudents,
                    lastUpdated: new Date().toISOString()
                });
                console.log('Fresh students data initialized');
                
            } catch (error) {
                console.error('Error initializing default data:', error);
            }
        }

        function showProfileSelection() {
            document.getElementById('profileSelection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('appControls').style.display = 'none';
            document.getElementById('permissionNotice').style.display = 'none';
        }

        function selectProfile(profileType) {
            selectedProfile = profileType;
            
            // Remove selected class from all options
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelector(`[data-profile="${profileType}"]`).classList.add('selected');
            
            // Enable continue button
            document.getElementById('continueButton').disabled = false;
        }

        function continueToLogin() {
            if (!selectedProfile) return;
            
            currentUserType = selectedProfile;
            
            document.getElementById('profileSelection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Update login form based on profile
            const loginTitle = document.getElementById('loginTitle');
            const accessCodeLabel = document.getElementById('accessCodeLabel');
            const accessCodeInput = document.getElementById('accessCode');
            
            switch(selectedProfile) {
                case 'teacher':
                    loginTitle.textContent = '📖 Ustaadh Login';
                    accessCodeLabel.textContent = 'Ustaadh Access Code';
                    accessCodeInput.placeholder = 'Enter Ustaadh access code';
                    break;
                case 'office':
                    loginTitle.textContent = '🕌 Office Login';
                    accessCodeLabel.textContent = 'Office Access Code';
                    accessCodeInput.placeholder = 'Enter office access code';
                    break;
                case 'parent':
                    loginTitle.textContent = '👨‍👩‍👧‍👦 Parent Login';
                    accessCodeLabel.textContent = 'Student Access Code';
                    accessCodeInput.placeholder = 'Enter your child\'s access code';
                    break;
            }
            
            accessCodeInput.value = '';
        }

        function goBackToProfiles() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('profileSelection').style.display = 'block';
            selectedProfile = null;
            currentUserType = null;
            document.getElementById('continueButton').disabled = true;
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        async function login() {
            const accessCode = document.getElementById('accessCode').value.trim();
            
            if (!accessCode) {
                showError('Please enter the access code');
                return;
            }

            let loginSuccess = false;
            let foundStudent = null;

            switch(currentUserType) {
                case 'teacher':
                    if (accessCode === teacherCode) {
                        loginSuccess = true;
                    }
                    break;
                case 'office':
                    if (accessCode === officeCode) {
                        loginSuccess = true;
                    }
                    break;
                case 'parent':
                    // Check if access code matches any student's access code
                    const studentInfo = studentAccessCodes[accessCode.toLowerCase()];
                    if (studentInfo) {
                        loginSuccess = true;
                        currentStudent = studentInfo.studentId;
                    }
                    break;
            }

            if (loginSuccess) {
                // Sign in to Firebase anonymously for demo
                try {
                    const { signInWithEmailAndPassword } = window.firebaseModules;
                    const { auth } = window.firebase;
                    
                    // Use dummy account for demo (you can create these in Firebase Console)
                    const email = `${currentUserType}@hifz.com`;
                    const password = `${currentUserType}123`;
                    
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (authError) {
                        // If account doesn't exist, continue without Firebase auth for demo
                        console.log('Auth account not found, continuing with local auth');
                    }
                    
                    showMainInterface();
                } catch (error) {
                    console.error('Login error:', error);
                    showMainInterface(); // Continue anyway for demo
                }
            } else {
                const errorMsg = currentUserType === 'parent' 
                    ? 'Invalid student access code' 
                    : `Invalid ${currentUserType} access code`;
                showError(errorMsg);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showMainInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('appControls').style.display = 'block';
            
            // Update UI based on user type
            updateUIForUserType();
            updateUserInfo();
            loadStudentsAndInitialize();
        }

        function updateUIForUserType() {
            const container = document.querySelector('.container');
            const absentButton = document.getElementById('absentButton');
            const teacherControls = document.getElementById('teacherControls');
            const officeControls = document.getElementById('officeControls');
            const parentControls = document.getElementById('parentControls');
            const controlsTitle = document.getElementById('controlsTitle');
            
            // Reset classes
            container.classList.remove('parent-mode');
            
            // Update progress rows
            const progressRows = document.querySelectorAll('.progress-row');
            
            progressRows.forEach(row => {
                row.classList.remove('read-only');
            });
            
            switch(currentUserType) {
                case 'teacher':
                    absentButton.style.display = 'inline-block';
                    teacherControls.style.display = 'block';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Ustaadh Controls';
                    break;
                    
                case 'office':
                    absentButton.style.display = 'none';
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'block';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Office Controls';
                    
                    // Progress rows are read-only for office
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    break;
                    
                case 'parent':
                    container.classList.add('parent-mode');
                    absentButton.style.display = 'none';
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'block';
                    controlsTitle.textContent = 'Parent View';
                    
                    // Progress rows are read-only for parents
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    
                    // Show parent check section
                    document.getElementById('parentCheckSection').style.display = 'block';
                    break;
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const footerText = document.getElementById('footerText');
            
            switch(currentUserType) {
                case 'teacher':
                    userInfo.textContent = '📖 Ustaadh - Full Access';
                    footerText.textContent = 'Track daily student progress with Firebase real-time sync';
                    break;
                case 'office':
                    userInfo.textContent = '🕌 Office - Read-Only Access';
                    footerText.textContent = 'View student progress and generate reports';
                    break;
                case 'parent':
                    const studentInfo = Object.values(studentAccessCodes).find(s => s.studentId === currentStudent);
                    const studentName = studentInfo ? studentInfo.studentName : 'Student';
                    userInfo.textContent = `👨‍👩‍👧‍👦 Parent - ${studentName}'s Progress`;
                    footerText.textContent = `Track ${studentName}'s Hifz progress in real-time`;
                    break;
            }
            userInfo.style.display = 'block';
        }

        async function loadStudentsAndInitialize() {
            try {
                const students = await window.getStudents();
                
                // Load holiday cache
                await updateHolidayCache();
                
                if (currentUserType === 'parent') {
                    // Parents only see their child
                    if (currentStudent) {
                        await setupStudentListeners([currentStudent]);
                        selectStudent(currentStudent);
                        // Check for homework
                        await checkForHomework();
                    }
                } else {
                    // Teachers and office see all students
                    await setupStudentListeners(students.map(s => s.id));
                    populateStudentTabs(students);
                    if (students.length > 0) {
                        selectStudent(students[0].id);
                    }
                }
                
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Error loading students: ' + error.message);
            }
        }

        function populateStudentTabs(students) {
            const tabsContainer = document.getElementById('studentTabs');
            tabsContainer.innerHTML = '';
            
            // Sort students alphabetically by name
            students.sort((a, b) => a.name.localeCompare(b.name));
            
            if (currentUserType === 'parent') {
                // Parents only see their child's tab
                const student = students.find(s => s.id === currentStudent);
                if (student) {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab active';
                    tab.innerHTML = student.name;
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                }
            } else {
                // Teachers and office staff see all students
                students.forEach(student => {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab';
                    tab.innerHTML = student.name;
                    tab.onclick = () => selectStudent(student.id);
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                });
            }
        }

        async function setupStudentListeners(studentIds) {
            // Clean up existing listeners
            studentUnsubscribes.forEach(unsubscribe => unsubscribe());
            studentUnsubscribes = [];
            
            // Set up new listeners for each student
            const { onSnapshot, doc } = window.firebaseModules;
            const { db } = window.firebase;
            
            studentIds.forEach(studentId => {
                const unsubscribe = onSnapshot(doc(db, 'progress', studentId), (doc) => {
                    if (doc.exists()) {
                        // Update UI if this is the current student
                        if (studentId === currentStudent) {
                            updateTodaysProgress();
                            updateStats();
                            generateCalendar();
                            // Check for homework if parent
                            if (currentUserType === 'parent') {
                                checkForHomework();
                            }
                        }
                    }
                });
                studentUnsubscribes.push(unsubscribe);
            });
        }

        async function selectStudent(studentId) {
            currentStudent = studentId;
            
            if (currentUserType !== 'parent') {
                document.querySelectorAll('.student-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.studentId === studentId) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // Show student name
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('selectedStudentName').textContent = student.name;
                document.getElementById('studentNameDisplay').style.display = 'block';
            }
            
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            
            // Check for homework if parent
            if (currentUserType === 'parent') {
                await checkForHomework();
            }
        }

        // Homework Functions
        async function checkForHomework() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const homeworkSection = document.getElementById('homeworkSection');
                
                if (homework && homework.length > 0) {
                    // Check if there's any pending (incomplete) homework
                    const pendingHomework = homework.filter(hw => !hw.completed);
                    
                    if (pendingHomework.length > 0) {
                        const latestHomework = pendingHomework[0]; // Get the latest homework
                        
                        // Update homework notification
                        const dueDateObj = new Date(latestHomework.dueDate);
                        const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                        
                        document.getElementById('homeworkNotificationDesc').textContent = 
                            `${latestHomework.type.charAt(0).toUpperCase() + latestHomework.type.slice(1)} homework assigned`;
                        document.getElementById('homeworkDueDate').textContent = `Due: ${dueDateStr}`;
                        
                        homeworkSection.style.display = 'block';
                        return;
                    }
                }
                
                // No homework found
                homeworkSection.style.display = 'none';
                
            } catch (error) {
                console.error('Error checking for homework:', error);
                document.getElementById('homeworkSection').style.display = 'none';
            }
        }

        function showViewAllHomeworkModal() {
            if (currentUserType !== 'teacher') return;
            
            loadAllHomework();
            document.getElementById('viewAllHomeworkModal').style.display = 'block';
        }

        // Parent All Homework Modal function
        async function showParentAllHomeworkModal() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const content = document.getElementById('parentAllHomeworkContent');
                
                if (!homework || homework.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">No Homework Assigned</h3>
                            <p style="color: #8E8E93; font-size: 16px;">No homework has been assigned yet.</p>
                        </div>
                    `;
                } else {
                    // Show all homework with summary at top
                    const totalHomework = homework.length;
                    const completedHomework = homework.filter(hw => hw.completed).length;
                    const pendingHomework = homework.filter(hw => !hw.completed).length;
                    const today = new Date();
                    const overdueHomework = homework.filter(hw => !hw.completed && new Date(hw.dueDate) < today).length;
                    
                    let homeworkHtml = `
                        <!-- Summary Section -->
                        <div style="background: #F8F9FA; border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid #E5E5EA;">
                            <h3 style="font-size: 20px; font-weight: 600; color: #1C1C1E; margin-bottom: 16px;">📊 Homework Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #1C1C1E;">${totalHomework}</div>
                                    <div style="font-size: 14px; color: #8E8E93;">Total</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #34C759;">${completedHomework}</div>
                                    <div style="font-size: 14px; color: #8E8E93;">Completed</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #FF9500;">${pendingHomework}</div>
                                    <div style="font-size: 14px; color: #8E8E93;">Pending</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #FF3B30;">${overdueHomework}</div>
                                    <div style="font-size: 14px; color: #8E8E93;">Overdue</div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="font-size: 18px; font-weight: 600; color: #1C1C1E; margin-bottom: 16px;">All Homework</h3>
                    `;
                    
                    homework.forEach((hw, index) => {
                        const dueDateObj = new Date(hw.dueDate);
                        const isOverdue = !hw.completed && dueDateObj < today;
                        
                        const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        
                        let statusHtml = '';
                        let statusColor = '';
                        if (hw.completed) {
                            statusHtml = '<span style="color: #34C759; font-weight: 600;">✓ Completed by Teacher</span>';
                            statusColor = '#D1FAE5';
                        } else if (isOverdue) {
                            statusHtml = '<span style="color: #FF3B30; font-weight: 600;">⚠ Overdue</span>';
                            statusColor = '#FEE2E2';
                        } else {
                            statusHtml = '<span style="color: #FF9500; font-weight: 600;">⏳ Pending</span>';
                            statusColor = '#FEF3C7';
                        }
                        
                        const descriptionHtml = hw.description ? 
                            `<div style="margin-top: 16px; padding: 16px; background: #E8F4FD; border-radius: 12px; border-left: 4px solid #3B82F6;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #1E40AF; margin-bottom: 8px;">Instructions:</h4>
                                <p style="color: #1E40AF; font-size: 14px; line-height: 1.5;">${hw.description}</p>
                            </div>` : '';
                        
                        homeworkHtml += `
                            <div style="padding: 20px; margin-bottom: 16px; background: ${hw.completed ? '#F0F9FF' : 'white'}; border-radius: 16px; border: 1px solid ${hw.completed ? '#34C759' : isOverdue ? '#FF3B30' : '#E5E5EA'};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                    <div>
                                        <h3 style="font-size: 18px; font-weight: 600; color: #1C1C1E; margin-bottom: 8px;">${typeDisplay} Homework</h3>
                                        <p style="color: #8E8E93; font-size: 14px; margin-bottom: 8px;">Due: ${dueDateStr}</p>
                                    </div>
                                    <div style="padding: 8px 12px; background: ${statusColor}; border-radius: 8px;">
                                        ${statusHtml}
                                    </div>
                                </div>
                                
                                <div style="padding: 16px; background: #F8F9FA; border-radius: 12px; margin-bottom: 16px;">
                                    <h4 style="font-size: 16px; font-weight: 600; color: #1C1C1E; margin-bottom: 8px;">${typeDisplay}</h4>
                                    <p style="color: #8E8E93; font-size: 14px;">${typeDescription}</p>
                                </div>
                                
                                ${descriptionHtml}
                            </div>
                        `;
                    });
                    
                    content.innerHTML = homeworkHtml;
                }
                
                document.getElementById('parentAllHomeworkModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching all homework:', error);
                alert('Error loading homework: ' + error.message);
            }
        }

        async function loadAllHomework(filter = 'all') {
            try {
                const { getDocs, collection } = window.firebaseModules;
                const { db } = window.firebase;
                
                const querySnapshot = await getDocs(collection(db, 'homework'));
                const allHomework = [];
                
                querySnapshot.forEach((doc) => {
                    allHomework.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by assigned date (newest first)
                allHomework.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                // Get student names
                const students = await window.getStudents();
                
                // Filter homework based on selection
                let filteredHomework = allHomework;
                if (filter === 'pending') {
                    filteredHomework = allHomework.filter(hw => !hw.completed);
                } else if (filter === 'completed') {
                    filteredHomework = allHomework.filter(hw => hw.completed);
                } else if (filter === 'overdue') {
                    const today = new Date();
                    filteredHomework = allHomework.filter(hw => !hw.completed && new Date(hw.dueDate) < today);
                }
                
                displayAllHomework(filteredHomework, students, filter);
                
            } catch (error) {
                console.error('Error loading homework:', error);
            }
        }

        function displayAllHomework(homework, students, currentFilter) {
            const content = document.getElementById('allHomeworkContent');
            
            const filtersHtml = `
                <div class="homework-filters">
                    <button class="filter-button ${currentFilter === 'all' ? 'active' : ''}" onclick="loadAllHomework('all')">All</button>
                    <button class="filter-button ${currentFilter === 'pending' ? 'active' : ''}" onclick="loadAllHomework('pending')">Pending</button>
                    <button class="filter-button ${currentFilter === 'completed' ? 'active' : ''}" onclick="loadAllHomework('completed')">Completed</button>
                    <button class="filter-button ${currentFilter === 'overdue' ? 'active' : ''}" onclick="loadAllHomework('overdue')">Overdue</button>
                </div>
            `;
            
            if (homework.length === 0) {
                content.innerHTML = filtersHtml + `
                    <div class="no-homework">
                        <div style="font-size: 48px; margin-bottom: 16px;">📚</div>
                        <h3 style="font-size: 18px; margin-bottom: 8px;">No Homework Found</h3>
                        <p>No homework matches the current filter.</p>
                    </div>
                `;
                return;
            }
            
            let homeworkListHtml = '';
            
            homework.forEach(hw => {
                const student = students.find(s => s.id === hw.studentId);
                const studentName = student ? student.name : 'Unknown Student';
                
                const dueDateObj = new Date(hw.dueDate);
                const today = new Date();
                const isOverdue = !hw.completed && dueDateObj < today;
                
                const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const typeDisplay = hw.type.charAt(0).toUpperCase() + hw.type.slice(1);
                
                let statusHtml = '';
                if (hw.completed) {
                    statusHtml = '<span class="homework-status completed">✓ Completed</span>';
                } else if (isOverdue) {
                    statusHtml = '<span class="homework-status overdue">⚠ Overdue</span>';
                } else {
                    statusHtml = '<span class="homework-status pending">⏳ Pending</span>';
                }
                
                const descriptionHtml = hw.description ? 
                    `<div class="homework-description">${hw.description}</div>` : '';
                
                homeworkListHtml += `
                    <div class="homework-item ${hw.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}">
                        <div class="homework-header">
                            <div>
                                <div class="homework-student-name">${studentName}</div>
                                <div class="homework-details">
                                    <span class="homework-type-badge ${hw.type}">${typeDisplay}</span>
                                    Due: ${dueDateStr}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${statusHtml}
                            </div>
                        </div>
                        
                        ${descriptionHtml}
                        
                        <div class="homework-actions">
                            <button class="homework-toggle ${hw.completed ? 'complete' : 'incomplete'}" 
                                    onclick="toggleHomeworkCompletion('${hw.id}', ${!hw.completed})">
                                ${hw.completed ? '✓ Mark Incomplete' : '✓ Mark Complete'}
                            </button>
                            <button class="homework-toggle incomplete" onclick="deleteHomework('${hw.id}')" 
                                    style="background: #FF3B30;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = filtersHtml + homeworkListHtml;
        }

        async function toggleHomeworkCompletion(homeworkId, completed) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await updateDoc(doc(db, 'homework', homeworkId), {
                    completed: completed,
                    completedDate: completed ? new Date().toISOString() : null
                });
                
                // Reload the homework list
                loadAllHomework(document.querySelector('.filter-button.active').textContent.toLowerCase());
                
            } catch (error) {
                console.error('Error updating homework completion:', error);
                alert('Error updating homework: ' + error.message);
            }
        }

        async function deleteHomework(homeworkId) {
            if (!confirm('Are you sure you want to delete this homework assignment?')) {
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await deleteDoc(doc(db, 'homework', homeworkId));
                
                // Reload the homework list
                loadAllHomework(document.querySelector('.filter-button.active').textContent.toLowerCase());
                
            } catch (error) {
                console.error('Error deleting homework:', error);
                alert('Error deleting homework: ' + error.message);
            }
        }

        function showAssignHomeworkModal() {
            if (currentUserType !== 'teacher') return;
            
            // Populate student dropdown
            window.getStudents().then(students => {
                const select = document.getElementById('homeworkStudentSelect');
                select.innerHTML = '<option value="">Choose student</option>';
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
            
            // Reset form
            document.getElementById('homeworkTypeSelect').value = '';
            document.getElementById('homeworkDueDate').value = '';
            document.getElementById('homeworkDescriptionInput').value = '';
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('homeworkDueDate').value = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('assignHomeworkModal').style.display = 'block';
        }

        async function assignHomework() {
            if (currentUserType !== 'teacher') return;
            
            const studentId = document.getElementById('homeworkStudentSelect').value;
            const type = document.getElementById('homeworkTypeSelect').value;
            const dueDate = document.getElementById('homeworkDueDate').value;
            const description = document.getElementById('homeworkDescriptionInput').value.trim();
            
            if (!studentId || !type || !dueDate) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const homeworkData = {
                    studentId: studentId,
                    type: type,
                    dueDate: dueDate,
                    description: description,
                    assignedDate: new Date().toISOString(),
                    assignedBy: 'Ustaadh',
                    completed: false,
                    reviewed: false
                };
                
                // Save homework assignment
                await saveHomeworkAssignment(homeworkData);
                
                closeModal('assignHomeworkModal');
                
                const students = await window.getStudents();
                const student = students.find(s => s.id === studentId);
                const studentName = student ? student.name : 'Student';
                const typeDisplay = type.charAt(0).toUpperCase() + type.slice(1);
                
                alert(`${typeDisplay} homework assigned to ${studentName} successfully!`);
                
            } catch (error) {
                console.error('Error assigning homework:', error);
                alert('Error assigning homework: ' + error.message);
            }
        }

        async function saveHomeworkAssignment(homeworkData) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Create unique ID for homework
                const homeworkId = `${homeworkData.studentId}_${Date.now()}`;
                
                await setDoc(doc(db, 'homework', homeworkId), homeworkData);
                console.log('Homework assignment saved:', homeworkId);
            } catch (error) {
                console.error('Error saving homework assignment:', error);
                throw error;
            }
        }

        async function getStudentHomework(studentId) {
            try {
                const { getDocs, collection, query, where } = window.firebaseModules;
                const { db } = window.firebase;
                
                const q = query(
                    collection(db, 'homework'), 
                    where('studentId', '==', studentId)
                );
                
                const querySnapshot = await getDocs(q);
                const homework = [];
                
                querySnapshot.forEach((doc) => {
                    homework.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by assigned date (newest first)
                homework.sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                
                return homework;
            } catch (error) {
                console.error('Error fetching student homework:', error);
                return [];
            }
        }

        async function showViewHomeworkModal() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            try {
                const homework = await getStudentHomework(currentStudent);
                const content = document.getElementById('homeworkContent');
                
                if (!homework || homework.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                            <div style="font-size: 48px; margin-bottom: 20px;">📚</div>
                            <h3 style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">No Homework Assigned</h3>
                            <p style="color: #8E8E93; font-size: 14px;">No homework has been assigned yet.</p>
                        </div>
                    `;
                } else {
                    // Show only current/pending homework
                    const currentHomework = homework.filter(hw => !hw.completed);
                    
                    if (currentHomework.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px; color: #8E8E93;">
                                <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
                                <h3 style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">All Homework Complete!</h3>
                                <p style="color: #8E8E93; font-size: 14px;">Great work! You have completed all assigned homework.</p>
                            </div>
                        `;
                    } else {
                        let homeworkHtml = '';
                        
                        currentHomework.forEach((hw, index) => {
                            const dueDateObj = new Date(hw.dueDate);
                            const today = new Date();
                            const isOverdue = dueDateObj < today;
                            
                            const dueDateStr = dueDateObj.toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            
                            let statusHtml = '';
                            let statusColor = '';
                            if (isOverdue) {
                                statusHtml = '<span style="color: #FF3B30; font-weight: 600;">⚠ Overdue</span>';
                                statusColor = '#FEE2E2';
                            } else {
                                statusHtml = '<span style="color: #FF9500; font-weight: 600;">⏳ Pending</span>';
                                statusColor = '#FEF3C7';
                            }
                            
                            const descriptionHtml = hw.description ? 
                                `<div style="margin-top: 16px; padding: 16px; background: #E8F4FD; border-radius: 12px; border-left: 4px solid #3B82F6;">
                                    <h4 style="font-size: 14px; font-weight: 600; color: #1E40AF; margin-bottom: 8px;">Instructions:</h4>
                                    <p style="color: #1E40AF; font-size: 14px; line-height: 1.5;">${hw.description}</p>
                                </div>` : '';
                            
                            homeworkHtml += `
                                <div style="padding: 20px; margin-bottom: 16px; background: white; border-radius: 16px; border: 1px solid ${isOverdue ? '#FF3B30' : '#E5E5EA'};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                                        <div>
                                            <h3 style="font-size: 20px; font-weight: 600; color: #1C1C1E; margin-bottom: 8px;">${typeDisplay} Homework</h3>
                                            <p style="color: #8E8E93; font-size: 14px; margin-bottom: 8px;">Due: ${dueDateStr}</p>
                                        </div>
                                        <div style="padding: 8px 12px; background: ${statusColor}; border-radius: 8px;">
                                            ${statusHtml}
                                        </div>
                                    </div>
                                    
                                    <div style="padding: 16px; background: #F8F9FA; border-radius: 12px; margin-bottom: 16px;">
                                        <h4 style="font-size: 16px; font-weight: 600; color: #1C1C1E; margin-bottom: 8px;">${typeDisplay}</h4>
                                        <p style="color: #8E8E93; font-size: 14px;">${typeDescription}</p>
                                    </div>
                                    
                                    ${descriptionHtml}
                                </div>
                            `;
                        });
                        
                        content.innerHTML = `
                            <div style="text-align: center; margin-bottom: 24px;">
                                <h3 style="font-size: 20px; font-weight: 600; color: #1C1C1E;">Current Homework</h3>
                                <p style="color: #8E8E93; font-size: 14px;">Complete these assignments on time</p>
                            </div>
                            
                            ${homeworkHtml}
                        `;
                    }
                }
                
                document.getElementById('viewHomeworkModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching homework:', error);
                alert('Error loading homework: ' + error.message);
            }
        }

        async function acknowledgeHomework() {
            try {
                // For simplicity, we'll just show a confirmation
                // In a real app, you might want to track acknowledgments separately
                alert('Thank you for acknowledging the homework! Please help your child complete it by the due date.');
                closeModal('viewHomeworkModal');
                
            } catch (error) {
                console.error('Error acknowledging homework:', error);
                alert('Error acknowledging homework: ' + error.message);
            }
        }

        async function markHomeworkReviewed(homeworkId) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await updateDoc(doc(db, 'homework', homeworkId), {
                    reviewed: true,
                    reviewedDate: new Date().toISOString()
                });
                
                closeModal('viewHomeworkModal');
                alert('Homework marked as reviewed!');
                
                // Refresh homework check
                await checkForHomework();
                
            } catch (error) {
                console.error('Error marking homework as reviewed:', error);
                alert('Error marking homework as reviewed: ' + error.message);
            }
        }

        // Firebase Helper Functions
        window.getStudents = async function() {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const studentsDoc = await getDoc(doc(db, 'config', 'students'));
                if (studentsDoc.exists()) {
                    const students = studentsDoc.data().list || [];
                    // Sort alphabetically by name
                    return students.sort((a, b) => a.name.localeCompare(b.name));
                }
                return defaultStudents.sort((a, b) => a.name.localeCompare(b.name));
            } catch (error) {
                console.error('Error fetching students:', error);
                return defaultStudents.sort((a, b) => a.name.localeCompare(b.name));
            }
        };

        window.getStudentData = async function(studentId) {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const progressDoc = await getDoc(doc(db, 'progress', studentId));
                const studentDoc = await getDoc(doc(db, 'students', studentId));
                
                let progressData = {};
                if (progressDoc.exists()) {
                    progressData = progressDoc.data();
                }
                
                let studentInfo = {};
                if (studentDoc.exists()) {
                    studentInfo = studentDoc.data();
                }
                
                return { ...progressData, ...studentInfo };
            } catch (error) {
                console.error('Error fetching student data:', error);
                return {};
            }
        };

        window.saveStudentData = async function(studentId, data) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Separate student info from progress data
                const { quranType, name, parentEmail, accessCode, ...progressData } = data;
                
                // Save progress data
                await setDoc(doc(db, 'progress', studentId), progressData);
                
                // Save student info if available
                if (quranType || name || parentEmail || accessCode) {
                    await setDoc(doc(db, 'students', studentId), {
                        quranType: quranType || 13,
                        name: name || '',
                        parentEmail: parentEmail || '',
                        accessCode: accessCode || '',
                        lastUpdated: new Date().toISOString()
                    });
                }
                
                console.log(`Student data saved for ${studentId}`);
            } catch (error) {
                console.error('Error saving student data:', error);
                throw error;
            }
        };

        function getDateKey(date = new Date()) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        async function updateTodaysProgress() {
            if (!currentStudent) return;
            
            const today = new Date();
            const todayKey = getDateKey(today);
            const studentData = await window.getStudentData(currentStudent);
            const todayData = studentData[todayKey] || {};
            
            // Check if today is weekend or holiday
            const isWeekendToday = isWeekend(today);
            const isHolidayToday = isHolidayDate(today);
            const holidayInfo = getHolidayInfo(today);
            
            // Get UI elements
            const progressSectionTitle = document.getElementById('progressSectionTitle');
            const progressContainer = document.getElementById('todayProgressContainer');
            const absentButton = document.getElementById('absentButton');
            
            if (isWeekendToday) {
                // Weekend mode - show mosque closed message
                progressSectionTitle.textContent = 'Weekend - Mosque Closed';
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                
                // Show weekend closed message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🕌</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Mosque Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No regular classes</p>
                        <div style="margin-top: 20px; padding: 12px; background: #E8F4FD; border-radius: 8px; font-size: 14px; color: #1E40AF;">
                            Classes resume on Monday
                        </div>
                    </div>
                `;
                
                // Hide parent check section on weekends
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            } else if (isHolidayToday && holidayInfo) {
                // Holiday mode - show holiday message
                progressSectionTitle.textContent = `Holiday - ${holidayInfo.name}`;
                
                // Hide buttons
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                
                // Show holiday message instead of progress
                progressContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600; color: #1C1C1E;">Maktab Closed Today</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Holiday - ${holidayInfo.name}</p>
                        <div style="margin-top: 20px; padding: 12px; background: #FFF3CD; border-radius: 8px; font-size: 14px; color: #856404;">
                            🗓️ Holiday Period
                        </div>
                    </div>
                `;
                
                // Hide parent check section on holidays
                const parentCheckSection = document.getElementById('parentCheckSection');
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'none';
                }
                
                return;
            }
            
            // Weekday mode - restore normal progress display
            progressSectionTitle.textContent = 'Today\'s Progress';
            
            // Show absent button for teachers
            if (currentUserType === 'teacher' && absentButton) {
                absentButton.style.display = 'inline-block';
            }
            
            // Restore progress rows structure if it was changed
            progressContainer.innerHTML = `
                <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                    <div class="progress-info">
                        <div class="progress-icon sabak">📖</div>
                        <div class="progress-details">
                            <h4>Sabak</h4>
                            <p>New Lesson</p>
                        </div>
                    </div>
                    <div class="progress-status" id="sabakStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                    <div class="progress-info">
                        <div class="progress-icon para">🔄</div>
                        <div class="progress-details">
                            <h4>Sabak Para</h4>
                            <p>Previous Lessons</p>
                        </div>
                    </div>
                    <div class="progress-status" id="paraStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
                <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                    <div class="progress-info">
                        <div class="progress-icon dhor">💭</div>
                        <div class="progress-details">
                            <h4>Dhor</h4>
                            <p>Revision</p>
                        </div>
                    </div>
                    <div class="progress-status" id="dhorStatus">
                        <span class="amount-badge">--</span>
                    </div>
                </div>
            `;
            
            // Update UI based on user type for weekdays
            updateUIForUserType();
            
            // Update progress display
            progressTypes.forEach(type => {
                const statusEl = document.getElementById(`${type}Status`);
                const entry = todayData[type];
                
                if (entry) {
                    if (type === 'sabak' && entry.lines) {
                        const conversionInfo = entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : '';
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <span class="amount-badge">${entry.lines} lines</span>
                                    <span class="grade-badge ${entry.grade}"></span>
                                    ${parentCheckHtml}
                                </div>
                                ${conversionInfo}
                            </div>
                        `;
                    } else {
                        let parentCheckHtml = '';
                        
                        // Show parent check status for teachers and office
                        if (currentUserType === 'teacher' || currentUserType === 'office') {
                            if (todayData.parentChecked) {
                                parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                            } else {
                                parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                            }
                        }
                        
                        statusEl.innerHTML = `
                            <div style="display: flex; gap: 4px; align-items: center;">
                                <span class="amount-badge">${entry.amount || entry.lines + ' lines'}</span>
                                <span class="grade-badge ${entry.grade}"></span>
                                ${parentCheckHtml}
                            </div>
                        `;
                    }
                } else {
                    statusEl.innerHTML = '<span class="amount-badge">--</span>';
                }
            });

            // Update absent button for teachers
            if (currentUserType === 'teacher' && absentButton) {
                const progressContainer = document.getElementById('todayProgressContainer');
                const isAbsent = todayData.absent || false;
                
                if (isAbsent) {
                    absentButton.textContent = '✓ Present';
                    absentButton.classList.add('active');
                    progressContainer.classList.add('absent');
                } else {
                    absentButton.textContent = '🔴 Absent';
                    absentButton.classList.remove('active');
                    progressContainer.classList.remove('absent');
                }
            }

            // Update parent check section and button for parents (only on weekdays)
            if (currentUserType === 'parent') {
                const parentCheckSection = document.getElementById('parentCheckSection');
                const parentCheckButton = document.getElementById('parentCheckButton');
                
                if (parentCheckSection) {
                    parentCheckSection.style.display = 'block';
                }
                
                if (parentCheckButton) {
                    if (todayData.parentChecked) {
                        parentCheckButton.textContent = '✓ Checked';
                        parentCheckButton.classList.add('checked');
                    } else {
                        parentCheckButton.textContent = '✓ Mark as Checked';
                        parentCheckButton.classList.remove('checked');
                    }
                }
            }
        }

        async function updateStats() {
            if (!currentStudent) return;
            
            const studentData = await window.getStudentData(currentStudent);
            const stats = { sabak: 0, para: 0, dhor: 0 };
            
            const currentMonth = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}`;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                if (date.startsWith(currentMonth)) {
                    progressTypes.forEach(type => {
                        if (dayData[type]) {
                            stats[type]++;
                        }
                    });
                }
            });
            
            document.getElementById('sabakCount').textContent = stats.sabak;
            document.getElementById('paraCount').textContent = stats.para;
            document.getElementById('dhorCount').textContent = stats.dhor;
        }

        function openProgressModal(type, title) {
            // Only allow teachers to open progress modal
            if (currentUserType !== 'teacher') return;
            
            currentProgressType = type;
            currentDate = null;
            document.getElementById('modalTitle').textContent = `${title} Progress`;
            
            // Show appropriate input fields based on type
            const linesInputGroup = document.getElementById('linesInputGroup');
            const amountInputGroup = document.getElementById('amountInputGroup');
            const linesInput = document.getElementById('linesInput');
            const amountInput = document.getElementById('amountInput');
            
            if (type === 'sabak') {
                linesInputGroup.style.display = 'block';
                amountInputGroup.style.display = 'none';
                linesInput.value = '';
            } else {
                linesInputGroup.style.display = 'none';
                amountInputGroup.style.display = 'block';
                amountInput.value = '';
            }
            
            selectedGrade = null;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateConversionDisplay();
            document.getElementById('progressModal').style.display = 'block';
            
            linesInput.addEventListener('input', updateConversionDisplay);
        }

        function selectGrade(grade) {
            selectedGrade = grade;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-grade="${grade}"]`).classList.add('selected');
        }

        async function saveProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            let entryData = {
                grade: selectedGrade,
                timestamp: new Date().toISOString()
            };
            
            if (currentProgressType === 'sabak') {
                const lines = parseInt(document.getElementById('linesInput').value) || 0;
                if (!lines || !selectedGrade) {
                    alert('Please enter number of lines and select a grade');
                    return;
                }
                
                const students = await window.getStudents();
                const student = students.find(s => s.id === currentStudent);
                const quranType = student ? student.quranType || 13 : 13;
                
                const conversion = convertLinesToPagesAndJuz(lines, quranType);
                
                entryData.lines = lines;
                entryData.amount = `${lines} lines`;
                entryData.pages = conversion.pages;
                entryData.juz = conversion.juz;
                entryData.fraction = conversion.fraction;
                entryData.quranType = quranType;
            } else {
                const amount = document.getElementById('amountInput').value.trim();
                if (!amount || !selectedGrade) {
                    alert('Please enter amount and select a grade');
                    return;
                }
                
                entryData.amount = amount;
            }
            
            const dateKey = currentDate || getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[dateKey]) {
                studentData[dateKey] = {};
            }
            
            studentData[dateKey][currentProgressType] = entryData;
            
            await window.saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            closeModal('progressModal');
            
            if (currentDate && currentDate !== getDateKey()) {
                setTimeout(() => {
                    const dayNumber = parseInt(currentDate.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        async function clearProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            const dateKey = currentDate || getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (studentData[dateKey] && studentData[dateKey][currentProgressType]) {
                delete studentData[dateKey][currentProgressType];
                
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                await window.saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('progressModal');
                
                if (currentDate && currentDate !== getDateKey()) {
                    setTimeout(() => {
                        const dayNumber = parseInt(currentDate.split('-')[2]);
                        openDayModal(dayNumber);
                    }, 200);
                }
            }
        }

        async function toggleAbsent() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const today = getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[today]) {
                studentData[today] = {};
            }
            
            const isCurrentlyAbsent = studentData[today].absent || false;
            
            if (isCurrentlyAbsent) {
                delete studentData[today].absent;
                if (Object.keys(studentData[today]).length === 0) {
                    delete studentData[today];
                }
            } else {
                studentData[today] = { absent: true };
            }
            
            await window.saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
        }

        async function toggleParentCheck(dateKey = null) {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            const targetDate = dateKey || getDateKey();
            const studentData = await window.getStudentData(currentStudent);
            
            if (!studentData[targetDate]) {
                studentData[targetDate] = {};
            }
            
            studentData[targetDate].parentChecked = !studentData[targetDate].parentChecked;
            
            await window.saveStudentData(currentStudent, studentData);
            
            // Update UI based on which date was modified
            if (!dateKey || dateKey === getDateKey()) {
                updateTodaysProgress();
            }
            generateCalendar();
            
            // If modal is open for this date, refresh it
            const dayModalTitle = document.getElementById('dayModalTitle').textContent;
            if (dayModalTitle.includes(new Date(targetDate).toLocaleDateString('en-US', { day: 'numeric' }))) {
                const day = parseInt(targetDate.split('-')[2]);
                setTimeout(() => openDayModal(day), 100);
            }
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('monthTitle');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthTitle.textContent = `${monthNames[currentDisplayMonth - 1]} ${currentDisplayYear}`;
            
            grid.innerHTML = '';
            
            // Show all 7 days of the week including weekends
            const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            dayHeaders.forEach(header => {
                const headerEl = document.createElement('div');
                headerEl.className = 'day-header';
                headerEl.textContent = header;
                grid.appendChild(headerEl);
            });
            
            const firstDay = new Date(currentDisplayYear, currentDisplayMonth - 1, 1);
            const lastDay = new Date(currentDisplayYear, currentDisplayMonth, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get the first Monday of the calendar grid
            const startDate = new Date(firstDay);
            const dayOfWeek = firstDay.getDay();
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday = 0, Sunday = 6
            startDate.setDate(firstDay.getDate() - daysToSubtract);
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentDisplayYear && 
                                  today.getMonth() + 1 === currentDisplayMonth;
            const todayDate = today.getDate();
            
            // Generate calendar grid (6 weeks = 42 days)
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const day = currentDate.getDate();
                const isCurrentMonthDay = currentDate.getMonth() + 1 === currentDisplayMonth;
                const dayOfWeek = currentDate.getDay();
                const isWeekendDay = (dayOfWeek === 0 || dayOfWeek === 6); // Saturday = 6, Sunday = 0
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div style="opacity: ${isCurrentMonthDay ? '1' : '0.3'}">${day}</div>`;
                
                // Add click handler only for current month days
                if (isCurrentMonthDay) {
                    dayEl.style.cursor = 'pointer';
                    dayEl.addEventListener('click', function() {
                        openDayModal(day);
                    });
                }
                
                const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Style weekends - just lighter text, no special background
                if (isWeekendDay && isCurrentMonthDay) {
                    dayEl.classList.add('weekend');
                }
                
                // Check if it's a holiday - holidays override weekend styling
                if (isCurrentMonthDay && isHolidayDate(currentDate)) {
                    dayEl.classList.add('holiday');
                    const holidayInfo = getHolidayInfo(currentDate);
                    if (holidayInfo) {
                        dayEl.title = `Holiday: ${holidayInfo.name}`;
                    }
                }
                
                if (currentStudent && isCurrentMonthDay) {
                    window.getStudentData(currentStudent).then(studentData => {
                        const dayData = studentData[dateKey];
                        
                        if (dayData) {
                            dayEl.classList.add('has-data');
                            
                            if (dayData.absent) {
                                const absentIndicator = document.createElement('div');
                                absentIndicator.style.cssText = 'width: 8px; height: 8px; background: #FF3B30; border-radius: 50%; margin-top: 2px;';
                                dayEl.appendChild(absentIndicator);
                            } else {
                                const indicators = document.createElement('div');
                                indicators.className = 'day-indicators';
                                
                                // Show progress indicators (only for weekdays)
                                if (!isWeekendDay) {
                                    progressTypes.forEach(type => {
                                        if (dayData[type]) {
                                            const indicator = document.createElement('div');
                                            indicator.className = `indicator ${type}`;
                                            indicators.appendChild(indicator);
                                        }
                                    });
                                }
                                
                                // Add parent check indicator (blue tick)
                                if (dayData.parentChecked) {
                                    const parentIndicator = document.createElement('div');
                                    parentIndicator.className = 'parent-check-tick';
                                    parentIndicator.textContent = '✓';
                                    parentIndicator.title = 'Checked by Parent';
                                    indicators.appendChild(parentIndicator);
                                }
                                
                                dayEl.appendChild(indicators);
                            }
                        }
                    });
                }
                
                if (isCurrentMonth && day === todayDate && isCurrentMonthDay) {
                    dayEl.classList.add('today');
                }
                
                grid.appendChild(dayEl);
            }
        }

        async function openDayModal(day) {
            if (!currentStudent) return;
            
            const dateKey = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(currentDisplayYear, currentDisplayMonth - 1, day);
            const isWeekendDay = isWeekend(date);
            const isHolidayDay = isHolidayDate(date);
            const holidayInfo = getHolidayInfo(date);
            
            const studentData = await window.getStudentData(currentStudent);
            const dayData = studentData[dateKey] || {};
            
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            document.getElementById('dayModalTitle').textContent = dateStr;
            
            const progressList = document.getElementById('dayProgressList');
            progressList.innerHTML = '';
            
            if (isWeekendDay) {
                // Weekend view
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🕌</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Mosque Closed</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No classes</p>
                    </div>
                `;
            } else if (isHolidayDay && holidayInfo) {
                // Holiday view
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Maktab Closed</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Holiday - ${holidayInfo.name}</p>
                    </div>
                `;
            } else {
                // Weekday view
                if (dayData.absent) {
                    let absentHtml = `
                        <div style="text-align: center; padding: 50px 30px; color: #FF3B30;">
                            <div style="font-size: 48px; margin-bottom: 20px;">😴</div>
                            <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Student was Absent</h3>
                            <p style="color: #8E8E93; font-size: 16px; margin-bottom: 20px;">No progress recorded for this day</p>
                    `;
                    
                    if (currentUserType === 'teacher') {
                        absentHtml += `
                            <button onclick="removeAbsent('${dateKey}')" style="
                                background: #10A37F; color: white; border: none; 
                                padding: 14px 24px; border-radius: 10px; 
                                font-size: 16px; font-weight: 600; 
                                cursor: pointer; margin-top: 20px;
                            ">Mark as Present</button>
                        `;
                    }
                    
                    absentHtml += '</div>';
                    progressList.innerHTML = absentHtml;
                } else {
                    // Add absent button for teachers only on non-absent days
                    if (currentUserType === 'teacher') {
                        const absentButtonDiv = document.createElement('div');
                        absentButtonDiv.style.marginBottom = '20px';
                        absentButtonDiv.innerHTML = `
                            <button onclick="markDayAbsent('${dateKey}')" style="
                                background: #FF3B30; color: white; border: none; 
                                padding: 14px 24px; border-radius: 10px; 
                                font-size: 16px; font-weight: 600; 
                                cursor: pointer; width: 100%;
                            ">🔴 Mark as Absent</button>
                        `;
                        progressList.appendChild(absentButtonDiv);
                    }
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'today-progress';
                    progressContainer.style.marginTop = '20px';
                    
                    const progressData = [
                        { type: 'sabak', title: 'Sabak', icon: '📖' },
                        { type: 'para', title: 'Sabak Para', icon: '🔄' },
                        { type: 'dhor', title: 'Dhor', icon: '💭' }
                    ];
                    
                    progressData.forEach((item, index) => {
                        const entry = dayData[item.type];
                        
                        const progressRow = document.createElement('div');
                        progressRow.className = 'progress-row';
                        progressRow.style.padding = '24px';
                        progressRow.style.margin = '0 -8px';
                        
                        if (index < progressData.length - 1) {
                            progressRow.style.borderBottom = '1px solid #F2F2F7';
                        }
                        
                        let statusHtml = '<span class="amount-badge">--</span>';
                        if (entry) {
                            if (item.type === 'sabak' && entry.lines) {
                                statusHtml = `
                                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div style="display: flex; gap: 4px;">
                                            <span class="amount-badge">${entry.lines} lines</span>
                                            <span class="grade-badge ${entry.grade}"></span>
                                        </div>
                                        ${entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : ''}
                                    </div>
                                `;
                            } else {
                                statusHtml = `
                                    <div style="display: flex; gap: 4px;">
                                        <span class="amount-badge">${entry.amount}</span>
                                        <span class="grade-badge ${entry.grade}"></span>
                                    </div>
                                `;
                            }
                        }
                        
                        progressRow.innerHTML = `
                            <div class="progress-info">
                                <div class="progress-icon ${item.type}">${item.icon}</div>
                                <div class="progress-details">
                                    <h4>${item.title}</h4>
                                    <p style="color: #8E8E93; font-size: 14px;">${item.type === 'sabak' ? 'New Lesson' : item.type === 'para' ? 'Previous Lessons' : 'Revision'}</p>
                                </div>
                            </div>
                            <div class="progress-status">${statusHtml}</div>
                        `;
                        
                        // Only make clickable for teachers
                        if (currentUserType === 'teacher') {
                            progressRow.style.cursor = 'pointer';
                            progressRow.addEventListener('click', function() {
                                currentProgressType = item.type;
                                currentDate = dateKey;
                                document.getElementById('modalTitle').textContent = `${item.title}`;
                                
                                const linesInputGroup = document.getElementById('linesInputGroup');
                                const amountInputGroup = document.getElementById('amountInputGroup');
                                const linesInput = document.getElementById('linesInput');
                                const amountInput = document.getElementById('amountInput');
                                
                                if (item.type === 'sabak') {
                                    linesInputGroup.style.display = 'block';
                                    amountInputGroup.style.display = 'none';
                                    
                                    if (entry) {
                                        linesInput.value = entry.lines || '';
                                    } else {
                                        linesInput.value = '';
                                    }
                                } else {
                                    linesInputGroup.style.display = 'none';
                                    amountInputGroup.style.display = 'block';
                                    
                                    if (entry) {
                                        amountInput.value = entry.amount || '';
                                    } else {
                                        amountInput.value = '';
                                    }
                                }
                                
                                if (entry) {
                                    selectedGrade = entry.grade;
                                    document.querySelectorAll('.grade-button').forEach(btn => {
                                        btn.classList.remove('selected');
                                    });
                                    document.querySelector(`[data-grade="${entry.grade}"]`).classList.add('selected');
                                } else {
                                    selectedGrade = null;
                                    document.querySelectorAll('.grade-button').forEach(btn => {
                                        btn.classList.remove('selected');
                                    });
                                }
                                
                                updateConversionDisplay();
                                closeModal('dayModal');
                                document.getElementById('progressModal').style.display = 'block';
                                
                                linesInput.addEventListener('input', updateConversionDisplay);
                            });
                        }
                        
                        progressContainer.appendChild(progressRow);
                    });
                    
                    // Add parent check section for any weekday
                    if (!isWeekendDay && !isHolidayDay) {
                        // Parent check button for parents
                        if (currentUserType === 'parent') {
                            const parentCheckRow = document.createElement('div');
                            parentCheckRow.style.cssText = 'padding: 16px 24px; border-top: 1px solid #F2F2F7; background: #F8F9FA;';
                            
                            const isChecked = dayData.parentChecked || false;
                            const buttonText = isChecked ? '✓ Checked by Parent' : '✓ Mark as Checked';
                            const buttonColor = isChecked ? '#8E8E93' : '#34C759';
                            
                            parentCheckRow.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #1C1C1E;">Parent Review</h4>
                                    </div>
                                    <button onclick="toggleParentCheck('${dateKey}')" style="
                                        background: ${buttonColor}; color: white; border: none; 
                                        padding: 12px 16px; border-radius: 8px; 
                                        font-size: 14px; font-weight: 600; 
                                        cursor: pointer; min-width: 140px;
                                    ">${buttonText}</button>
                                </div>
                            `;
                            progressContainer.appendChild(parentCheckRow);
                        }
                        
                        // Parent check status for teachers and office (show both checked and unchecked status)
                        else if (currentUserType === 'teacher' || currentUserType === 'office') {
                            const parentStatusRow = document.createElement('div');
                            if (dayData.parentChecked) {
                                parentStatusRow.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600;';
                                parentStatusRow.innerHTML = '✓ Reviewed by Parent';
                            } else {
                                parentStatusRow.style.cssText = 'padding: 16px 24px; background: #FEF2F2; border-top: 1px solid #FECACA; text-align: center; color: #DC2626; font-size: 14px; font-weight: 600;';
                                parentStatusRow.innerHTML = '✗ Not yet reviewed by Parent';
                            }
                            progressContainer.appendChild(parentStatusRow);
                        }
                    }
                    
                    progressList.appendChild(progressContainer);
                }
            }
            
            document.getElementById('dayModal').style.display = 'block';
        }

        async function markDayAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            studentData[dateKey] = { absent: true };
            
            await window.saveStudentData(currentStudent, studentData);
            generateCalendar();
            closeModal('dayModal');
            
            setTimeout(() => {
                const dayNumber = parseInt(dateKey.split('-')[2]);
                openDayModal(dayNumber);
            }, 200);
        }

        async function removeAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = await window.getStudentData(currentStudent);
            if (studentData[dateKey] && studentData[dateKey].absent) {
                delete studentData[dateKey].absent;
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                await window.saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('dayModal');
                
                setTimeout(() => {
                    const dayNumber = parseInt(dateKey.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        function changeMonth(direction) {
            currentDisplayMonth += direction;
            
            if (currentDisplayMonth > 12) {
                currentDisplayMonth = 1;
                currentDisplayYear++;
            } else if (currentDisplayMonth < 1) {
                currentDisplayMonth = 12;
                currentDisplayYear--;
            }
            
            generateCalendar();
            updateStats();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Admin functions (Teacher only)
        function showAddStudentModal() {
            if (currentUserType !== 'teacher') return;
            
            document.getElementById('newStudentName').value = '';
            document.getElementById('newQuranType').value = '13';
            document.getElementById('newParentCode').value = '';
            document.getElementById('addStudentModal').style.display = 'block';
        }

        async function addStudent() {
            if (currentUserType !== 'teacher') return;
            
            const name = document.getElementById('newStudentName').value.trim();
            const quranType = parseInt(document.getElementById('newQuranType').value);
            const parentCode = document.getElementById('newParentCode').value.trim();
            
            if (!name || !parentCode) {
                alert('Please fill in all fields');
                return;
            }
            
            if (parentCode.length !== 8) {
                alert('Parent access code must be 8 characters long');
                return;
            }
            
            const students = await window.getStudents();
            const studentId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (students.find(s => s.id === studentId)) {
                alert('Student with this name already exists');
                return;
            }
            
            // Check if access code already exists
            if (students.find(s => s.accessCode === parentCode.toLowerCase())) {
                alert('This access code is already in use');
                return;
            }
            
            const newStudent = { 
                id: studentId, 
                name: name, 
                parentEmail: `parent_${studentId}@hifz.com`,
                quranType: quranType,
                accessCode: parentCode.toLowerCase()
            };
            
            students.push(newStudent);
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Save updated students list
                await setDoc(doc(db, 'config', 'students'), {
                    list: students,
                    lastUpdated: new Date().toISOString()
                });
                
                populateStudentTabs(students);
                closeModal('addStudentModal');
                alert(`Student ${name} added successfully!\nQuran Type: ${quranType} Line\nParent access code: ${parentCode.toLowerCase()}`);
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }

        function showRemoveStudentModal() {
            if (currentUserType !== 'teacher') return;
            
            window.getStudents().then(students => {
                const select = document.getElementById('removeStudentSelect');
                select.innerHTML = '<option value="">Choose student to remove</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
                
                document.getElementById('removeStudentModal').style.display = 'block';
            });
        }

        async function removeStudent() {
            if (currentUserType !== 'teacher') return;
            
            const select = document.getElementById('removeStudentSelect');
            const studentId = select.value;
            
            if (!studentId) {
                alert('Please select a student to remove');
                return;
            }
            
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to remove ${student.name} from the active student list? Their data will be preserved in Firebase.`)) {
                return;
            }
            
            const updatedStudents = students.filter(s => s.id !== studentId);
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                // Save updated students list
                await setDoc(doc(db, 'config', 'students'), {
                    list: updatedStudents,
                    lastUpdated: new Date().toISOString()
                });
                
                populateStudentTabs(updatedStudents);
                closeModal('removeStudentModal');
                
                if (currentStudent === studentId) {
                    if (updatedStudents.length > 0) {
                        selectStudent(updatedStudents[0].id);
                    } else {
                        currentStudent = null;
                        updateTodaysProgress();
                        updateStats();
                        generateCalendar();
                    }
                }
                
                alert(`${student.name} has been removed from active students. Their progress data is preserved in Firebase.`);
            } catch (error) {
                console.error('Error removing student:', error);
                alert('Error removing student: ' + error.message);
            }
        }

        // Weekend detection
        function isWeekend(date = new Date()) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday = 0, Saturday = 6
        }

        // Holiday management functions
        async function getHolidays() {
            try {
                const { getDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                const holidaysDoc = await getDoc(doc(db, 'config', 'holidays'));
                if (holidaysDoc.exists()) {
                    return holidaysDoc.data().list || [];
                }
                return [];
            } catch (error) {
                console.error('Error fetching holidays:', error);
                return [];
            }
        }

        async function saveHolidays(holidays) {
            try {
                const { setDoc, doc } = window.firebaseModules;
                const { db } = window.firebase;
                
                await setDoc(doc(db, 'config', 'holidays'), {
                    list: holidays,
                    lastUpdated: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving holidays:', error);
                throw error;
            }
        }

        function showHolidayModal() {
            if (currentUserType !== 'teacher') return;
            
            document.getElementById('holidayName').value = '';
            document.getElementById('holidayStartDate').value = '';
            document.getElementById('holidayEndDate').value = '';
            
            loadHolidayList();
            document.getElementById('holidayModal').style.display = 'block';
        }

        async function loadHolidayList() {
            const holidays = await getHolidays();
            const holidayList = document.getElementById('holidayList');
            
            if (holidays.length === 0) {
                holidayList.innerHTML = '<p style="color: #8E8E93; font-size: 14px; text-align: center; padding: 20px;">No holidays added yet</p>';
                return;
            }
            
            holidayList.innerHTML = '';
            holidays.forEach((holiday, index) => {
                const holidayItem = document.createElement('div');
                holidayItem.className = 'holiday-item';
                
                const startDate = new Date(holiday.startDate).toLocaleDateString();
                const endDate = new Date(holiday.endDate).toLocaleDateString();
                const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
                
                holidayItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: #1C1C1E;">${holiday.name}</div>
                        <div style="font-size: 12px; color: #8E8E93;">${dateRange}</div>
                    </div>
                    <button onclick="removeHoliday(${index})" class="holiday-remove-btn">Remove</button>
                `;
                holidayList.appendChild(holidayItem);
            });
        }

        async function addHoliday() {
            const name = document.getElementById('holidayName').value.trim();
            const startDate = document.getElementById('holidayStartDate').value;
            const endDate = document.getElementById('holidayEndDate').value;
            
            if (!name || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date');
                return;
            }
            
            const holidays = await getHolidays();
            holidays.push({
                name: name,
                startDate: startDate,
                endDate: endDate,
                created: new Date().toISOString()
            });
            
            try {
                await saveHolidays(holidays);
                await updateHolidayCache(); // Update the cache
                loadHolidayList();
                generateCalendar(); // Refresh calendar to show new holiday
                
                // Clear form
                document.getElementById('holidayName').value = '';
                document.getElementById('holidayStartDate').value = '';
                document.getElementById('holidayEndDate').value = '';
                
                alert(`Holiday "${name}" added successfully!`);
            } catch (error) {
                alert('Error adding holiday: ' + error.message);
            }
        }

        async function removeHoliday(index) {
            const holidays = await getHolidays();
            const holiday = holidays[index];
            
            if (confirm(`Remove "${holiday.name}" holiday?`)) {
                holidays.splice(index, 1);
                await saveHolidays(holidays);
                await updateHolidayCache(); // Update the cache
                loadHolidayList();
                generateCalendar(); // Refresh calendar to remove holiday indicators
            }
        }

        // Updated holiday check function
        let cachedHolidays = [];
        
        async function updateHolidayCache() {
            cachedHolidays = await getHolidays();
        }
        
        function isHolidayDate(date = new Date()) {
            const dateStr = getDateKey(date);
            
            return cachedHolidays.some(holiday => {
                const start = new Date(holiday.startDate);
                const end = new Date(holiday.endDate);
                const checkDate = new Date(dateStr);
                
                return checkDate >= start && checkDate <= end;
            });
        }
        
        function getHolidayInfo(date = new Date()) {
            const dateStr = getDateKey(date);
            
            const holiday = cachedHolidays.find(holiday => {
                const start = new Date(holiday.startDate);
                const end = new Date(holiday.endDate);
                const checkDate = new Date(dateStr);
                
                return checkDate >= start && checkDate <= end;
            });
            
            return holiday || null;
        }

        // PDF Export Functions (simplified for this demo with homework summary)
        function exportStudentPDF() {
            document.getElementById('exportPDFModal').style.display = 'block';
            
            // Populate student dropdown for PDF export
            window.getStudents().then(students => {
                const select = document.getElementById('pdfStudentSelect');
                const existingOptions = select.querySelectorAll('option');
                
                // Clear existing options except first two
                for (let i = existingOptions.length - 1; i >= 2; i--) {
                    existingOptions[i].remove();
                }
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
        }

        async function generateSelectedPDF() {
            const studentId = document.getElementById('pdfStudentSelect').value;
            const reportType = document.getElementById('pdfReportType').value;
            
            if (!studentId) {
                alert('Please select a student for PDF report');
                return;
            }
            
            // Show loading
            const btn = document.getElementById('generatePDFBtn');
            const spinner = document.getElementById('modalPdfSpinner');
            const btnText = document.getElementById('modalPdfBtnText');
            
            spinner.style.display = 'inline-block';
            btnText.textContent = 'Generating PDF...';
            btn.disabled = true;
            
            try {
                if (studentId === 'all') {
                    await generateAllStudentsPDF(reportType);
                } else {
                    await generateSingleStudentPDF(studentId, reportType);
                }
                
                closeModal('exportPDFModal');
                alert('PDF report generated successfully!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            } finally {
                // Hide loading
                spinner.style.display = 'none';
                btnText.textContent = '📄 Generate PDF Report';
                btn.disabled = false;
            }
        }

        async function generateSingleStudentPDF(studentId, reportType) {
            const students = await window.getStudents();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const studentData = await window.getStudentData(studentId);
            const homework = await getStudentHomework(studentId);
            
            // Create PDF with homework summary
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Header
            pdf.setFontSize(20);
            pdf.text('📖 Hifz Progress Report', 20, 20);
            
            pdf.setFontSize(14);
            pdf.text(`Student: ${student.name}`, 20, 35);
            pdf.text(`Report Type: ${reportType.replace('-', ' ').toUpperCase()}`, 20, 45);
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 55);
            
            let yPosition = 75;
            
            // Homework Summary Section
            if (homework && homework.length > 0) {
                pdf.setFontSize(16);
                pdf.text('📚 Homework Summary', 20, yPosition);
                yPosition += 15;
                
                const totalHomework = homework.length;
                const completedHomework = homework.filter(hw => hw.completed).length;
                const pendingHomework = homework.filter(hw => !hw.completed).length;
                const today = new Date();
                const overdueHomework = homework.filter(hw => !hw.completed && new Date(hw.dueDate) < today).length;
                
                pdf.setFontSize(12);
                pdf.text(`Total Homework Assigned: ${totalHomework}`, 25, yPosition);
                yPosition += 8;
                pdf.text(`Completed: ${completedHomework}`, 25, yPosition);
                yPosition += 8;
                pdf.text(`Pending: ${pendingHomework}`, 25, yPosition);
                yPosition += 8;
                pdf.text(`Overdue: ${overdueHomework}`, 25, yPosition);
                yPosition += 8;
                
                const completionRate = totalHomework > 0 ? Math.round((completedHomework / totalHomework) * 100) : 0;
                pdf.text(`Completion Rate: ${completionRate}%`, 25, yPosition);
                yPosition += 20;
            } else {
                pdf.setFontSize(16);
                pdf.text('📚 Homework Summary', 20, yPosition);
                yPosition += 15;
                pdf.setFontSize(12);
                pdf.text('No homework has been assigned yet.', 25, yPosition);
                yPosition += 20;
            }
            
            // Progress Summary Section
            pdf.setFontSize(16);
            pdf.text('📊 Progress Summary', 20, yPosition);
            yPosition += 15;
            
            const progressStats = { sabak: 0, para: 0, dhor: 0 };
            let totalDays = 0;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    totalDays++;
                    progressTypes.forEach(type => {
                        if (dayData[type]) {
                            progressStats[type]++;
                        }
                    });
                }
            });
            
            pdf.setFontSize(12);
            pdf.text(`Total Days Recorded: ${totalDays}`, 25, yPosition);
            yPosition += 8;
            pdf.text(`Sabak (New Lessons): ${progressStats.sabak} days`, 25, yPosition);
            yPosition += 8;
            pdf.text(`Sabak Para (Previous Lessons): ${progressStats.para} days`, 25, yPosition);
            yPosition += 8;
            pdf.text(`Dhor (Revision): ${progressStats.dhor} days`, 25, yPosition);
            yPosition += 15;
            
            // Save PDF
            pdf.save(`${student.name}_${reportType}_report.pdf`);
        }

        async function generateAllStudentsPDF(reportType) {
            const students = await window.getStudents();
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Header
            pdf.setFontSize(20);
            pdf.text('📖 All Students Progress Report', 20, 20);
            
            pdf.setFontSize(14);
            pdf.text(`Report Type: ${reportType.replace('-', ' ').toUpperCase()}`, 20, 35);
            pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 45);
            
            let yPosition = 65;
            
            for (const student of students) {
                if (yPosition > 250) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                const studentData = await window.getStudentData(student.id);
                const homework = await getStudentHomework(student.id);
                
                // Student header
                pdf.setFontSize(16);
                pdf.text(`👤 ${student.name}`, 20, yPosition);
                yPosition += 12;
                
                // Homework summary
                if (homework && homework.length > 0) {
                    const totalHomework = homework.length;
                    const completedHomework = homework.filter(hw => hw.completed).length;
                    const completionRate = Math.round((completedHomework / totalHomework) * 100);
                    
                    pdf.setFontSize(10);
                    pdf.text(`Homework: ${completedHomework}/${totalHomework} (${completionRate}%)`, 25, yPosition);
                    yPosition += 8;
                } else {
                    pdf.setFontSize(10);
                    pdf.text('Homework: No assignments', 25, yPosition);
                    yPosition += 8;
                }
                
                // Progress summary
                const progressStats = { sabak: 0, para: 0, dhor: 0 };
                let totalDays = 0;
                
                Object.entries(studentData).forEach(([date, dayData]) => {
                    if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        totalDays++;
                        progressTypes.forEach(type => {
                            if (dayData[type]) {
                                progressStats[type]++;
                            }
                        });
                    }
                });
                
                pdf.text(`Progress: Sabak(${progressStats.sabak}) Para(${progressStats.para}) Dhor(${progressStats.dhor}) - Total: ${totalDays} days`, 25, yPosition);
                yPosition += 15;
            }
            
            // Save PDF
            pdf.save(`all_students_${reportType}_report.pdf`);
        }

        function showResetModal() {
            if (currentUserType !== 'teacher') return;
            
            if (confirm('Are you sure you want to reset ALL student data? This cannot be undone.')) {
                if (confirm('This will permanently delete all progress records. Continue?')) {
                    alert('Reset functionality would be implemented here');
                }
            }
        }

        async function logout() {
            try {
                // Clean up listeners
                studentUnsubscribes.forEach(unsubscribe => unsubscribe());
                studentUnsubscribes = [];
                
                // Sign out from Firebase
                if (currentUser) {
                    await window.firebaseModules.signOut(window.firebase.auth);
                }
                
                // Reset state
                currentStudent = null;
                currentUserType = null;
                currentUser = null;
                selectedProfile = null;
                
                // Show profile selection
                showProfileSelection();
                
            } catch (error) {
                console.error('Error during logout:', error);
                // Force logout anyway
                currentStudent = null;
                currentUserType = null;
                currentUser = null;
                selectedProfile = null;
                showProfileSelection();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['progressModal', 'assignHomeworkModal', 'viewHomeworkModal', 'parentAllHomeworkModal', 'viewAllHomeworkModal', 'addStudentModal', 'removeStudentModal', 'exportPDFModal', 'dayModal', 'holidayModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };

        // Allow Enter key for login
        document.addEventListener('DOMContentLoaded', function() {
            const accessCodeInput = document.getElementById('accessCode');
            if (accessCodeInput) {
                accessCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // Add event listener for lines input
            const linesInput = document.getElementById('linesInput');
            if (linesInput) {
                linesInput.addEventListener('input', updateConversionDisplay);
            }
        });

        // Initialize app when page loads
        function initializeApp() {
            try {
                updateCurrentDate();
                initializeFirebaseConnection();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Add global error handler for debugging
        window.addEventListener('error', function(event) {
            console.error('JavaScript error:', event.error);
        });

        // Ensure all functions are available globally for onclick handlers
        window.selectProfile = selectProfile;
        window.continueToLogin = continueToLogin;
        window.goBackToProfiles = goBackToProfiles;
        window.login = login;
        window.openProgressModal = openProgressModal;
        window.selectGrade = selectGrade;
        window.saveProgress = saveProgress;
        window.clearProgress = clearProgress;
        window.toggleAbsent = toggleAbsent;
        window.toggleParentCheck = toggleParentCheck;
        window.changeMonth = changeMonth;
        window.closeModal = closeModal;
        window.openDayModal = openDayModal;
        window.markDayAbsent = markDayAbsent;
        window.removeAbsent = removeAbsent;
        window.showAddStudentModal = showAddStudentModal;
        window.addStudent = addStudent;
        window.showRemoveStudentModal = showRemoveStudentModal;
        window.removeStudent = removeStudent;
        window.showHolidayModal = showHolidayModal;
        window.addHoliday = addHoliday;
        window.removeHoliday = removeHoliday;
        window.showAssignHomeworkModal = showAssignHomeworkModal;
        window.assignHomework = assignHomework;
        window.showViewHomeworkModal = showViewHomeworkModal;
        window.showParentAllHomeworkModal = showParentAllHomeworkModal;
        window.showViewAllHomeworkModal = showViewAllHomeworkModal;
        window.loadAllHomework = loadAllHomework;
        window.toggleHomeworkCompletion = toggleHomeworkCompletion;
        window.deleteHomework = deleteHomework;
        window.acknowledgeHomework = acknowledgeHomework;
        window.markHomeworkReviewed = markHomeworkReviewed;
        window.exportStudentPDF = exportStudentPDF;
        window.generateSelectedPDF = generateSelectedPDF;
        window.showResetModal = showResetModal;
        window.logout = logout;
    </script>
</body>
</html>
