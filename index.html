<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <meta name="apple-mobile-web-app-title" content="📚 Hifz Record">
    <meta name="theme-color" content="#10A37F">
    <title>📚 Hifz Record - Progress Tracking</title>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            color: #1C1C1E;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            background: #F2F2F7;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 1024px;
                padding: 0 20px;
            }
        }

        .header {
            background: #F2F2F7;
            padding: 20px;
            text-align: center;
            border-radius: 0 0 25px 25px;
        }

        @media (min-width: 768px) {
            .header {
                padding: 30px 40px;
            }
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1C1C1E;
        }

        @media (min-width: 768px) {
            .app-title {
                font-size: 36px;
            }
        }

        .current-date {
            font-size: 16px;
            font-weight: 500;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .current-date {
                font-size: 18px;
            }
        }

        .cloud-status {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            color: #1C1C1E;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .cloud-status.connected {
            background: rgba(16, 163, 127, 0.2);
            color: #0D7A5F;
        }

        .cloud-status.connecting {
            background: rgba(255, 149, 0, 0.2);
            color: #E65100;
        }

        .cloud-status.disconnected {
            background: rgba(255, 59, 48, 0.2);
            color: #C62828;
        }

        .user-info {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(16, 163, 127, 0.1);
            border-radius: 12px;
            color: #1C1C1E;
            font-size: 14px;
            font-weight: 600;
        }

        /* Setup Section */
        .setup-section {
            margin: 20px;
            display: block;
        }

        @media (min-width: 768px) {
            .setup-section {
                margin: 40px auto;
                max-width: 500px;
            }
        }

        .setup-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #E5E5EA;
        }

        @media (min-width: 768px) {
            .setup-card {
                padding: 40px;
            }
        }

        .setup-title {
            font-size: 22px;
            font-weight: 700;
            color: #1C1C1E;
            margin-bottom: 16px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .setup-title {
                font-size: 28px;
            }
        }

        .setup-instructions {
            color: #8E8E93;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .setup-instructions {
                font-size: 16px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 24px;
            }
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #8E8E93;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E5EA;
            border-radius: 10px;
            background: #F2F2F7;
            color: #1C1C1E;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .form-input {
                padding: 16px 20px;
                font-size: 18px;
            }
        }

        .form-input:disabled {
            background: #E5E5EA;
            color: #8E8E93;
            cursor: not-allowed;
        }

        .form-input:focus {
            outline: none;
            border-color: #10A37F;
            background: white;
        }

        .connect-button {
            width: 100%;
            padding: 16px;
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        @media (min-width: 768px) {
            .connect-button {
                padding: 20px;
                font-size: 20px;
            }
        }

        .connect-button:hover {
            background: #0D7A5F;
        }

        .connect-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .error-message {
            background: #FF3B30;
            color: white;
        }

        .success-message {
            background: #34C759;
            color: white;
        }

        /* Profile Selection */
        .profile-selection { 
            margin: 20px; 
            display: none; 
        }

        @media (min-width: 768px) {
            .profile-selection {
                margin: 40px auto;
                max-width: 600px;
            }
        }

        .profile-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .profile-card {
                padding: 40px;
            }
        }

        .profile-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .profile-title {
                font-size: 28px;
                margin-bottom: 30px;
            }
        }

        .profile-option {
            background: #F8F9FA;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .profile-option {
                padding: 20px;
                gap: 16px;
            }
        }

        .profile-option:hover {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.05);
        }

        .profile-option.selected {
            border-color: #10A37F;
            background: rgba(16, 163, 127, 0.1);
        }

        .profile-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .profile-icon {
                font-size: 32px;
                width: 50px;
            }
        }

        .profile-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1C1C1E;
            margin-bottom: 4px;
        }

        @media (min-width: 768px) {
            .profile-info h3 {
                font-size: 18px;
            }
        }

        .profile-info p {
            font-size: 12px;
            color: #8E8E93;
        }

        @media (min-width: 768px) {
            .profile-info p {
                font-size: 14px;
            }
        }

        .continue-button {
            width: 100%;
            padding: 14px;
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
        }

        @media (min-width: 768px) {
            .continue-button {
                padding: 18px;
                font-size: 18px;
            }
        }

        .continue-button:hover {
            background: #0D7A5F;
        }

        .continue-button:disabled {
            background: #8E8E93;
            cursor: not-allowed;
        }

        /* Login styles */
        .login-section { 
            margin: 20px; 
            display: none; 
        }

        @media (min-width: 768px) {
            .login-section {
                margin: 40px auto;
                max-width: 500px;
            }
        }
        
        .login-card { 
            background: white; 
            border-radius: 16px; 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            border: 1px solid #E5E5EA; 
        }

        @media (min-width: 768px) {
            .login-card {
                padding: 40px;
            }
        }
        
        .login-title { 
            font-size: 22px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 20px; 
            text-align: center; 
        }

        @media (min-width: 768px) {
            .login-title {
                font-size: 28px;
            }
        }
        
        .login-button { 
            width: 100%; 
            padding: 14px; 
            background: #10A37F; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .login-button {
                padding: 18px;
                font-size: 18px;
            }
        }
        
        .login-button:hover { 
            background: #0D7A5F; 
        }

        .back-button {
            background: #8E8E93;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }

        /* Permission Notice */
        .permission-notice {
            background: rgba(16, 163, 127, 0.1);
            border: 1px solid #10A37F;
            border-radius: 12px;
            padding: 12px 16px;
            margin: 15px 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #0D7A5F;
            display: none;
        }

        @media (min-width: 768px) {
            .permission-notice {
                margin: 20px 40px;
                font-size: 16px;
            }
        }

        .permission-notice.read-only {
            background: rgba(255, 149, 0, 0.1);
            border-color: #FF9500;
            color: #E65100;
        }

        /* Main app styles */
        .main-content { 
            display: none; 
            padding: 20px; 
        }

        @media (min-width: 768px) {
            .main-content {
                padding: 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 40px;
                align-items: start;
            }

            .main-left {
                order: 1;
            }

            .main-right {
                order: 2;
            }
        }
        
        .student-selector { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .student-selector {
                margin-bottom: 30px;
            }
        }
        
        .student-tabs { 
            display: flex; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 4px; 
        }

        @media (min-width: 768px) {
            .student-tabs {
                gap: 12px;
                flex-wrap: wrap;
                overflow-x: visible;
            }
        }
        
        .student-tab { 
            min-width: 100px; 
            max-width: 140px;
            padding: 12px 16px; 
            background: white; 
            border: 1px solid #E5E5EA; 
            border-radius: 20px; 
            color: #8E8E93; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-align: center; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 768px) {
            .student-tab {
                min-width: 120px;
                max-width: 160px;
                padding: 14px 20px;
                font-size: 14px;
            }
        }
        
        .student-tab.active { 
            background: #10A37F; 
            border-color: #10A37F; 
            color: white; 
        }

        .stats-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .stats-container {
                gap: 16px;
                margin-bottom: 30px;
            }
        }
        
        .stat-card { 
            background: white; 
            padding: 16px; 
            border-radius: 16px; 
            border: 1px solid #E5E5EA; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .stat-card {
                padding: 24px;
            }
        }
        
        .stat-number { 
            font-size: 24px; 
            font-weight: 700; 
            margin-bottom: 4px; 
        }

        @media (min-width: 768px) {
            .stat-number {
                font-size: 32px;
            }
        }
        
        .stat-label { 
            font-size: 12px; 
            color: #8E8E93; 
            font-weight: 600; 
        }

        @media (min-width: 768px) {
            .stat-label {
                font-size: 14px;
            }
        }
        
        .stat-card.sabak .stat-number { 
            color: #10A37F; 
        }
        
        .stat-card.para .stat-number { 
            color: #8E44AD; 
        }
        
        .stat-card.dhor .stat-number { 
            color: #FF9500; 
        }

        .section { 
            margin-bottom: 20px; 
        }

        @media (min-width: 768px) {
            .section {
                margin-bottom: 30px;
            }
        }
        
        .section-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 12px; 
            padding-left: 4px; 
        }

        @media (min-width: 768px) {
            .section-title {
                font-size: 22px;
                margin-bottom: 16px;
            }
        }

        .today-progress { 
            background: white; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }
        
        .progress-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 18px; 
            border-bottom: 1px solid #F2F2F7; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .progress-row {
                padding: 20px 24px;
            }
        }

        .progress-row.read-only {
            cursor: default;
        }
        
        .progress-row:last-child { 
            border-bottom: none; 
        }
        
        .progress-row:hover:not(.read-only) { 
            background: #F8F9FA; 
        }
        
        .progress-info { 
            display: flex; 
            align-items: center; 
        }
        
        .progress-icon { 
            width: 40px; 
            height: 40px; 
            background: #F2F2F7; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-right: 12px; 
            font-size: 18px; 
        }

        @media (min-width: 768px) {
            .progress-icon {
                width: 50px;
                height: 50px;
                margin-right: 16px;
                font-size: 22px;
            }
        }
        
        .progress-icon.sabak { 
            background: rgba(16, 163, 127, 0.1); 
            color: #10A37F; 
        }
        
        .progress-icon.para { 
            background: rgba(142, 68, 173, 0.1); 
            color: #8E44AD; 
        }
        
        .progress-icon.dhor { 
            background: rgba(255, 149, 0, 0.1); 
            color: #FF9500; 
        }
        
        .progress-details h4 { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 2px; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .progress-details h4 {
                font-size: 18px;
            }
        }
        
        .progress-details p { 
            font-size: 13px; 
            color: #8E8E93; 
        }

        @media (min-width: 768px) {
            .progress-details p {
                font-size: 14px;
            }
        }
        
        .progress-status { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-wrap: wrap;
        }
        
        .amount-badge { 
            background: #F2F2F7; 
            color: #8E8E93; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 12px; 
            font-weight: 600; 
        }

        @media (min-width: 768px) {
            .amount-badge {
                padding: 6px 12px;
                font-size: 13px;
            }
        }
        
        .grade-badge { 
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        @media (min-width: 768px) {
            .grade-badge {
                width: 16px;
                height: 16px;
            }
        }
        
        .grade-badge.excellent { 
            background: #34C759; 
        }
        
        .grade-badge.good { 
            background: #10A37F; 
        }
        
        .grade-badge.okay { 
            background: #FF9500; 
        }
        
        .grade-badge.poor { 
            background: #FF3B30; 
        }

        .conversion-badge {
            background: rgba(16, 163, 127, 0.1);
            color: #10A37F;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        @media (min-width: 768px) {
            .conversion-badge {
                font-size: 11px;
                padding: 3px 8px;
            }
        }

        .parent-check-indicator {
            color: #007AFF;
            font-size: 14px;
            font-weight: 600;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-check-indicator {
                font-size: 16px;
            }
        }

        .parent-pending-indicator {
            color: #FF3B30;
            font-size: 12px;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .parent-pending-indicator {
                font-size: 14px;
            }
        }

        .homework-check-indicator {
            background: #007AFF;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        @media (min-width: 768px) {
            .homework-check-indicator {
                font-size: 11px;
                padding: 3px 8px;
            }
        }
        
        .absent-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .absent-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .absent-button.active { 
            background: #8E8E93; 
        }

        .absent-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }
        
        .today-progress.absent { 
            opacity: 0.5; 
            pointer-events: none; 
        }

        /* Weekend styles */
        .weekend-closed {
            background: white;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 768px) {
            .weekend-closed {
                padding: 60px 40px;
            }
        }

        .weekend-closed h3 {
            font-size: 18px;
            color: #8E8E93;
            margin-bottom: 8px;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .weekend-closed h3 {
                font-size: 22px;
            }
        }

        .weekend-closed p {
            color: #8E8E93;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .weekend-closed p {
                font-size: 16px;
            }
        }

        .weekend-homework {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .homework-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 18px;
            border-bottom: 1px solid #F2F2F7;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .homework-row {
                padding: 20px 24px;
            }
        }

        .homework-row:last-child {
            border-bottom: none;
        }

        .homework-row:hover:not(.read-only) {
            background: #F8F9FA;
        }

        .homework-row.read-only {
            cursor: default;
        }

        .homework-status {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .homework-badge {
            background: rgba(16, 163, 127, 0.1);
            color: #10A37F;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .homework-badge {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        .homework-note {
            background: #F2F2F7;
            color: #8E8E93;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .homework-note {
                max-width: 200px;
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* Parent Check Button */
        .parent-check-button { 
            background: #34C759; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .parent-check-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
        
        .parent-check-button.checked { 
            background: #8E8E93; 
        }

        /* Calendar styles */
        .calendar-container { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .calendar-container {
                padding: 30px;
            }
        }
        
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 4px; 
            margin-top: 12px; 
        }

        @media (min-width: 768px) {
            .calendar-grid {
                gap: 8px;
                margin-top: 16px;
            }
        }
        
        .day-header { 
            font-weight: 600; 
            text-align: center; 
            padding: 10px; 
            color: #8E8E93; 
            font-size: 12px; 
        }

        @media (min-width: 768px) {
            .day-header {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: #F2F2F7; 
            border-radius: 8px; 
            font-size: 12px; 
            font-weight: 600; 
            border: 1px solid #E5E5EA; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            position: relative; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .calendar-day {
                border-radius: 12px;
                font-size: 14px;
            }
        }
        
        .calendar-day:hover { 
            background: #E5E5EA; 
        }
        
        .calendar-day.today { 
            border: 2px solid #10A37F; 
            background: #F2F2F7;
            font-weight: 700;
        }
        
        .calendar-day.has-data { 
            background: white; 
            border-color: #10A37F; 
        }

        .calendar-day.holiday {
            background: #FFF3CD;
            border-color: #FF9500;
            color: #856404;
        }

        .calendar-day.weekend {
            background: #E8F4FD;
            border-color: #3B82F6;
            color: #1E40AF;
        }
        
        .day-indicators { 
            display: flex; 
            gap: 1px; 
            margin-top: 2px; 
        }
        
        .indicator { 
            width: 4px; 
            height: 4px; 
            border-radius: 50%; 
        }

        @media (min-width: 768px) {
            .indicator {
                width: 6px;
                height: 6px;
            }
        }
        
        .indicator.sabak { 
            background: #10A37F; 
        }
        
        .indicator.para { 
            background: #8E44AD; 
        }
        
        .indicator.dhor { 
            background: #FF9500; 
        }

        .indicator.homework {
            background: #3B82F6;
        }
        
        .nav-arrow { 
            background: white; 
            border: 1px solid #E5E5EA; 
            color: #10A37F; 
            padding: 10px 14px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .nav-arrow {
                padding: 12px 18px;
                font-size: 18px;
            }
        }
        
        .month-navigation { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 16px; 
            padding: 0 4px; 
        }

        @media (min-width: 768px) {
            .month-navigation {
                margin-bottom: 20px;
            }
        }
        
        .month-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            text-align: center; 
            flex: 1; 
            margin: 0 12px; 
        }

        @media (min-width: 768px) {
            .month-title {
                font-size: 22px;
            }
        }

        /* Modal styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(5px); 
        }
        
        .modal-content { 
            background: white; 
            margin: 15% auto; 
            padding: 32px; 
            border-radius: 20px; 
            width: 90%; 
            max-width: 350px; 
            position: relative; 
            max-height: 70vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 500px;
                padding: 48px;
                margin: 10% auto;
            }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 28px; 
            padding-bottom: 16px; 
            border-bottom: 1px solid #F2F2F7; 
        }

        @media (min-width: 768px) {
            .modal-header {
                margin-bottom: 36px;
                padding-bottom: 20px;
            }
        }
        
        .modal-title { 
            font-size: 20px; 
            font-weight: 700; 
            color: #1C1C1E; 
        }

        @media (min-width: 768px) {
            .modal-title {
                font-size: 24px;
            }
        }
        
        .close { 
            color: #8E8E93; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: color 0.3s ease; 
            padding: 8px; 
            line-height: 1; 
        }

        @media (min-width: 768px) {
            .close {
                font-size: 32px;
            }
        }
        
        .entry-form { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }

        @media (min-width: 768px) {
            .entry-form {
                gap: 24px;
            }
        }
        
        .grade-buttons { 
            display: flex; 
            gap: 8px; 
        }

        @media (min-width: 768px) {
            .grade-buttons {
                gap: 12px;
            }
        }
        
        .grade-button { 
            flex: 1; 
            padding: 12px; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            background: #F2F2F7; 
            color: #8E8E93; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .grade-button {
                padding: 16px;
                font-size: 16px;
            }
        }
        
        .grade-button.selected { 
            background: #10A37F; 
            border-color: #10A37F; 
            color: white; 
        }
        
        .save-button { 
            background: #10A37F; 
            color: white; 
            border: none; 
            padding: 14px; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .save-button {
                padding: 18px;
                font-size: 18px;
            }
        }
        
        .clear-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 12px; 
        }

        @media (min-width: 768px) {
            .clear-button {
                padding: 16px;
                font-size: 16px;
                margin-top: 16px;
            }
        }

        .form-select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            background: #F2F2F7; 
            color: #1C1C1E; 
            font-size: 16px; 
            transition: all 0.3s ease; 
        }

        @media (min-width: 768px) {
            .form-select {
                padding: 16px 20px;
                font-size: 18px;
            }
        }
        
        .form-select:focus { 
            outline: none; 
            border-color: #10A37F; 
            background: white; 
        }

        .homework-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        @media (min-width: 768px) {
            .homework-checkboxes {
                gap: 20px;
            }
        }

        .homework-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid #E5E5EA;
            border-radius: 10px;
            background: #F8F9FA;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (min-width: 768px) {
            .homework-checkbox {
                padding: 20px;
                gap: 16px;
            }
        }

        .homework-checkbox:hover {
            background: #F2F2F7;
            border-color: #10A37F;
        }

        .homework-checkbox.selected {
            background: rgba(16, 163, 127, 0.1);
            border-color: #10A37F;
        }

        .homework-checkbox input {
            margin: 0;
            transform: scale(1.2);
        }

        @media (min-width: 768px) {
            .homework-checkbox input {
                transform: scale(1.4);
            }
        }

        .homework-label {
            flex: 1;
            font-weight: 600;
            color: #1C1C1E;
        }

        @media (min-width: 768px) {
            .homework-label {
                font-size: 16px;
            }
        }

        /* Controls */
        .app-controls { 
            margin: 20px; 
            display: none;
        }

        @media (min-width: 768px) {
            .app-controls {
                margin: 30px 40px;
            }
        }

        @media (min-width: 1024px) {
            .app-controls {
                margin: 0;
            }
        }
        
        .controls-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            border: 1px solid #E5E5EA; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); 
        }

        @media (min-width: 768px) {
            .controls-card {
                padding: 30px;
            }
        }
        
        .controls-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: #1C1C1E; 
            margin-bottom: 16px; 
        }

        @media (min-width: 768px) {
            .controls-title {
                font-size: 22px;
                margin-bottom: 20px;
            }
        }
        
        .control-button { 
            width: 100%; 
            padding: 12px; 
            background: #F2F2F7; 
            border: 1px solid #E5E5EA; 
            border-radius: 10px; 
            color: #1C1C1E; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 8px; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }

        @media (min-width: 768px) {
            .control-button {
                padding: 16px;
                font-size: 16px;
                margin-bottom: 12px;
            }
        }
        
        .control-button.danger { 
            background: #FF3B30; 
            border-color: #FF3B30; 
            color: white; 
        }
        
        .pdf-export-button { 
            background: linear-gradient(135deg, #10A37F, #0D7A5F) !important; 
            color: white !important; 
            border: none !important; 
        }
        
        .loading-spinner { 
            display: none; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #ffffff; 
            border-top: 2px solid transparent; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Footer */
        .footer { 
            text-align: center; 
            padding: 20px; 
            color: #8E8E93; 
            font-size: 12px; 
        }

        @media (min-width: 768px) {
            .footer {
                font-size: 14px;
                padding: 30px;
            }
        }
        
        .logout-button { 
            background: #FF3B30; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 16px auto; 
            display: block; 
        }

        @media (min-width: 768px) {
            .logout-button {
                padding: 16px 32px;
                font-size: 16px;
            }
        }

        .quran-type-badge {
            background: rgba(16, 163, 127, 0.1);
            color: #10A37F;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        @media (min-width: 768px) {
            .quran-type-badge {
                font-size: 11px;
                padding: 3px 10px;
            }
        }

        .day-modal-absent-button {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 15px 0;
            width: 100%;
        }

        @media (min-width: 768px) {
            .day-modal-absent-button {
                padding: 16px 24px;
                font-size: 16px;
                margin: 20px 0;
            }
        }

        .day-modal-absent-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
        }

        /* Hide student selector for parent users */
        .parent-mode .student-selector {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="app-title">📚 Hifz Record</h1>
            <div class="current-date" id="currentDate">Loading...</div>
            <div class="cloud-status disconnected" id="cloudStatus">📂 Not Connected</div>
            <div class="user-info" id="userInfo" style="display: none;"></div>
        </div>

        <!-- GitHub Setup Section -->
        <div class="setup-section" id="setupSection">
            <div class="setup-card">
                <h2 class="setup-title">📂 Connect to Database</h2>
                <div class="error-message" id="setupError"></div>
                <div class="success-message" id="setupSuccess"></div>
                
                <div class="setup-instructions">
                    Connect to the GitHub database to access student progress data.
                </div>

                <div class="form-group">
                    <label class="form-label">GitHub Username</label>
                    <input type="text" class="form-input" id="githubUsername" value="sam-dev93" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Access Token</label>
                    <input type="password" class="form-input" id="githubToken" value="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" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Repository</label>
                    <input type="text" class="form-input" id="repoName" value="hifz-record" disabled>
                </div>

                <button class="connect-button" onclick="connectToDatabase()" id="connectButton">
                    🔗 CONNECT
                </button>
            </div>
        </div>

        <!-- Profile Selection -->
        <div class="profile-selection" id="profileSelection">
            <div class="profile-card">
                <h2 class="profile-title">Select Your Profile</h2>
                
                <div class="profile-option" onclick="selectProfile('teacher')" data-profile="teacher">
                    <div class="profile-icon">📖</div>
                    <div class="profile-info">
                        <h3>Teacher</h3>
                        <p>Full access - Add/edit progress, manage students, reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('office')" data-profile="office">
                    <div class="profile-icon">🕌</div>
                    <div class="profile-info">
                        <h3>Office</h3>
                        <p>Read-only - View all students, generate reports</p>
                    </div>
                </div>

                <div class="profile-option" onclick="selectProfile('parent')" data-profile="parent">
                    <div class="profile-icon">👨‍👩‍👧‍👦</div>
                    <div class="profile-info">
                        <h3>Parent</h3>
                        <p>View your child's progress only</p>
                    </div>
                </div>

                <button class="continue-button" onclick="continueToLogin()" id="continueButton" disabled>
                    Continue
                </button>
            </div>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <div class="login-card">
                <button class="back-button" onclick="goBackToProfiles()">← Back to Profiles</button>
                <h2 class="login-title" id="loginTitle">Login</h2>
                <div class="error-message" id="errorMessage"></div>
                
                <div class="form-group">
                    <label class="form-label" id="accessCodeLabel">Access Code</label>
                    <input type="password" class="form-input" id="accessCode" placeholder="Enter access code">
                </div>

                <button class="login-button" onclick="login()">Login</button>
            </div>
        </div>

        <!-- Permission Notice -->
        <div class="permission-notice" id="permissionNotice"></div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="main-left">
                <!-- Student Selector -->
                <div class="student-selector">
                    <div class="student-tabs" id="studentTabs"></div>
                </div>

                <!-- Student Name Display -->
                <div class="section" id="studentNameDisplay" style="display: none;">
                    <h2 class="section-title" style="text-align: center; font-size: 20px; color: #10A37F; margin-bottom: 8px;" id="selectedStudentName"></h2>
                </div>

                <!-- Statistics -->
                <div class="section">
                    <h2 class="section-title">Monthly Progress</h2>
                    <div class="stats-container">
                        <div class="stat-card sabak">
                            <div class="stat-number" id="sabakCount">0</div>
                            <div class="stat-label">Sabak</div>
                        </div>
                        <div class="stat-card para">
                            <div class="stat-number" id="paraCount">0</div>
                            <div class="stat-label">Sabak Para</div>
                        </div>
                        <div class="stat-card dhor">
                            <div class="stat-number" id="dhorCount">0</div>
                            <div class="stat-label">Dhor</div>
                        </div>
                    </div>
                </div>

                <!-- Today's Progress / Weekend Homework -->
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="progressSectionTitle">Today's Progress</h2>
                        <button class="absent-button" onclick="toggleAbsent()" id="absentButton" style="display: none;">
                            🔴 Absent
                        </button>
                    </div>
                    
                    <!-- Regular weekday progress -->
                    <div class="today-progress" id="todayProgressContainer">
                        <div class="progress-row" onclick="openProgressModal('sabak', 'Sabak')" id="sabakRow">
                            <div class="progress-info">
                                <div class="progress-icon sabak">📖</div>
                                <div class="progress-details">
                                    <h4>Sabak</h4>
                                    <p>New Lesson</p>
                                </div>
                            </div>
                            <div class="progress-status" id="sabakStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('para', 'Sabak Para')" id="paraRow">
                            <div class="progress-info">
                                <div class="progress-icon para">🔄</div>
                                <div class="progress-details">
                                    <h4>Sabak Para</h4>
                                    <p>Previous Lessons</p>
                                </div>
                            </div>
                            <div class="progress-status" id="paraStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                        <div class="progress-row" onclick="openProgressModal('dhor', 'Dhor')" id="dhorRow">
                            <div class="progress-info">
                                <div class="progress-icon dhor">💭</div>
                                <div class="progress-details">
                                    <h4>Dhor</h4>
                                    <p>Revision</p>
                                </div>
                            </div>
                            <div class="progress-status" id="dhorStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weekend closed message -->
                    <div class="weekend-closed" id="weekendClosedContainer" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🏢</div>
                        <h3>Maktab Closed Today</h3>
                        <p>Weekend - No regular classes</p>
                    </div>

                    <!-- Weekend homework -->
                    <div class="weekend-homework" id="weekendHomeworkContainer" style="display: none;">
                        <div class="homework-row" onclick="openHomeworkModal('sabak', 'Sabak')" id="homeworkSabakRow">
                            <div class="progress-info">
                                <div class="progress-icon sabak">📖</div>
                                <div class="progress-details">
                                    <h4>Sabak Homework</h4>
                                    <p>Weekend Practice</p>
                                </div>
                            </div>
                            <div class="homework-status" id="homeworkSabakStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                        <div class="homework-row" onclick="openHomeworkModal('para', 'Sabak Para')" id="homeworkParaRow">
                            <div class="progress-info">
                                <div class="progress-icon para">🔄</div>
                                <div class="progress-details">
                                    <h4>Sabak Para Homework</h4>
                                    <p>Weekend Revision</p>
                                </div>
                            </div>
                            <div class="homework-status" id="homeworkParaStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                        <div class="homework-row" onclick="openHomeworkModal('dhor', 'Dhor')" id="homeworkDhorRow">
                            <div class="progress-info">
                                <div class="progress-icon dhor">💭</div>
                                <div class="progress-details">
                                    <h4>Dhor Homework</h4>
                                    <p>Weekend Practice</p>
                                </div>
                            </div>
                            <div class="homework-status" id="homeworkDhorStatus">
                                <span class="amount-badge">Not Set</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parent Check Section -->
                <div class="section" id="parentCheckSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 class="section-title" style="margin-bottom: 0;" id="parentCheckTitle">Checked by Parent</h2>
                        <button class="parent-check-button" onclick="toggleParentCheck()" id="parentCheckButton">
                            ✓ Mark as Checked
                        </button>
                    </div>
                    <div style="background: white; border-radius: 16px; padding: 16px; border: 1px solid #E5E5EA; font-size: 14px; color: #8E8E93;" id="parentCheckDescription">
                        Mark when you have reviewed your child's progress for today
                        <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                            <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                            <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-right">
                <!-- Monthly Calendar -->
                <div class="section">
                    <div class="month-navigation">
                        <button class="nav-arrow" onclick="changeMonth(-1)">‹</button>
                        <h3 class="month-title" id="monthTitle">Loading...</h3>
                        <button class="nav-arrow" onclick="changeMonth(1)">›</button>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>

                <!-- App Controls -->
                <div class="app-controls" id="appControls">
                    <div class="controls-card">
                        <h3 class="controls-title" id="controlsTitle">Controls</h3>
                        
                        <!-- Teacher Controls -->
                        <div id="teacherControls" style="display: none;">
                            <button class="control-button" onclick="showAddStudentModal()">➕ Add New Student</button>
                            <button class="control-button" onclick="showRemoveStudentModal()">➖ Remove Student</button>
                            <button class="control-button" onclick="showHolidayModal()">🏖️ Manage Holidays</button>
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="pdfSpinner"></div>
                                <span id="pdfBtnText">📄 Export Student PDF</span>
                            </button>
                            <button class="control-button" onclick="exportGitHubData()">📊 Export GitHub Data</button>
                            <button class="control-button danger" onclick="showResetModal()">🗑️ Reset All Data</button>
                        </div>

                        <!-- Office Controls -->
                        <div id="officeControls" style="display: none;">
                            <button class="control-button pdf-export-button" onclick="exportStudentPDF()">
                                <div class="loading-spinner" id="officePdfSpinner"></div>
                                <span id="officePdfBtnText">📄 Export Student PDF</span>
                            </button>
                            <button class="control-button" onclick="exportGitHubData()">📊 View GitHub Data</button>
                        </div>

                        <!-- Parent Controls -->
                        <div id="parentControls" style="display: none;">
                            <!-- Parents don't get PDF export - only teachers and office -->
                        </div>

                        <button class="logout-button" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p id="footerText">Track daily student progress with GitHub sync</p>
        </div>
    </div>

    <!-- Modals -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Enter Progress</h2>
                <span class="close" onclick="closeModal('progressModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group" id="linesInputGroup">
                    <label class="form-label">Lines (will auto-convert to pages & Juz)</label>
                    <input type="number" class="form-input" id="linesInput" placeholder="e.g., 26 lines" min="1">
                    <div id="conversionDisplay" style="margin-top: 8px; font-size: 12px; color: #10A37F;"></div>
                </div>
                <div class="form-group" id="amountInputGroup" style="display: none;">
                    <label class="form-label">Amount/Pages</label>
                    <input type="text" class="form-input" id="amountInput" placeholder="e.g., 5 lines, 1 page">
                </div>
                <div class="form-group">
                    <label class="form-label">Grade</label>
                    <div class="grade-buttons">
                        <div class="grade-button" data-grade="excellent" onclick="selectGrade('excellent')">Excellent</div>
                        <div class="grade-button" data-grade="good" onclick="selectGrade('good')">Good</div>
                        <div class="grade-button" data-grade="okay" onclick="selectGrade('okay')">Okay</div>
                        <div class="grade-button" data-grade="poor" onclick="selectGrade('poor')">Poor</div>
                    </div>
                </div>
                <button class="save-button" onclick="saveProgress()">Save Progress</button>
                <button class="clear-button" onclick="clearProgress()">Clear Entry</button>
            </div>
        </div>
    </div>

    <div id="homeworkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="homeworkModalTitle">Set Weekend Homework</h2>
                <span class="close" onclick="closeModal('homeworkModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group" id="homeworkCheckboxGroup">
                    <label class="form-label">Assign Homework</label>
                    <div class="homework-checkbox" onclick="toggleHomeworkType('sabak')">
                        <input type="checkbox" id="homeworkSabakCheck">
                        <div class="homework-label">Sabak (New Lesson)</div>
                    </div>
                    <div class="homework-checkbox" onclick="toggleHomeworkType('para')">
                        <input type="checkbox" id="homeworkParaCheck">
                        <div class="homework-label">Sabak Para (Previous Lessons)</div>
                    </div>
                    <div class="homework-checkbox" onclick="toggleHomeworkType('dhor')">
                        <input type="checkbox" id="homeworkDhorCheck">
                        <div class="homework-label">Dhor (Revision)</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Homework Note (Optional)</label>
                    <input type="text" class="form-input" id="homeworkNote" placeholder="e.g., Practice Surah Al-Baqarah verses 1-10">
                </div>
                <button class="save-button" onclick="saveHomework()">Set Homework</button>
                <button class="clear-button" onclick="clearHomework()">Clear Homework</button>
            </div>
        </div>
    </div>

    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dayModalTitle">Day Progress</h2>
                <span class="close" onclick="closeModal('dayModal')">&times;</span>
            </div>
            <div id="dayProgressList"></div>
            
            <!-- Legend for colored dots -->
            <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 12px; border-top: 1px solid #E5E5EA;">
                <div style="font-size: 12px; font-weight: 600; color: #8E8E93; margin-bottom: 12px; text-align: center;">Progress Indicators</div>
                <div style="display: flex; justify-content: center; gap: 20px; font-size: 11px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 12px; height: 12px; background: #34C759; border-radius: 50%; display: inline-block;"></span>
                        <span style="color: #8E8E93;">Excellent</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 12px; height: 12px; background: #10A37F; border-radius: 50%; display: inline-block;"></span>
                        <span style="color: #8E8E93;">Good</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 12px; height: 12px; background: #FF9500; border-radius: 50%; display: inline-block;"></span>
                        <span style="color: #8E8E93;">Okay</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 12px; height: 12px; background: #FF3B30; border-radius: 50%; display: inline-block;"></span>
                        <span style="color: #8E8E93;">Poor/Unchecked</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Student</h2>
                <span class="close" onclick="closeModal('addStudentModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group">
                    <label class="form-label">Student Name</label>
                    <input type="text" class="form-input" id="newStudentName" placeholder="Enter student name">
                </div>
                <div class="form-group">
                    <label class="form-label">Quran Type</label>
                    <select class="form-select" id="newQuranType">
                        <option value="13">13 Line Quran (26 pages = 1 Juz)</option>
                        <option value="15">15 Line Quran (20 pages = 1 Juz)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Parent Access Code</label>
                    <input type="text" class="form-input" id="newParentCode" placeholder="Create parent access code">
                </div>
                <button class="save-button" onclick="addStudent()">Add Student</button>
            </div>
        </div>
    </div>

    <div id="removeStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Remove Student</h2>
                <span class="close" onclick="closeModal('removeStudentModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group">
                    <label class="form-label">Select Student to Remove</label>
                    <select class="form-select" id="removeStudentSelect">
                        <option value="">Choose student to remove</option>
                    </select>
                </div>
                <div style="background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 12px; color: #856404;">
                    ⚠️ <strong>Warning:</strong> This will keep the data in GitHub but remove from active student list.
                </div>
                <button class="save-button" style="background: #FF3B30;" onclick="removeStudent()">Remove Student</button>
            </div>
        </div>
    </div>

    <div id="exportPDFModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export Student PDF Report</h2>
                <span class="close" onclick="closeModal('exportPDFModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group">
                    <label class="form-label">Select Student</label>
                    <select class="form-select" id="pdfStudentSelect">
                        <option value="">Choose student for PDF report</option>
                        <option value="all">All Students (Combined Report)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="pdfReportType">
                        <option value="current-month">Current Month Progress</option>
                        <option value="yearly-summary">Yearly Summary</option>
                        <option value="yearly-detailed">Yearly Detailed</option>
                    </select>
                </div>
                <button class="save-button pdf-export-button" onclick="generateSelectedPDF()" id="generatePDFBtn">
                    <div class="loading-spinner" id="modalPdfSpinner"></div>
                    <span id="modalPdfBtnText">📄 Generate PDF Report</span>
                </button>
            </div>
        </div>
    </div>

    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Holidays</h2>
                <span class="close" onclick="closeModal('holidayModal')">&times;</span>
            </div>
            <div class="entry-form">
                <div class="form-group">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-input" id="holidayFromDate">
                </div>
                <div class="form-group">
                    <label class="form-label">To Date (Optional - leave blank for single day)</label>
                    <input type="date" class="form-input" id="holidayToDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Holiday Name/Reason</label>
                    <input type="text" class="form-input" id="holidayName" placeholder="e.g., Eid, Easter Break, Term Break">
                </div>
                <button class="save-button" onclick="addHoliday()">Add Holiday</button>
                
                <div style="margin-top: 20px;">
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Current Holidays</h4>
                    <div id="holidayList" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let githubConfig = {
            username: 'sam-dev93',
            token: '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',
            repo: 'hifz-record',
            connected: false
        };

        let currentUserType = null; // 'teacher', 'office', 'parent'
        let currentStudent = null;
        let currentProgressType = null;
        let currentDate = null;
        let currentDisplayMonth = new Date().getMonth() + 1;
        let currentDisplayYear = new Date().getFullYear();
        let selectedGrade = null;
        let selectedProfile = null;
        let currentHomeworkTypes = [];

        // Default students data
        const defaultStudents = [
            { id: 'abdul_qadir', name: 'Abdul Qadir', parentCode: 'aqd123', quranType: 13 },
            { id: 'abdullah_sheriwala', name: 'Abdullah Sheriwala', parentCode: 'abs123', quranType: 13 },
            { id: 'ahsan_haque', name: 'Ahsan Haque', parentCode: 'ahs123', quranType: 13 },
            { id: 'arafat_rayyan', name: 'Arafat Rayyan', parentCode: 'ara123', quranType: 13 },
            { id: 'ayyan_miah', name: 'Ayyan Miah', parentCode: 'ayy123', quranType: 13 },
            { id: 'ishaq_noor', name: 'Ishaq Noor', parentCode: 'ish123', quranType: 13 },
            { id: 'ismail_hussain', name: 'Ismail Hussain', parentCode: 'ism123', quranType: 13 },
            { id: 'naveed_khan', name: 'Naveed Khan', parentCode: 'nav123', quranType: 13 },
            { id: 'raqib_awal', name: 'Raqib Awal', parentCode: 'raq123', quranType: 13 },
            { id: 'rayhan_rahman', name: 'Rayhan Rahman', parentCode: 'ray123', quranType: 13 }
        ];

        const teacherCode = 'teacher2025';
        const officeCode = 'office2025';
        const progressTypes = ['sabak', 'para', 'dhor'];

        // Weekend detection
        function isWeekend(date = new Date()) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday = 0, Saturday = 6
        }

        // Conversion functions
        function convertLinesToPagesAndJuz(lines, quranType) {
            if (!lines || lines <= 0) return { pages: 0, juz: 0, fraction: '' };
            
            const linesPerPage = quranType;
            const pagesPerJuz = quranType === 13 ? 26 : 20;
            
            const pages = lines / linesPerPage;
            const juz = pages / pagesPerJuz;
            
            let fraction = '';
            if (juz >= 1) {
                const wholeJuz = Math.floor(juz);
                const remainingJuz = juz - wholeJuz;
                if (remainingJuz >= 0.875) {
                    fraction = `${wholeJuz + 1} Juz`;
                } else if (remainingJuz >= 0.625) {
                    fraction = `${wholeJuz} & ¾ Juz`;
                } else if (remainingJuz >= 0.375) {
                    fraction = `${wholeJuz} & ½ Juz`;
                } else if (remainingJuz >= 0.125) {
                    fraction = `${wholeJuz} & ¼ Juz`;
                } else {
                    fraction = `${wholeJuz} Juz`;
                }
            } else if (juz >= 0.875) {
                fraction = '1 Juz';
            } else if (juz >= 0.625) {
                fraction = '¾ Juz';
            } else if (juz >= 0.375) {
                fraction = '½ Juz';
            } else if (juz >= 0.125) {
                fraction = '¼ Juz';
            } else {
                fraction = `${Math.round(pages * 100) / 100} pages`;
            }
            
            return {
                pages: Math.round(pages * 100) / 100,
                juz: Math.round(juz * 1000) / 1000,
                fraction: fraction
            };
        }

        function updateConversionDisplay() {
            const linesInput = document.getElementById('linesInput');
            const conversionDisplay = document.getElementById('conversionDisplay');
            const lines = parseInt(linesInput.value) || 0;
            
            if (lines > 0 && currentStudent) {
                const students = JSON.parse(localStorage.getItem('students') || '[]');
                const student = students.find(s => s.id === currentStudent);
                const quranType = student ? student.quranType || 13 : 13;
                
                const conversion = convertLinesToPagesAndJuz(lines, quranType);
                conversionDisplay.innerHTML = `📊 ${lines} lines = ${conversion.pages} pages = ${conversion.fraction}`;
                conversionDisplay.style.display = 'block';
            } else {
                conversionDisplay.style.display = 'none';
            }
        }

        // Initialize application
        function init() {
            updateCurrentDate();
            showSetupSection();
        }

        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        function showSetupSection() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('profileSelection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('appControls').style.display = 'none';
            document.getElementById('permissionNotice').style.display = 'none';
        }

        function showError(message, elementId = 'setupError') {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message, elementId = 'setupSuccess') {
            const successEl = document.getElementById(elementId);
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 3000);
        }

        async function connectToDatabase() {
            const connectButton = document.getElementById('connectButton');
            connectButton.disabled = true;
            connectButton.textContent = '🔄 Connecting...';
            
            try {
                updateCloudStatus('connecting', '🔄 Connecting to GitHub...');
                
                // Test connection
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Cannot access repository. Please check the repository and token.');
                }
                
                githubConfig.connected = true;
                localStorage.setItem('github_config', JSON.stringify(githubConfig));
                
                updateCloudStatus('connected', '✅ Connected to GitHub');
                showSuccess('Successfully connected to GitHub!');
                
                // Load students data
                await loadStudentsFromGitHub();
                
                setTimeout(() => {
                    showProfileSelection();
                }, 1500);
                
            } catch (error) {
                console.error('Error connecting to GitHub:', error);
                updateCloudStatus('disconnected', '❌ Connection failed');
                showError('Connection failed: ' + error.message);
                connectButton.disabled = false;
                connectButton.textContent = '🔗 CONNECT';
            }
        }

        function updateCloudStatus(status, message) {
            const cloudStatus = document.getElementById('cloudStatus');
            
            cloudStatus.className = `cloud-status ${status}`;
            cloudStatus.textContent = message;
        }

        function showProfileSelection() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('profileSelection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('appControls').style.display = 'none';
        }

        function selectProfile(profileType) {
            selectedProfile = profileType;
            
            // Remove selected class from all options
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelector(`[data-profile="${profileType}"]`).classList.add('selected');
            
            // Enable continue button
            document.getElementById('continueButton').disabled = false;
        }

        function continueToLogin() {
            if (!selectedProfile) return;
            
            currentUserType = selectedProfile;
            
            document.getElementById('profileSelection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Update login form based on profile
            const loginTitle = document.getElementById('loginTitle');
            const accessCodeLabel = document.getElementById('accessCodeLabel');
            const accessCodeInput = document.getElementById('accessCode');
            
            switch(selectedProfile) {
                case 'teacher':
                    loginTitle.textContent = '📖 Teacher Login';
                    accessCodeLabel.textContent = 'Teacher Access Code';
                    accessCodeInput.placeholder = 'Enter teacher access code';
                    break;
                case 'office':
                    loginTitle.textContent = '🕌 Office Login';
                    accessCodeLabel.textContent = 'Office Access Code';
                    accessCodeInput.placeholder = 'Enter office access code';
                    break;
                case 'parent':
                    loginTitle.textContent = '👨‍👩‍👧‍👦 Parent Login';
                    accessCodeLabel.textContent = 'Student Access Code';
                    accessCodeInput.placeholder = 'Enter your child\'s access code';
                    break;
            }
            
            accessCodeInput.value = '';
        }

        function goBackToProfiles() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('profileSelection').style.display = 'block';
            selectedProfile = null;
            document.getElementById('continueButton').disabled = true;
            document.querySelectorAll('.profile-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function login() {
            const accessCode = document.getElementById('accessCode').value.trim();
            
            if (!accessCode) {
                showError('Please enter the access code', 'errorMessage');
                return;
            }

            let loginSuccess = false;
            let foundStudent = null;

            switch(currentUserType) {
                case 'teacher':
                    if (accessCode === teacherCode) {
                        loginSuccess = true;
                    }
                    break;
                case 'office':
                    if (accessCode === officeCode) {
                        loginSuccess = true;
                    }
                    break;
                case 'parent':
                    // Check if access code matches any student's parent code
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    foundStudent = students.find(s => s.parentCode === accessCode);
                    if (foundStudent) {
                        loginSuccess = true;
                        currentStudent = foundStudent.id;
                    }
                    break;
            }

            if (loginSuccess) {
                showMainInterface();
            } else {
                const errorMsg = currentUserType === 'parent' 
                    ? 'Invalid student access code' 
                    : `Invalid ${currentUserType} access code`;
                showError(errorMsg, 'errorMessage');
            }
        }

        async function loadStudentsFromGitHub() {
            try {
                const students = await loadFileFromGitHub('students.json');
                const updatedStudents = (students || defaultStudents).map(student => ({
                    ...student,
                    quranType: student.quranType || 13
                }));
                localStorage.setItem('students', JSON.stringify(updatedStudents));
                
                // Also load holidays if they exist
                try {
                    const holidays = await loadFileFromGitHub('holidays.json');
                    if (holidays) {
                        localStorage.setItem('holidays', JSON.stringify(holidays));
                    }
                } catch (error) {
                    console.log('No holidays file found, using empty array');
                    localStorage.setItem('holidays', JSON.stringify([]));
                }
                
            } catch (error) {
                console.error('Error loading students from GitHub:', error);
                localStorage.setItem('students', JSON.stringify(defaultStudents));
                localStorage.setItem('holidays', JSON.stringify([]));
            }
        }

        async function loadFileFromGitHub(filename) {
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${filename}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content);
                    return JSON.parse(content);
                } else {
                    throw new Error(`File ${filename} not found`);
                }
                
            } catch (error) {
                console.error(`Error loading ${filename} from GitHub:`, error);
                return null;
            }
        }

        function showMainInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('appControls').style.display = 'block';
            
            // Show permission notice
            const permissionNotice = document.getElementById('permissionNotice');
            switch(currentUserType) {
                case 'teacher':
                    permissionNotice.textContent = '📖 TEACHER ACCESS - Full read/write permissions';
                    permissionNotice.className = 'permission-notice';
                    break;
                case 'office':
                    permissionNotice.textContent = '🕌 OFFICE ACCESS - Read-only view, reports only';
                    permissionNotice.className = 'permission-notice read-only';
                    break;
                case 'parent':
                    permissionNotice.textContent = '👨‍👩‍👧‍👦 PARENT ACCESS - View your child\'s progress only';
                    permissionNotice.className = 'permission-notice read-only';
                    break;
            }
            permissionNotice.style.display = 'block';
            
            // Update UI based on user type
            updateUIForUserType();
            updateUserInfo();
            populateStudentTabs();
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            if (currentUserType === 'parent') {
                // For parents, current student is already set during login
                loadStudentDataFromGitHub(currentStudent).then(() => {
                    updateTodaysProgress();
                    updateStats();
                    generateCalendar();
                });
            } else if (students.length > 0) {
                selectStudent(students[0].id);
            } else {
                // Still call updateTodaysProgress for UI initialization
                updateTodaysProgress();
                generateCalendar();
            }
        }

        function updateUIForUserType() {
            const container = document.querySelector('.container');
            const absentButton = document.getElementById('absentButton');
            const teacherControls = document.getElementById('teacherControls');
            const officeControls = document.getElementById('officeControls');
            const parentControls = document.getElementById('parentControls');
            const controlsTitle = document.getElementById('controlsTitle');
            
            // Reset classes
            container.classList.remove('parent-mode');
            
            // Update progress rows
            const progressRows = document.querySelectorAll('.progress-row');
            const homeworkRows = document.querySelectorAll('.homework-row');
            
            progressRows.forEach(row => {
                row.classList.remove('read-only');
            });
            
            homeworkRows.forEach(row => {
                row.classList.remove('read-only');
            });
            
            switch(currentUserType) {
                case 'teacher':
                    absentButton.style.display = 'inline-block';
                    teacherControls.style.display = 'block';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Teacher Controls';
                    
                    // Progress rows are clickable for teachers
                    const sabakRow = document.getElementById('sabakRow');
                    const paraRow = document.getElementById('paraRow');
                    const dhorRow = document.getElementById('dhorRow');
                    
                    if (sabakRow) sabakRow.onclick = () => openProgressModal('sabak', 'Sabak');
                    if (paraRow) paraRow.onclick = () => openProgressModal('para', 'Sabak Para');
                    if (dhorRow) dhorRow.onclick = () => openProgressModal('dhor', 'Dhor');
                    
                    // Homework rows are clickable for teachers
                    const homeworkSabakRow = document.getElementById('homeworkSabakRow');
                    const homeworkParaRow = document.getElementById('homeworkParaRow');
                    const homeworkDhorRow = document.getElementById('homeworkDhorRow');
                    
                    if (homeworkSabakRow) homeworkSabakRow.onclick = () => openHomeworkModal('sabak', 'Sabak');
                    if (homeworkParaRow) homeworkParaRow.onclick = () => openHomeworkModal('para', 'Sabak Para');
                    if (homeworkDhorRow) homeworkDhorRow.onclick = () => openHomeworkModal('dhor', 'Dhor');
                    break;
                    
                case 'office':
                    absentButton.style.display = 'none';
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'block';
                    parentControls.style.display = 'none';
                    controlsTitle.textContent = 'Office Controls';
                    
                    // Progress rows are read-only for office
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    
                    homeworkRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    break;
                    
                case 'parent':
                    container.classList.add('parent-mode');
                    absentButton.style.display = 'none';
                    teacherControls.style.display = 'none';
                    officeControls.style.display = 'none';
                    parentControls.style.display = 'block';
                    controlsTitle.textContent = 'Parent View';
                    
                    // Progress rows are read-only for parents
                    progressRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    
                    homeworkRows.forEach(row => {
                        row.classList.add('read-only');
                        row.onclick = null;
                    });
                    
                    // Show parent check button
                    const parentCheckButton = document.getElementById('parentCheckButton');
                    if (parentCheckButton) {
                        parentCheckButton.style.display = 'inline-block';
                    }
                    break;
            }
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const footerText = document.getElementById('footerText');
            
            switch(currentUserType) {
                case 'teacher':
                    userInfo.textContent = '📖 Teacher - Full Access';
                    footerText.textContent = 'Track daily student progress with full access';
                    break;
                case 'office':
                    userInfo.textContent = '🕌 Office - Read-Only Access';
                    footerText.textContent = 'View student progress and generate reports';
                    break;
                case 'parent':
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    const student = students.find(s => s.id === currentStudent);
                    userInfo.textContent = `👨‍👩‍👧‍👦 Parent - ${student ? student.name : 'Student'} Progress`;
                    footerText.textContent = 'View your child\'s Hifz progress';
                    break;
            }
            userInfo.style.display = 'block';
        }

        function populateStudentTabs() {
            const tabsContainer = document.getElementById('studentTabs');
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            tabsContainer.innerHTML = '';
            
            if (currentUserType === 'parent') {
                // Parents only see their child's tab (already set in currentStudent)
                const student = students.find(s => s.id === currentStudent);
                if (student) {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab active';
                    tab.innerHTML = `${student.name}<span class="quran-type-badge">${student.quranType || 13}L</span>`;
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                }
            } else {
                // Teachers and office staff see all students
                students.forEach(student => {
                    const tab = document.createElement('div');
                    tab.className = 'student-tab';
                    tab.innerHTML = `${student.name}<span class="quran-type-badge">${student.quranType || 13}L</span>`;
                    tab.onclick = () => selectStudent(student.id);
                    tab.dataset.studentId = student.id;
                    tabsContainer.appendChild(tab);
                });
            }
        }

        async function selectStudent(studentId) {
            currentStudent = studentId;
            
            // Load student data from GitHub if connected
            await loadStudentDataFromGitHub(studentId);
            
            if (currentUserType !== 'parent') {
                document.querySelectorAll('.student-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.studentId === studentId) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // Show student name
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const student = students.find(s => s.id === studentId);
            if (student) {
                document.getElementById('selectedStudentName').textContent = student.name;
                document.getElementById('studentNameDisplay').style.display = 'block';
            }
            
            updateTodaysProgress();
            updateStats();
            generateCalendar();
        }

        async function loadStudentDataFromGitHub(studentId) {
            if (!githubConfig.connected) return;
            
            try {
                const data = await loadFileFromGitHub(`progress_${studentId}.json`);
                if (data) {
                    const key = `student_${studentId}`;
                    localStorage.setItem(key, JSON.stringify(data));
                }
            } catch (error) {
                console.error(`Error loading data for ${studentId}:`, error);
            }
        }

        function getStudentData(studentId) {
            const key = `student_${studentId}`;
            return JSON.parse(localStorage.getItem(key) || '{}');
        }

        function saveStudentData(studentId, data) {
            const key = `student_${studentId}`;
            localStorage.setItem(key, JSON.stringify(data));
            
            // Allow both teachers and parents to sync to GitHub
            // Parents can only sync their own child's data
            if (githubConfig.connected && (currentUserType === 'teacher' || currentUserType === 'parent')) {
                const commitMessage = currentUserType === 'parent' 
                    ? `Parent checked homework for ${studentId}` 
                    : `Update progress for ${studentId}`;
                saveFileToGitHub(`progress_${studentId}.json`, data, commitMessage);
            }
        }

        async function saveFileToGitHub(filename, content, commitMessage = `Update ${filename}`) {
            // Teachers can save any file, parents can only save their own child's progress
            if (!githubConfig.connected) return;
            
            if (currentUserType === 'teacher') {
                // Teachers have full access
            } else if (currentUserType === 'parent') {
                // Parents can only save their own child's progress file
                const expectedFilename = `progress_${currentStudent}.json`;
                if (filename !== expectedFilename) {
                    console.log('Parent access denied: Can only update own child\'s progress');
                    return;
                }
            } else {
                // Office and other users cannot save
                return;
            }
            
            try {
                // Get current file SHA (required for updates)
                const checkResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${filename}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const fileContent = btoa(JSON.stringify(content, null, 2));
                const requestBody = {
                    message: commitMessage,
                    content: fileContent
                };
                
                // If file exists, add SHA for update
                if (checkResponse.ok) {
                    const existingFile = await checkResponse.json();
                    requestBody.sha = existingFile.sha;
                }
                
                const saveResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (saveResponse.ok) {
                    updateCloudStatus('connected', '✅ Synced to GitHub');
                    console.log(`Successfully saved ${filename} to GitHub: ${commitMessage}`);
                }
                
            } catch (error) {
                console.error('Error saving to GitHub:', error);
            }
        }

        function getDateKey(date = new Date()) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function updateTodaysProgress() {
            if (!currentStudent) return;
            
            const today = new Date();
            const todayKey = getDateKey(today);
            const studentData = getStudentData(currentStudent);
            const todayData = studentData[todayKey] || {};
            
            // Check if today is weekend
            const isWeekendToday = isWeekend(today);
            
            // Get all UI elements
            const progressSectionTitle = document.getElementById('progressSectionTitle');
            const weekdayContainer = document.getElementById('todayProgressContainer');
            const weekendClosedContainer = document.getElementById('weekendClosedContainer');
            const weekendHomeworkContainer = document.getElementById('weekendHomeworkContainer');
            const absentButton = document.getElementById('absentButton');
            const parentCheckSection = document.getElementById('parentCheckSection');
            const parentCheckTitle = document.getElementById('parentCheckTitle');
            const parentCheckDescription = document.getElementById('parentCheckDescription');
            
            if (isWeekendToday) {
                // Weekend mode
                if (progressSectionTitle) {
                    progressSectionTitle.textContent = 'Weekend Homework';
                }
                
                if (weekdayContainer) {
                    weekdayContainer.style.display = 'none';
                }
                
                if (absentButton) {
                    absentButton.style.display = 'none';
                }
                
                if (currentUserType === 'parent') {
                    // Show homework for parents
                    if (weekendClosedContainer) {
                        weekendClosedContainer.style.display = 'none';
                    }
                    if (weekendHomeworkContainer) {
                        weekendHomeworkContainer.style.display = 'block';
                        updateWeekendHomeworkDisplay(todayData);
                    }
                    
                    // Update parent check section for homework
                    if (parentCheckTitle) {
                        parentCheckTitle.textContent = 'Homework Checked';
                    }
                    if (parentCheckDescription) {
                        parentCheckDescription.innerHTML = `Mark when you have reviewed your child's weekend homework
                            <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                                <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                                <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                            </div>`;
                    }
                    if (parentCheckSection) {
                        parentCheckSection.style.display = 'block';
                    }
                } else if (currentUserType === 'teacher') {
                    // Show homework assignment for teachers
                    if (weekendClosedContainer) {
                        weekendClosedContainer.style.display = 'none';
                    }
                    if (weekendHomeworkContainer) {
                        weekendHomeworkContainer.style.display = 'block';
                        updateWeekendHomeworkDisplay(todayData);
                    }
                    if (parentCheckTitle) {
                        parentCheckTitle.textContent = 'Parent Check Status';
                    }
                    if (parentCheckDescription) {
                        parentCheckDescription.innerHTML = `Parent homework review status indicators:
                            <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                                <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                                <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                            </div>`;
                    }
                    if (parentCheckSection) {
                        parentCheckSection.style.display = 'block';
                    }
                    // Hide the parent check button for teachers
                    const parentCheckButton = document.getElementById('parentCheckButton');
                    if (parentCheckButton) {
                        parentCheckButton.style.display = 'none';
                    }
                } else {
                    // Office view - show closed message
                    if (weekendClosedContainer) {
                        weekendClosedContainer.style.display = 'block';
                    }
                    if (weekendHomeworkContainer) {
                        weekendHomeworkContainer.style.display = 'none';
                    }
                    if (parentCheckSection) {
                        parentCheckSection.style.display = 'none';
                    }
                }
            } else {
                // Weekday mode
                progressSectionTitle.textContent = 'Today\'s Progress';
                weekdayContainer.style.display = 'block';
                weekendClosedContainer.style.display = 'none';
                weekendHomeworkContainer.style.display = 'none';
                
                if (currentUserType === 'teacher') {
                    absentButton.style.display = 'inline-block';
                } else {
                    absentButton.style.display = 'none';
                }
                
                // Update weekday progress
                const isAbsent = todayData.absent || false;
                
                if (currentUserType === 'teacher') {
                    if (isAbsent) {
                        absentButton.textContent = '✓ Present';
                        absentButton.classList.add('active');
                        weekdayContainer.classList.add('absent');
                    } else {
                        absentButton.textContent = '🔴 Absent';
                        absentButton.classList.remove('active');
                        weekdayContainer.classList.remove('absent');
                    }
                }

                const students = JSON.parse(localStorage.getItem('students') || '[]');
                const student = students.find(s => s.id === currentStudent);

                progressTypes.forEach(type => {
                    const statusEl = document.getElementById(`${type}Status`);
                    const entry = todayData[type];
                    
                    if (isAbsent) {
                        statusEl.innerHTML = '<span class="amount-badge">Absent</span>';
                    } else if (entry) {
                        let displayHtml = '';
                        
                        if (type === 'sabak' && entry.lines) {
                            const conversionInfo = `<div class="conversion-badge">${entry.fraction}</div>`;
                            let parentCheckHtml = '';
                            
                            // Show parent check status for teachers and office
                            if (currentUserType === 'teacher' || currentUserType === 'office') {
                                if (todayData.parentChecked) {
                                    parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                                } else {
                                    parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                                }
                            }
                            
                            displayHtml = `
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">
                                        <span class="amount-badge">${entry.lines} lines</span>
                                        <span class="grade-badge ${entry.grade}"></span>
                                        ${parentCheckHtml}
                                    </div>
                                    ${conversionInfo}
                                </div>
                            `;
                        } else {
                            let parentCheckHtml = '';
                            
                            // Show parent check status for teachers and office
                            if (currentUserType === 'teacher' || currentUserType === 'office') {
                                if (todayData.parentChecked) {
                                    parentCheckHtml = '<span class="parent-check-indicator">✓</span>';
                                } else {
                                    parentCheckHtml = '<span class="parent-pending-indicator">✗</span>';
                                }
                            }
                            
                            displayHtml = `
                                <div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">
                                    <span class="amount-badge">${entry.amount}</span>
                                    <span class="grade-badge ${entry.grade}"></span>
                                    ${parentCheckHtml}
                                </div>
                            `;
                        }
                        
                        statusEl.innerHTML = displayHtml;
                    } else {
                        statusEl.innerHTML = '<span class="amount-badge">Not Set</span>';
                    }
                });
                
                // Update parent check section for regular progress
                if (currentUserType === 'parent') {
                    parentCheckTitle.textContent = 'Checked by Parent';
                    parentCheckDescription.innerHTML = `Mark when you have reviewed your child's progress for today
                        <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                            <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                            <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                        </div>`;
                    parentCheckSection.style.display = 'block';
                } else if (currentUserType === 'teacher' || currentUserType === 'office') {
                    parentCheckTitle.textContent = 'Parent Check Status';
                    parentCheckDescription.innerHTML = `Parent review status indicators:
                        <div style="margin-top: 12px; font-size: 12px; display: flex; gap: 16px; justify-content: center;">
                            <span><span style="color: #007AFF; font-weight: 600;">✓</span> Checked by parent</span>
                            <span><span style="color: #FF3B30; font-weight: 600;">✗</span> Not checked by parent</span>
                        </div>`;
                    parentCheckSection.style.display = 'block';
                    // Hide the parent check button for teachers/office
                    const parentCheckButton = document.getElementById('parentCheckButton');
                    if (parentCheckButton) {
                        parentCheckButton.style.display = 'none';
                    }
                } else {
                    parentCheckSection.style.display = 'none';
                }
            }

            // Update parent check button
            if (currentUserType === 'parent') {
                const parentCheckButton = document.getElementById('parentCheckButton');
                if (todayData.parentChecked) {
                    parentCheckButton.textContent = '✓ Checked';
                    parentCheckButton.classList.add('checked');
                } else {
                    parentCheckButton.textContent = '✓ Mark as Checked';
                    parentCheckButton.classList.remove('checked');
                }
            }
        }

        function updateWeekendHomeworkDisplay(todayData) {
            const homework = todayData.homework || {};
            
            // Update homework status for each type
            progressTypes.forEach(type => {
                const statusEl = document.getElementById(`homework${type.charAt(0).toUpperCase() + type.slice(1)}Status`);
                const homeworkEntry = homework[type];
                
                if (homeworkEntry) {
                    let displayHtml = `<div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">
                            <span class="homework-badge">✓ Assigned</span>`;
                    
                    // Show parent check status for teachers and office
                    if (currentUserType === 'teacher' || currentUserType === 'office') {
                        if (todayData.parentChecked) {
                            displayHtml += '<span class="parent-check-indicator">✓</span>';
                        } else {
                            displayHtml += '<span class="parent-pending-indicator">✗</span>';
                        }
                    }
                    
                    displayHtml += '</div>';
                    
                    if (homeworkEntry.note) {
                        displayHtml += `<span class="homework-note">${homeworkEntry.note}</span>`;
                    }
                    displayHtml += '</div>';
                    statusEl.innerHTML = displayHtml;
                } else {
                    statusEl.innerHTML = '<span class="amount-badge">Not Set</span>';
                }
            });
        }

        function updateStats() {
            if (!currentStudent) return;
            
            const studentData = getStudentData(currentStudent);
            const stats = { sabak: 0, para: 0, dhor: 0 };
            
            const currentMonth = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}`;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                if (date.startsWith(currentMonth)) {
                    // Only count weekday progress, not weekend homework
                    const dateObj = new Date(date);
                    if (!isWeekend(dateObj)) {
                        progressTypes.forEach(type => {
                            if (dayData[type]) {
                                stats[type]++;
                            }
                        });
                    }
                }
            });
            
            document.getElementById('sabakCount').textContent = stats.sabak;
            document.getElementById('paraCount').textContent = stats.para;
            document.getElementById('dhorCount').textContent = stats.dhor;
        }

        function openProgressModal(type, title) {
            // Only allow teachers to open progress modal
            if (currentUserType !== 'teacher') return;
            
            const today = getDateKey();
            const studentData = getStudentData(currentStudent);
            const todayData = studentData[today] || {};
            
            if (todayData.absent) {
                alert('Student is marked as absent today. Please mark as present first.');
                return;
            }
            
            currentProgressType = type;
            currentDate = null;
            document.getElementById('modalTitle').textContent = `${title} Progress`;
            
            // Show appropriate input fields based on type
            const linesInputGroup = document.getElementById('linesInputGroup');
            const amountInputGroup = document.getElementById('amountInputGroup');
            const linesInput = document.getElementById('linesInput');
            const amountInput = document.getElementById('amountInput');
            
            if (type === 'sabak') {
                linesInputGroup.style.display = 'block';
                amountInputGroup.style.display = 'none';
                linesInput.value = '';
            } else {
                linesInputGroup.style.display = 'none';
                amountInputGroup.style.display = 'block';
                amountInput.value = '';
            }
            
            selectedGrade = null;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            updateConversionDisplay();
            document.getElementById('progressModal').style.display = 'block';
            
            linesInput.addEventListener('input', updateConversionDisplay);
        }

        function openHomeworkModal(type, title) {
            // Only allow teachers to open homework modal
            if (currentUserType !== 'teacher') return;
            
            currentProgressType = type;
            currentDate = null;
            document.getElementById('homeworkModalTitle').textContent = `Set Weekend Homework`;
            
            // Reset homework checkboxes
            currentHomeworkTypes = [];
            document.querySelectorAll('#homeworkCheckboxGroup input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.homework-checkbox').forEach(checkbox => {
                checkbox.classList.remove('selected');
            });
            
            // Clear homework note
            document.getElementById('homeworkNote').value = '';
            
            document.getElementById('homeworkModal').style.display = 'block';
        }

        function toggleHomeworkType(type) {
            const checkbox = document.getElementById(`homework${type.charAt(0).toUpperCase() + type.slice(1)}Check`);
            const container = checkbox.parentElement;
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                container.classList.add('selected');
                if (!currentHomeworkTypes.includes(type)) {
                    currentHomeworkTypes.push(type);
                }
            } else {
                container.classList.remove('selected');
                currentHomeworkTypes = currentHomeworkTypes.filter(t => t !== type);
            }
        }

        function saveHomework() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            if (currentHomeworkTypes.length === 0) {
                alert('Please select at least one homework type');
                return;
            }
            
            const note = document.getElementById('homeworkNote').value.trim();
            const dateKey = getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (!studentData[dateKey]) {
                studentData[dateKey] = {};
            }
            
            if (!studentData[dateKey].homework) {
                studentData[dateKey].homework = {};
            }
            
            // Clear existing homework
            studentData[dateKey].homework = {};
            
            // Set new homework
            currentHomeworkTypes.forEach(type => {
                studentData[dateKey].homework[type] = {
                    assigned: true,
                    note: note,
                    timestamp: new Date().toISOString()
                };
            });
            
            saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            generateCalendar();
            closeModal('homeworkModal');
        }

        function clearHomework() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const dateKey = getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (studentData[dateKey] && studentData[dateKey].homework) {
                delete studentData[dateKey].homework;
                
                // If no other data for this date, remove the entire day entry
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                generateCalendar();
                closeModal('homeworkModal');
            }
        }

        function selectGrade(grade) {
            selectedGrade = grade;
            document.querySelectorAll('.grade-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-grade="${grade}"]`).classList.add('selected');
        }

        function saveProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            let entryData = {
                grade: selectedGrade,
                timestamp: new Date().toISOString()
            };
            
            if (currentProgressType === 'sabak') {
                const lines = parseInt(document.getElementById('linesInput').value) || 0;
                if (!lines || !selectedGrade) {
                    alert('Please enter number of lines and select a grade');
                    return;
                }
                
                const students = JSON.parse(localStorage.getItem('students') || '[]');
                const student = students.find(s => s.id === currentStudent);
                const quranType = student ? student.quranType || 13 : 13;
                
                const conversion = convertLinesToPagesAndJuz(lines, quranType);
                
                entryData.lines = lines;
                entryData.amount = `${lines} lines`;
                entryData.pages = conversion.pages;
                entryData.juz = conversion.juz;
                entryData.fraction = conversion.fraction;
                entryData.quranType = quranType;
            } else {
                const amount = document.getElementById('amountInput').value.trim();
                if (!amount || !selectedGrade) {
                    alert('Please enter amount and select a grade');
                    return;
                }
                
                entryData.amount = amount;
            }
            
            const dateKey = currentDate || getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (!studentData[dateKey]) {
                studentData[dateKey] = {};
            }
            
            studentData[dateKey][currentProgressType] = entryData;
            
            saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            closeModal('progressModal');
            
            if (currentDate && currentDate !== getDateKey()) {
                setTimeout(() => {
                    const dayNumber = parseInt(currentDate.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        function clearProgress() {
            if (!currentProgressType || !currentStudent || currentUserType !== 'teacher') return;
            
            const dateKey = currentDate || getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (studentData[dateKey] && studentData[dateKey][currentProgressType]) {
                delete studentData[dateKey][currentProgressType];
                
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('progressModal');
                
                if (currentDate && currentDate !== getDateKey()) {
                    setTimeout(() => {
                        const dayNumber = parseInt(currentDate.split('-')[2]);
                        openDayModal(dayNumber);
                    }, 200);
                }
            }
        }

        function toggleAbsent() {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const today = getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (!studentData[today]) {
                studentData[today] = {};
            }
            
            const isCurrentlyAbsent = studentData[today].absent || false;
            
            if (isCurrentlyAbsent) {
                delete studentData[today].absent;
                if (Object.keys(studentData[today]).length === 0) {
                    delete studentData[today];
                }
            } else {
                studentData[today] = { absent: true };
            }
            
            saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
        }

        function toggleParentCheck() {
            if (currentUserType !== 'parent' || !currentStudent) return;
            
            const today = getDateKey();
            const studentData = getStudentData(currentStudent);
            
            if (!studentData[today]) {
                studentData[today] = {};
            }
            
            studentData[today].parentChecked = !studentData[today].parentChecked;
            
            saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            generateCalendar();
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('monthTitle');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthTitle.textContent = `${monthNames[currentDisplayMonth - 1]} ${currentDisplayYear}`;
            
            grid.innerHTML = '';
            
            // Only show Monday to Friday
            const dayHeaders = ['M', 'T', 'W', 'T', 'F'];
            dayHeaders.forEach(header => {
                const headerEl = document.createElement('div');
                headerEl.className = 'day-header';
                headerEl.textContent = header;
                grid.appendChild(headerEl);
            });
            
            const firstDay = new Date(currentDisplayYear, currentDisplayMonth - 1, 1);
            const lastDay = new Date(currentDisplayYear, currentDisplayMonth, 0);
            const daysInMonth = lastDay.getDate();
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentDisplayYear && 
                                  today.getMonth() + 1 === currentDisplayMonth;
            const todayDate = today.getDate();
            
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            
            // Generate calendar for weekdays only
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentDisplayYear, currentDisplayMonth - 1, day);
                const dayOfWeek = date.getDay();
                
                // Skip weekends (Saturday = 6, Sunday = 0)
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div>${day}</div>`;
                
                dayEl.style.cursor = 'pointer';
                dayEl.addEventListener('click', function() {
                    openDayModal(day);
                });
                
                const dateKey = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Check if this date is a holiday
                const holiday = holidays.find(h => h.date === dateKey);
                if (holiday) {
                    dayEl.classList.add('holiday');
                    dayEl.style.background = '#FFF3CD';
                    dayEl.style.color = '#856404';
                    const holidayIndicator = document.createElement('div');
                    holidayIndicator.style.cssText = 'width: 8px; height: 8px; background: #FF9500; border-radius: 50%; margin-top: 2px;';
                    holidayIndicator.title = holiday.name;
                    dayEl.appendChild(holidayIndicator);
                } else if (currentStudent) {
                    const studentData = getStudentData(currentStudent);
                    const dayData = studentData[dateKey];
                    
                    if (dayData) {
                        dayEl.classList.add('has-data');
                        
                        if (dayData.absent) {
                            const absentIndicator = document.createElement('div');
                            absentIndicator.style.cssText = 'width: 8px; height: 8px; background: #FF3B30; border-radius: 50%; margin-top: 2px;';
                            dayEl.appendChild(absentIndicator);
                        } else {
                            const indicators = document.createElement('div');
                            indicators.className = 'day-indicators';
                            
                            // Show regular progress indicators
                            progressTypes.forEach(type => {
                                if (dayData[type]) {
                                    const indicator = document.createElement('div');
                                    indicator.className = `indicator ${type}`;
                                    indicators.appendChild(indicator);
                                }
                            });

                            // Show homework indicator
                            if (dayData.homework && Object.keys(dayData.homework).length > 0) {
                                const homeworkIndicator = document.createElement('div');
                                homeworkIndicator.className = 'indicator homework';
                                indicators.appendChild(homeworkIndicator);
                            }
                            
                            // Add parent check indicator (green dot)
                            if (dayData.parentChecked) {
                                const parentIndicator = document.createElement('div');
                                parentIndicator.style.cssText = 'width: 4px; height: 4px; background: #34C759; border-radius: 50%;';
                                parentIndicator.title = 'Checked by Parent';
                                indicators.appendChild(parentIndicator);
                            }
                            
                            dayEl.appendChild(indicators);
                        }
                    }
                }
                
                if (isCurrentMonth && day === todayDate) {
                    dayEl.classList.add('today');
                }
                
                grid.appendChild(dayEl);
            }
        }

        function openDayModal(day) {
            if (!currentStudent) return;
            
            const dateKey = `${currentDisplayYear}-${String(currentDisplayMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(currentDisplayYear, currentDisplayMonth - 1, day);
            const isWeekendDay = isWeekend(date);
            
            // Check if this is a holiday
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            const holiday = holidays.find(h => h.date === dateKey);
            
            if (holiday) {
                const dateStr = date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                document.getElementById('dayModalTitle').textContent = dateStr;
                
                const progressList = document.getElementById('dayProgressList');
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #FF9500;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🏖️</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">${holiday.name}</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Maktab was closed - No classes</p>
                    </div>
                `;
                document.getElementById('dayModal').style.display = 'block';
                return;
            }
            
            const studentData = getStudentData(currentStudent);
            const dayData = studentData[dateKey] || {};
            
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            document.getElementById('dayModalTitle').textContent = dateStr;
            
            const progressList = document.getElementById('dayProgressList');
            progressList.innerHTML = '';
            
            if (isWeekendDay) {
                // Weekend view
                showWeekendDayModal(dayData, dateKey, progressList);
            } else {
                // Weekday view
                showWeekdayDayModal(dayData, dateKey, progressList);
            }
            
            document.getElementById('dayModal').style.display = 'block';
        }

        function showWeekendDayModal(dayData, dateKey, progressList) {
            const homework = dayData.homework || {};
            
            if (Object.keys(homework).length === 0) {
                progressList.innerHTML = `
                    <div style="text-align: center; padding: 50px 30px; color: #8E8E93;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📝</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">No Homework Set</h3>
                        <p style="color: #8E8E93; font-size: 16px;">Weekend - No homework assigned</p>
                    </div>
                `;
                return;
            }

            const homeworkContainer = document.createElement('div');
            homeworkContainer.className = 'weekend-homework';
            homeworkContainer.style.marginTop = '20px';
            
            const progressData = [
                { type: 'sabak', title: 'Sabak Homework', icon: '📖' },
                { type: 'para', title: 'Sabak Para Homework', icon: '🔄' },
                { type: 'dhor', title: 'Dhor Homework', icon: '💭' }
            ];
            
            progressData.forEach((item, index) => {
                const homeworkEntry = homework[item.type];
                
                const homeworkRow = document.createElement('div');
                homeworkRow.className = 'homework-row';
                homeworkRow.style.padding = '24px';
                homeworkRow.style.margin = '0 -8px';
                
                if (index < progressData.length - 1) {
                    homeworkRow.style.borderBottom = '1px solid #F2F2F7';
                }
                
                let statusHtml = '<span class="amount-badge">Not Set</span>';
                if (homeworkEntry) {
                    statusHtml = `<span class="homework-badge">✓ Assigned</span>`;
                    if (homeworkEntry.note) {
                        statusHtml += `<span class="homework-note">${homeworkEntry.note}</span>`;
                    }
                }
                
                homeworkRow.innerHTML = `
                    <div class="progress-info">
                        <div class="progress-icon ${item.type}">${item.icon}</div>
                        <div class="progress-details">
                            <h4>${item.title}</h4>
                            <p style="color: #8E8E93; font-size: 14px;">Weekend Practice</p>
                        </div>
                    </div>
                    <div class="homework-status">${statusHtml}</div>
                `;
                
                homeworkContainer.appendChild(homeworkRow);
            });

            // Add parent check status for homework
            if (dayData.parentChecked) {
                const parentCheckRow = document.createElement('div');
                parentCheckRow.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600; margin-top: 4px;';
                parentCheckRow.innerHTML = '✓ Homework Checked by Parent';
                homeworkContainer.appendChild(parentCheckRow);
            }
            
            progressList.appendChild(homeworkContainer);
        }

        function showWeekdayDayModal(dayData, dateKey, progressList) {
            if (dayData.absent) {
                let absentHtml = `
                    <div style="text-align: center; padding: 50px 30px; color: #FF3B30;">
                        <div style="font-size: 48px; margin-bottom: 20px;">😴</div>
                        <h3 style="font-size: 20px; margin-bottom: 12px; font-weight: 600;">Student was Absent</h3>
                        <p style="color: #8E8E93; font-size: 16px; margin-bottom: 20px;">No progress recorded for this day</p>
                `;
                
                if (currentUserType === 'teacher') {
                    absentHtml += `
                        <button onclick="removeAbsent('${dateKey}')" style="
                            background: #10A37F; color: white; border: none; 
                            padding: 14px 24px; border-radius: 10px; 
                            font-size: 16px; font-weight: 600; 
                            cursor: pointer; margin-top: 20px;
                        ">Mark as Present</button>
                    `;
                }
                
                absentHtml += '</div>';
                progressList.innerHTML = absentHtml;
                return;
            }
            
            // Add absent button for teachers only on non-absent days
            if (currentUserType === 'teacher') {
                const absentButtonDiv = document.createElement('div');
                absentButtonDiv.style.marginBottom = '20px';
                absentButtonDiv.innerHTML = `
                    <button class="day-modal-absent-button" onclick="markDayAbsent('${dateKey}')">
                        🔴 Mark as Absent
                    </button>
                `;
                progressList.appendChild(absentButtonDiv);
            }
            
            const progressContainer = document.createElement('div');
            progressContainer.className = 'today-progress';
            progressContainer.style.marginTop = '20px';
            
            const progressData = [
                { type: 'sabak', title: 'Sabak', icon: '📖' },
                { type: 'para', title: 'Sabak Para', icon: '🔄' },
                { type: 'dhor', title: 'Dhor', icon: '💭' }
            ];
            
            progressData.forEach((item, index) => {
                const entry = dayData[item.type];
                
                const progressRow = document.createElement('div');
                progressRow.className = 'progress-row';
                progressRow.style.padding = '24px';
                progressRow.style.margin = '0 -8px';
                
                if (index < progressData.length - 1) {
                    progressRow.style.borderBottom = '1px solid #F2F2F7';
                }
                
                let statusHtml = '<span class="amount-badge">Not Set</span>';
                if (entry) {
                    if (item.type === 'sabak' && entry.lines) {
                        statusHtml = `
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="display: flex; gap: 4px;">
                                    <span class="amount-badge">${entry.lines} lines</span>
                                    <span class="grade-badge ${entry.grade}"></span>
                                </div>
                                ${entry.fraction ? `<div class="conversion-badge">${entry.fraction}</div>` : ''}
                            </div>
                        `;
                    } else {
                        statusHtml = `
                            <div style="display: flex; gap: 4px;">
                                <span class="amount-badge">${entry.amount}</span>
                                <span class="grade-badge ${entry.grade}"></span>
                            </div>
                        `;
                    }
                }
                
                progressRow.innerHTML = `
                    <div class="progress-info">
                        <div class="progress-icon ${item.type}">${item.icon}</div>
                        <div class="progress-details">
                            <h4>${item.title}</h4>
                            <p style="color: #8E8E93; font-size: 14px;">${item.type === 'sabak' ? 'New Lesson' : item.type === 'para' ? 'Previous Lessons' : 'Revision'}</p>
                        </div>
                    </div>
                    <div class="progress-status">${statusHtml}</div>
                `;
                
                // Only make clickable for teachers
                if (currentUserType === 'teacher') {
                    progressRow.style.cursor = 'pointer';
                    progressRow.addEventListener('click', function() {
                        currentProgressType = item.type;
                        currentDate = dateKey;
                        document.getElementById('modalTitle').textContent = `${item.title}`;
                        
                        const linesInputGroup = document.getElementById('linesInputGroup');
                        const amountInputGroup = document.getElementById('amountInputGroup');
                        const linesInput = document.getElementById('linesInput');
                        const amountInput = document.getElementById('amountInput');
                        
                        if (item.type === 'sabak') {
                            linesInputGroup.style.display = 'block';
                            amountInputGroup.style.display = 'none';
                            
                            if (entry) {
                                linesInput.value = entry.lines || '';
                            } else {
                                linesInput.value = '';
                            }
                        } else {
                            linesInputGroup.style.display = 'none';
                            amountInputGroup.style.display = 'block';
                            
                            if (entry) {
                                amountInput.value = entry.amount || '';
                            } else {
                                amountInput.value = '';
                            }
                        }
                        
                        if (entry) {
                            selectedGrade = entry.grade;
                            document.querySelectorAll('.grade-button').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            document.querySelector(`[data-grade="${entry.grade}"]`).classList.add('selected');
                        } else {
                            selectedGrade = null;
                            document.querySelectorAll('.grade-button').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                        }
                        
                        updateConversionDisplay();
                        closeModal('dayModal');
                        document.getElementById('progressModal').style.display = 'block';
                        
                        linesInput.addEventListener('input', updateConversionDisplay);
                    });
                }
                
                progressContainer.appendChild(progressRow);
            });
            
            // Add parent check status for day
            if (dayData.parentChecked) {
                const parentCheckRow = document.createElement('div');
                parentCheckRow.style.cssText = 'padding: 16px 24px; background: #F0F9FF; border-top: 1px solid #E0F2FE; text-align: center; color: #0369A1; font-size: 14px; font-weight: 600; margin-top: 4px;';
                parentCheckRow.innerHTML = '✓ Checked by Parent';
                progressContainer.appendChild(parentCheckRow);
            }
            
            progressList.appendChild(progressContainer);
        }

        function markDayAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = getStudentData(currentStudent);
            studentData[dateKey] = { absent: true };
            
            saveStudentData(currentStudent, studentData);
            updateTodaysProgress();
            updateStats();
            generateCalendar();
            closeModal('dayModal');
            
            setTimeout(() => {
                const dayNumber = parseInt(dateKey.split('-')[2]);
                openDayModal(dayNumber);
            }, 200);
        }

        function removeAbsent(dateKey) {
            if (!currentStudent || currentUserType !== 'teacher') return;
            
            const studentData = getStudentData(currentStudent);
            if (studentData[dateKey] && studentData[dateKey].absent) {
                delete studentData[dateKey].absent;
                if (Object.keys(studentData[dateKey]).length === 0) {
                    delete studentData[dateKey];
                }
                
                saveStudentData(currentStudent, studentData);
                updateTodaysProgress();
                updateStats();
                generateCalendar();
                closeModal('dayModal');
                
                setTimeout(() => {
                    const dayNumber = parseInt(dateKey.split('-')[2]);
                    openDayModal(dayNumber);
                }, 200);
            }
        }

        function changeMonth(direction) {
            currentDisplayMonth += direction;
            
            if (currentDisplayMonth > 12) {
                currentDisplayMonth = 1;
                currentDisplayYear++;
            } else if (currentDisplayMonth < 1) {
                currentDisplayMonth = 12;
                currentDisplayYear--;
            }
            
            generateCalendar();
            updateStats();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Holiday Management Functions
        function showHolidayModal() {
            loadHolidayList();
            document.getElementById('holidayModal').style.display = 'block';
        }

        function addHoliday() {
            const fromDate = document.getElementById('holidayFromDate').value;
            const toDate = document.getElementById('holidayToDate').value;
            const name = document.getElementById('holidayName').value.trim();
            
            if (!fromDate || !name) {
                alert('Please enter at least the from date and holiday name');
                return;
            }
            
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            
            // If no to date, treat as single day
            const endDate = toDate || fromDate;
            
            // Generate all dates in the range
            const startDateObj = new Date(fromDate);
            const endDateObj = new Date(endDate);
            
            if (endDateObj < startDateObj) {
                alert('To date cannot be before from date');
                return;
            }
            
            const datesToAdd = [];
            const currentDate = new Date(startDateObj);
            
            while (currentDate <= endDateObj) {
                const dateString = currentDate.toISOString().split('T')[0];
                
                // Check if holiday already exists for this date
                if (holidays.find(h => h.date === dateString)) {
                    alert(`Holiday already exists for ${dateString}`);
                    return;
                }
                
                datesToAdd.push({
                    date: dateString,
                    name: name,
                    isRange: fromDate !== endDate,
                    rangeStart: fromDate,
                    rangeEnd: endDate
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Add all dates
            holidays.push(...datesToAdd);
            localStorage.setItem('holidays', JSON.stringify(holidays));
            
            // Save to GitHub if connected
            if (githubConfig.connected && currentUserType === 'teacher') {
                const rangeText = fromDate === endDate ? fromDate : `${fromDate} to ${endDate}`;
                saveFileToGitHub('holidays.json', holidays, `Add holiday: ${name} (${rangeText})`);
            }
            
            document.getElementById('holidayFromDate').value = '';
            document.getElementById('holidayToDate').value = '';
            document.getElementById('holidayName').value = '';
            loadHolidayList();
            generateCalendar();
        }

        function removeHoliday(date) {
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            const updatedHolidays = holidays.filter(h => h.date !== date);
            localStorage.setItem('holidays', JSON.stringify(updatedHolidays));
            
            // Save to GitHub if connected
            if (githubConfig.connected && currentUserType === 'teacher') {
                saveFileToGitHub('holidays.json', updatedHolidays, `Remove holiday on ${date}`);
            }
            
            loadHolidayList();
            generateCalendar();
        }

        function loadHolidayList() {
            const holidayList = document.getElementById('holidayList');
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            
            holidayList.innerHTML = '';
            
            if (holidays.length === 0) {
                holidayList.innerHTML = '<p style="color: #8E8E93; font-size: 14px;">No holidays added yet</p>';
                return;
            }
            
            // Group holidays by name and range
            const groupedHolidays = {};
            holidays.forEach(holiday => {
                const key = holiday.isRange ? `${holiday.name}_${holiday.rangeStart}_${holiday.rangeEnd}` : holiday.date;
                if (!groupedHolidays[key]) {
                    groupedHolidays[key] = holiday;
                }
            });
            
            Object.values(groupedHolidays).sort((a, b) => a.date.localeCompare(b.date)).forEach(holiday => {
                const holidayItem = document.createElement('div');
                holidayItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #F8F9FA; border-radius: 8px; margin-bottom: 8px;';
                
                let dateText;
                if (holiday.isRange && holiday.rangeStart !== holiday.rangeEnd) {
                    const fromDate = new Date(holiday.rangeStart).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                    const toDate = new Date(holiday.rangeEnd).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    dateText = `${fromDate} - ${toDate}`;
                } else {
                    dateText = new Date(holiday.date).toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }
                
                holidayItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${holiday.name}</div>
                        <div style="font-size: 12px; color: #8E8E93;">${dateText}</div>
                    </div>
                    <button onclick="removeHolidayRange('${holiday.name}', '${holiday.isRange ? holiday.rangeStart : holiday.date}', '${holiday.isRange ? holiday.rangeEnd : holiday.date}')" style="
                        background: #FF3B30; color: white; border: none; 
                        padding: 4px 8px; border-radius: 4px; font-size: 12px; 
                        cursor: pointer;
                    ">Remove</button>
                `;
                
                holidayList.appendChild(holidayItem);
            });
        }

        function removeHolidayRange(name, startDate, endDate) {
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            
            // Remove all holidays with matching name and date range
            const updatedHolidays = holidays.filter(h => {
                if (startDate === endDate) {
                    // Single day holiday
                    return !(h.date === startDate && h.name === name);
                } else {
                    // Range holiday
                    return !(h.name === name && h.rangeStart === startDate && h.rangeEnd === endDate);
                }
            });
            
            localStorage.setItem('holidays', JSON.stringify(updatedHolidays));
            
            // Save to GitHub if connected
            if (githubConfig.connected && currentUserType === 'teacher') {
                const rangeText = startDate === endDate ? startDate : `${startDate} to ${endDate}`;
                saveFileToGitHub('holidays.json', updatedHolidays, `Remove holiday: ${name} (${rangeText})`);
            }
            
            loadHolidayList();
            generateCalendar();
        }

        // Admin functions (Teacher only)
        function showAddStudentModal() {
            if (currentUserType !== 'teacher') return;
            
            document.getElementById('newStudentName').value = '';
            document.getElementById('newQuranType').value = '13';
            document.getElementById('newParentCode').value = '';
            document.getElementById('addStudentModal').style.display = 'block';
        }

        function addStudent() {
            if (currentUserType !== 'teacher') return;
            
            const name = document.getElementById('newStudentName').value.trim();
            const quranType = parseInt(document.getElementById('newQuranType').value);
            const parentCode = document.getElementById('newParentCode').value.trim();
            
            if (!name || !parentCode) {
                alert('Please fill in all fields');
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const studentId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            if (students.find(s => s.id === studentId)) {
                alert('Student with this name already exists');
                return;
            }
            
            students.push({ 
                id: studentId, 
                name: name, 
                parentCode: parentCode,
                quranType: quranType
            });
            localStorage.setItem('students', JSON.stringify(students));
            
            // Save to GitHub
            if (githubConfig.connected) {
                saveFileToGitHub('students.json', students, `Add student: ${name} (${quranType}L)`);
            }
            
            populateStudentTabs();
            closeModal('addStudentModal');
            alert(`Student ${name} added successfully!\nQuran Type: ${quranType} Line\nParent code: ${parentCode}`);
        }

        function showRemoveStudentModal() {
            if (currentUserType !== 'teacher') return;
            
            const select = document.getElementById('removeStudentSelect');
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            select.innerHTML = '<option value="">Choose student to remove</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.quranType || 13}L)`;
                select.appendChild(option);
            });
            
            document.getElementById('removeStudentModal').style.display = 'block';
        }

        function removeStudent() {
            if (currentUserType !== 'teacher') return;
            
            const select = document.getElementById('removeStudentSelect');
            const studentId = select.value;
            
            if (!studentId) {
                alert('Please select a student to remove');
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const student = students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Student not found');
                return;
            }
            
            if (!confirm(`Are you sure you want to remove ${student.name} from the active student list? Their data will be kept in GitHub.`)) {
                return;
            }
            
            const updatedStudents = students.filter(s => s.id !== studentId);
            localStorage.setItem('students', JSON.stringify(updatedStudents));
            
            // Update students list in GitHub
            if (githubConfig.connected) {
                saveFileToGitHub('students.json', updatedStudents, `Remove student from active list: ${student.name}`);
            }
            
            populateStudentTabs();
            closeModal('removeStudentModal');
            
            if (currentStudent === studentId) {
                if (updatedStudents.length > 0) {
                    selectStudent(updatedStudents[0].id);
                } else {
                    currentStudent = null;
                    updateTodaysProgress();
                    updateStats();
                    generateCalendar();
                }
            }
            
            alert(`${student.name} has been removed from active students. Their progress data is preserved in GitHub.`);
        }

        function exportStudentPDF() {
            const select = document.getElementById('pdfStudentSelect');
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            select.innerHTML = '<option value="">Choose student for PDF report</option>';
            
            if (currentUserType === 'parent') {
                // Parents can only export their child's data
                const student = students.find(s => s.id === currentStudent);
                if (student) {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.quranType || 13}L)`;
                    select.appendChild(option);
                }
            } else {
                // Teachers and office can export all students
                select.innerHTML += '<option value="all">All Students (Combined Report)</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.quranType || 13}L)`;
                    select.appendChild(option);
                });
            }
            
            document.getElementById('exportPDFModal').style.display = 'block';
        }

        function generateSelectedPDF() {
            const studentSelect = document.getElementById('pdfStudentSelect');
            const reportType = document.getElementById('pdfReportType').value;
            const selectedStudent = studentSelect.value;
            
            if (!selectedStudent) {
                alert('Please select a student');
                return;
            }

            const btn = document.getElementById('generatePDFBtn');
            const btnText = document.getElementById('modalPdfBtnText');
            const spinner = document.getElementById('modalPdfSpinner');
            
            const originalText = btnText.textContent;
            btnText.textContent = 'Generating PDF...';
            spinner.style.display = 'block';
            btn.disabled = true;

            try {
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF library not loaded. Please refresh the page and try again.');
                    resetPdfButton();
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                if (selectedStudent === 'all') {
                    generateAllStudentsPDF(doc, reportType);
                } else {
                    generateSingleStudentPDF(doc, selectedStudent, reportType);
                }
                
                closeModal('exportPDFModal');
                setTimeout(() => {
                    alert('📄 PDF report generated successfully!');
                }, 500);
                
                resetPdfButton();

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
                resetPdfButton();
            }
            
            function resetPdfButton() {
                btnText.textContent = originalText;
                spinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        // Improved PDF generation functions
        function generateSingleStudentPDF(doc, studentId, reportType) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const student = students.find(s => s.id === studentId);
            const studentData = getStudentData(studentId);
            const holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
            
            if (!student) {
                throw new Error('Student not found');
            }

            // Header
            doc.setFillColor(16, 163, 127);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            
            let reportTitle = '';
            switch(reportType) {
                case 'current-month':
                    reportTitle = 'CURRENT MONTH PROGRESS REPORT';
                    break;
                case 'yearly-summary':
                    reportTitle = 'YEARLY SUMMARY REPORT';
                    break;
                case 'yearly-detailed':
                    reportTitle = 'YEARLY DETAILED REPORT';
                    break;
            }
            
            doc.text(reportTitle, 105, 15, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(230, 230, 230);
            const currentMonth = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const reportSubtitle = reportType === 'current-month' ? 
                `${student.name} - ${currentMonth}` : 
                `${student.name} - Academic Year ${new Date().getFullYear()}/${new Date().getFullYear() + 1}`;
            doc.text(reportSubtitle, 105, 25, { align: 'center' });
            
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const generatedDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            doc.text(`${student.quranType || 13} Line Quran • Generated on ${generatedDate}`, 105, 35, { align: 'center' });

            let yPos = 60;

            if (reportType === 'current-month' || reportType === 'yearly-detailed') {
                // Progress Summary Stats
                const stats = calculateStudentStats(studentData, reportType);
                
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Progress Summary', 20, yPos);
                yPos += 20;

                // Stats boxes
                const statBoxes = [
                    { label: 'Sabak', value: stats.sabak, color: [16, 163, 127] },
                    { label: 'Sabak Para', value: stats.para, color: [142, 68, 173] },
                    { label: 'Dhor', value: stats.dhor, color: [255, 149, 0] },
                    { label: 'Absent', value: stats.absent, color: [255, 59, 48] }
                ];

                const boxWidth = 40;
                const boxHeight = 25;
                let xPos = 20;

                statBoxes.forEach(stat => {
                    // Subtle box background with rounded corners effect
                    doc.setFillColor(248, 249, 250);
                    // Use roundedRect if available, otherwise use regular rect
                    if (typeof doc.roundedRect === 'function') {
                        doc.roundedRect(xPos, yPos - 15, boxWidth, boxHeight, 3, 3, 'F');
                    } else {
                        doc.rect(xPos, yPos - 15, boxWidth, boxHeight, 'F');
                    }
                    
                    // Border with rounded corners
                    doc.setDrawColor(229, 229, 234);
                    doc.setLineWidth(0.5);
                    if (typeof doc.roundedRect === 'function') {
                        doc.roundedRect(xPos, yPos - 15, boxWidth, boxHeight, 3, 3);
                    } else {
                        doc.rect(xPos, yPos - 15, boxWidth, boxHeight);
                    }
                    
                    // Number with color
                    doc.setTextColor(stat.color[0], stat.color[1], stat.color[2]);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text(stat.value.toString(), xPos + boxWidth/2, yPos - 3, { align: 'center' });
                    
                    // Label
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(stat.label, xPos + boxWidth/2, yPos + 8, { align: 'center' });
                    
                    xPos += boxWidth + 15;
                });

                yPos += 35;
            }

            if (reportType === 'yearly-summary' || reportType === 'yearly-detailed') {
                // Sabak Achievement Summary
                const sabakStats = calculateSabakAchievement(studentData, student.quranType || 13);
                
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Sabak Achievement Summary', 20, yPos);
                yPos += 15;

                const achievementData = [
                    ['Achievement', 'Total', 'Progress'],
                    ['Lines Memorized', sabakStats.totalLines.toString(), `${sabakStats.totalLines} lines completed`],
                    ['Pages Completed', sabakStats.totalPages.toFixed(1), `${sabakStats.totalPages.toFixed(1)} pages of Quran`],
                    ['Juz Progress', sabakStats.totalJuz.toFixed(2), sabakStats.juzFraction]
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [achievementData[0]],
                    body: achievementData.slice(1),
                    theme: 'grid',
                    headStyles: { fillColor: [16, 163, 127], textColor: 255, fontSize: 10, fontStyle: 'bold', halign: 'center' },
                    bodyStyles: { fontSize: 9, textColor: [50, 50, 50] },
                    columnStyles: {
                        0: { cellWidth: 60, fontStyle: 'bold', halign: 'left' },
                        1: { cellWidth: 30, halign: 'center' },
                        2: { cellWidth: 90, halign: 'left' }
                    },
                    margin: { left: 15, right: 15 },
                    tableWidth: 'auto'
                });

                yPos = doc.lastAutoTable.finalY + 15;
            }

            if (reportType === 'yearly-summary') {
                // Monthly Summary for yearly summary
                const monthlyStats = calculateMonthlyStats(studentData);
                
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Monthly Summary', 20, yPos);
                yPos += 15;

                const monthlyHeaders = ['Month', 'Sabak', 'Lines', 'Sabak Para', 'Dhor', 'Absent'];
                const monthlyData = [];

                monthlyStats.forEach(month => {
                    monthlyData.push([
                        month.month,
                        month.sabak.toString(),
                        month.lines.toString(),
                        month.para.toString(),
                        month.dhor.toString(),
                        month.absent.toString()
                    ]);
                });

                if (monthlyData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [monthlyHeaders],
                        body: monthlyData,
                        theme: 'grid',
                        headStyles: { fillColor: [16, 163, 127], textColor: 255, fontSize: 10, fontStyle: 'bold', halign: 'center' },
                        bodyStyles: { fontSize: 9, textColor: [50, 50, 50], halign: 'center' },
                        columnStyles: {
                            0: { cellWidth: 40, halign: 'left' },
                            1: { cellWidth: 25, halign: 'center' },
                            2: { cellWidth: 25, halign: 'center' },
                            3: { cellWidth: 25, halign: 'center' },
                            4: { cellWidth: 25, halign: 'center' },
                            5: { cellWidth: 25, halign: 'center' }
                        },
                        margin: { left: 15, right: 15 },
                        tableWidth: 'auto'
                    });
                }
            }

            if (reportType === 'current-month' || reportType === 'yearly-detailed') {
                // Daily Progress Breakdown
                const dailyData = prepareDailyProgressData(studentData, reportType, holidays);
                
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 30;
                }
                
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('Daily Progress Breakdown', 20, yPos);
                yPos += 15;

                if (dailyData.length > 0) {
                    const headers = ['Date', 'Sabak', 'Sabak Para', 'Dhor', 'Status', 'Parent Check'];
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [headers],
                        body: dailyData.map(row => [...row.data, row.parentChecked ? '✓' : '✗']),
                        theme: 'grid',
                        headStyles: { fillColor: [16, 163, 127], textColor: 255, fontSize: 10, fontStyle: 'bold', halign: 'center' },
                        bodyStyles: { fontSize: 9, textColor: [50, 50, 50], halign: 'center' },
                        columnStyles: {
                            0: { cellWidth: 30, halign: 'center' },
                            1: { cellWidth: 35, halign: 'center' },
                            2: { cellWidth: 35, halign: 'center' },
                            3: { cellWidth: 35, halign: 'center' },
                            4: { cellWidth: 25, halign: 'center' },
                            5: { cellWidth: 25, halign: 'center' }
                        },
                        didParseCell: function(data) {
                            const rowIndex = data.row.index;
                            if (rowIndex < dailyData.length && dailyData[rowIndex].isAbsent) {
                                data.cell.styles.fillColor = [255, 235, 235]; // Light red background for absent days
                                data.cell.styles.textColor = [200, 50, 50]; // Darker red text
                            } else if (rowIndex < dailyData.length && dailyData[rowIndex].isHoliday) {
                                data.cell.styles.fillColor = [255, 243, 205]; // Light yellow background for holidays
                                data.cell.styles.textColor = [133, 100, 4]; // Dark yellow text
                            } else if (rowIndex < dailyData.length && dailyData[rowIndex].isWeekend) {
                                data.cell.styles.fillColor = [232, 244, 253]; // Light blue background for weekends
                                data.cell.styles.textColor = [30, 64, 175]; // Dark blue text
                            }
                            
                            // Style parent check column
                            if (data.column.index === 5) {
                                if (rowIndex < dailyData.length && dailyData[rowIndex].parentChecked) {
                                    data.cell.styles.textColor = [0, 122, 255]; // Blue for checked
                                } else {
                                    data.cell.styles.textColor = [255, 59, 48]; // Red for not checked
                                }
                            }
                        },
                        margin: { left: 15, right: 15 },
                        tableWidth: 'auto'
                    });
                }
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setTextColor(107, 114, 128);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.text('Generated by Hifz Record Teacher App', 105, 285, { align: 'center' });
            }
            
            const fileName = `${student.name.toLowerCase().replace(/\s+/g, '_')}_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function generateAllStudentsPDF(doc, reportType) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            
            // Header
            doc.setFillColor(16, 163, 127);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('ALL STUDENTS PROGRESS REPORT', 105, 15, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(230, 230, 230);
            doc.text('Class Performance Overview', 105, 25, { align: 'center' });
            
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const generatedDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            doc.text(`Generated by ${currentUserType} on ${generatedDate}`, 105, 35, { align: 'center' });

            let yPos = 60;

            // Class overview table
            doc.setTextColor(31, 41, 55);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Class Overview', 20, yPos);
            yPos += 15;

            const classData = [];
            students.forEach(student => {
                const studentData = getStudentData(student.id);
                const stats = calculateStudentStats(studentData, reportType);
                const sabakStats = calculateSabakAchievement(studentData, student.quranType || 13);
                
                classData.push([
                    student.name,
                    `${student.quranType || 13}L`,
                    stats.sabak.toString(),
                    stats.para.toString(),
                    stats.dhor.toString(),
                    sabakStats.totalLines.toString(),
                    sabakStats.juzFraction
                ]);
            });

            const headers = ['Student', 'Type', 'Sabak', 'Para', 'Dhor', 'Lines', 'Progress'];
            
            doc.autoTable({
                startY: yPos,
                head: [headers],
                body: classData,
                theme: 'grid',
                headStyles: { fillColor: [16, 163, 127], textColor: 255, fontSize: 10, fontStyle: 'bold', halign: 'center' },
                bodyStyles: { fontSize: 9, textColor: [50, 50, 50], halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 50, halign: 'left' },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 20, halign: 'center' },
                    4: { cellWidth: 20, halign: 'center' },
                    5: { cellWidth: 25, halign: 'center' },
                    6: { cellWidth: 35, halign: 'center' }
                },
                margin: { left: 15, right: 15 },
                tableWidth: 'auto'
            });

            // Footer
            doc.setTextColor(107, 114, 128);
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text('Generated by Hifz Record Teacher App', 105, 285, { align: 'center' });

            const fileName = `all_students_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Helper functions for PDF generation
        function calculateStudentStats(studentData, reportType) {
            const stats = { sabak: 0, para: 0, dhor: 0, absent: 0 };
            const now = new Date();
            
            let filterDate;
            if (reportType === 'current-month') {
                filterDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            } else {
                // For yearly reports, include all data
                filterDate = '';
            }
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                if (!filterDate || date.startsWith(filterDate)) {
                    const dateObj = new Date(date);
                    
                    if (dayData.absent) {
                        stats.absent++;
                    } else {
                        // Only count weekday progress
                        if (!isWeekend(dateObj)) {
                            progressTypes.forEach(type => {
                                if (dayData[type]) {
                                    stats[type]++;
                                }
                            });
                        }
                    }
                }
            });
            
            return stats;
        }

        function calculateSabakAchievement(studentData, quranType) {
            let totalLines = 0;
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                if (dayData.sabak && dayData.sabak.lines && !dayData.absent) {
                    totalLines += dayData.sabak.lines;
                }
            });
            
            const conversion = convertLinesToPagesAndJuz(totalLines, quranType);
            
            return {
                totalLines,
                totalPages: conversion.pages,
                totalJuz: conversion.juz,
                juzFraction: conversion.fraction
            };
        }

        function calculateMonthlyStats(studentData) {
            const monthlyStats = {};
            
            Object.entries(studentData).forEach(([date, dayData]) => {
                const dateObj = new Date(date);
                const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
                const monthName = dateObj.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (!monthlyStats[monthKey]) {
                    monthlyStats[monthKey] = {
                        month: monthName,
                        sabak: 0,
                        lines: 0,
                        para: 0,
                        dhor: 0,
                        absent: 0
                    };
                }
                
                if (dayData.absent) {
                    monthlyStats[monthKey].absent++;
                } else {
                    // Only count weekday progress
                    if (!isWeekend(dateObj)) {
                        progressTypes.forEach(type => {
                            if (dayData[type]) {
                                monthlyStats[monthKey][type]++;
                                if (type === 'sabak' && dayData[type].lines) {
                                    monthlyStats[monthKey].lines += dayData[type].lines;
                                }
                            }
                        });
                    }
                }
            });
            
            return Object.values(monthlyStats).sort((a, b) => {
                const aDate = new Date(a.month);
                const bDate = new Date(b.month);
                return aDate - bDate;
            });
        }

        function prepareDailyProgressData(studentData, reportType, holidays) {
            const dailyData = [];
            const now = new Date();
            
            let filterDate;
            if (reportType === 'current-month') {
                filterDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }
            
            const sortedDates = Object.keys(studentData).sort();
            
            sortedDates.forEach(date => {
                if (!filterDate || date.startsWith(filterDate)) {
                    const dayData = studentData[date];
                    const dateObj = new Date(date);
                    const holiday = holidays.find(h => h.date === date);
                    const isWeekendDay = isWeekend(dateObj);
                    
                    let sabakText = '-';
                    let paraText = '-';
                    let dhorText = '-';
                    let statusText = 'Present';
                    let isAbsent = false;
                    let isHoliday = false;
                    let parentChecked = false;
                    
                    if (holiday) {
                        statusText = 'Holiday';
                        isHoliday = true;
                    } else if (dayData.absent) {
                        statusText = 'Absent';
                        isAbsent = true;
                    } else if (isWeekendDay) {
                        statusText = 'Weekend';
                        // Show homework if assigned
                        if (dayData.homework) {
                            if (dayData.homework.sabak) sabakText = 'HW Assigned';
                            if (dayData.homework.para) paraText = 'HW Assigned';
                            if (dayData.homework.dhor) dhorText = 'HW Assigned';
                        }
                    } else {
                        // Regular weekday
                        if (dayData.sabak) {
                            sabakText = dayData.sabak.lines ? 
                                `${dayData.sabak.lines} lines - ${dayData.sabak.fraction}` : 
                                dayData.sabak.amount;
                        }
                        if (dayData.para) paraText = dayData.para.amount;
                        if (dayData.dhor) dhorText = dayData.dhor.amount;
                    }
                    
                    if (dayData.parentChecked) {
                        parentChecked = true;
                    }
                    
                    const formattedDate = dateObj.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    dailyData.push({
                        data: [formattedDate, sabakText, paraText, dhorText, statusText],
                        isAbsent,
                        isHoliday,
                        isWeekend: isWeekendDay && !holiday,
                        parentChecked
                    });
                }
            });
            
            return dailyData;
        }

        function exportGitHubData() {
            if (!githubConfig.connected) {
                alert('Not connected to GitHub');
                return;
            }
            
            const repoUrl = `https://github.com/${githubConfig.username}/${githubConfig.repo}`;
            window.open(repoUrl, '_blank');
            alert(`Repository URL:\n${repoUrl}\n\nYou can view all data files in the repository.`);
        }

        function showResetModal() {
            if (currentUserType !== 'teacher') return;
            
            if (confirm('Are you sure you want to reset ALL student data? This cannot be undone.')) {
                if (confirm('This will permanently delete all progress records. Continue?')) {
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    students.forEach(student => {
                        localStorage.removeItem(`student_${student.id}`);
                    });
                    
                    localStorage.setItem('students', JSON.stringify(defaultStudents));
                    
                    alert('All data has been reset');
                    location.reload();
                }
            }
        }

        function logout() {
            currentStudent = null;
            currentUserType = null;
            selectedProfile = null;
            showSetupSection();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['progressModal', 'homeworkModal', 'dayModal', 'addStudentModal', 'removeStudentModal', 'exportPDFModal', 'holidayModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };

        // Allow Enter key for login
        document.addEventListener('DOMContentLoaded', function() {
            const accessCodeInput = document.getElementById('accessCode');
            if (accessCodeInput) {
                accessCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // Add event listener for lines input
            const linesInput = document.getElementById('linesInput');
            if (linesInput) {
                linesInput.addEventListener('input', updateConversionDisplay);
            }
        });

        // Initialize app when page loads
        function initializeApp() {
            updateCurrentDate();
            showSetupSection();
        }

        // Initialize app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Fallback initialization
        window.addEventListener('load', function() {
            if (document.getElementById('currentDate').textContent === 'Loading...') {
                initializeApp();
            }
        });
    </script>
</body>
</html>
